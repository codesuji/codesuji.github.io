<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>codesuji</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://codesuji.com/"/>
  <updated>2020-11-06T01:38:10.892Z</updated>
  <id>http://codesuji.com/</id>
  
  <author>
    <name>codesuji.com</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Rust and Dynamic Time Warping</title>
    <link href="http://codesuji.com/2020/11/05/Rust-and-Dynamic-Time-Warping/"/>
    <id>http://codesuji.com/2020/11/05/Rust-and-Dynamic-Time-Warping/</id>
    <published>2020-11-06T01:17:11.000Z</published>
    <updated>2020-11-06T01:38:10.892Z</updated>
    
    <content type="html"><![CDATA[<p>I’m back to a familar topic, dynamic time warping.  This time it’s my excuse to play with <a href="https://www.rust-lang.org/" target="_blank" rel="noopener">Rust</a>.</p><a id="more"></a><p>As a bit of refresher, Dynamic Time Warping (DTW) is a useful mechanism to compare signals, or series, while adjusting for frequency variance.  It has turned into one of my go-to algorithms when trying out a new language, Rust is no exception.  Today I’m going to explore implementing the DTW algorithm in Rust.  My goal is to be as idiomatic as possible, but since this is a learning process, I assume there will be some gaps.  Obviously for all this to work I need Rust, installation instructions can be found <a href="https://www.rust-lang.org/tools/install" target="_blank" rel="noopener">here</a>.</p><p>There is a little setup first.  The plan is to read data from csv files, and use gnuplot for some sequence visualizations.  As a sidenote, the gnuplot crate assumes gnuplot is installed.  So I need to ensure that is installed.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> csv;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> csv::ReaderBuilder;</span><br><span class="line"><span class="keyword">use</span> gnuplot::&#123;Figure, Caption, Color&#125;;</span><br><span class="line"><span class="keyword">use</span> std::env;</span><br></pre></td></tr></table></figure><p>Getting right into the meat of it, here is the dtw implementation.  The cost function takes 2 float vectors (and a debug flag) and returns a float as the cost, or difference, between the two sequences.  The internal structure that is traversed is a two-dimensional vector, the cost matrix.  After the matrix initialization, I iterate through both sequences, comparing and storing cummulative “best” distances.  As an initial pass I’m not interested in implementing some of the typical dtw optimizations.  That makes this implementation straight-forward, and a good first step.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Calculate distance between values</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">distance</span></span>(a: <span class="built_in">f32</span>, b: <span class="built_in">f32</span>) -&gt; <span class="built_in">f32</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">f32</span>::abs(a - b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Calculate cost difference between two sequences (dtw-style)</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">cost</span></span>(debug: <span class="built_in">bool</span>, a: &amp;[<span class="built_in">f32</span>], b: &amp;[<span class="built_in">f32</span>]) -&gt; <span class="built_in">f32</span> &#123;</span><br><span class="line">  <span class="comment">// Init matrix</span></span><br><span class="line">  <span class="keyword">let</span> matrix_a_len = a.len() + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> matrix_b_len = b.len() + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mut</span> data = <span class="built_in">vec!</span>[<span class="built_in">vec!</span>[<span class="built_in">f32</span>::MAX; matrix_b_len]; matrix_a_len];</span><br><span class="line">  data[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span>.;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Calculate cost matrix</span></span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> ai and bi represent index in data (do -1 when referencing into the a and b vectors)</span></span><br><span class="line">  <span class="keyword">for</span> ai <span class="keyword">in</span> <span class="number">1</span>..matrix_a_len &#123;</span><br><span class="line">    <span class="keyword">for</span> bi <span class="keyword">in</span> <span class="number">1</span>..matrix_b_len &#123;</span><br><span class="line">      <span class="keyword">let</span> cost = distance(a[ai - <span class="number">1</span>], b[bi - <span class="number">1</span>]);</span><br><span class="line">      data[ai][bi] = cost + <span class="built_in">f32</span>::min(<span class="built_in">f32</span>::min(data[ai - <span class="number">1</span>][bi], data[ai][bi - <span class="number">1</span>]), data[ai - <span class="number">1</span>][bi - <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Dump cost matrix</span></span><br><span class="line">  <span class="keyword">if</span> debug &#123;</span><br><span class="line">    <span class="keyword">for</span> ai <span class="keyword">in</span> <span class="number">0</span>..matrix_a_len &#123;</span><br><span class="line">      <span class="keyword">for</span> bi <span class="keyword">in</span> <span class="number">0</span>..matrix_b_len &#123;</span><br><span class="line">        <span class="built_in">print!</span>(<span class="string">"&#123;:5&#125; "</span>, (<span class="keyword">if</span> data[ai][bi] == <span class="built_in">f32</span>::MAX &#123; <span class="built_in">String</span>::from(<span class="string">"-"</span>) &#125; <span class="keyword">else</span> &#123; <span class="built_in">format!</span>(<span class="string">"&#123;:.*&#125;"</span>, <span class="number">2</span>, data[ai][bi]) &#125;));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">println!</span>(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Return final cost</span></span><br><span class="line">  <span class="keyword">return</span> data[a.len()][b.len()];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The algorithm doesn’t do much if it doesn’t have data.  I use this an excuse to learn how to use a csv parser.  I’m still getting a handle on the best way to deal with errors in Rust.  For my purposes printing an error, but filtering out bad data works for me.  The goal is to read a csv, and transform the first column into a vector.  I then return the resulting vector to eventually be consumed by the previously defined cost function.  The csv::ReaderBuilder works well for me out of the box, and it has several more options than I choose to use here. </p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Load a file for processing</span></span><br><span class="line"><span class="comment">/// Assumes rows with at least one column</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">load_file</span></span>(debug: <span class="built_in">bool</span>, filename: &amp;<span class="built_in">String</span>) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Vec</span>&lt;<span class="built_in">f32</span>&gt;, csv::Error&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> debug &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"loading: &#123;&#125;"</span>, filename);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> reader =</span><br><span class="line">    ReaderBuilder::new()</span><br><span class="line">    .has_headers(<span class="literal">false</span>)</span><br><span class="line">    .delimiter(<span class="string">b','</span>)</span><br><span class="line">    .from_path(&amp;filename);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">match</span> reader &#123;</span><br><span class="line">    <span class="literal">Ok</span>(<span class="keyword">mut</span> r) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> data: <span class="built_in">Vec</span>&lt;<span class="built_in">f32</span>&gt; =</span><br><span class="line">        r</span><br><span class="line">        .records()</span><br><span class="line">        .filter_map(|x| x.ok())</span><br><span class="line">        .map(|x| (x[<span class="number">0</span>]).parse::&lt;<span class="built_in">f32</span>&gt;())</span><br><span class="line">        .filter_map(|x| &#123; <span class="keyword">match</span> &amp;x &#123;</span><br><span class="line">                            <span class="literal">Ok</span>(_) =&gt; &#123; () &#125;</span><br><span class="line">                            <span class="literal">Err</span>(e) =&gt; &#123; <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, &amp;e) &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        x.ok() &#125;)</span><br><span class="line">        .collect();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">Ok</span>(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">Err</span>(e) =&gt; &#123;</span><br><span class="line">      <span class="literal">Err</span>(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>To aid in the development process it is useful to visualize the data.  For that I’ll use gnuplot, and thankfully there is a crate for me to use.  As mentioned previously, I need to also have gnuplot installed, beyond just the crate.  The comparison chart I put together here is pretty basic, but it meets my exploratory needs.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Make a chart containing 2 sequences (for comparison)</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">make_chart</span></span>(debug: <span class="built_in">bool</span>, filename: &amp;<span class="built_in">str</span>, a: &amp;[<span class="built_in">f32</span>], b: &amp;[<span class="built_in">f32</span>]) &#123;</span><br><span class="line">  <span class="keyword">let</span> x_max = a.len().max(b.len()) <span class="keyword">as</span> <span class="built_in">i32</span>;</span><br><span class="line">  <span class="keyword">let</span> x: <span class="built_in">Vec</span>&lt;<span class="built_in">i32</span>&gt; = (<span class="number">0</span>..x_max).collect();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mut</span> chart = Figure::new();</span><br><span class="line">  chart</span><br><span class="line">    .set_terminal(<span class="string">"pngcairo"</span>, filename)</span><br><span class="line">    .axes2d()</span><br><span class="line">    .lines(&amp;x, a, &amp;[Caption(<span class="string">"A"</span>), Color(<span class="string">"red"</span>)])</span><br><span class="line">    .lines(&amp;x, b, &amp;[Caption(<span class="string">"B"</span>), Color(<span class="string">"blue"</span>)]);</span><br><span class="line">  chart.show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Now, I’m finally to the point where I can put it all together.  To facilitate flexiblity, I take two csv files at the command line and compare their results.  After calculating the cost I create a combined chart of the sequences.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// main</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">  <span class="keyword">let</span> args: <span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt; = env::args().collect();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> debug =</span><br><span class="line">    args</span><br><span class="line">      .iter()</span><br><span class="line">      .map(|x| x == <span class="string">"--debug"</span>)</span><br><span class="line">      .fold(<span class="literal">false</span>, |acc, x| acc || x);</span><br><span class="line">  <span class="built_in">println!</span>(<span class="string">"&#123;&#125;"</span>, debug);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> filename1 = &amp;args[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">let</span> filename2 = &amp;args[<span class="number">2</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> file1 = load_file(debug, filename1);</span><br><span class="line">  <span class="keyword">let</span> file2 = load_file(debug, filename2);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">match</span> (file1, file2) &#123;</span><br><span class="line">    (<span class="literal">Ok</span>(file1), <span class="literal">Ok</span>(file2)) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> cost = cost(debug, &amp;file1, &amp;file2);</span><br><span class="line">      <span class="built_in">println!</span>(<span class="string">"cost: &#123;&#125;"</span>, cost);</span><br><span class="line"></span><br><span class="line">      make_chart(debug, <span class="string">"chart1.png"</span>, &amp;file1, &amp;file2);</span><br><span class="line">    &#125;</span><br><span class="line">    (<span class="literal">Err</span>(e), _) =&gt; &#123; <span class="built_in">println!</span>(<span class="string">"Error: &#123;&#125; &#123;&#125;"</span>, filename1, e); &#125;</span><br><span class="line">    (_, <span class="literal">Err</span>(e)) =&gt; &#123; <span class="built_in">println!</span>(<span class="string">"Error: &#123;&#125; &#123;&#125;"</span>, filename2, e); &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>With the code complete, it is time to test it out.  For that I grabbed some cpu logs from different workloads.  To simplify the post I’ll just focus on cpu; although memory, disk, and network are important to workload profiling.  The existing algorithm can easily have a modified distance calculation to handle multiple dimensions.  Now I just run the app to measure profile similarities and build charts for comparison.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cargo run cpu1.csv cpu2.csv</span><br></pre></td></tr></table></figure><p><img src="/images/dtw2/chart-1.png" alt="Workload 1"><br><img src="/images/dtw2/chart-2.png" alt="Workload 2"><br><img src="/images/dtw2/chart-3.png" alt="Workload 3"><br><img src="/images/dtw2/chart-4.png" alt="Workload 4"><br><img src="/images/dtw2/chart-5.png" alt="Workload 5"></p><p>From the chart below, we can see Workloads 3, 4, and 5 have the closest profile.  Workloads 1 and 5 have the highest distance difference.</p><table><thead><tr><th></th><th>W1</th><th>W2</th><th>W3</th><th>W4</th><th>W5</th></tr></thead><tbody><tr><td>W1</td><td></td><td>1212</td><td>1613</td><td>2002</td><td>2218</td></tr><tr><td>W2</td><td></td><td></td><td>1572</td><td>1899</td><td>1928</td></tr><tr><td>W3</td><td></td><td></td><td></td><td>890</td><td>585</td></tr><tr><td>W4</td><td></td><td></td><td></td><td></td><td>1075</td></tr></tbody></table><p>Using Rust for implementing DTW went relatively smoothly.  My own code review exposes room for improvement and leveraging Rust better.  So I already have some avenues to follow for more learnings.  With that said, I’m pleased with how it all came together.  Honestly, it’s too early to judge, but I’m thrilled with what I see from Rust.  Even though I ran into the typical Rustism snags, coming from a functional background, I felt right at home with many of the idioms.  And those snags are just room for growth and part of the learning process.  Rust’s approach is solid and I like what I get out of some extra manual effort.  Expect more posts as I continue the experiments.  Until next time.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;I’m back to a familar topic, dynamic time warping.  This time it’s my excuse to play with &lt;a href=&quot;https://www.rust-lang.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Rust&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
    
      <category term="DTW" scheme="http://codesuji.com/tags/DTW/"/>
    
      <category term="Dynamic Time Warping" scheme="http://codesuji.com/tags/Dynamic-Time-Warping/"/>
    
      <category term="Rust" scheme="http://codesuji.com/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>Nix for Development</title>
    <link href="http://codesuji.com/2020/10/25/Nix-For-Development/"/>
    <id>http://codesuji.com/2020/10/25/Nix-For-Development/</id>
    <published>2020-10-25T13:18:33.000Z</published>
    <updated>2020-10-26T11:26:01.818Z</updated>
    
    <content type="html"><![CDATA[<p>For awhile I’ve admired <a href="https://nixos.org" target="_blank" rel="noopener">Nix</a> from afar, but I’ve recently taken the opportunity to dive in and get a feel for it myself.  This is mostly an aggregation of initial impressions and ideas of how I can leverage Nix in my development workflow.</p><a id="more"></a><p>To start off, this is a view into the Nix package manager, not NixOS.  The distro is on my list to evaluate, but that is a task for another day.  Additionally, this isn’t meant to be a Nix tutorial, the <a href="https://nixos.org" target="_blank" rel="noopener">Nix</a> project has some good starting information.  My goal here is just focusing on the development experience.  For those not familiar with Nix, it is a package manager focused on reproducibility.  For me, that is the appeal.  I’m always looking for ways to make my process at home and work better; providing a more consistent environment is part of that.  In addition, Nix should open opportunities for additional flexibility and safety while dealing with different tooling versions.</p><p>To that point, tooling versions can be particular pain point when dealing with different projects and teams in an organization.  Inevitably, there are projects needing that particular version of Node or Python (to just pick on two language runtimes).  Their respective communities have come up with solutions to this problem, tools like nvm, nodeenv, virtualenv, and pyenv, to just name a few.  Nix, among other things, solves this problem using a overarching singular solution.  It is a consistent answer across different types of languages and projects.  Honestly, it is not that hard to manage different languages with their own set of tools.  But the ability to manage tooling dependencies the exact same way at a higher level is very appealing.</p><p>Since Nix is a package manager, not just a language runtime manager, that means I can control more than Python or Node versions.  I can use it add sorts of application dependencies for a project.  These may be required or recommended developer tooling for the project.  As example, lsof or netcat installation can be part of the project development package.  Outside of project-specific usage, you can use Nix as your general system package manager (technically that’s the underlying intent anyway).  But for those who want to just dip their toes, you don’t need to go all-in for OS package management.  It’s just an option to consider.  I will say, if you’re not going to go all-in with Nix, just make sure you clearly delineate your boundaries.  The last thing you want to do is add the mental load of “hrm, how did I install that app?”.</p><p>It is time to dig a bit deeper, and that starts at understanding the different aspects of the Nix.</p><ul><li>Nix, the package manager</li><li>Nix, the shell</li><li>The Nix configuration files</li></ul><p>An example can do wonders for understanding how everything pieces together.  For this example project I’m going to be use .Net Core (v3) and NodeJs (v14).  First make sure Nix is installed; which adds the package manager, nix shell, plus several other tools.  Once complete, it is time to setup the project-specific tooling configuration.  This is handled by the <code>shell.nix</code> file (or <code>default.nix</code>).  In the project directory, I’ll create the file <code>shell.nix</code>.  Once created, I add the development dependencies.  This includes the .NET Core sdk as well as the NodeJs runtime; available options <a href="https://search.nixos.org/packages?channel=unstable" target="_blank" rel="noopener">here</a>.  It doesn’t have to end there, I can also run commands and/or set environment variables for the project’s Nix shell.</p><p><code>shell.nix</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123; pkgs ? import &lt;nixpkgs&gt; &#123;&#125; &#125;:</span><br><span class="line"></span><br><span class="line">pkgs.mkShell &#123;</span><br><span class="line">  buildInputs = [</span><br><span class="line">    pkgs.dotnet-sdk_3</span><br><span class="line">    pkgs.nodejs-14_x</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  shellHook = &apos;&apos;</span><br><span class="line">    echo starting...</span><br><span class="line">  &apos;&apos;;</span><br><span class="line"></span><br><span class="line">  MY_VAR = &quot;foobar&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Now my project directory looks like this:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~/projects/myproject(dev)$ tree -L 1</span><br><span class="line">.</span><br><span class="line">├── main.fsx</span><br><span class="line">├── main.js</span><br><span class="line">├── node_modules</span><br><span class="line">├── package.json</span><br><span class="line">├── package-lock.json</span><br><span class="line">└── shell.nix</span><br></pre></td></tr></table></figure><p>Once this is created, just run <code>nix-shell</code>.  This handles project setup as well as development dependencies.  The below example shows the manifestation of the defined development dependencies.  Currently I have dotnet installed globally, and node not installed at all.  So inside my nix-shell my dotnet version changes, while node and my environment variable are made available.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">~/projects$ cd myproject</span><br><span class="line">~/projects/myproject(dev)$ echo $MY_VAR</span><br><span class="line"></span><br><span class="line">~/projects/myproject(dev)$ dotnet --version</span><br><span class="line">3.1.403</span><br><span class="line">~/projects/myproject(dev)$ node --version</span><br><span class="line">bash: node: command not found</span><br><span class="line">~/projects/myproject(dev)$ nix-shell</span><br><span class="line">starting...</span><br><span class="line"></span><br><span class="line">[nix-shell:~/projects/myproject]$ echo $MY_VAR</span><br><span class="line">foobar</span><br><span class="line"></span><br><span class="line">[nix-shell:~/projects/myproject]$ dotnet --version</span><br><span class="line">3.1.402</span><br><span class="line"></span><br><span class="line">[nix-shell:~/projects/myproject]$ node --version</span><br><span class="line">v14.9.0</span><br><span class="line"></span><br><span class="line">[nix-shell:~/projects/myproject]$ which dotnet</span><br><span class="line">/nix/store/wdy002bjakj6x2a6mdqajg11j23b3v2v-dotnet-sdk-3.1.402/bin/dotnet</span><br><span class="line"></span><br><span class="line">[nix-shell:~/projects/myproject]$ which node</span><br><span class="line">/nix/store/0f4ar6v0qvsb6cnyz1k2avhg9frsjr8s-nodejs-14.9.0/bin/node</span><br><span class="line"></span><br><span class="line">[nix-shell:~/projects/myproject]$ dotnet fsi main.fsx </span><br><span class="line">Hello, MY_VAR = foobar</span><br><span class="line"></span><br><span class="line">[nix-shell:~/projects/myproject]$ node main.js </span><br><span class="line">Hello, MY_VAR = foobar</span><br><span class="line"></span><br><span class="line">[nix-shell:~/projects/myproject]$ exit</span><br><span class="line">exit</span><br></pre></td></tr></table></figure><p>Great! I now have development dependencies set for my project.  Add the newly created <code>nix.shell</code> to source control, and teammates can now develop in a similar environment (assuming they also have Nix of course).  So, this is a bit of a lie.  Others can get close, but the question is, how do I ensure actual reproducibility so we all can truly see the same version of the tools?  To understand the situation better, I need to mention channels.  Channels are a Nix construct that defines a consistent sets of packages that can be installed.  As an example unstable, 20.09, 20.03, 19.09 are some of the channels available at the time of this writing.  Everyone could have their default channel set to a different channel.  Each channel having it’s own version of applications, for example <code>dotnet-sdk_3</code> is version 3.1.101 in the channel 20.03 and 3.1.102 in 20.09.  So a user’s system can be consistent within itself, but how do you get consistency across a team?  You pin a shell.nix to a specific git commit.  This guarantees everyone works off the same set of packages.  For reference you can find the proper commit for a channel on the <a href="https://status.nixos.org/" target="_blank" rel="noopener">status</a> page.  To do this, I modify the first line of my shell.nix to pin it to a specific commit of the unstable channel.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; pkgs ? import (fetchTarball &quot;https://github.com/NixOS/nixpkgs/archive/cfed29bfcb28259376713005d176a6f82951014a.tar.gz&quot;) &#123;&#125; &#125;:</span><br></pre></td></tr></table></figure><p>Now we have everyone on the same page.  I believe this setup can go a long way to making a better development experience.  But there is more.  This works, but some may find entering the nix-specific shell every time a hassle.  This is where <a href="https://direnv.net" target="_blank" rel="noopener">direnv</a> enters the picture.  Once this is installed, I can automatically enter a nix shell when I cd into the project directory.  <i>Aside: There are other solutions for this, direnv is just what I settled on</i>.  It works as a nice addition to make the whole experience seamless.  Once direnv is installed and configured, there is a little project-specific setup.  First, in the project directory create a <code>.envrc</code> file.  Second, authorize direnv to activate on the project directory.  This second step is important.  Since direnv won’t just run code because an .envrc file is there, you have to tell it which dirs it is supposed to run against.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd myproject</span><br><span class="line"></span><br><span class="line"># Create an environment file</span><br><span class="line">echo &quot;use nix&quot; &gt; .envrc</span><br><span class="line"></span><br><span class="line"># Enable direnv for this dir</span><br><span class="line">direnv allow</span><br></pre></td></tr></table></figure><p>With that in place, now when I enter the directory, Nix auto configures and I’m good to go.  Fwiw, direnv can be used for more than just instantiating Nix.  In fact, there is some overlap in nix-shell and direnv functionality.  Things like environment variables can be configured in either shell.nix or .envrc.  It’s worth figuring out where the right balance is for you.  I prefer to keep static and development-specific configuration across environments in the shell.nix.  For things that can, or should, vary across environments I prefer an environment-specific file, like .envrc.  All these pieces put together make for a nice development experience.  My initial experience has been good and I look forward to putting this setup through it’s paces.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;For awhile I’ve admired &lt;a href=&quot;https://nixos.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Nix&lt;/a&gt; from afar, but I’ve recently taken the opportunity to dive in and get a feel for it myself.  This is mostly an aggregation of initial impressions and ideas of how I can leverage Nix in my development workflow.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Nix" scheme="http://codesuji.com/tags/Nix/"/>
    
  </entry>
  
  <entry>
    <title>Playing with the micro:bit</title>
    <link href="http://codesuji.com/2020/10/19/Microbit-Introduction/"/>
    <id>http://codesuji.com/2020/10/19/Microbit-Introduction/</id>
    <published>2020-10-20T03:54:29.000Z</published>
    <updated>2020-10-26T12:07:49.470Z</updated>
    
    <content type="html"><![CDATA[<p>I try to keep an eye out for interesting and accessible electronics projects.  The <a href="https://microbit.org/" target="_blank" rel="noopener">micro:bit</a> is a cool little board.  Although there is a plethora of boards and kits out there, it can often be a challenge to find a fun kit that engages in just the right way.  I’ve recently been playing with the micro:bit, and it’s an impressive little package.  For me, it checks several boxes for being a nice STEM kit for learning.</p><a id="more"></a><p>First, the hardware.  It is an all-in-one package equipped  with several different components.  What is immediately noticeable is the 5x5 LED grid flanked by 2 user buttons.  Beyond that it has a couple I/O pins, accelerometer, radio, bluetooth (full details <a href="https://tech.microbit.org/hardware/" target="_blank" rel="noopener">here</a>).  The perfect set of components to get started and jump right in, especially when introducing someone to microcontrollers and programming.  Second, the software.  The usual suspects are available for build micro:bit apps.  They provide both Scratch and Python web interfaces, so it makes putting code together pretty simple.  Using Scratch, my kids and I had a simple program up and running in a couple minutes.  The preset bitmaps and scrolling marquee text do well to give the kids something fun to play with.  If you use Chrome you’re supposed to be able to use WebUSB to flash the micro:bit directly from the browser.  I couldn’t get it to work, but that’s ok.  When the micro:bit is connected to the computer, it is exposed as a usb drive.  All I needed to do was download the program’s .hex file to it like a normal drive.  This resulted in a reasonably quick reload for the program run.</p><p>Taking it past initial playing, the documentation and code samples are nicely put together.  It is more than enough to jump-start the learning process.  I found the documentation to be pretty easy to sift through, at least for the Python interfaces.  Students won’t be short on resources when figuring out how to venture out on their own.  It’s nice to see easy to navigate docs.  We were able to put several quick projects together, and the kids had a blast.</p><p>In the end, this is a fun little board to experiment with.  I was able to whip up some nice little prototypes with relatively minimal effort.  I look forward to using this on some future learning projects.  I think it has a nice balance of functionality and usablity, especially for the kids.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;I try to keep an eye out for interesting and accessible electronics projects.  The &lt;a href=&quot;https://microbit.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;micro:bit&lt;/a&gt; is a cool little board.  Although there is a plethora of boards and kits out there, it can often be a challenge to find a fun kit that engages in just the right way.  I’ve recently been playing with the micro:bit, and it’s an impressive little package.  For me, it checks several boxes for being a nice STEM kit for learning.&lt;/p&gt;
    
    </summary>
    
    
      <category term="STEM" scheme="http://codesuji.com/tags/STEM/"/>
    
  </entry>
  
  <entry>
    <title>Propagator Networks in F#</title>
    <link href="http://codesuji.com/2020/05/10/Propagator-Networks-in-F/"/>
    <id>http://codesuji.com/2020/05/10/Propagator-Networks-in-F/</id>
    <published>2020-05-10T12:32:07.000Z</published>
    <updated>2020-05-10T23:37:04.725Z</updated>
    
    <content type="html"><![CDATA[<p>Propagator Networks are an interesting approach to computation.  Today I want to provide an introduction to the concept of propagators using <a href="https://fsharp.org" target="_blank" rel="noopener">F#</a>.</p><a id="more"></a><p>First, what is a propagator network?  In short, it is a computational method that provides a unique approach to model information and it’s flow through a system.  It’s concepts and motivations are described in several papers by Alexey Radul and Gerald Sussman, <a href="#references">references</a> below.  Here I’ll provide a brief overview as well as some examples.  On the surface, propagator networks are constructed of two primary components: cells and propagators.  Cells are independent entities that maintain their own data.  Propagators are functional connectors that propagate information between cells.  These two parts work together to provide a method of data accumulation and computation.</p><p>To go a bit deeper, cells don’t just hold data, but accumulate data.  For datatypes like int, this is relatively straight-forward.  When a cell is created it may have a known value.  But it may also be unknown (no information), since the implementation uses the Option type, it initialized with None.  As data is processed through the network, a cell may increase it’s information with an actual value when available.  For an Interval datatype this is more interesting.  It too can have information when initialized, but in cases where there is no information, it is initialized with None.  But as the network processes data, the cell accumulates additional information, resulting in more accurate interval values.</p><p>Propagators calculate and push data through the network, allowing cells to accumulate additional information.  Propagators must adhere to several rules.  They must be monotonically increasing.  The information they pass to a cell must be at least as good or better than what the cell contained before.  Since a cell is an Option type, in a basic sense any value is better than None (information is better than no information).  The real power is best seen using the Interval datatype.  For example, if a cell has the value range 10.1 - 12.2, any value a propagator passes to that cell must be at least this good.  A new value of 10.1 - 11.0 is more precise (better), but a value of 9.0 - 15.0 is less precise (worse).  As a result, a propagator would update the cell with the former value, but not the latter.  Propagators must also be idempotent.  Since a propagator can be triggered to executed multiple times, it must return the same data.  These attributes work to support stability, internal autonomy, asynchronous execution, as well as proper accumulation of information.  </p><p>Propagators should also be bi-directional in their computational ability.  This is what allows data to flow in both directions across operators.  In general this means a propagator for the function <code>p(a) = b</code> should have bundled an equivalent function <code>p&#39;(b) = a</code>.  As an example, imagine a function <code>a + b = c</code>.  There are reciprocal functions <code>c - b = a</code> and <code>c - a = b</code>.  A propagator is the bundling of these functions together so that given any two values it can provide the third.  This allows a developer to write <code>adder a b c</code> to create an addition function of <code>a + b = c</code>, but get functional computation in all directions for free. </p><p>These components and their associated rules provide some interesting computational characteristics for accumulating data.  A model of data relationships only need to be defined once.  It enables data population from diverse sources, and a more robust representation of knowledge.  Also, those reading might think these concepts bear a striking resemblance to CRDT and join-semilattice, and they would be correct.  This is a useful comparison to carry mentally when thinking about propagator networks.</p><p>Moving onto the code portion of the post, the below examples were created using <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core</a> 3.1.  As a caveat, this is an experimental project.  I’m using it to research several concepts surrounding propagator networks.  So it is functional, but not currently production ready.  Beyond internal implementation choices I’m playing with the semantics and library ergonomics.  As a result, the code you see below will certainly shift over time.  This doesn’t change the underlying concepts of propagator networks.  The library is available below. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet new package propagator --version 0.1.0</span><br></pre></td></tr></table></figure><h2 id="Temperature-Conversion"><a href="#Temperature-Conversion" class="headerlink" title="Temperature Conversion"></a>Temperature Conversion</h2><p>I want to pull a couple examples from the previously mentioned papers to walk through the process. First is a temperature conversion example.  The math on this is so simple that using propagators can feel like overkill, but the simplicity allows focus on the propagator mechanics without getting too caught up in complex formulas.  Even with simple formulas, don’t underestimate the ability to define mathematical relationships once.</p><p>Building a propagator network is a multiple step process.  Starting with the temperature conversion formula <code>F = C * 1.8 + 32</code>, there are several components and operations to be codified.  But before getting into the details, a diagram assists in conceptualization of the entire formula and how the it is broken down.</p><p><img src="/images/prop1/temperature-network.png" alt="Temperature Converter"></p><p>First, cells need to be created to hold data.  There are the two end points (Celsius and Fahrenheit) that will serve as input or output, depending on conversion direction.  There are also constants in the formula (1.8 and 32).  Additionally, and perhaps less obvious at first glance, there are sub-results for the intermediate operations within the formula (C * 1.8).  When the function is initially created the only values known are the ones sent in (C or F) and the constants.  Beyond that, everything else is uninitialized.  </p><p>Second, the relationships between the cells need to be defined, these are the propagators.  Conveniently, the library has built-in propagators to support common math operations.  A multiplier propagator will represent the <code>C * 1.8 = C18</code> sub-component.  An adder propagator will then take that sub-result and combine it for a final result <code>C18 + 32 = F</code>.  These propagators are all that is needed to wire things together.</p><p>With the network in place, all that is needed now is to set the input and run the network.  Since this is meant to work in either direction, it will accept and return both Celsius and Fahrenheit values.  Below is the implementation.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// TemperatureConverter</span></span><br><span class="line"><span class="comment">/// F = C * 1.8 + 32 </span></span><br><span class="line"><span class="keyword">let</span> temperatureConverter (c: float option) (f: float option) =</span><br><span class="line">  <span class="keyword">let</span> network = PropagatorNetwork()</span><br><span class="line">  <span class="keyword">let</span> cellc = network.AddCell c</span><br><span class="line">  <span class="keyword">let</span> cell18 = network.AddConstant <span class="number">1.8</span></span><br><span class="line">  <span class="keyword">let</span> cellc18 = network.AddCell None</span><br><span class="line">  <span class="keyword">let</span> cell32 = network.AddConstant <span class="number">32.</span></span><br><span class="line">  <span class="keyword">let</span> cellf = network.AddCell f</span><br><span class="line">  </span><br><span class="line">  multiplier cellc cell18 cellc18 |&gt; network.AddPropagator</span><br><span class="line">  adder cellc18 cell32 cellf |&gt; network.AddPropagator</span><br><span class="line"></span><br><span class="line">  network.Run()</span><br><span class="line">  (network.GetFloat cellc, network.GetFloat cellf)</span><br></pre></td></tr></table></figure><p>With the Celsius/Fahrenheit relationship defined, I can now call conversions in either direction.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// C -&gt; F</span></span><br><span class="line"><span class="keyword">match</span> (temperatureConverter (Some <span class="number">20.</span>) None) <span class="keyword">with</span></span><br><span class="line">| Some(c), Some(f) -&gt; printfn <span class="string">"%5.2fc = %5.2ff"</span> c f</span><br><span class="line">| _ -&gt; printfn <span class="string">"Conversion undetermined"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// F -&gt; C</span></span><br><span class="line"><span class="keyword">match</span> (temperatureConverter None (Some <span class="number">80.</span>)) <span class="keyword">with</span></span><br><span class="line">| Some(c), Some(f) -&gt; printfn <span class="string">"%5.2fc = %5.2ff"</span> c f</span><br><span class="line">| _ -&gt; printfn <span class="string">"Conversion undetermined"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Results:</span></span><br><span class="line"><span class="number">20.00</span>c = <span class="number">68.00</span>f</span><br><span class="line"><span class="number">26.67</span>c = <span class="number">80.00</span>f</span><br></pre></td></tr></table></figure><p>Just for kicks I can easily add capability.  The propagator network can be expanded to support Kelvin.  By adding a single propagator for a <code>C = K - 273.15</code> conversion, the network now supports conversions between all three systems in any direction. </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> temperatureConverterCFK (c: float option) (f: float option) (k: float option) =</span><br><span class="line">  <span class="keyword">let</span> network = PropagatorNetwork()</span><br><span class="line">  <span class="keyword">let</span> cellc = network.AddCell c</span><br><span class="line">  <span class="keyword">let</span> cell18 = network.AddConstant <span class="number">1.8</span></span><br><span class="line">  <span class="keyword">let</span> cellc18 = network.AddCell None</span><br><span class="line">  <span class="keyword">let</span> cell32 = network.AddConstant <span class="number">32.</span></span><br><span class="line">  <span class="keyword">let</span> cellf = network.AddCell f</span><br><span class="line">  <span class="keyword">let</span> cellk = network.AddCell k</span><br><span class="line">  <span class="keyword">let</span> cell27315 = network.AddConstant <span class="number">273.15</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// F = C × 1.8 + 32 </span></span><br><span class="line">  multiplier cellc cell18 cellc18 |&gt; network.AddPropagator</span><br><span class="line">  adder cellc18 cell32 cellf |&gt; network.AddPropagator</span><br><span class="line">  <span class="comment">// C = K - 273.15</span></span><br><span class="line">  subtracter cellk cell27315 cellc |&gt; network.AddPropagator</span><br><span class="line"></span><br><span class="line">  network.Run()</span><br><span class="line">  (network.GetFloat cellc, network.GetFloat cellf, network.GetFloat cellk)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Kelvin conversions</span></span><br><span class="line">[ (Some <span class="number">20.</span>, None, None)</span><br><span class="line">  (None, Some <span class="number">80.</span>, None)</span><br><span class="line">  (None, None, Some <span class="number">200.</span>) ]</span><br><span class="line">|&gt; List.iter(<span class="keyword">fun</span> (c, f, k) -&gt;</span><br><span class="line">  <span class="keyword">match</span> (temperatureConverterCFK c f k) <span class="keyword">with</span></span><br><span class="line">  | Some(c), Some(f), Some(k) -&gt; printfn <span class="string">"%6.2fc = %6.2ff = %6.2fk"</span> c f k</span><br><span class="line">  | _ -&gt; printfn <span class="string">"Conversion undetermined"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Results:</span></span><br><span class="line"> <span class="number">20.00</span>c =  <span class="number">68.00</span>f = <span class="number">293.15</span>k</span><br><span class="line"> <span class="number">26.67</span>c =  <span class="number">80.00</span>f = <span class="number">299.82</span>k</span><br><span class="line"><span class="number">-73.15</span>c = <span class="number">-99.67</span>f = <span class="number">200.00</span>k</span><br></pre></td></tr></table></figure><h2 id="Estimating-Building-Height"><a href="#Estimating-Building-Height" class="headerlink" title="Estimating Building Height"></a>Estimating Building Height</h2><p>Moving beyond relatively simple conversions, there are more complicated data relationships that can be represented using propagator networks.  That leads to the second example, estimating the height of a building.  It specifically addresses the idea of imperfect information and how multiple sources of truth can improve the overall quality of knowledge.  Again, this is an example pulled from the reference papers.  It isn’t exact clone though, I provide a slightly different twist to show additional dynamics.</p><p>For the resourceful person, there is more than one way to estimate the height of a building.  Assuming I have a barometer at my disposal, I have encoded three possible methods below.  First, I can drop an object from the top of the building and time how long it takes to hit the ground.  The associated formula is <code>height = 0.5 * g * t^2</code>.  Second, leveraging the knowledge of similar triangles, I can measure the height and shadow of a small object setting beside the building as well as the building’s shadow. The associated formula is <code>buildingHeight / buildingShadow = smallHeight / smallShadow</code>.  Third, I can count the rows of windows and estimate the height of a floor.  The associated formula is <code>height = floors * floorHeight</code>.  These are all reasonable, but imprecise, estimation methods.  We’ll also find that the total is better than the sum of all parts.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Height - using fall duration and shadow length and floor count</span></span><br><span class="line"><span class="keyword">let</span> buildingHeight (fallTime: Interval option) (buildingShadow: Interval option) (barometerHeight: Interval option) (barometerShadow: Interval option) (floors: Interval option) (floorHeight: Interval option) =</span><br><span class="line">  <span class="keyword">let</span> buildingHeight = None</span><br><span class="line">  <span class="keyword">let</span> network = PropagatorNetwork()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Height based on fall time</span></span><br><span class="line">  <span class="comment">// Fall duration: d = 0.5 * g * t^2</span></span><br><span class="line">  <span class="keyword">let</span> fallTime = network.AddCell fallTime</span><br><span class="line">  <span class="keyword">let</span> two = network.AddConstant &#123; Interval.Min = Some <span class="number">2.</span>; Max = Some <span class="number">2.</span>&#125;</span><br><span class="line">  <span class="keyword">let</span> t2 = network.AddCell None</span><br><span class="line">  <span class="keyword">let</span> g = network.AddConstant &#123; Interval.Min = Some <span class="number">9.80665</span>; Max = Some <span class="number">9.80665</span> &#125;</span><br><span class="line">  <span class="keyword">let</span> gt2 = network.AddCell None</span><br><span class="line">  <span class="keyword">let</span> half = network.AddConstant &#123; Interval.Min = Some <span class="number">0.5</span>; Max = Some <span class="number">0.5</span> &#125;</span><br><span class="line">  <span class="keyword">let</span> buildingHeight = network.AddCell buildingHeight</span><br><span class="line">  </span><br><span class="line">  power fallTime two t2 |&gt; network.AddPropagator</span><br><span class="line">  multiplier g t2 gt2 |&gt; network.AddPropagator</span><br><span class="line">  multiplier half gt2 buildingHeight |&gt; network.AddPropagator</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Shadow</span></span><br><span class="line">  <span class="comment">// Similar triangles Shadow Ratio = Height / Shadow</span></span><br><span class="line">  <span class="keyword">let</span> barometerHeight = network.AddCell barometerHeight</span><br><span class="line">  <span class="keyword">let</span> barometerShadow = network.AddCell barometerShadow</span><br><span class="line">  <span class="keyword">let</span> buildingShadow = network.AddCell buildingShadow</span><br><span class="line">  <span class="keyword">let</span> shadowRatio = network.AddCell None</span><br><span class="line"></span><br><span class="line">  divider barometerHeight barometerShadow shadowRatio |&gt; network.AddPropagator</span><br><span class="line">  divider buildingHeight buildingShadow shadowRatio |&gt; network.AddPropagator</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Floors</span></span><br><span class="line">  <span class="keyword">let</span> floorCount = network.AddCell floors</span><br><span class="line">  <span class="keyword">let</span> floorHeight = network.AddCell floorHeight</span><br><span class="line">  </span><br><span class="line">  multiplier floorHeight floorCount buildingHeight |&gt; network.AddPropagator</span><br><span class="line"></span><br><span class="line">  network.Run()</span><br><span class="line">  </span><br><span class="line">  (network.GetInterval fallTime, network.GetInterval buildingHeight, network.GetInterval buildingShadow, network.GetInterval floorCount, network.GetInterval floorHeight)</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Create an in interval type</span></span><br><span class="line"><span class="keyword">let</span> interval (min: float option) (max: float option) =</span><br><span class="line">  Some &#123; Interval.Min = min; Max = max &#125;</span><br></pre></td></tr></table></figure><p>One thing about imprecise measurements is the need for a datatype that supports values with a margin of error.  Enter Interval, a built-in propagator library type.  Instead of using <code>float</code> for building height estimates, <code>Interval</code> provides a range of possible values per each measurement method.  This facilitates the storing of imperfect information.</p><p>In the first scenario, I have a barometer. I decide to drop the barometer from the top of the building and measure how long it takes to hit the ground.  Frankly this feels like a destructive method of measurement, but desperate times…  When measured, it takes about 4 seconds. But given that there is a natural delay when I start and stop the stopwatch, I assume I have a one second margin of error.  This translates to a possible interval of between 3.5 and 4.5 seconds.  With this knowledge I can feed that information in the <code>buildingHeight</code> function and find that the building is between 60 and 99 meters high.  The function supports additional inputs, but since I don’t have additional information those parts of the propagator network are non-impacting.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fallTime = interval (Some <span class="number">3.5</span>) (Some <span class="number">4.5</span>)</span><br><span class="line"><span class="keyword">let</span> (_, height', _, _, _) = buildingHeight fallTime None None None None None</span><br><span class="line">printfn <span class="string">"Only fall time...                Height (m): %O"</span> height'</span><br><span class="line"></span><br><span class="line"><span class="comment">// Result: </span></span><br><span class="line">Only fall time...                Height (m): Some([<span class="number">60.06573</span> .. <span class="number">99.29233</span>])</span><br></pre></td></tr></table></figure><p>In the second scenario I use the knowledge of similar triangles and ratios.  I can place the barometer on the ground beside the building and measure it’s shadow.  Since the sun’s angle is similar for the barometer and building, I can use that information along with the length of the building’s shadow to gain an estimate of the building’s height.  After some measurements it is determined that the barometer’s height and shadow are about 12.5cm and 24.5cm.  The building’s shadow is about 170.5m long.  Providing this additional information into the function I get a better estimate of the building’s height of between 81 and 92 meters high.  It looks like I’m making progress.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> buildingShadow = interval (Some <span class="number">170.0</span>) (Some <span class="number">171.0</span>)</span><br><span class="line"><span class="keyword">let</span> barometerHeight = interval (Some <span class="number">0.12</span>) (Some <span class="number">0.13</span>)</span><br><span class="line"><span class="keyword">let</span> barometerShadow = interval (Some <span class="number">0.24</span>) (Some <span class="number">0.25</span>)</span><br><span class="line"><span class="keyword">let</span> (_, height', _, _, _) = buildingHeight fallTime buildingShadow barometerHeight barometerShadow None None </span><br><span class="line">printfn <span class="string">"Fall time and shadow...          Height (m): %O"</span> height'</span><br><span class="line"></span><br><span class="line"><span class="comment">// Result: </span></span><br><span class="line">Fall time <span class="keyword">and</span> shadow...          Height (m): Some([<span class="number">81.6</span> .. <span class="number">92.625</span>])</span><br></pre></td></tr></table></figure><p>In the third scenario I can improve the estimate even more. I count the windows on the outside and determine it has 30 floors. I can also make an educated guess that each floor is about 3-3.5 meters high.  Using this third piece of information I can enhance the building’s height estimate even more to 90 to 92 meters high.  The power of multiple sources is magnified.  Using three different sources, all with their own margin of error, I can easily aggregate the results to reduce the overall margin of error.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> floors = interval (Some <span class="number">30.</span>) (Some <span class="number">30.</span>)</span><br><span class="line"><span class="keyword">let</span> floorHeight = interval (Some <span class="number">3.</span>) (Some <span class="number">3.5</span>)</span><br><span class="line"><span class="keyword">let</span> (_, height', _, _, _) = buildingHeight fallTime buildingShadow barometerHeight barometerShadow floors floorHeight</span><br><span class="line">printfn <span class="string">"Fall time, shadow, and floors... Height (m): %O"</span> height'</span><br><span class="line"></span><br><span class="line"><span class="comment">// Result:</span></span><br><span class="line">Fall time, shadow, <span class="keyword">and</span> floors... Height (m): Some([<span class="number">90</span> .. <span class="number">92.625</span>])</span><br></pre></td></tr></table></figure><p>Stepping back, it helps to visualize in more detail how these intervals work together.  Below are the results of each piece of knowledge by itself.  They all have varying amounts of accuracy, but as additional information is added to the model, the final estimate is improved.  </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Separate results:</span></span><br><span class="line">Only fall time...                Height (m): Some([<span class="number">60.06573</span> .. <span class="number">99.29233</span>])</span><br><span class="line">Only shadow...                   Height (m): Some([<span class="number">81.6</span> .. <span class="number">92.625</span>])</span><br><span class="line">Only floors...                   Height (m): Some([<span class="number">90</span> .. <span class="number">105</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">// Aggregated result:</span></span><br><span class="line">Fall time, shadow, <span class="keyword">and</span> floors... Height (m): Some([<span class="number">90</span> .. <span class="number">92.625</span>])</span><br></pre></td></tr></table></figure><p><img src="/images/prop1/aggregated-intervals.png" alt="Aggregated Intervals"></p><p>As a side note, this model contains the same type of dynamic relationships as the temperature conversion model.  Data flows in all directions.  Lets say for example I don’t feel good about a mental estimate of floor height, but I can still count windows.  If I run the function and exclude my floorHeight measurement, I won’t get a better building height estimate, but I can get an additional estimate that the floor height is between 2.7 and 3.1 meters.  With respect to knowledge aggregation, this is a nice attribute of propagator network models.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> (_, height', _, _, floorHeight') = buildingHeight fallTime buildingShadow barometerHeight barometerShadow floors None</span><br><span class="line">printfn <span class="string">"Building Height (m): %O"</span> height'</span><br><span class="line">printfn <span class="string">"Floor Height (m)   : %O"</span> floorHeight'</span><br><span class="line"></span><br><span class="line"><span class="comment">// Result:</span></span><br><span class="line">Building Height (m): Some([<span class="number">81.6</span> .. <span class="number">92.625</span>])</span><br><span class="line">Floor Height (m)   : Some([<span class="number">2.72</span> .. <span class="number">3.0875</span>])</span><br></pre></td></tr></table></figure><p>These two examples provide some insight into the dynamics of propagator networks.  I could go on, but I think this is a good break point.  As an introduction to the concept of propagator networks, I hope you’ve found this computation approach interesting.  If you want to dig in a bit more, additional references are below.  Until next time.</p><h2 id="References"><a href="#References" class="headerlink" title="References "></a>References <a name="references"></a></h2><ul><li><a href="/images/prop1/the_art_of_the_propagator.pdf">The Art of the Propagator</a></li><li><a href="/images/prop1/propagation_networks_thesis.pdf">Propagator Networks Thesis</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Propagator Networks are an interesting approach to computation.  Today I want to provide an introduction to the concept of propagators using &lt;a href=&quot;https://fsharp.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;F#&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
    
      <category term="F#" scheme="http://codesuji.com/tags/F/"/>
    
      <category term="FSharp" scheme="http://codesuji.com/tags/FSharp/"/>
    
      <category term="Propagator" scheme="http://codesuji.com/tags/Propagator/"/>
    
  </entry>
  
  <entry>
    <title>Web Scraping with F#</title>
    <link href="http://codesuji.com/2020/04/25/Web-Scraping-with-F/"/>
    <id>http://codesuji.com/2020/04/25/Web-Scraping-with-F/</id>
    <published>2020-04-26T03:09:13.000Z</published>
    <updated>2020-04-27T20:19:20.139Z</updated>
    
    <content type="html"><![CDATA[<p>Not surprisely, <a href="https://fsharp.org" target="_blank" rel="noopener">F#</a> is a useful tool for all sorts of random tasks, web scraping among them.  Today I’ll take a quick side-track and leverage <a href="https://fsharp.org" target="_blank" rel="noopener">F#</a> to web scrap some COVID-19 data and create some charts.</p><a id="more"></a><p>Pennsylvania provides daily COVID-19 stats on their website.  This is great, but there are charts I’d like to see that they don’t provide.  This is easy enough to resolve by doing my own data collection and charting; enter web scraping.  As anyone who has done it before, they know scraping data can sometimes be a messy and error-prone process.  Luckily <code>FSharp.Data</code> provides some useful HTML parsing capabilities to make this process easier.  I would also be remiss if I didn’t mention, <a href="https://github.com/tomswartz07/covid19-pennsylvania" target="_blank" rel="noopener">github.com/tomswartz07</a> inspired me to whip this little project together.  He uses Python, but I borrowed his data identification method, with a few F#-style improvements.  Ok, time to do some setup.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dotnet new console -lang F# -n Covid19</span><br><span class="line">cd Covid19 </span><br><span class="line">dotnet add package FSharp.Data</span><br><span class="line">dotnet add package XPlot.GoogleCharts --version 3.0.1</span><br></pre></td></tr></table></figure><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> System</span><br><span class="line"><span class="keyword">open</span> System.IO</span><br><span class="line"><span class="keyword">open</span> FSharp.Data</span><br><span class="line"><span class="keyword">open</span> XPlot.GoogleCharts</span><br></pre></td></tr></table></figure><p>As with most web scraping, this can be a touchy and/or dirty process.  Luckily in this particular case the data is relatively simple to parse.  I just need to grab the table rows <code>&lt;tr&gt;</code>.  I can then transform each row’s set of <code>&lt;td&gt;</code> into an array of strings.  After that I just need to filter to only the rows I want.  Again, I luck out with some pretty easy demarcation of the desired rows.  The page reports at the county level detail, but I only feel like tracking totals for the state.  As a result, I’ll do some some quick column level summing.  This will take the target webpage down to a timestamped row of data.  </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> getData () =</span><br><span class="line">  <span class="keyword">let</span> url = <span class="string">"https://www.health.pa.gov/topics/disease/coronavirus/Pages/Cases.aspx"</span></span><br><span class="line">  <span class="keyword">let</span> page = HtmlDocument.Load(url)</span><br><span class="line">  <span class="comment">// Note: target row format is: County,Positives,Negatives,Deaths</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> timestamp = DateTime.Now.ToString(<span class="string">"MM-dd"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> aggregatedStateData =</span><br><span class="line">    <span class="comment">// Grab the html rows</span></span><br><span class="line">    page.Descendants [<span class="string">"tr"</span>]</span><br><span class="line">    <span class="comment">// Transform data (convert each html row into an array)</span></span><br><span class="line">    |&gt; Seq.map (<span class="keyword">fun</span> htmlRow -&gt;</span><br><span class="line">      htmlRow.Descendants[<span class="string">"td"</span>]</span><br><span class="line">      |&gt; Seq.map (<span class="keyword">fun</span> x -&gt; x.InnerText())</span><br><span class="line">      |&gt; Seq.toArray)</span><br><span class="line">    <span class="comment">// Skip rows prior to the section I want</span></span><br><span class="line">    |&gt; Seq.skipWhile (<span class="keyword">fun</span> row -&gt; Array.isEmpty row || row.[<span class="number">0</span>] &lt;&gt; <span class="string">"County"</span>)</span><br><span class="line">    <span class="comment">// Take data from my section until I reach the next section</span></span><br><span class="line">    |&gt; Seq.takeWhile (<span class="keyword">fun</span> row -&gt; not (Array.isEmpty row) &amp;&amp; row.[<span class="number">0</span>] &lt;&gt; <span class="string">"Sex"</span>)</span><br><span class="line">    <span class="comment">// Skip section header</span></span><br><span class="line">    |&gt; Seq.skip <span class="number">1</span></span><br><span class="line">    <span class="comment">// Sum all county data into a singular state record </span></span><br><span class="line">    |&gt; Seq.map (<span class="keyword">fun</span> row -&gt; row.[<span class="number">1.</span><span class="number">.3</span>] |&gt; Array.map (<span class="keyword">fun</span> (x:String) -&gt; int(x.Replace(<span class="string">","</span>,<span class="string">""</span>))))</span><br><span class="line">    |&gt; Seq.fold (<span class="keyword">fun</span> a x -&gt; [| a.[<span class="number">0</span>] + x.[<span class="number">0</span>]; a.[<span class="number">1</span>] + x.[<span class="number">1</span>]; a.[<span class="number">2</span>] + x.[<span class="number">2</span>] |]) [|<span class="number">0</span>; <span class="number">0</span>; <span class="number">0</span>|]</span><br><span class="line">    <span class="comment">// Convert sequence to a csv string </span></span><br><span class="line">    |&gt; (<span class="keyword">fun</span> row -&gt;</span><br><span class="line">      row</span><br><span class="line">      |&gt; Array.map (<span class="keyword">fun</span> x -&gt; x.ToString())  </span><br><span class="line">      |&gt; String.concat <span class="string">","</span></span><br><span class="line">      |&gt; (<span class="keyword">fun</span> data -&gt; sprintf <span class="string">"%s,%s"</span> timestamp data))</span><br><span class="line"></span><br><span class="line">  (timestamp, aggregatedStateData)</span><br></pre></td></tr></table></figure><p>Once I have the data, I need to store it.  Since this is meant to be lightweight, I’ll just drop the data to a csv.  I want the script to be able to run multiple times a day, but I don’t want multiple date entries.  Using a <code>Map</code> keyed by timestamp is a simple solution.  More robust or performance sensitive solutions would call for at least something like <a href="/2017/07/28/F-and-SQLite/">SQLite</a>, but a csv is good enough for now.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> insertData dataFile =</span><br><span class="line">  <span class="keyword">let</span> (timestamp, todaysData) = getData()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update current state from file with new information</span></span><br><span class="line">  <span class="keyword">let</span> stateData' =</span><br><span class="line">    File.ReadAllLines(dataFile)</span><br><span class="line">    |&gt; Array.map (<span class="keyword">fun</span> x -&gt; (x.Split <span class="string">","</span>).[<span class="number">0</span>], x)</span><br><span class="line">    |&gt; Map.ofArray </span><br><span class="line">    |&gt; Map.add timestamp todaysData</span><br><span class="line">    |&gt; Map.toArray</span><br><span class="line">    |&gt; Array.map (<span class="keyword">fun</span> (k,v) -&gt; v)</span><br><span class="line">  </span><br><span class="line">  File.WriteAllLines(dataFile, stateData')</span><br></pre></td></tr></table></figure><p>Once the data is collected, I want to show some simple trending over time.  Granted, this has nothing to do with web scraping, but once I have the data I need to show a chart or two.  Again, F# offers a decent charting option for quick visualizations. </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> chartData dataFile =</span><br><span class="line">  <span class="keyword">let</span> data =</span><br><span class="line">    File.ReadAllLines(dataFile)</span><br><span class="line">    |&gt; Array.map (<span class="keyword">fun</span> row -&gt; row.Split <span class="string">","</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create series with timestamp and corresponding data</span></span><br><span class="line">  <span class="keyword">let</span> positives = data |&gt; Array.map (<span class="keyword">fun</span> row -&gt; (row.[<span class="number">0</span>], int row.[<span class="number">1</span>]))</span><br><span class="line">  <span class="keyword">let</span> negatives = data |&gt; Array.map (<span class="keyword">fun</span> row -&gt; (row.[<span class="number">0</span>], int row.[<span class="number">2</span>]))</span><br><span class="line">  <span class="keyword">let</span> deaths = data |&gt; Array.map (<span class="keyword">fun</span> row -&gt; (row.[<span class="number">0</span>], int row.[<span class="number">3</span>]))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> options =</span><br><span class="line">    Options (</span><br><span class="line">      title = <span class="string">"COVID19 - PA"</span>, </span><br><span class="line">      curveType = <span class="string">"function"</span>,</span><br><span class="line">      legend = Legend(position = <span class="string">"bottom"</span>),</span><br><span class="line">      vAxis = Axis(minValue = <span class="number">0</span>, viewWindow = ViewWindow(min = <span class="number">0</span>) ) )</span><br><span class="line">  </span><br><span class="line">  [positives; deaths]</span><br><span class="line">  |&gt; Chart.Line</span><br><span class="line">  |&gt; Chart.WithOptions options</span><br><span class="line">  |&gt; Chart.WithLabels [<span class="string">"Positives"</span>; <span class="string">"Deaths"</span>]</span><br><span class="line">  |&gt; Chart.WithSize (<span class="number">800</span>, <span class="number">400</span>)</span><br><span class="line">  |&gt; Chart.Show</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> printData () =</span><br><span class="line">  printfn <span class="string">"%A"</span> (getData())</span><br></pre></td></tr></table></figure><p>The final piece is providing some control to determine what functionality I want to perform.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[&lt;EntryPoint&gt;]</span></span><br><span class="line"><span class="keyword">let</span> main argv =</span><br><span class="line">  <span class="keyword">let</span> dataFile = <span class="string">"state.csv"</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> Array.isEmpty argv <span class="keyword">then</span></span><br><span class="line">    printfn <span class="string">"Missing argument [insert|print|chart]"</span></span><br><span class="line">    Environment.Exit <span class="number">1</span></span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">    <span class="keyword">match</span> argv.[<span class="number">0</span>] <span class="keyword">with</span></span><br><span class="line">    | <span class="string">"insert"</span> -&gt; insertData dataFile</span><br><span class="line">    | <span class="string">"print"</span> -&gt; printData ()</span><br><span class="line">    | <span class="string">"chart"</span> -&gt; chartData dataFile</span><br><span class="line">    | _ -&gt; printfn <span class="string">"Missing argument [insert|print|chart]"</span></span><br><span class="line">           Environment.Exit <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="number">0</span></span><br></pre></td></tr></table></figure><p>Below are resulting charts from the data.  The first is cummulative data over time.  The second is the daily increase in positive tests with a cummulative scaled positives overlayed.  As the second chart shows, in the beginning of April the daily increases level off (relatively good news, and perhaps a good sign). </p><p><img src="/images/web1/web1.png" alt="Trending"></p><p><img src="/images/web1/web2.png" alt="Daily Increase"></p><p>This has been a brief look into how F# can be used for some quick and dirty web scraping (and charting).  It isn’t real sexy, but hacking quick things like this together with F# is a useful tool to have in the toolbox.  Until next time.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Not surprisely, &lt;a href=&quot;https://fsharp.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;F#&lt;/a&gt; is a useful tool for all sorts of random tasks, web scraping among them.  Today I’ll take a quick side-track and leverage &lt;a href=&quot;https://fsharp.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;F#&lt;/a&gt; to web scrap some COVID-19 data and create some charts.&lt;/p&gt;
    
    </summary>
    
    
      <category term="F#" scheme="http://codesuji.com/tags/F/"/>
    
      <category term="FSharp" scheme="http://codesuji.com/tags/FSharp/"/>
    
      <category term="Web" scheme="http://codesuji.com/tags/Web/"/>
    
  </entry>
  
  <entry>
    <title>Introduction to F# Talk</title>
    <link href="http://codesuji.com/2020/03/17/Introduction-to-F-Talk/"/>
    <id>http://codesuji.com/2020/03/17/Introduction-to-F-Talk/</id>
    <published>2020-03-17T22:30:00.000Z</published>
    <updated>2020-03-11T23:54:04.498Z</updated>
    
    <content type="html"><![CDATA[<p>Recently I gave an Introduction to <a href="https://fsharp.org" target="_blank" rel="noopener">F#</a> talk at <a href="https://techlancaster.com/" target="_blank" rel="noopener">Tech Lancaster</a>.  Here are the <a href="/slides/introduction-to-fsharp/index.html">slides</a> from that talk.</p><a id="more"></a><br><center><a href="/slides/introduction-to-fsharp/index.html" class="fancybox"><img src="/images/intro1/intro1.png">Slides</a></center><br>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Recently I gave an Introduction to &lt;a href=&quot;https://fsharp.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;F#&lt;/a&gt; talk at &lt;a href=&quot;https://techlancaster.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Tech Lancaster&lt;/a&gt;.  Here are the &lt;a href=&quot;/slides/introduction-to-fsharp/index.html&quot;&gt;slides&lt;/a&gt; from that talk.&lt;/p&gt;
    
    </summary>
    
    
      <category term="F#" scheme="http://codesuji.com/tags/F/"/>
    
      <category term="FSharp" scheme="http://codesuji.com/tags/FSharp/"/>
    
      <category term="Presentations" scheme="http://codesuji.com/tags/Presentations/"/>
    
  </entry>
  
  <entry>
    <title>COVID-19 Educational Resources</title>
    <link href="http://codesuji.com/2020/03/14/Covid-19-Educational-Resources/"/>
    <id>http://codesuji.com/2020/03/14/Covid-19-Educational-Resources/</id>
    <published>2020-03-14T22:19:43.000Z</published>
    <updated>2020-07-24T23:47:58.694Z</updated>
    
    <content type="html"><![CDATA[<p>In these crazy times parents are looking for, among other things, good ways to occupy their childrens’ time in a wholesome fashion.  I didn’t want my childrens’ learning to just stop. To move the ball forward, at least a little, I have currated a list of education related resources to help in that process.  My goal was to find things that are in the spirit of fun and learning.  Nothing here is officially endorsed by me.  I only provide these links because our family has found them helpful, I hope you do to. Stay safe, stay sane.</p><a id="more"></a><h1 id="Biology"><a href="#Biology" class="headerlink" title="Biology"></a>Biology</h1><p><a href="https://m.facebook.com/ZooAmerica" target="_blank" rel="noopener">Zoo America</a> - Zoo America features an animal (11:00AM daily)</p><p><a href="https://www.facebook.com/cincinnatizoo/photos/a.96076385478/10158043842200479/?type=3&amp;theater" target="_blank" rel="noopener">Cincinnati Zoo</a> - Cincinnati Zoo features an animal (3:00PM daily)</p><p><a href="https://zoo.sandiegozoo.org/live-cams" target="_blank" rel="noopener">San Diego Zoo Live cams</a> - Animal cams </p><p><a href="https://www.zooniverse.org/organizations/meredithspalmer/snapshot-safari" target="_blank" rel="noopener">Snapshot Safari</a> - Crowdsourced projects to classify animals from nature cameras</p><h1 id="Art"><a href="#Art" class="headerlink" title="Art"></a>Art</h1><p><a href="https://www.kennedy-center.org/education/mo-willems/" target="_blank" rel="noopener">Lunch Doodles with Mo Willems</a> - A fun drawing time (1:00PM daily)</p><p><a href="https://www.youtube.com/studiojjk" target="_blank" rel="noopener">Draw every day with Jarett J. Krosoczka</a> - A fun drawing time</p><p><a href="https://musiclab.chromeexperiments.com" target="_blank" rel="noopener">Google Music Lab</a> - Fun little music lab</p><p><a href="https://www.travelandleisure.com/attractions/museums-galleries/museums-with-virtual-tours" target="_blank" rel="noopener">Virtual museum tours</a></p><p><a href="https://www.playbill.com/article/metropolitan-opera-after-shutting-its-doors-will-offer-free-streams-from-live-in-hd-catalog?fbclid=IwAR3L3irSQY8Fj3cf04agQQLsOgBtmmNMSUcY3HlT6VhReif7f551lTP4Ho8" target="_blank" rel="noopener">Metropolitan Opera</a> - Live performance every night from their catalog of recorded events. </p><p><a href="https://seattlesymphony.org/watch-listen/beyondthestage/live-broadcasts" target="_blank" rel="noopener">Seattle Symphony Orchestra</a> - Free live stream performances</p><h1 id="Geography"><a href="#Geography" class="headerlink" title="Geography"></a>Geography</h1><p><a href="https://locationestimatr.github.io/play/#world" target="_blank" rel="noopener">Location Estimater</a> - Guess the world location from Google-van images</p><p><a href="https://www.geoguessr.com/free" target="_blank" rel="noopener">GeoGuesser</a> - Guess the world location from Google-van images (nice, but kind of naggy)</p><h1 id="Language"><a href="#Language" class="headerlink" title="Language"></a>Language</h1><p><a href="https://www.duolingo.com/" target="_blank" rel="noopener">Duolingo</a> - Learn or practice another language</p><p><a href="http://www.hellochinese.cc/" target="_blank" rel="noopener">Hello Chinese</a> - Learn Chinese</p><p><a href="https://stories.audible.com/start-listen" target="_blank" rel="noopener">Audible</a> - Audible provides a selection of free kids books</p><p><a href="https://www.storylineonline.net/" target="_blank" rel="noopener">StorylineOnline</a> - World’s best storytellers reading books aloud. Each video includes an activity guide with lessons for K-5 students </p><p><a href="https://www.weareteachers.com/math-card-games/" target="_blank" rel="noopener">We Are Teachers</a> - Math card games</p><h1 id="Educational-Games"><a href="#Educational-Games" class="headerlink" title="Educational Games"></a>Educational Games</h1><p><a href="https://educators.brainpop.com/2020/02/19/free-brainpop-access-for-schools-affected-by-the-corona-virus" target="_blank" rel="noopener">Brain Pop</a></p><p><a href="https://kahoot.com/blog/2020/02/27/kahoot-free-access-schools-higher-education-coronavirus/" target="_blank" rel="noopener">Kahoot</a></p><p><a href="https://online.seterra.com/en/p/corona-support" target="_blank" rel="noopener">Seterra Geography</a></p><p><a href="https://mysteryscience.com/" target="_blank" rel="noopener">Mystery Science</a></p><h1 id="Science"><a href="#Science" class="headerlink" title="Science"></a>Science</h1><p><a href="https://www.skypeascientist.com" target="_blank" rel="noopener">Skype a Scientist</a> - Scientists cover wide variety of topics</p><h1 id="Activities"><a href="#Activities" class="headerlink" title="Activities"></a>Activities</h1><p><a href="http://www.scholastic.com/learnathome" target="_blank" rel="noopener">Scholastic Daily</a> - Activities/Articles/Videos</p><p><a href="https://www.discoveryeducation.com/details/5-ways-discovery-education-experience-supports-virtual-learning/" target="_blank" rel="noopener">Discovery Education</a> - Daily activies for kids</p><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><p><a href="https://lancasterpubliclibrary.org/social-distancing-during-covid-19/" target="_blank" rel="noopener">Lancaster Library Links</a> - A nice list of more links</p><p><a href="https://kidsactivitiesblog.com/135609/list-of-education-companies-offering-free-subscriptions/" target="_blank" rel="noopener">Free Subscriptions</a> - Education companies offering free subscriptions during COVID-19</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;In these crazy times parents are looking for, among other things, good ways to occupy their childrens’ time in a wholesome fashion.  I didn’t want my childrens’ learning to just stop. To move the ball forward, at least a little, I have currated a list of education related resources to help in that process.  My goal was to find things that are in the spirit of fun and learning.  Nothing here is officially endorsed by me.  I only provide these links because our family has found them helpful, I hope you do to. Stay safe, stay sane.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Education" scheme="http://codesuji.com/tags/Education/"/>
    
  </entry>
  
  <entry>
    <title>Containerizing F# with Docker</title>
    <link href="http://codesuji.com/2020/03/08/F-and-Docker/"/>
    <id>http://codesuji.com/2020/03/08/F-and-Docker/</id>
    <published>2020-03-08T14:09:22.000Z</published>
    <updated>2020-03-08T15:19:11.339Z</updated>
    
    <content type="html"><![CDATA[<p>Containerizing an <a href="https://fsharp.org" target="_blank" rel="noopener">F#</a> application using <a href="https://www.docker.com/" target="_blank" rel="noopener">Docker</a> is a fairly straight forward process.  Today we’ll take a look at doing just that.</p><a id="more"></a><p>This post will cover putting different types of F# applications in Docker containers.  If you want to follow along, you’ll need to get a couple things.  You’ll need to install <a href="https://www.docker.com/" target="_blank" rel="noopener">Docker</a> and <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core</a>.  As of right now, dotnet core is at 3.1, so that will be the target version.</p><p>The process follows a common pattern, although there is some divergence based on the specific use case.  This can eaily be shown using two examples.  The first example is a console app in Docker.  It won’t do much, since I don’t want to distract from the core docker implementation.  The second example is putting a web app in Docker.  This example is more involved for a couple reasons, as you’ll see below.</p><h3 id="Dockerizing-a-console-application"><a href="#Dockerizing-a-console-application" class="headerlink" title="Dockerizing a console application"></a>Dockerizing a console application</h3><p>First, create the application.  This is a standard process for any F# application.  As promised, it will be about as boring an application as possible.  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dotnet new console -lang F# -n SampleConsole</span><br><span class="line">cd SampleConsole</span><br></pre></td></tr></table></figure><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> System</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;EntryPoint&gt;]</span></span><br><span class="line"><span class="keyword">let</span> main argv =</span><br><span class="line">  printfn <span class="string">"Hello from F# in Docker."</span></span><br><span class="line">  <span class="number">0</span></span><br></pre></td></tr></table></figure><p>Once the application is in place, it’s time to add the docker components.  In the SampleConsole directory I’ll add a <code>Dockerfile</code> for the build and <code>.dockerignore</code> to excluded files.  The <code>.dockerignore</code> isn’t strictly necessary, but it does keep the container cleaner. Using a multi-stage Dockerfile makes the implementation pretty easy.  Since Microsoft provides dotnet core images, I leverage those.  The sdk one for building, and the runtime one for final execution.  To containerize the application, copy the application source into /src.  Then build from /src into /app. Then run out of /app.  The alpine flavor is used to keep the image smaller.  There is a non-alpine version (just remove the “-alpine” from the image names) if that is so desired.  In some ways this process is anti-climatic, there isn’t much here, but that is kind of the point.  Sometimes it is nice when things just work.</p><p>Dockerfile<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FROM mcr.microsoft.com/dotnet/core/sdk:3.1-alpine AS build</span><br><span class="line"></span><br><span class="line"># build application </span><br><span class="line">WORKDIR /src</span><br><span class="line">COPY . .</span><br><span class="line">RUN dotnet restore</span><br><span class="line">RUN dotnet publish -c release -o /app --no-self-contained --no-restore</span><br><span class="line"></span><br><span class="line"># final stage/image</span><br><span class="line">FROM mcr.microsoft.com/dotnet/core/runtime:3.1-alpine</span><br><span class="line"></span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY --from=build /app .</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;./SampleConsole&quot;]</span><br></pre></td></tr></table></figure></p><p>.dockerignore<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin</span><br><span class="line">obj</span><br><span class="line">Dockerfile</span><br></pre></td></tr></table></figure></p><p>At this point, the only thing left to do is build and run the application.  The output is relatively uninspiring, but at least it is a good first step to doing something slightly more interesting.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t sample-console .</span><br><span class="line">docker run sample-console</span><br></pre></td></tr></table></figure><p><img src="/images/docker1/docker1-console.png" alt="Sample Console Results"></p><h3 id="Dockerizing-a-web-application"><a href="#Dockerizing-a-web-application" class="headerlink" title="Dockerizing a web application"></a>Dockerizing a web application</h3><p>Entering the second part of the post, putting an F# web application in a container.  Much of the above still applies, but considering the way of web apps, it needs to be different.  The first is initializing the app.  There are several good dotnet core templates to choose from, but I’m going to specifically use <a href="https://github.com/giraffe-fsharp/Giraffe" target="_blank" rel="noopener">Giraffe</a>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dotnet new giraffe -lang F# -n SampleWeb </span><br><span class="line">cd SampleWeb</span><br></pre></td></tr></table></figure><p>This is where a little surgery takes place.  Like the above example, I want to use dotnet core 3.1, but the Giraffe template is for v2.1.  I’ll need to tweak a couple parts to get it to work together.  I’ll break them down by file.  Here are the <strong>SampleWeb.fsproj</strong> modifications.  Half of this is obvious, the slightly less obvious is the certificate.json reference, this will be used for Kestrel configuration later.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  &lt;PropertyGroup&gt;</span><br><span class="line">    &lt;!-- Change from netcoreapp version from <span class="number">2.1</span> <span class="keyword">to</span> <span class="number">3.1</span> --&gt;</span><br><span class="line">    &lt;TargetFramework&gt;netcoreapp3<span class="number">.1</span>&lt;/TargetFramework&gt;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/PropertyGroup&gt;</span><br><span class="line">  ...</span><br><span class="line">  &lt;ItemGroup&gt;</span><br><span class="line">    &lt;!-- Remove PackageReference Include=<span class="string">"Microsoft.AspNetCore.App"</span> Version=<span class="string">"2.1.*"</span> --&gt;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/ItemGroup&gt;</span><br><span class="line">  ... </span><br><span class="line">  &lt;ItemGroup&gt;</span><br><span class="line">    &lt;!-- Add certificate configuration --&gt;</span><br><span class="line">    &lt;None Include=<span class="string">"certificate.json"</span> CopyToOutputDirectory=<span class="string">"PreserveNewest"</span> /&gt;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/ItemGroup&gt;</span><br><span class="line">&lt;/Project&gt;</span><br></pre></td></tr></table></figure><p>Here are the <strong>web.config</strong> modifications.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">  &lt;system.webServer&gt;</span><br><span class="line">    &lt;handlers&gt;</span><br><span class="line">      &lt;!-- Change AspNetCoreModule <span class="keyword">to</span> AspNetCoreModuleV2 --&gt;</span><br><span class="line">      &lt;add name=<span class="string">"aspNetCore"</span> path=<span class="string">"*"</span> verb=<span class="string">"*"</span> modules=<span class="string">"AspNetCoreModuleV2"</span> resourceType=<span class="string">"Unspecified"</span> /&gt;</span><br><span class="line">    &lt;/handlers&gt;</span><br><span class="line">    &lt;aspNetCore processPath=<span class="string">"dotnet"</span> arguments=<span class="string">"SampleWeb.dll"</span> stdoutLogEnabled=<span class="string">"false"</span> stdoutLogFile=<span class="string">"logs/stdout"</span> /&gt;</span><br><span class="line">  &lt;/system.webServer&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><p>Here are the <strong>Program.fs</strong> modifications.  For the most part the web app stays intact, but there are two specific parts to call out.  <code>IHostingEnvironment</code> works, but is deprecated.  As a result I’ll refactor to use <code>IWebHostEnvironment</code>. It removes a warning and future-proofs things a bit.  The big thing is Kestrel configuration.  The slightly short version is that the Kestrel changes are not required if running the application outside of Docker.  But, since the target is Docker, I ran into some complications.  I need to explicitly configure Kestrel so it runs https properly while in the container.  To do this I add a configuration step, using a certificate.json.  I then use that to create a certificate object that can be used in Kestrel configuration.  I’ll run http over 5000 and https over 5001; this will be useful information in a later step.  </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> System.Security.Cryptography.X509Certificates</span><br><span class="line"><span class="keyword">open</span> Microsoft.Extensions.Configuration</span><br><span class="line"><span class="keyword">open</span> Microsoft.Extensions.Hosting</span><br><span class="line"><span class="keyword">open</span> Microsoft.AspNetCore.Server.Kestrel.Core</span><br><span class="line">...</span><br><span class="line"><span class="keyword">let</span> configureApp (app: IApplicationBuilder) =</span><br><span class="line">  <span class="comment">// Former: let env = app.ApplicationServices.GetService&lt;IHostingEnvironment&gt;()</span></span><br><span class="line">  <span class="keyword">let</span> env = app.ApplicationServices.GetService&lt;IWebHostEnvironment&gt;()</span><br><span class="line">...</span><br><span class="line"><span class="keyword">let</span> configureAppConfiguration (config: IConfigurationBuilder) =</span><br><span class="line">  config.AddJsonFile(<span class="string">"/https/certificate.json"</span>) |&gt; ignore</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> configureKestrel (context: WebHostBuilderContext) (options: KestrelServerOptions) =</span><br><span class="line">  <span class="keyword">let</span> certificatePath = context.Configuration.GetSection(<span class="string">"certificate"</span>).GetValue&lt;string&gt;(<span class="string">"Path"</span>)</span><br><span class="line">  <span class="keyword">let</span> certificatePassword = context.Configuration.GetSection(<span class="string">"certificate"</span>).GetValue&lt;string&gt;(<span class="string">"Password"</span>)</span><br><span class="line">  <span class="keyword">let</span> certificate = <span class="keyword">new</span> X509Certificate2(certificatePath, certificatePassword)</span><br><span class="line">  options.ListenAnyIP(<span class="number">5000</span>)</span><br><span class="line">  options.ListenAnyIP(<span class="number">5001</span>, <span class="keyword">fun</span> options -&gt; options.UseHttps certificate |&gt; ignore)</span><br><span class="line">...</span><br><span class="line">WebHostBuilder()</span><br><span class="line">    .ConfigureAppConfiguration(configureAppConfiguration)</span><br><span class="line">    .UseKestrel(Action&lt;WebHostBuilderContext,KestrelServerOptions&gt; configureKestrel)</span><br><span class="line">...</span><br><span class="line">    .Build()</span><br><span class="line">    .Run()</span><br></pre></td></tr></table></figure><p>Now to add the supporting <strong>certificate.json</strong> file.  Here I show a good and a bad practice.  First the good, by creating the configuration file and certificate outside of the project, I won’t include secrets in the image itself.  Second the bad, “password” is not a good certificate password.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;Certificate&quot;: &#123;</span><br><span class="line">    &quot;Path&quot;: &quot;/https/SampleWeb.pfx&quot;,</span><br><span class="line">    &quot;Password&quot;: &quot;password&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>One last piece is needed for ssl support.  Normally production would have a proper cert, but since this just dev I’ll export my dotnet dev cert and use that for my Docker instance.  Below is how to export the cert.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet dev-certs https -ep ~/.aspnet/https/SampleWeb.pfx -p password</span><br></pre></td></tr></table></figure><p>Now that the necessary changes are in place, it’s time to do the containerization part.  In the SampleWeb directory I’ll add <code>Dockerfile</code> and <code>.dockerignore</code> files.  As before, the <code>Dockerfile</code> implements the application build as well as final packaging of the application using alpine.  You may note that the final stage here uses <code>aspnet-3.1-alpine</code>, where the previous version was <code>runtime-3.1-alpine</code>.</p><p>Dockerfile<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FROM mcr.microsoft.com/dotnet/core/sdk:3.1-alpine AS build</span><br><span class="line"></span><br><span class="line">WORKDIR /src</span><br><span class="line">COPY src/SampleWeb/. .</span><br><span class="line">RUN dotnet restore</span><br><span class="line">RUN dotnet publish -c release -o /app --no-self-contained --no-restore</span><br><span class="line"></span><br><span class="line"># create final image</span><br><span class="line">FROM mcr.microsoft.com/dotnet/core/aspnet:3.1-alpine</span><br><span class="line"></span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY --from=build /app ./</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;./SampleWeb&quot;]</span><br></pre></td></tr></table></figure></p><p>.dockerignore</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin</span><br><span class="line">obj</span><br><span class="line">Dockerfile</span><br></pre></td></tr></table></figure><p>At this point, the only thing left to do is build and run the application.  Since this is a web server, I’ll need to map the necessary ports.  I also map the directory containing certificate.json and SampleWeb.pfx into the container.  I will note a specific omission for a real-world implementation.  Kestrel can now be used as an edge server, although my preference is to put it behind a reverse proxy like <a href="https://www.nginx.com/" target="_blank" rel="noopener">nginx</a>.  That topic is beyond the scope of this post.  At least in the current configuration http and https can be tested locally.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t sample-web .</span><br><span class="line">docker run -p 5000:5000 -p 5001:5001 -v $&#123;HOME&#125;/.aspnet/https:/https/ sample-web</span><br></pre></td></tr></table></figure><p><img src="/images/docker1/docker1-web.png" alt="Sample Web Results"></p><p>This has been a brief look into how Docker can be leveraged with F#.  This is only the begining of what can be done, so hopefully you can use this as a jumping point for your projects. Until next time.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Containerizing an &lt;a href=&quot;https://fsharp.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;F#&lt;/a&gt; application using &lt;a href=&quot;https://www.docker.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Docker&lt;/a&gt; is a fairly straight forward process.  Today we’ll take a look at doing just that.&lt;/p&gt;
    
    </summary>
    
    
      <category term="F#" scheme="http://codesuji.com/tags/F/"/>
    
      <category term="FSharp" scheme="http://codesuji.com/tags/FSharp/"/>
    
      <category term="Docker" scheme="http://codesuji.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>Preonic V3 Build</title>
    <link href="http://codesuji.com/2020/01/25/Preonic-V3/"/>
    <id>http://codesuji.com/2020/01/25/Preonic-V3/</id>
    <published>2020-01-25T11:43:12.000Z</published>
    <updated>2020-04-30T02:25:00.512Z</updated>
    
    <content type="html"><![CDATA[<p>Today I wanted to talk about my new Preonic V3 from <a href="https://olkb.com" target="_blank" rel="noopener">OKLB</a> from <a href="https://drop.com" target="_blank" rel="noopener">Drop</a>.  I know by now I have a problem, but I just couldn’t pass up the opportunity.  I can only assume a future apocalypse will be survived by a plethora of keyboards.</p><a id="more"></a><p>Here is the final result, equipped with Kalih Box Black switches.  After hand-wiring my last <a href="/2019/11/02/Handwired-Preonic/">keyboard</a>, putting together this beauty almost feels like cheating.  The no-solder sockets make this an easy afternoon project.  With that said, I did bend a couple pins the first couple times I was assembling the switches, so it isn’t a fool-proof method.  The lesson is don’t go blindly jamming the switches in, assuming they’ll just work.  You do need to expend a little effort to get it right.  Regarding the box switches, the wobble of other switches has never really bothered me, but I wanted to give the box switches a try.  They do have a nice feel to them.  I’ve also grown fond of my current layout,  so I just copied it into a new QMK profile based on the Preonic V3 firmware.  Overall, as expected, it has been an enjoyable keyboard to assemble and use.</p><p>Beyond the stock keyboard build there are a couple custom components.  The caps they shipped were nice, but I already had in mind a slightly different look.</p><p><img src="/images/preonic2/preonic-final.jpg" alt="Preonic - final result"></p><p>As a bonus, I’ve included a couple build process images.  I ended up with a damaged switch from shipping, luckily I had a spare Speed Silver laying around.</p><p><img src="/images/preonic2/preonic-top.jpg" alt="Preonic - Switches "></p><p><img src="/images/preonic2/preonic-bottom.jpg" alt="Preonic - Bottom"></p><p><img src="/images/preonic2/preonic-assembling.jpg" alt="Preonic - Assembling"></p><p><img src="/images/preonic2/preonic-switches.jpg" alt="Preonic - Switches"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Today I wanted to talk about my new Preonic V3 from &lt;a href=&quot;https://olkb.com&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;OKLB&lt;/a&gt; from &lt;a href=&quot;https://drop.com&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Drop&lt;/a&gt;.  I know by now I have a problem, but I just couldn’t pass up the opportunity.  I can only assume a future apocalypse will be survived by a plethora of keyboards.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Keyboard" scheme="http://codesuji.com/tags/Keyboard/"/>
    
  </entry>
  
  <entry>
    <title>Examing Entropy with F#</title>
    <link href="http://codesuji.com/2019/12/21/F-Entropy/"/>
    <id>http://codesuji.com/2019/12/21/F-Entropy/</id>
    <published>2019-12-21T22:09:22.000Z</published>
    <updated>2020-04-23T02:28:24.258Z</updated>
    
    <content type="html"><![CDATA[<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><p>Measuring entropy can be a useful heuristic when performing analysis.  This is a short introduction into performing entropy analysis on binary and text files using <a href="https://fsharp.org" target="_blank" rel="noopener">F#</a>.</p><a id="more"></a><p>What can entropy based analysis be used for? One specific use case is searching for secret keys in files.  In particular, scanning for hardcoded secrets or passwords that are accidently committed to git.  Scanning tools can be used to catch these kinds of issues.  Another use case is scanning binaries for reverse engineering purposes.  It is an interesting exercise to see what goes on behind the scenes with these types of tools.  The ability to scan successfully is predicated on the keys being blocks of random characters (a fair assumption for good passwords).  The randomness can be extracted from code files that have a certain level of predictability.  At the core of this process is Information Theory, namely <a href="https://en.wikipedia.org/wiki/Entropy_%28information_theory%29" target="_blank" rel="noopener">Shannon Entropy</a>. If you want to follow along, you’ll need to get <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core</a> installed.  For visualizations, XPlot will provide the necessary functionality. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dotnet new console -lang F# -n Entropy</span><br><span class="line">cd Entropy</span><br><span class="line">dotnet add package XPlot.GoogleCharts --version 3.0.1</span><br></pre></td></tr></table></figure><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> System</span><br><span class="line"><span class="keyword">open</span> System.IO</span><br><span class="line"><span class="keyword">open</span> XPlot.GoogleCharts</span><br></pre></td></tr></table></figure><p>$$ {H = - \sum^N_{i=1}p_i \log p_i} $$</p><p>The above equation is our starting point, where p<sub>i</sub> is the probability of seeing a particular character.  Implementation of the Shannon Entropy calculation is deceptively simple.  First, take a byte array and count the frequency of each byte value.  Second, sum the probabilities of seeing each byte in the byte array times the Log of the respective probability.  Here is where I diverge from the typical implementation.  Discussion often focuses on Log<sub>2</sub>, since so many instances focus on bits.  I prefer to work with a normalized value.  For 256 possible values I use Log<sub>256</sub> to scale between 0 and 1, where 0 is no entropy and 1 is high entropy. </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> NormalizedEntropy (data: byte[]) =</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mutable</span> frequency = Array.create <span class="number">256</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Populate byte frequencies</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> .. (data.Length - <span class="number">1</span>) <span class="keyword">do</span> </span><br><span class="line">    <span class="keyword">let</span> newByte = int data.[i]</span><br><span class="line">    frequency.[newByte] &lt;- frequency.[newByte] + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Calculate entropy based on character frequencies</span></span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mutable</span> entropy = <span class="number">0.</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> .. <span class="number">255</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">let</span> probX = (float frequency.[i]) / (float data.Length)</span><br><span class="line">    <span class="keyword">if</span> probX &gt; <span class="number">0.</span> <span class="keyword">then</span> entropy &lt;- entropy - (probX * Math.Log(probX, <span class="number">256.</span>))</span><br><span class="line">  </span><br><span class="line">  entropy</span><br></pre></td></tr></table></figure><p>Since one of the possible uses of entropy analysis is checking files for secrets, a simple example is looking at <code>Program.fs</code>.  For comparison I copied the file and added a couple random passwords.  Taking it a step further, I generated a <code>fake.pem</code> just to demonstrate how the entropy of code differs from pem files (something else that might want to be scanned for in code repos).</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[ <span class="string">"Program.fs"</span> </span><br><span class="line">  <span class="string">"Program-Secret.fs"</span> </span><br><span class="line">  <span class="string">"fake.pem"</span> ]</span><br><span class="line">  |&gt; List.iter (<span class="keyword">fun</span> filename -&gt;</span><br><span class="line">    <span class="keyword">let</span> bytes = File.ReadAllBytes(filename)</span><br><span class="line">    <span class="keyword">let</span> e = NormalizedEntropy bytes</span><br><span class="line">    printfn <span class="string">"%20s - %3.2f"</span> filename e)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>As the results show below, putting some randomized strings (like secret keys or passwords) in a code file increases it’s entropy.  For comparison, the pem file is noticeably higher.  Although this is interesting, it has its limitations for any type of real scanning.  Perhaps I could scan all my code files to see if there is a typical range and use that to find anomalies, but I have a better idea.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">       Program.fs - 0.60</span><br><span class="line">Program-Secret.fs - 0.63</span><br><span class="line">         fake.pem - 0.75</span><br></pre></td></tr></table></figure><p>Details can be lost by looking at a file as a whole.  Another approach is to using a sliding window through the file.  Additionally leverage a threshold to show any blocks of the the file that have a high entropy.  A little refactoring for readability, the entropy calculation is broken out.  Then a sliding window is applied against the file.  Whenever a window is above the entropy threshold, show that block (at least the printable characters).  To cut down on excessive printing, don’t show overlapping windows.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Given a frequency array, calculate normalized entropy for a specified window size</span></span><br><span class="line"><span class="keyword">let</span> windowNormalizedEntropy (windowSize: int) (frequency: int[])=</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mutable</span> entropy = <span class="number">0.</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> .. <span class="number">255</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">let</span> probX = (float frequency.[i]) / (float windowSize)</span><br><span class="line">    <span class="keyword">if</span> probX &gt; <span class="number">0.</span> <span class="keyword">then</span> entropy &lt;- entropy - (probX * Math.Log(probX, <span class="number">256.</span>))</span><br><span class="line">  entropy</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Normalized entropy using a rolling window</span></span><br><span class="line"><span class="keyword">let</span> NormalizedEntropyWindowShow (windowSize: int) (threshold: float) (data: byte[]) =</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mutable</span> frequency = Array.create <span class="number">256</span> <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mutable</span> lastPrintedPosition = <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> position <span class="keyword">in</span> <span class="number">0</span> .. (data.Length - windowSize - <span class="number">1</span>) <span class="keyword">do</span></span><br><span class="line">    <span class="comment">// Add new byte to window</span></span><br><span class="line">    <span class="keyword">let</span> newByte = int data.[position + windowSize]</span><br><span class="line">    frequency.[newByte] &lt;- frequency.[newByte] + <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> position &gt;= windowSize <span class="keyword">then</span> </span><br><span class="line">      <span class="comment">// Roll off old byte from window </span></span><br><span class="line">      <span class="keyword">let</span> currentByte = int data.[position]</span><br><span class="line">      frequency.[currentByte] &lt;- frequency.[currentByte] - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Calculate entropy </span></span><br><span class="line">      <span class="keyword">let</span> entropy = windowNormalizedEntropy windowSize frequency</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Show high entropy block (if I haven't shown part already)</span></span><br><span class="line">      <span class="keyword">if</span> entropy &gt;= threshold &amp;&amp; (position &gt; lastPrintedPosition) <span class="keyword">then</span></span><br><span class="line">        lastPrintedPosition &lt;- position + windowSize - <span class="number">1</span></span><br><span class="line">        <span class="keyword">let</span> nonPrintable = RegularExpressions.Regex(<span class="string">"[^ -~]"</span>)</span><br><span class="line">        <span class="keyword">let</span> slice = data.[position..(position + windowSize - <span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">let</span> s = nonPrintable.Replace(Encoding.ASCII.GetString (slice), <span class="string">"?"</span>)</span><br><span class="line">        printfn <span class="string">"%6d %6.5f %s"</span> position entropy s</span><br></pre></td></tr></table></figure><p>The file can then be evaluated by providing a window size and threshold.  A window size of 50 bytes and threshold of 0.58 are mostly arbitrary, but some experimentation show these seem to get a reasonable result.  I can now run the analysis against a code file with secrets and the pem file.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ <span class="string">"Program-Secret.fs"</span> </span><br><span class="line">  <span class="string">"fake.pem"</span> ]</span><br><span class="line">|&gt; List.iter (<span class="keyword">fun</span> filename -&gt;</span><br><span class="line">  printfn <span class="string">"File: %s"</span> filename</span><br><span class="line">  <span class="keyword">let</span> bytes = File.ReadAllBytes(filename)</span><br><span class="line">  NormalizedEntropyWindowShow <span class="number">50</span> <span class="number">0.58</span> bytes)</span><br></pre></td></tr></table></figure><p>The results provide a bit more insight than before.  The entire pem file is captured (as expected).  For the code file, not all things caught are secrets.  Natural codeblocks get caught up in the process, and that’s fine.  This is about finding possibly areas of concern, and that goal is accomplished.  This is useful approach, but not perfect.  There are still gaps that can be closed to make it a more robust solution.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">File: Program-Secret.fs</span><br><span class="line">   151 0.58482 &quot;?  |&gt; printfn &quot;%s&quot;??// let keyToFind = &quot;ABCKEDIEM</span><br><span class="line">   201 0.63482 WPFHEIK1238UIMQ890PoqEgfh&quot;??/// Normalized entropy</span><br><span class="line">  1070 0.58105 bX * Math.Log(probX, 256.))?  entropy??/// Normali</span><br><span class="line">  1850 0.58105 rintable = Text.RegularExpressions.Regex(&quot;[^ -~]&quot;)</span><br><span class="line">  2830 0.58391 ?[&lt;EntryPoint&gt;]?let main argv =?  // 94kmnhdnbi*IE</span><br><span class="line">  2880 0.66548 JDMSKQL098123456hjqwemn,.&lt;&gt;/;&apos;:&apos;,.mnbvcxzasdfghjkl</span><br><span class="line">  2930 0.70548 ;&apos;][poiuytrewq1234567890-=+_)(*&amp;^%$#@!QWERTYUIOP&#123;&#125;</span><br><span class="line">  2980 0.63635 |&quot;:LKJHGFDSAZXCVBNM&lt;&gt;?*))]?  ?    // (Text.Encodin</span><br><span class="line">File: fake.pem</span><br><span class="line">    50 0.61793 04w4NMK0Ak5XVR1XR/TX/YGcj6z91Zd8j3K+0Q8SZKa9n8?QIu</span><br><span class="line">   100 0.62482 0URxz/CT5I4SeS746vd1bPpcSXy0rHvLMz0UxtIxlEOuCHAoed</span><br><span class="line">   150 0.60982 eDzKv4zr+MJ?/FCrKRazzAFv2/klBi3bRfW4UseYPeVs43ahRF</span><br><span class="line">   200 0.62293 O/gugc11n8drzlQq3BqkwJCTAx?uj+ZqG5QI6C8x8uooOvs0xk</span><br><span class="line">   ...</span><br><span class="line">  1450 0.63048 xjaxX+GIqEK?TM0T8QKBgCN83f96A39Qf5WGlJuY5EAsLWi+eu</span><br><span class="line">  1500 0.63048 0BO/We7heP1Op74XidcWucKaRb?t0+cNjkcnYgziBPj8TxAzMh</span><br><span class="line">  1550 0.63671 ueHJIB+TRAOqxQXPuYj+15O2PudrgMrKkRFC0lG90?3rOiKJCY</span><br><span class="line">  1600 0.63146 4g578SCKRNF0/xiMlXe9+DzfBCStzFirsI2Bq7tcrTmw?-----</span><br></pre></td></tr></table></figure><p>One question that remains is what are ideal values for window size and threshold that maximize finding secrets while minimizing false positives.  One of the impacting factors for this is different languages have their own characteristics, impacting the best parameters.  Beyond static parameters, statistical methods can be used to determine anomalies and parameters for a file, providing a more dynamic approach.  In the spirit of investigating different angles, I ran analysis against some of my repos (using a window size of 50).  My code generally has a range, but it appears some scanning refinement can be accomplished by taking file type into account. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.c  : 0.530</span><br><span class="line">.cl : 0.477</span><br><span class="line">.cpp: 0.490</span><br><span class="line">.cs : 0.486</span><br><span class="line">.fs : 0.502</span><br><span class="line">.fsx: 0.500</span><br><span class="line">.hs : 0.513</span><br><span class="line">.js : 0.492</span><br><span class="line">.pl : 0.540</span><br><span class="line">.ps1: 0.503</span><br><span class="line">.py : 0.490</span><br><span class="line">.r  : 0.516</span><br><span class="line">.rkt: 0.475</span><br><span class="line">.sh : 0.540</span><br><span class="line">.ts : 0.520</span><br></pre></td></tr></table></figure><p>Because there are multiple ways to look at the data, it is time to go a bit more visual.  The below adaptation returns a by-sliding-window entropy array.  This array is then fed into a charting function.  A chart provides a nice visual representation of the entropy over the entire file. </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Normalized entropy using a rolling window</span></span><br><span class="line"><span class="keyword">let</span> NormalizedEntropyWindow (windowSize: int) (data: byte[]) =</span><br><span class="line">  <span class="keyword">let</span> <span class="keyword">mutable</span> frequency = Array.create <span class="number">256</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  [| </span><br><span class="line">    <span class="keyword">for</span> position <span class="keyword">in</span> <span class="number">0</span> .. (data.Length - windowSize - <span class="number">1</span>) <span class="keyword">do</span></span><br><span class="line">      <span class="comment">// Add new byte to window</span></span><br><span class="line">      <span class="keyword">let</span> newByte = int data.[position + windowSize]</span><br><span class="line">      frequency.[newByte] &lt;- frequency.[newByte] + <span class="number">1</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> position &gt;= windowSize <span class="keyword">then</span> </span><br><span class="line">        <span class="comment">// Roll off old byte off window</span></span><br><span class="line">        <span class="keyword">let</span> currentByte = int data.[position]</span><br><span class="line">        frequency.[currentByte] &lt;- frequency.[currentByte] - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Calculate entropy </span></span><br><span class="line">        <span class="keyword">yield</span> (windowNormalizedEntropy windowSize frequency)</span><br><span class="line">  |]</span><br></pre></td></tr></table></figure><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[ <span class="string">"Program-Secret.fs"</span> </span><br><span class="line">  <span class="string">"fake.pem"</span> ]</span><br><span class="line">|&gt; List.iter (<span class="keyword">fun</span> filename -&gt;</span><br><span class="line">  printfn <span class="string">"File: %s"</span> filename</span><br><span class="line">  <span class="keyword">let</span> bytes = File.ReadAllBytes(filename)</span><br><span class="line">  </span><br><span class="line">  NormalizedEntropyWindow <span class="number">100</span> bytes</span><br><span class="line">  |&gt; Chart.Line</span><br><span class="line">  |&gt; Chart.Show)</span><br></pre></td></tr></table></figure><p>Now, as a result, I get charts showing entropy over the respective file.  The bumps show where I placed some random string keys in the file.  Just for kicks, I including a block of “AAAA…”, which is also evident when entropy drops to 0.  As a contrast, the pem file has a pretty consistently higher entropy throughout the whole file.  As with so many things, different angles on the problem help to improve intuition.  Plus I’m a sucker for a good picture.</p><p><img src="/images/entropy1/program-secret.png" alt="Program-Secret.fs"></p><p><img src="/images/entropy1/fake.png" alt="fake.pem"></p><p>This has been a brief look into how entropy patterns can be of use when scanning files for interesting information.  Until next time.</p>]]></content>
    
    <summary type="html">
    
      &lt;script src=&quot;https://polyfill.io/v3/polyfill.min.js?features=es6&quot;&gt;&lt;/script&gt;
&lt;script id=&quot;MathJax-script&quot; async src=&quot;https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js&quot;&gt;&lt;/script&gt;


&lt;p&gt;Measuring entropy can be a useful heuristic when performing analysis.  This is a short introduction into performing entropy analysis on binary and text files using &lt;a href=&quot;https://fsharp.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;F#&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
    
      <category term="F#" scheme="http://codesuji.com/tags/F/"/>
    
      <category term="FSharp" scheme="http://codesuji.com/tags/FSharp/"/>
    
      <category term="Entropy" scheme="http://codesuji.com/tags/Entropy/"/>
    
  </entry>
  
  <entry>
    <title>Handwired Preonic</title>
    <link href="http://codesuji.com/2019/11/02/Handwired-Preonic/"/>
    <id>http://codesuji.com/2019/11/02/Handwired-Preonic/</id>
    <published>2019-11-03T01:45:55.000Z</published>
    <updated>2020-04-30T17:39:47.671Z</updated>
    
    <content type="html"><![CDATA[<p>Today I wanted to share my newly hand-wired Preonic keyboard.</p><a id="more"></a><p>Below is the final result, equipped with Gateron Black switches.</p><p><img src="/images/preonic1/preonic_final.jpg" alt="Preonic, final result"></p><p>Since this is a more involved project, I’ve included a bunch of build process images.  </p><p>The journey started when I picked up a Preonic top plate from <a href="https://olkb.com" target="_blank" rel="noopener">OKLB</a>, but no PCBs were available.  This felt like the perfect opportunity to learn how to hand-wire a keyboard.  Luckily there are a couple good guides out there: <a href="https://docs.qmk.fm/#/hand_wire" target="_blank" rel="noopener">QMK Handwire</a>, <a href="https://trauring.org/hand-wiring-a-keyboard/" target="_blank" rel="noopener">trauring.org</a>.  I used these plus a couple other random resources to put this one together.</p><p>In the beginning, there were switches and a plate.  Mounting the switches seems like a good starting point.</p><p><img src="/images/preonic1/preonic_switches.jpg" alt="Gateron black switches"></p><p><img src="/images/preonic1/preonic_plate.jpg" alt="Preonic plate"></p><p><img src="/images/preonic1/preonic_switches_top.jpg" alt="Switches, a top view"></p><p><img src="/images/preonic1/preonic_switches_bottom.jpg" alt="Switches, a bottom view"></p><p>I wired the grid, starting with the rows.  Some people like to solder the diode legs directly together, leaving a bare metal row.  I prefer to attach them to an insulated wire.  I figure less bare wire is better.</p><p><img src="/images/preonic1/preonic_rows_partial.jpg" alt="Rows partially wired"></p><p><img src="/images/preonic1/preonic_rows.jpg" alt="Rows completely wired"></p><p><img src="/images/preonic1/preonic_rows_closeup.jpg" alt="Rows, a closer look"></p><p>After the rows, I tackle the columns.</p><p><img src="/images/preonic1/preonic_rows_columns_partial.jpg" alt="Colums partially wired"></p><p><img src="/images/preonic1/preonic_rows_columns.jpg" alt="Columns completely wired"></p><p><img src="/images/preonic1/preonic_rows_columns_closeup.jpg" alt="Rows and Column, a closer look"></p><p>Once the grid was soldered, I used ribbon cable to connect the rows and columns to the Teensy.  The thinner wires make it easier to snake through the underside of the board, and colors make for easier tracking.  I do have a minor regret here.  At the solder points I found the thinner ribbon cable to be a bit of a pain.  To be fair, it worked fine and often choices are about tradeoffs; but next time I’ll probably use something other than the thin ribbon cable.</p><p><img src="/images/preonic1/preonic_teensy_cable.jpg" alt="Wires for Teensy"></p><p><img src="/images/preonic1/preonic_teensy_connected.jpg" alt="Teensy, connected"></p><p><img src="/images/preonic1/preonic_teensy.jpg" alt="Teensy"></p><p>All wired up, its time to switch over to QMK.  They have a pretty good <a href="https://docs.qmk.fm/#/newbs_building_firmware" target="_blank" rel="noopener">guide</a> on how to setup a custom firmware.  Once I got myself oriented to the process, it wasn’t too bad to get a new firmware up and running.</p><p>Once flashed, the keyboard is all functional and good to go.  At this point I’m still waiting on putting a custom case together, but that is a whole other project I have in mind.  Until then the keyboard works as desired, and its an enjoyable addition to my collection.</p><p><img src="/images/preonic1/preonic_final.jpg" alt="Preonic, final result"></p><p>The below is the keyboard layout.  This is also what I use on my <a href="/2019/08/14/Nyquist-Keyboard/">Nyquist</a>.  I’ve found Esc and Backspace on the bottom row works really well.  I treat layer 1 mostly as a movement and number layer. Layer 2 is a symbols layer, primarily focused on developer ergonomics. I’m intrigued by the Planck format (one less row).  With this in mind, I make a conscious effort to compress the key space without sacrificing logical grouping and positional relationships.  It just makes the layout easier to remember.</p><p><a name="layout"></a><br><img src="/images/preonic1/preonic_layer0.png" alt="Layer 0"></p><p><img src="/images/preonic1/preonic_layer1.png" alt="Layer 1"></p><p><img src="/images/preonic1/preonic_layer2.png" alt="Layer 2"></p><p>As a final note, for anyone considering hand wiring a keyboard but unsure if they can do it. I say go for it.  The process really isn’t as bad as you might think and its fun journey.  Until next time.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Today I wanted to share my newly hand-wired Preonic keyboard.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Keyboard" scheme="http://codesuji.com/tags/Keyboard/"/>
    
  </entry>
  
  <entry>
    <title>Utilizing RabbitMQ with F#</title>
    <link href="http://codesuji.com/2019/10/24/F-RabbitMQ/"/>
    <id>http://codesuji.com/2019/10/24/F-RabbitMQ/</id>
    <published>2019-10-25T00:01:17.000Z</published>
    <updated>2019-10-25T19:34:57.941Z</updated>
    
    <content type="html"><![CDATA[<p>Today is a overview of how to use the <a href="https://www.rabbitmq.com/" target="_blank" rel="noopener">RabbitMQ</a> message broker with <a href="https://fsharp.org" target="_blank" rel="noopener">F#</a>.  The RabbitMQ tutorials have a lot of great <a href="https://www.rabbitmq.com/getstarted.html" target="_blank" rel="noopener">getting started</a> information.  Its .NET section focuses on C#, so I wanted to provide an F# angle to the general use cases.<br><a id="more"></a></p><p>There are a several different use cases for leveraging RabbitMQ.  My examples will track against most of the tutorials, but with my own twist on the examples.  The producer will generate and publish a datastream of floats using RabbitMQ.  Depending on the specific use cases, consumers will filter and processes messages out of RabbitMQ.  I want all of these to be singular files, so I also leverage Async workflows to operate both producer and consumers in the same process.  To get started, you will need to have <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core</a> installed.  Once this is complete the application can be setup.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dotnet new console -lang F# -n RabbitMQ</span><br><span class="line">cd RabbitMQ </span><br><span class="line">dotnet new package RabbitMQ.Client --version 5.1.2</span><br></pre></td></tr></table></figure><p>Based on the types of interaction, I’ve broken the post into sections.  For quick reference, the sections are:</p><p><a href="#work_queues">Work Queues</a><br><a href="#publish_subscribe">Publish/Subscribe</a><br><a href="#routing">Routing</a><br><a href="#topics">Topics</a></p><p>There is a lot of repetition, but I want each example to stand on it’s own.  In all of the below examples, the same libraries and namespaces are used.  So this will be a singular header for all examples.  The primary difference between the following examples is the exchange, queue, and routing key definitions and usages. </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> System</span><br><span class="line"><span class="keyword">open</span> System.Text</span><br><span class="line"><span class="keyword">open</span> System.Threading</span><br><span class="line"><span class="keyword">open</span> RabbitMQ.Client</span><br><span class="line"><span class="keyword">open</span> RabbitMQ.Client.Events</span><br></pre></td></tr></table></figure><h2 id="Work-Queues"><a href="#Work-Queues" class="headerlink" title="Work Queues "></a>Work Queues <a name="work_queue"></a></h2><p>For this example, the interaction is pretty direct.  The producer takes it’s datastream and publishes it to the defined queue every 500 milliseconds.  The consumer(s) will read from the same queue, processing data as available.  The consumer is setup in a similar fashion to the producer; they both need a connexionand channel.  It does has the extra need to setup a handler for receiving messages.  Once it is all setup, the consumer must be started for processing.  The final piece is running the producer and consumer workflows.  Since this is a quick test, I’ll run everything for 5 seconds, then kill the workflow. </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> producer hostname queue routingKey (token: CancellationTokenSource) = async &#123;</span><br><span class="line">  <span class="keyword">let</span> factory = ConnectionFactory(HostName = hostname)</span><br><span class="line">  <span class="keyword">use</span> connection = factory.CreateConnection()</span><br><span class="line">  <span class="keyword">use</span> channel = connection.CreateModel()</span><br><span class="line">  <span class="keyword">let</span> result = channel.QueueDeclare(queue = queue, durable = <span class="keyword">false</span>, exclusive = <span class="keyword">false</span>, autoDelete = <span class="keyword">false</span>, arguments = <span class="keyword">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> rand = Random()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> not token.IsCancellationRequested <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">let</span> message = sprintf <span class="string">"%f"</span> (rand.NextDouble())</span><br><span class="line">    <span class="keyword">let</span> body = Encoding.UTF8.GetBytes(message)</span><br><span class="line">    printfn <span class="string">"publish     : %s"</span> message</span><br><span class="line">    channel.BasicPublish(exchange = <span class="string">""</span>, routingKey = routingKey, basicProperties = <span class="keyword">null</span>, body = body)</span><br><span class="line">    Thread.Sleep(<span class="number">500</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> consumer id hostname queue (token: CancellationTokenSource) = async &#123;</span><br><span class="line">  <span class="keyword">let</span> factory = ConnectionFactory(HostName = hostname)</span><br><span class="line">  <span class="keyword">use</span> connection = factory.CreateConnection()</span><br><span class="line">  <span class="keyword">use</span> channel = connection.CreateModel()</span><br><span class="line">  <span class="keyword">let</span> result = channel.QueueDeclare(queue = queue, durable = <span class="keyword">false</span>, exclusive = <span class="keyword">false</span>, autoDelete = <span class="keyword">false</span>, arguments = <span class="keyword">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> consumer = EventingBasicConsumer(channel)</span><br><span class="line">  consumer.Received.AddHandler(<span class="keyword">new</span> EventHandler&lt;BasicDeliverEventArgs&gt;(<span class="keyword">fun</span> sender (data:BasicDeliverEventArgs) -&gt; </span><br><span class="line">    <span class="keyword">let</span> body = data.Body</span><br><span class="line">    <span class="keyword">let</span> message = Encoding.UTF8.GetString(body)</span><br><span class="line">    printfn <span class="string">"consumed [%s]: %s"</span> id message))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> consumeResult = channel.BasicConsume(queue = queue, autoAck = <span class="keyword">true</span>, consumer = consumer)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> not token.IsCancellationRequested <span class="keyword">do</span></span><br><span class="line">    Thread.Sleep(<span class="number">500</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;EntryPoint&gt;]</span></span><br><span class="line"><span class="keyword">let</span> main argv =</span><br><span class="line">  <span class="keyword">let</span> host = <span class="string">"localhost"</span></span><br><span class="line">  <span class="keyword">let</span> queue = <span class="string">"data_stream"</span></span><br><span class="line">  <span class="keyword">let</span> routingKey = <span class="string">"data_stream"</span></span><br><span class="line"></span><br><span class="line">  async &#123;</span><br><span class="line">    <span class="keyword">let</span> token = <span class="keyword">new</span> CancellationTokenSource()</span><br><span class="line">    token.CancelAfter <span class="number">5000</span></span><br><span class="line"></span><br><span class="line">    seq &#123; </span><br><span class="line">      (producer host queue routingKey token); </span><br><span class="line">      (consumer <span class="string">"1"</span> host queue token); </span><br><span class="line">      (consumer <span class="string">"2"</span> host queue token) &#125; </span><br><span class="line">    |&gt; Async.Parallel</span><br><span class="line">    |&gt; Async.RunSynchronously |&gt; ignore</span><br><span class="line">  &#125; |&gt; Async.RunSynchronously</span><br><span class="line"> </span><br><span class="line">  <span class="number">0</span></span><br></pre></td></tr></table></figure><p>The output shows the two consumers picking data off the data_stream queue.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">publish     : 0.750373</span><br><span class="line">consumed [1]: 0.750373</span><br><span class="line">publish     : 0.130004</span><br><span class="line">consumed [2]: 0.130004</span><br><span class="line">publish     : 0.279026</span><br><span class="line">consumed [1]: 0.279026</span><br><span class="line">publish     : 0.709584</span><br><span class="line">consumed [2]: 0.709584</span><br><span class="line">publish     : 0.573295</span><br><span class="line">consumed [1]: 0.573295</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="Publish-Subscribe"><a href="#Publish-Subscribe" class="headerlink" title="Publish/Subscribe "></a>Publish/Subscribe <a name="publish_subscribe"></a></h2><p>In contrast to the previous example, using a <code>Fanout</code> exchange type distributes the published message to all subscribed consumers.  Of note, here I use exchange and routing key.  The consumer also needs a queue binding, that wasn’t required in the previous example.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> producer hostname exchange routingKey (token: CancellationTokenSource) = async &#123;</span><br><span class="line">  <span class="keyword">let</span> factory = ConnectionFactory(HostName = hostname)</span><br><span class="line">  <span class="keyword">use</span> connection = factory.CreateConnection()</span><br><span class="line">  <span class="keyword">use</span> channel = connection.CreateModel()</span><br><span class="line">  channel.ExchangeDeclare(exchange = exchange, ``<span class="class"><span class="keyword">type</span>`` </span>= ExchangeType.Fanout, durable = <span class="keyword">false</span>, autoDelete = <span class="keyword">false</span>, arguments = <span class="keyword">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> rand = Random()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> not token.IsCancellationRequested <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">let</span> message = sprintf <span class="string">"%f"</span> (rand.NextDouble())</span><br><span class="line">    <span class="keyword">let</span> body = Encoding.UTF8.GetBytes(message)</span><br><span class="line">    printfn <span class="string">"publish: %s"</span> message</span><br><span class="line">    channel.BasicPublish(exchange = exchange, routingKey = routingKey, basicProperties = <span class="keyword">null</span>, body = body)</span><br><span class="line">    Thread.Sleep(<span class="number">500</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> consumer id hostname exchange routingKey (token: CancellationTokenSource) = async &#123;</span><br><span class="line">  <span class="keyword">let</span> factory = ConnectionFactory(HostName = hostname)</span><br><span class="line">  <span class="keyword">use</span> connection = factory.CreateConnection()</span><br><span class="line">  <span class="keyword">use</span> channel = connection.CreateModel()</span><br><span class="line">  channel.ExchangeDeclare(exchange = exchange, ``<span class="class"><span class="keyword">type</span>`` </span>= ExchangeType.Fanout)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> queueName = channel.QueueDeclare().QueueName</span><br><span class="line">  channel.QueueBind(queue = queueName, exchange = exchange, routingKey = routingKey);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> consumer = EventingBasicConsumer(channel)</span><br><span class="line">  consumer.Received.AddHandler(<span class="keyword">new</span> EventHandler&lt;BasicDeliverEventArgs&gt;(<span class="keyword">fun</span> sender (data:BasicDeliverEventArgs) -&gt; </span><br><span class="line">    <span class="keyword">let</span> body = data.Body</span><br><span class="line">    <span class="keyword">let</span> message = Encoding.UTF8.GetString(body)</span><br><span class="line">    printfn <span class="string">"consumed [%s]: %A"</span> id message))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> consumeResult = channel.BasicConsume(queue = <span class="string">""</span>, autoAck = <span class="keyword">true</span>, consumer = consumer)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> not token.IsCancellationRequested <span class="keyword">do</span></span><br><span class="line">    Thread.Sleep(<span class="number">500</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;EntryPoint&gt;]</span></span><br><span class="line"><span class="keyword">let</span> main argv =</span><br><span class="line">  <span class="keyword">let</span> host = <span class="string">"localhost"</span></span><br><span class="line">  <span class="keyword">let</span> exchange = <span class="string">"pubsub_exchange"</span></span><br><span class="line">  <span class="keyword">let</span> routingKey = <span class="string">"pubsub_route"</span></span><br><span class="line"></span><br><span class="line">  async &#123;</span><br><span class="line">    <span class="keyword">let</span> token = <span class="keyword">new</span> CancellationTokenSource()</span><br><span class="line">    token.CancelAfter <span class="number">5000</span></span><br><span class="line"></span><br><span class="line">    seq &#123; </span><br><span class="line">      (producer host exchange routingKey token); </span><br><span class="line">      (consumer <span class="string">"1"</span> host exchange routingKey token); </span><br><span class="line">      (consumer <span class="string">"2"</span> host exchange routingKey token) &#125; </span><br><span class="line">    |&gt; Async.Parallel</span><br><span class="line">    |&gt; Async.RunSynchronously |&gt; ignore</span><br><span class="line"></span><br><span class="line">    printfn <span class="string">"workflow complete"</span></span><br><span class="line">  &#125; |&gt; Async.RunSynchronously</span><br><span class="line"> </span><br><span class="line">  <span class="number">0</span></span><br></pre></td></tr></table></figure><p>The below results show each consumer processing every message.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">publish: 0.178846</span><br><span class="line">consumed [1]: &quot;0.178846&quot;</span><br><span class="line">consumed [2]: &quot;0.178846&quot;</span><br><span class="line">publish: 0.734746</span><br><span class="line">consumed [1]: &quot;0.734746&quot;</span><br><span class="line">consumed [2]: &quot;0.734746&quot;</span><br><span class="line">publish: 0.171448</span><br><span class="line">consumed [2]: &quot;0.171448&quot;</span><br><span class="line">consumed [1]: &quot;0.171448&quot;</span><br><span class="line">publish: 0.890113</span><br><span class="line">consumed [2]: &quot;0.890113&quot;</span><br><span class="line">consumed [1]: &quot;0.890113&quot;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="Routing"><a href="#Routing" class="headerlink" title="Routing "></a>Routing <a name="routing"></a></h2><p>For this example, if the first digit is even or odd, the producer will route it to the appropriate ‘even’ or ‘odd’ route.  Two consumers are setup, one to listen for even messages, and the other to listen to odd messages.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> producer hostname exchange (routingKeys:string list) (token: CancellationTokenSource) = async &#123;</span><br><span class="line">  <span class="keyword">let</span> factory = ConnectionFactory(HostName = hostname)</span><br><span class="line">  <span class="keyword">use</span> connection = factory.CreateConnection()</span><br><span class="line">  <span class="keyword">use</span> channel = connection.CreateModel()</span><br><span class="line">  channel.ExchangeDeclare(exchange = exchange, ``<span class="class"><span class="keyword">type</span>`` </span>= ExchangeType.Direct, durable = <span class="keyword">false</span>, autoDelete = <span class="keyword">false</span>, arguments = <span class="keyword">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> rand = Random()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> not token.IsCancellationRequested <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">let</span> data = rand.NextDouble()</span><br><span class="line">    <span class="keyword">let</span> message = sprintf <span class="string">"%f"</span> data</span><br><span class="line">    <span class="keyword">let</span> body = Encoding.UTF8.GetBytes(message)</span><br><span class="line">    printfn <span class="string">"publish     : %s"</span> message</span><br><span class="line">    <span class="keyword">let</span> routingKey = <span class="keyword">if</span> int ((data * <span class="number">10.</span>)) % <span class="number">2</span> = <span class="number">0</span> </span><br><span class="line">                     <span class="keyword">then</span> routingKeys.[<span class="number">0</span>] </span><br><span class="line">                     <span class="keyword">else</span> routingKeys.[<span class="number">1</span>]</span><br><span class="line">    channel.BasicPublish(exchange = exchange, routingKey = routingKey, basicProperties = <span class="keyword">null</span>, body = body)</span><br><span class="line">    Thread.Sleep(<span class="number">500</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> consumer id hostname exchange routingKey (token: CancellationTokenSource) = async &#123;</span><br><span class="line">  <span class="keyword">let</span> factory = ConnectionFactory(HostName = hostname)</span><br><span class="line">  <span class="keyword">use</span> connection = factory.CreateConnection()</span><br><span class="line">  <span class="keyword">use</span> channel = connection.CreateModel()</span><br><span class="line">  channel.ExchangeDeclare(exchange = exchange, ``<span class="class"><span class="keyword">type</span>`` </span>= ExchangeType.Direct)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> queueName = channel.QueueDeclare().QueueName</span><br><span class="line">  channel.QueueBind(queue = queueName, exchange = exchange, routingKey = routingKey);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> consumer = EventingBasicConsumer(channel)</span><br><span class="line">  consumer.Received.AddHandler(<span class="keyword">new</span> EventHandler&lt;BasicDeliverEventArgs&gt;(<span class="keyword">fun</span> sender (data:BasicDeliverEventArgs) -&gt; </span><br><span class="line">    <span class="keyword">let</span> body = data.Body</span><br><span class="line">    <span class="keyword">let</span> message = Encoding.UTF8.GetString(body)</span><br><span class="line">    printfn <span class="string">"consumed [%s]: %s"</span> id message))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> consumeResult = channel.BasicConsume(queue = <span class="string">""</span>, autoAck = <span class="keyword">true</span>, consumer = consumer)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> not token.IsCancellationRequested <span class="keyword">do</span></span><br><span class="line">    Thread.Sleep(<span class="number">500</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;EntryPoint&gt;]</span></span><br><span class="line"><span class="keyword">let</span> main argv =</span><br><span class="line">  <span class="keyword">let</span> host = <span class="string">"localhost"</span></span><br><span class="line">  <span class="keyword">let</span> exchange = <span class="string">"routing_exchange"</span></span><br><span class="line">  <span class="keyword">let</span> routingKey0 = <span class="string">"even"</span></span><br><span class="line">  <span class="keyword">let</span> routingKey1 = <span class="string">"odd"</span></span><br><span class="line"></span><br><span class="line">  async &#123;</span><br><span class="line">    <span class="keyword">let</span> token = <span class="keyword">new</span> CancellationTokenSource()</span><br><span class="line">    token.CancelAfter <span class="number">5000</span></span><br><span class="line"></span><br><span class="line">    seq &#123; </span><br><span class="line">      (producer host exchange [routingKey0; routingKey1] token); </span><br><span class="line">      (consumer <span class="string">"0"</span> host exchange routingKey0 token);  </span><br><span class="line">      (consumer <span class="string">"1"</span> host exchange routingKey1 token) &#125;</span><br><span class="line">    |&gt; Async.Parallel</span><br><span class="line">    |&gt; Async.RunSynchronously |&gt; ignore</span><br><span class="line">  &#125; |&gt; Async.RunSynchronously</span><br><span class="line"> </span><br><span class="line">  <span class="number">0</span></span><br></pre></td></tr></table></figure><p>The below results show consumer 0 filtering on even messages and consumer 1 filtering on odd messages.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">publish: 0.910740</span><br><span class="line">consumed [1]: 0.910740</span><br><span class="line">publish     : 0.650291</span><br><span class="line">consumed [0]: 0.650291</span><br><span class="line">publish     : 0.128357</span><br><span class="line">consumed [1]: 0.128357</span><br><span class="line">publish     : 0.750614</span><br><span class="line">consumed [1]: 0.750614</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="Topics"><a href="#Topics" class="headerlink" title="Topics "></a>Topics <a name="topics"></a></h2><p>The <code>Topic</code> exchange type provides a mechanism for consumers to apply advanced filtering to the messages they process.  In this example, the same even/odd producer is used.  The consumers use routing keys that support wildcards.  <code>all.*</code> will process messages that start with ‘all’, while <code>*.odd</code> will process messages ending in ‘odd’.  This functionality allows you to setup topics in such a fashion to provided more advanced consumer processing.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> producer hostname exchange (routingKeys:string list) (token: CancellationTokenSource) = async &#123;</span><br><span class="line">  <span class="keyword">let</span> factory = ConnectionFactory(HostName = hostname)</span><br><span class="line">  <span class="keyword">use</span> connection = factory.CreateConnection()</span><br><span class="line">  <span class="keyword">use</span> channel = connection.CreateModel()</span><br><span class="line">  channel.ExchangeDeclare(exchange = exchange, ``<span class="class"><span class="keyword">type</span>`` </span>= ExchangeType.Topic, durable = <span class="keyword">false</span>, autoDelete = <span class="keyword">false</span>, arguments = <span class="keyword">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> rand = Random()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> not token.IsCancellationRequested <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">let</span> data = rand.NextDouble()</span><br><span class="line">    <span class="keyword">let</span> message = sprintf <span class="string">"%f"</span> data</span><br><span class="line">    <span class="keyword">let</span> body = Encoding.UTF8.GetBytes(message)</span><br><span class="line">    printfn <span class="string">"publish: %s"</span> message</span><br><span class="line">    <span class="keyword">let</span> routingKey = <span class="keyword">if</span> int ((data * <span class="number">10.</span>)) % <span class="number">2</span> = <span class="number">0</span> </span><br><span class="line">                     <span class="keyword">then</span> routingKeys.[<span class="number">0</span>] </span><br><span class="line">                     <span class="keyword">else</span> routingKeys.[<span class="number">1</span>]</span><br><span class="line">    channel.BasicPublish(exchange = exchange, routingKey = routingKey, basicProperties = <span class="keyword">null</span>, body = body)</span><br><span class="line">    Thread.Sleep(<span class="number">500</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> consumer id hostname exchange routingKey (token: CancellationTokenSource) = async &#123;</span><br><span class="line">  <span class="keyword">let</span> factory = ConnectionFactory(HostName = hostname)</span><br><span class="line">  <span class="keyword">use</span> connection = factory.CreateConnection()</span><br><span class="line">  <span class="keyword">use</span> channel = connection.CreateModel()</span><br><span class="line">  channel.ExchangeDeclare(exchange = exchange, ``<span class="class"><span class="keyword">type</span>`` </span>= ExchangeType.Topic) <span class="comment">//, durable = false, autoDelete = false, arguments = null)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> queueName = channel.QueueDeclare().QueueName</span><br><span class="line">  channel.QueueBind(queue = queueName, exchange = exchange, routingKey = routingKey);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> consumer = EventingBasicConsumer(channel)</span><br><span class="line">  consumer.Received.AddHandler(<span class="keyword">new</span> EventHandler&lt;BasicDeliverEventArgs&gt;(<span class="keyword">fun</span> sender (data:BasicDeliverEventArgs) -&gt; </span><br><span class="line">    <span class="keyword">let</span> body = data.Body</span><br><span class="line">    <span class="keyword">let</span> message = Encoding.UTF8.GetString(body)</span><br><span class="line">    printfn <span class="string">"consumed [%s]: %A"</span> id message))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> consumeResult = channel.BasicConsume(queue = <span class="string">""</span>, autoAck = <span class="keyword">true</span>, consumer = consumer)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> not token.IsCancellationRequested <span class="keyword">do</span></span><br><span class="line">    Thread.Sleep(<span class="number">500</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;EntryPoint&gt;]</span></span><br><span class="line"><span class="keyword">let</span> main argv =</span><br><span class="line">  <span class="keyword">let</span> host = <span class="string">"localhost"</span></span><br><span class="line">  <span class="keyword">let</span> exchange = <span class="string">"topic_exchange"</span></span><br><span class="line">  <span class="keyword">let</span> routingKey0 = <span class="string">"all.even"</span></span><br><span class="line">  <span class="keyword">let</span> routingKey1 = <span class="string">"all.odd"</span></span><br><span class="line"></span><br><span class="line">  async &#123;</span><br><span class="line">    <span class="keyword">let</span> token = <span class="keyword">new</span> CancellationTokenSource()</span><br><span class="line">    token.CancelAfter <span class="number">5000</span></span><br><span class="line"></span><br><span class="line">    seq &#123; </span><br><span class="line">      (producer host exchange [routingKey0; routingKey1] token); </span><br><span class="line">      (consumer <span class="string">"0"</span> host exchange routingKey0 token);  </span><br><span class="line">      (consumer <span class="string">"1"</span> host exchange routingKey1 token);</span><br><span class="line">      (consumer <span class="string">"2"</span> host exchange <span class="string">"all.*"</span> token)  </span><br><span class="line">      (consumer <span class="string">"3"</span> host exchange <span class="string">"*.even"</span> token)  </span><br><span class="line">    &#125;</span><br><span class="line">    |&gt; Async.Parallel</span><br><span class="line">    |&gt; Async.RunSynchronously |&gt; ignore</span><br><span class="line">  &#125; |&gt; Async.RunSynchronously</span><br><span class="line"> </span><br><span class="line">  <span class="number">0</span></span><br></pre></td></tr></table></figure><p>The below results show consumers pulling their appropriately filtered messages.  Even messages are processed by consumers 0, 2, and 3.  Odd messages are processed by consumers 1 and 2.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">publish     : <span class="number">0.789320</span></span><br><span class="line">consumed [<span class="number">2</span>]: <span class="number">0.789320</span></span><br><span class="line">consumed [<span class="number">1</span>]: <span class="number">0.789320</span></span><br><span class="line">publish     : <span class="number">0.163861</span></span><br><span class="line">consumed [<span class="number">1</span>]: <span class="number">0.163861</span></span><br><span class="line">consumed [<span class="number">2</span>]: <span class="number">0.163861</span></span><br><span class="line">publish     : <span class="number">0.256774</span></span><br><span class="line">consumed [<span class="number">0</span>]: <span class="number">0.256774</span></span><br><span class="line">consumed [<span class="number">3</span>]: <span class="number">0.256774</span></span><br><span class="line">consumed [<span class="number">2</span>]: <span class="number">0.256774</span></span><br><span class="line">publish     : <span class="number">0.273446</span></span><br><span class="line">consumed [<span class="number">3</span>]: <span class="number">0.273446</span></span><br><span class="line">consumed [<span class="number">2</span>]: <span class="number">0.273446</span></span><br><span class="line">consumed [<span class="number">0</span>]: <span class="number">0.273446</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>This has been a quick overview in how RabbitMQ can be used with F#.  It really only touches the surface of what can be done.  Until next time.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Today is a overview of how to use the &lt;a href=&quot;https://www.rabbitmq.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;RabbitMQ&lt;/a&gt; message broker with &lt;a href=&quot;https://fsharp.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;F#&lt;/a&gt;.  The RabbitMQ tutorials have a lot of great &lt;a href=&quot;https://www.rabbitmq.com/getstarted.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;getting started&lt;/a&gt; information.  Its .NET section focuses on C#, so I wanted to provide an F# angle to the general use cases.&lt;br&gt;
    
    </summary>
    
    
      <category term="F#" scheme="http://codesuji.com/tags/F/"/>
    
      <category term="FSharp" scheme="http://codesuji.com/tags/FSharp/"/>
    
      <category term="Messaging" scheme="http://codesuji.com/tags/Messaging/"/>
    
  </entry>
  
  <entry>
    <title>Performance Profiling F#</title>
    <link href="http://codesuji.com/2019/10/13/F-Performance-Profiling/"/>
    <id>http://codesuji.com/2019/10/13/F-Performance-Profiling/</id>
    <published>2019-10-13T11:32:09.000Z</published>
    <updated>2019-10-14T13:28:54.121Z</updated>
    
    <content type="html"><![CDATA[<p>The release of .NET Core version 3 contains some exciting cross-platform profiling tools.  Today I’ll use some of the newly available tools to target problem areas and improve performance of my <a href="http://fsharp.org/" target="_blank" rel="noopener">F#</a>-based library: FastDtw, as seen <a href="/2019/10/11/FastDtw">here</a>.</p><a id="more"></a><p>The new tooling that supports .NET Core profiling on Linux is a welcome addition.  It fills an important gap as the .NET ecosystem further improves support for non-Windows environments.  To easily be able to run the entire profilng stack on Linux is a joy.  This does require  at least <a href="https://dotnet.microsoft.com/download" target="_blank" rel="noopener">.NET Core version 3.0</a>.</p><p>To get started I need to add some global tooling.  I’ll add the trace tool for data capture and SpeedScope for data viewing.  <a href="https://www.speedscope.app/" target="_blank" rel="noopener">SpeedScope</a> has a website where you can upload traces if you prefer, but I generally like to run things locally if I can.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dotnet tool install --global dotnet-trace--version 3.0.47001</span><br><span class="line">npm install -g speedscope</span><br></pre></td></tr></table></figure><p>Fwiw, Microsoft has released several new tools.  Even though I will only focus on <code>trace</code> today, I want to mention the other ones, in case you want to look deeper into them.  Counters are for tracking live stats, and Dump is useful for application dumps and debugging.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dotnet tool install --global dotnet-counters --version 3.0.47001 </span><br><span class="line">dotnet tool install --global dotnet-dump --version 3.0.47001 </span><br></pre></td></tr></table></figure><p>Now that the basic tooling is installed, it is time to get started.  For this, I’ll put together a simple app that uses the library to profile.  Since I want to improve performance along the way, I’ll directly use the project source instead of the nuget package.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet new console -lang f# -n perf &amp;&amp; cd perf</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;ItemGroup&gt;</span><br><span class="line">  &lt;ProjectReference Include=&quot;..\src\FastDtw.fsproj&quot; /&gt;</span><br><span class="line">&lt;/ItemGroup&gt;</span><br></pre></td></tr></table></figure><p>For my purposes I don’t need anything fancy.  I will just loop infinitely, creating 2 randomly sized series to compare.  This will give me a steady process to perform a trace against.  I could’ve chosen anything really, but opt’d to compare a sin wave to a randomly altered sin wave.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> System</span><br><span class="line"><span class="keyword">open</span> FastDtw</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> rand = Random()</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;EntryPoint&gt;]</span></span><br><span class="line"><span class="keyword">let</span> main argv =</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> <span class="keyword">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">let</span> seriesLength = rand.Next(<span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">let</span> a = Array.init seriesLength (<span class="keyword">fun</span> x -&gt; Math.Sin(float x))</span><br><span class="line">    <span class="keyword">let</span> boffset = rand.NextDouble()</span><br><span class="line">    <span class="keyword">let</span> b = Array.init seriesLength (<span class="keyword">fun</span> x -&gt; boffset + Math.Sin(float x + rand.NextDouble()))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> d = FastDtw.Distance a b <span class="number">2</span></span><br><span class="line">    ()</span><br><span class="line"></span><br><span class="line">  <span class="number">0</span></span><br></pre></td></tr></table></figure><p>I’ll open 2 terminals: One to run my test, and another to profile.  First, <code>dotnet run</code> to get my simple app looping indefinitely.  Tracing is a multi-step process.  To start, I need to find it’s process id.  Once I have that I can starting tracing the process in question.  I also want to save it in a format that speedscope recognizes.  Once I have enough data I’ll stop the capture and do some analysis.  How much data is enough?  That will be problem dependent, but for this particular problem I’ll use about 20 seconds of data.  Once the capture is complete, the interesting part starts, looking at the provided profile using speedscope.  Running the below command will open the results in a browser.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ dotnet trace list-processes</span><br><span class="line">     14719 dotnet     /usr/share/dotnet/dotnet</span><br><span class="line">     14782 dotnet     /usr/share/dotnet/dotnet</span><br><span class="line">     14765 Perf       /home/jeff/projects/fastdtw/perf/bin/Debug/netcoreapp3.0/Perf</span><br><span class="line"></span><br><span class="line">$ dotnet trace collect --format speedscope -p 14765</span><br><span class="line"></span><br><span class="line">[00:00:00:00]Recording trace 581.00   (B)                             </span><br><span class="line">[00:00:00:00]Recording trace 592.00   (B)                             </span><br><span class="line">[00:00:00:00]Recording trace 5.275    (KB)                            </span><br><span class="line">...</span><br><span class="line">[00:00:00:21]Recording trace 735.465  (KB)                            </span><br><span class="line">[00:00:00:21]Recording trace 751.849  (KB)                            </span><br><span class="line">[00:00:00:21]Recording trace 761.382  (KB)                            </span><br><span class="line">Press &lt;Enter&gt; or &lt;Ctrl+C&gt; to exit...</span><br><span class="line"></span><br><span class="line">$ speedscope trace.speedscope.json</span><br></pre></td></tr></table></figure><p>As mentioned before, I am using <a href="https://www.speedscope.app/" target="_blank" rel="noopener">speedscope</a>, which is a flamegraph visualizer.  I have the data in the proper format, but if I didn’t, the trace tool comes with a conversion command as well, <code>dotnet trace convert trace.foo --format speedscope</code>.</p><p>My intention is not to make a speedscope tutorial, but it is useful to get some bearings.  The interface has 3 main views “Time Order”, “Left Heavy”, and “Sandwich”.  Time Order is representative of chronological time through the execution of the application, which isn’t interesting to me today.  Left Heavy groups function calls so it is easy to see which functions are taking the most time, and their respective callers.  “Sandwich” uses a percent time execution to find the big timesinks, but it also includes callers and callees, to help track the call stack a bit.  Depending on the view that is picked, additional detail is shown regarding the function in question.  I will primary leverage the last two views.</p><p><img src="/images/pe1/1-lefthand.png" alt="Initial Profile (Lefthand)"></p><p><br></p><p><img src="/images/pe1/1-sandwich.png" alt="Initial Profile (Sandwich)"></p><p>Looking at the above charts, it appears Array2D creation is unexpectedly taking a significant amount of time.  Looking into the code I see a frankly silly mistake.  I want to initialize the array with 0s, but for some reason I was using a lambda function instead of a straight initialization.  I don’t need the additional functionality of the lambda so this is a pretty obvious change.  As a sidenote, the <code>create</code> runs about 60% faster than <code>init</code> in my very informal tests.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OLD</span></span><br><span class="line"><span class="keyword">let</span> path = Array2D.init (n+<span class="number">1</span>) (m+<span class="number">1</span>) (<span class="keyword">fun</span> _ _ -&gt; <span class="number">0.</span>)</span><br><span class="line"><span class="comment">// NEW</span></span><br><span class="line"><span class="keyword">let</span> path = Array2D.create (n+<span class="number">1</span>) (m+<span class="number">1</span>) <span class="number">0.</span></span><br></pre></td></tr></table></figure><p><img src="/images/pe1/2-lefthand.png" alt="Profile (Lefthand)"></p><p>I now rerun my test with the newly enhanced code to find another area of contention in the <code>coarser</code> function.  Here is another interesting find, apparently a stepped population of an array triggers an underlying list creation, which carries with it some additional overhead.  Initializing the array differently is about 10 times faster than the <code>[| a .. s .. b |]</code>.  I think the original code is a bit more intuitive, but the change is worth the performance boost.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OLD</span></span><br><span class="line">[|<span class="number">0</span> .. <span class="number">2</span> .. series.Length - <span class="number">1</span>|]</span><br><span class="line"><span class="comment">// NEW</span></span><br><span class="line">(Array.init ((series.Length + <span class="number">1</span>) / <span class="number">2</span>) (<span class="keyword">fun</span> i -&gt; i * <span class="number">2</span>))</span><br></pre></td></tr></table></figure><p><img src="/images/pe1/3-lefthand.png" alt="Profile (Lefthand)"></p><p>In the next profiling run, I see calls being dominated by my <code>InWindow</code> functions.  Internally they mostly use <code>match</code> against an option type.  Turns out using a straight <code>If x.IsSome then ... else ...</code> is about 3 times faster than the equivalent <code>match</code>.  I will admit, I have a tendancy to over-use match, this is a good reminder to be more careful and ensure the usecase makes sense.  This brings up another rework, the <code>travelledPath</code> function I have for backtracking the path used by the algorithm for determining distance between the series.  In retrospect I overthought things.  I won’t show the before/after code because it’s a larger rewrite.  I was able to simplify and make the function faster, ironically removing a several match option calls that initially pointed me this way.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Old</span></span><br><span class="line"><span class="keyword">match</span> windows <span class="keyword">with</span></span><br><span class="line">| Some(w) -&gt; calculateDtwWithWindow series1 series2 w</span><br><span class="line">| None    -&gt; calculateDtwWithWindow series1 series2 [<span class="number">1</span>, series1.Length, <span class="number">1</span>, series2.Length]</span><br><span class="line"><span class="comment">// New</span></span><br><span class="line"><span class="keyword">if</span> windows.IsSome</span><br><span class="line"><span class="keyword">then</span> calculateDtwWithWindow series1 series2 windows.Value</span><br><span class="line"><span class="keyword">else</span> calculateDtwWithWindow series1 series2 [<span class="number">1</span>, series1.Length, <span class="number">1</span>, series2.Length]</span><br></pre></td></tr></table></figure><p><img src="/images/pe1/4-lefthand.png" alt="Profile (Lefthand)"></p><p>This is where I come to an end for now.  I allocated myself a limited amount of weekend time for this.  It looks like the next big enhancement is to remove a list usage, but the implications of that change are larger than I’m willing to take on in my current timeframe.  I will mark this away as a future enhancement.  I’m pretty happy with what I found, with not that much effort.  The new <em>dotnet trace</em> tool, in combination with <em>speedscope</em>, has proven to be very useful in quick profiling iterations on Linux.  Now that the optimizations are complete, it would be nice to see a before/after comparison.  For this I’ll use BenchmarkDotNet for some comparative analysis.  After putting together a quick benchmark app, here are the results.  Running on a couple different series sizes, I see about a 25% to 30% performance boost.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">|     Method | SeriesSize |           Mean |         Error |        StdDev |     Gen 0 |     Gen 1 |     Gen 2 |  Allocated |</span><br><span class="line">|----------- |----------- |---------------:|--------------:|--------------:|----------:|----------:|----------:|-----------:|</span><br><span class="line">| OldFastDtw |         10 |       9.898 us |     0.0470 us |     0.0440 us |    5.0354 |         - |         - |    7.73 KB |</span><br><span class="line">| NewFastDtw |         10 |       7.912 us |     0.0436 us |     0.0387 us |    3.9215 |         - |         - |    6.01 KB |</span><br><span class="line">| OldFastDtw |        100 |     186.328 us |     0.6261 us |     0.5856 us |  106.9336 |         - |         - |  166.79 KB |</span><br><span class="line">| NewFastDtw |        100 |     147.231 us |     0.6857 us |     0.6414 us |   95.2148 |         - |         - |  149.78 KB |</span><br><span class="line">| OldFastDtw |       1000 |   9,935.868 us |   189.7567 us |   210.9141 us | 1062.5000 |  765.6250 |  687.5000 |  602.67 KB |</span><br><span class="line">| NewFastDtw |       1000 |   7,337.256 us |   142.6234 us |   133.4100 us | 1085.9375 |  835.9375 |  804.6875 |  446.54 KB |</span><br><span class="line">| OldFastDtw |      10000 | 877,853.287 us | 6,475.0945 us | 6,056.8074 us | 5000.0000 | 4000.0000 | 4000.0000 | 5976.72 KB |</span><br><span class="line">| NewFastDtw |      10000 | 644,914.650 us | 2,543.4351 us | 2,379.1308 us | 3000.0000 | 3000.0000 | 3000.0000 | 4208.01 KB |</span><br></pre></td></tr></table></figure><p>This is all the performance tuning I have for today.  My goal was to find some easy wins, and I did that.  It has been a nice little project to kick the new performance tooling tires.  I hope you’ve also found this interesting and I encourage you to check them out.  I think you’ll find they are a nice addition to the toolkit.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;The release of .NET Core version 3 contains some exciting cross-platform profiling tools.  Today I’ll use some of the newly available tools to target problem areas and improve performance of my &lt;a href=&quot;http://fsharp.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;F#&lt;/a&gt;-based library: FastDtw, as seen &lt;a href=&quot;/2019/10/11/FastDtw&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
    
      <category term="F#" scheme="http://codesuji.com/tags/F/"/>
    
      <category term="FSharp" scheme="http://codesuji.com/tags/FSharp/"/>
    
      <category term=".NET Core" scheme="http://codesuji.com/tags/NET-Core/"/>
    
      <category term="DTW" scheme="http://codesuji.com/tags/DTW/"/>
    
      <category term="Performance" scheme="http://codesuji.com/tags/Performance/"/>
    
  </entry>
  
  <entry>
    <title>FastDtw, an F# Implementation</title>
    <link href="http://codesuji.com/2019/10/11/FastDtw/"/>
    <id>http://codesuji.com/2019/10/11/FastDtw/</id>
    <published>2019-10-12T01:19:42.000Z</published>
    <updated>2020-10-26T12:08:49.970Z</updated>
    
    <content type="html"><![CDATA[<p>Today’s post is a short introduction into using FastDtw for Dynamic Time Warping analysis.  Specifically it is a quick introduction to using my newly released FastDtw package.</p><a id="more"></a><p>Dynamic Time Warping (DTW) can be a useful tool when comparing signals or series while adjusting for frequency variance.  One downside to the standard algorithm is it can be expensive.  There are many ways to mitigate the cost, FastDtw is one of them.  While other methods typically hard-cap parameters on the search space, FastDtw provides a dynamic approach to reducing the search space while maintaining a higher level of accuracy.  In this post I’ll discuss the usage of my <a href="https://fsharp.org" target="_blank" rel="noopener">F#</a> package implementation of the <a href="https://cs.fit.edu/~pkc/papers/tdm04.pdf" target="_blank" rel="noopener">FastDtw: Toward Accurate Dynamic Time Warping in Linear Time and Space</a> paper.  For those interested in the details, it is a pretty accessible paper.  FastDtw is technically an approximation, but its flexible pathing strategy provides good results with some significant performance improvements over basic DTW. </p><p>To get started, you will need to have <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core</a> installed.  Once this is complete the application can be setup.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dotnet new console -lang F# -n BitCoinTrends </span><br><span class="line">cd BitCoinThrends</span><br><span class="line">dotnet add package FastDtw</span><br></pre></td></tr></table></figure><p>As always, there is some basic setup.  I’ll include <code>FastDtw</code> (obviously), and a charting library for some series comparison visualizations.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> System</span><br><span class="line"><span class="keyword">open</span> System.IO</span><br><span class="line"><span class="keyword">open</span> FastDtw</span><br><span class="line"><span class="keyword">open</span> XPlot.GoogleCharts</span><br></pre></td></tr></table></figure><p>The example will take a csv of Bitcoin/USD conversion values and transform it into a list of datasets broken down by month.  The file is a 2010-2019 data download from <a href="https://finance.yahoo.com/quote/BTC-USD/history?p=BTC-USD" target="_blank" rel="noopener">Yahoo Finance</a>.  The format can be seen below, for today’s purposes I only care about the Data and Close fields. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Date,Open,High,Low,Close,Adj Close,Volume</span><br><span class="line">2010-07-17,0.049510,0.049510,0.049510,0.049510,0.049510,0</span><br></pre></td></tr></table></figure><p>I want to break the file into datasets by month.  Since this is just a small script I’ll make a mini file processing pipeline to group and normalize the data by converting to a percentage of the previous day.  This improves comparisons, especially with something as volatile as bitcoin. </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[&lt;EntryPoint&gt;]</span></span><br><span class="line"><span class="keyword">let</span> main argv =</span><br><span class="line">  <span class="comment">// Convert file to month-group datasets</span></span><br><span class="line">  <span class="keyword">let</span> dataSets =</span><br><span class="line">    File.ReadLines(<span class="string">"data/BTC-USD.csv"</span>)</span><br><span class="line">    |&gt; Seq.skip <span class="number">1</span> <span class="comment">// header</span></span><br><span class="line">    |&gt; Seq.map (<span class="keyword">fun</span> line -&gt;</span><br><span class="line">      <span class="comment">// Convert line to desired tuple</span></span><br><span class="line">      <span class="keyword">let</span> columns = line.Split ','</span><br><span class="line">      <span class="keyword">let</span> month = DateTime.Parse(columns.[<span class="number">0</span>]).ToString(<span class="string">"yyyy-MM"</span>)</span><br><span class="line">      <span class="keyword">let</span> closing = float (columns.[<span class="number">4</span>])</span><br><span class="line">      (month, closing))</span><br><span class="line">    |&gt; Seq.groupBy fst <span class="comment">// groupby month </span></span><br><span class="line">    |&gt; Seq.map (<span class="keyword">fun</span> (month, closingData) -&gt; </span><br><span class="line">      <span class="comment">// Aggregate grouped rows into their respective arrays</span></span><br><span class="line">      <span class="keyword">let</span> data = </span><br><span class="line">        closingData </span><br><span class="line">        |&gt; Seq.map snd <span class="comment">// extract closing</span></span><br><span class="line">        |&gt; Seq.mapFold (<span class="keyword">fun</span> (a: float option) x -&gt; </span><br><span class="line">          <span class="comment">// Convert closing values to % change from previous day</span></span><br><span class="line">          <span class="keyword">if</span> a.IsSome <span class="keyword">then</span> (x / a.Value, Some x) <span class="keyword">else</span> (<span class="number">0.</span>, Some x)) None</span><br><span class="line">        |&gt; fst</span><br><span class="line">        |&gt; Seq.toArray</span><br><span class="line"></span><br><span class="line">      (month, data))</span><br></pre></td></tr></table></figure><p>Once the datasets are loaded, it is time to see which month most closely mirrors the trend of 9/2019.  For all the other code in this post, this is really the highlight: <code>let distance = FastDtw.Distance targetData data radius</code>.  This is where the comparison happens.  Radius allows a configurable level of accuracy.  It controls the per point search space as the series are compared.  In most cases, distance is all that matters, but there are times when how the series match up can be useful.  The <code>DistanceWithPath</code> function provides the series’ indexes that pair together.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> targetMonth = <span class="string">"2019-09"</span></span><br><span class="line"><span class="keyword">let</span> radius = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> targetData =</span><br><span class="line">  dataSets</span><br><span class="line">  |&gt; Seq.filter (<span class="keyword">fun</span> (month, _) -&gt; month = targetMonth)</span><br><span class="line">  |&gt; Seq.head</span><br><span class="line">  |&gt; snd</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> compares = </span><br><span class="line">  dataSets</span><br><span class="line">  |&gt; Seq.filter (<span class="keyword">fun</span> (month, _) -&gt; month &lt;&gt; targetMonth) <span class="comment">// skip target</span></span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> (month, data)-&gt;</span><br><span class="line">    <span class="keyword">let</span> distance = FastDtw.Distance targetData data radius</span><br><span class="line">    (month, distance, data))</span><br><span class="line">  |&gt; Seq.sortBy snd3 <span class="comment">// Sort by compare result</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> randomData =</span><br><span class="line">  compares</span><br><span class="line">  |&gt; Seq.skip (Random().Next(Seq.length compares))</span><br><span class="line">  |&gt; Seq.head</span><br></pre></td></tr></table></figure><p>Once the comparisons have been completed, it is time to show some comparison charts.  I print out the top couple matches as well as a random match.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> showChart targetData compareData title seriesName =</span><br><span class="line">  <span class="keyword">let</span> dataToChartData data =</span><br><span class="line">    data </span><br><span class="line">    |&gt; Array.skip <span class="number">1</span> <span class="comment">// skip first entry (always 0)</span></span><br><span class="line">    |&gt; Array.mapi (<span class="keyword">fun</span> i x -&gt; (i, x)) </span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> targetChartData = targetData |&gt; dataToChartData</span><br><span class="line">  <span class="keyword">let</span> compareChartData = compareData |&gt; thd3 |&gt; dataToChartData</span><br><span class="line"></span><br><span class="line">  [targetChartData; compareChartData]</span><br><span class="line">  |&gt; Chart.Combo</span><br><span class="line">  |&gt; Chart.WithOptions (Options(title = sprintf <span class="string">"%s (%s)"</span> title (fst3 compareData), </span><br><span class="line">                                series = [| Series(<span class="string">"line"</span>); Series(<span class="string">"line"</span>) |]))</span><br><span class="line">  |&gt; Chart.WithLabels [<span class="string">"Target"</span>; seriesName ]</span><br><span class="line">  |&gt; Chart.WithLegend <span class="keyword">true</span></span><br><span class="line">  |&gt; Chart.WithSize (<span class="number">700</span>, <span class="number">250</span>)</span><br><span class="line">  |&gt; Chart.Show</span><br><span class="line"></span><br><span class="line">showChart targetData randomData <span class="string">"% Daily Change Comparison"</span> <span class="string">"Random Match"</span></span><br><span class="line"></span><br><span class="line">compares</span><br><span class="line">|&gt; Seq.take <span class="number">5</span></span><br><span class="line">|&gt; Seq.iteri (<span class="keyword">fun</span> i x -&gt;</span><br><span class="line">  showChart targetData x <span class="string">"% Daily Change Comparison"</span> (sprintf <span class="string">"Match %d"</span> i))</span><br><span class="line"></span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure><p>Once the code is in place, it is time to look at some of the results.  It is useful to not only see a good match, but an average match.  This helps with the contrast.  There is no guarantee there will be a good match, but of the months provided, 2012-10 isn’t a bad match to 2019-09, especially considering what a random match can produce.  If you squint a bit, you even can see the portions of similar trends over a month, if only the elapsed time and amplitude is different.</p><p><img src="/images/fastdtw1/best.png" alt="Best Match"></p><p><img src="/images/fastdtw1/second.png" alt="Second-Best Match"></p><p><img src="/images/fastdtw1/random.png" alt="Random Match"></p><p>Beyond the example, it is useful to see some of the performance differences with the stock DTW algorithm.  For this I setup a quick BenchmarkDotNet test.  The below results show the performance benefits.  FastDtw is a multi-pass algorithm, so it’s not surprising that on very short series it’s overhead makes it slower.  Comparisons for larger series get anywhere from 65% - 70% faster.  One possible downside of the current implementation is more allocations, thus the extra GC events.  This is one of those cases where the allocations can be reduced with a bit of refactoring, so this looks like a good place for future optimizations. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">|  Method | SeriesSize |             Mean |         Error |        StdDev |     Gen 0 |     Gen 1 |     Gen 2 |  Allocated |</span><br><span class="line">|-------- |----------- |-----------------:|--------------:|--------------:|----------:|----------:|----------:|-----------:|</span><br><span class="line">|     dtw |         10 |         3.555 us |     0.0198 us |     0.0175 us |    1.8654 |         - |         - |    2.86 KB |</span><br><span class="line">| fastDtw |         10 |         7.936 us |     0.0357 us |     0.0334 us |    3.9215 |         - |         - |    6.01 KB |</span><br><span class="line">|     dtw |        100 |       210.675 us |     0.5531 us |     0.5174 us |   59.0820 |         - |         - |   94.99 KB |</span><br><span class="line">| fastDtw |        100 |       145.968 us |     0.6435 us |     0.5704 us |   94.9707 |         - |         - |  149.76 KB |</span><br><span class="line">|     dtw |       1000 |    20,856.656 us |    66.5105 us |    58.9598 us |  593.7500 |  500.0000 |  500.0000 |  148.99 KB |</span><br><span class="line">| fastDtw |       1000 |     7,392.059 us |   137.4944 us |   135.0379 us | 1109.3750 |  828.1250 |  820.3125 |  446.05 KB |</span><br><span class="line">|     dtw |      10000 | 2,082,283.166 us | 3,328.7961 us | 2,950.8911 us |         - |         - |         - | 1483.73 KB |</span><br><span class="line">| fastDtw |      10000 |   653,825.530 us | 4,111.5875 us | 3,845.9815 us | 3000.0000 | 3000.0000 | 3000.0000 |  4134.2 KB |</span><br></pre></td></tr></table></figure><p>This has been a quick introduction into the FastDtw package.  I hope you’ve enjoyed this. Until next time.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Today’s post is a short introduction into using FastDtw for Dynamic Time Warping analysis.  Specifically it is a quick introduction to using my newly released FastDtw package.&lt;/p&gt;
    
    </summary>
    
    
      <category term="F#" scheme="http://codesuji.com/tags/F/"/>
    
      <category term="FSharp" scheme="http://codesuji.com/tags/FSharp/"/>
    
      <category term="DTW" scheme="http://codesuji.com/tags/DTW/"/>
    
      <category term="Dynamic Time Warping" scheme="http://codesuji.com/tags/Dynamic-Time-Warping/"/>
    
  </entry>
  
  <entry>
    <title>F# and ML.NET Regression</title>
    <link href="http://codesuji.com/2019/09/14/F-and-MLNet-Regression-V2/"/>
    <id>http://codesuji.com/2019/09/14/F-and-MLNet-Regression-V2/</id>
    <published>2019-09-14T11:23:03.000Z</published>
    <updated>2019-09-16T23:47:19.713Z</updated>
    
    <content type="html"><![CDATA[<p>Today I’ll look at using <a href="http://fsharp.org/" target="_blank" rel="noopener">F#</a> and <a href="https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet" target="_blank" rel="noopener">ML.NET</a> to perform some model building.  Specifically to predict concrete compressive strength based on its composite ingredients.  If this sounds familiar, it is.  This is a revisit of a previous <a href="/2018/06/09/F-and-MLNet-Regression/">post</a> that explored a beta version of ML.NET.  This time around, the version 1 interface will be used.</p><a id="more"></a><p>It has been on my list for awhile to revisit the ML.NET beta posts to see how things have changed as well as get a good example of code in the new, now version 1, world.  Here I’ll be looking at the <a href="/2018/06/09/F-and-MLNet-Regression/">Regression</a> post from last year.  The original plan was to perform a closer analysis of how things have changed over time.  But the reality is so much has changed that a line by line comparison won’t provide much value.  Instead, I’ve decided to just redo the post using ML.NET version 1.3 and show some interesting points along the way.  Before getting into it, the experience was definitely better this time around.  The improvements are obvious and I have been pleased with the progression the ML.NET team has made over time.  Without further adieu, make sure you have <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core version 2.2</a> installed.  If you don’t, head out to <a href="https://dot.net" target="_blank" rel="noopener">dot.net</a>, then navigating to <code>Downloads</code> and the <code>.NET Core SDK</code>.</p><p>Create the project and add the necessary ML.NET packages.  This will be a console app in F# (obviously).</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dotnet new console -lang F# -n MLNetConcreteV2</span><br><span class="line">cd MLNetConcreteV2</span><br><span class="line">dotnet add package Microsoft.ML --version 1.3</span><br><span class="line">dotnet add package Microsoft.ML.FastTree --version 1.3</span><br></pre></td></tr></table></figure><p>Before getting into the code, I first need to get the data.  The source used is from <a href="https://archive.ics.uci.edu/ml/datasets/Concrete+Compressive+Strength" target="_blank" rel="noopener">UCI</a>.  The dataset is an Excel file (xls), and it needs to be a csv.  I used <code>ssconvert</code> (from <code>apt install gnumeric</code>) to convert from Excel to CSV, but feel free to use whatever works for you.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir data &amp;&amp; cd data</span><br><span class="line">curl -O https://archive.ics.uci.edu/ml/machine-learning-databases/concrete/compressive/Concrete_Data.xls</span><br><span class="line">ssconvert Concrete_Data.xls Concrete_Data.csv</span><br></pre></td></tr></table></figure><p>Here is a sample of what the data looks like.  There is a header row, I’ve transposed this to a vertical list for readablity.  The first 8 columns are features, the last is the concrete compressive strength.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Header Row</span><br><span class="line">Cement (component 1)(kg in a m^3 mixture)</span><br><span class="line">Blast Furnace Slag (component 2)(kg in a m^3 mixture)</span><br><span class="line">Fly Ash (component 3)(kg in a m^3 mixture)</span><br><span class="line">Water  (component 4)(kg in a m^3 mixture)</span><br><span class="line">Superplasticizer (component 5)(kg in a m^3 mixture)</span><br><span class="line">Coarse Aggregate  (component 6)(kg in a m^3 mixture)</span><br><span class="line">Fine Aggregate (component 7)(kg in a m^3 mixture)</span><br><span class="line">Age (day)</span><br><span class="line">Concrete compressive strength(MPa, megapascals)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Data Rows</span><br><span class="line">540,0,0,162,2.5,1040,676,28,79.98611076</span><br><span class="line">540,0,0,162,2.5,1055,676,28,61.887365759999994</span><br><span class="line">332.5,142.5,0,228,0,932,594,270,40.269535256000005</span><br><span class="line">332.5,142.5,0,228,0,932,594,365,41.052779992</span><br></pre></td></tr></table></figure><p>Now that the project is setup and data is local, there is some foundational code that needs created.  F# can use record types for specifying the data format.  The <code>ConcreteData</code> record is effectively a file definition.  ML.NET requires the <code>LoadColumn</code> attribute for column mappings used during the dataload phase. The <code>ConcretePrediction</code> record is for prediction results.  Once the datatypes are setup, an <code>MLContext</code> object must be created. </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> System</span><br><span class="line"><span class="keyword">open</span> Microsoft.ML</span><br><span class="line"><span class="keyword">open</span> Microsoft.ML.Data</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">ConcreteData</span> </span>= &#123;</span><br><span class="line">  <span class="meta">[&lt;LoadColumn(0)&gt;]</span></span><br><span class="line">  Cement: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(1)&gt;]</span></span><br><span class="line">  Slag: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(2)&gt;]</span></span><br><span class="line">  Ash: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(3)&gt;]</span></span><br><span class="line">  Water: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(4)&gt;]</span></span><br><span class="line">  Superplasticizer: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(5)&gt;]</span></span><br><span class="line">  CoarseAggregate: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(6)&gt;]</span></span><br><span class="line">  FineAggregate: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(7)&gt;]</span></span><br><span class="line">  Age: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(8)&gt;]</span></span><br><span class="line">  Label: float32</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">ConcretePrediction</span> </span>= &#123;</span><br><span class="line">  Score: float32</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> context = MLContext()</span><br></pre></td></tr></table></figure><p>Data loading is a reasonably simple process.  I will use all of the data, but if I wanted to filter data, there is a <code>FilterRowsByColumn</code> method to exclude data, perhaps known bad data or outliers.  Additionally, there is a need for training and test datasets.  ML.NET provides a convenient <code>TrainTestSplit</code> method to generate those datasets.  Here I will take 10% of the records for a test set. </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dataPath = <span class="string">"./data/Concrete_Data.csv"</span></span><br><span class="line"><span class="keyword">let</span> allData = </span><br><span class="line">  context</span><br><span class="line">    .Data</span><br><span class="line">    .LoadFromTextFile&lt;ConcreteData&gt;(</span><br><span class="line">      path = dataPath,</span><br><span class="line">      hasHeader = <span class="keyword">true</span>,</span><br><span class="line">      separatorChar = ',')</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> filteredData = context.Data.FilterRowsByColumn(allData, <span class="string">"Slag"</span>, lowerBound = <span class="number">50.</span>, upperBound = <span class="number">100.</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> allDataSplit = context.Data.TrainTestSplit(allData, testFraction = <span class="number">0.1</span>)</span><br><span class="line"><span class="keyword">let</span> trainData = allDataSplit.TrainSet</span><br><span class="line"><span class="keyword">let</span> testData = allDataSplit.TestSet</span><br></pre></td></tr></table></figure><p>Time to build the data pipeline.  There are a couple things to look at here.  Multiple transformation actions will be applied to the data.  <code>Concatenate</code> provides a mechanism to build an aggregate field, specifically <code>Features</code>.  I also don’t want to take the data raw, I want to apply a normalization method against the columns to improve the prediction results.  To keep it simple, I am applying <code>NormalizeMeanVariance</code> to all of the targeted fields.  To do it right I should be more rigorous about my transformation choices.  Other possible normalization methods are <code>NormalizeLogMeanVariance</code>, <code>NormalizeLpNorm</code>, <code>NormalizeMinMax</code>, to name a few.  The data is already in numeric form, but if there were text fields, there are transformation methods for that as well.  An example of this could be: <code>Transforms.Categorical.OneHotEncoding(&quot;CementBrandName&quot;, &quot;CementBrandId&quot;)</code>.  I’ve only touched the surface on data transformation options, but there is generally something there for your specific needs.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> pipeline = </span><br><span class="line">  EstimatorChain()</span><br><span class="line">    .Append(context.Transforms.NormalizeMeanVariance(<span class="string">"Cement"</span>, <span class="string">"Cement"</span>))</span><br><span class="line">    .Append(context.Transforms.NormalizeMeanVariance(<span class="string">"Slag"</span>, <span class="string">"Slag"</span>))</span><br><span class="line">    .Append(context.Transforms.NormalizeMeanVariance(<span class="string">"Ash"</span>, <span class="string">"Ash"</span>))</span><br><span class="line">    .Append(context.Transforms.NormalizeMeanVariance(<span class="string">"Water"</span>, <span class="string">"Water"</span>))</span><br><span class="line">    .Append(context.Transforms.NormalizeMeanVariance(<span class="string">"Superplasticizer"</span>, <span class="string">"Superplasticizer"</span>))</span><br><span class="line">    .Append(context.Transforms.NormalizeMeanVariance(<span class="string">"CoarseAggregate"</span>, <span class="string">"CoarseAggregate"</span>))</span><br><span class="line">    .Append(context.Transforms.NormalizeMeanVariance(<span class="string">"FineAggregate"</span>, <span class="string">"FineAggregate"</span>))</span><br><span class="line">    .Append(context.Transforms.NormalizeMeanVariance(<span class="string">"Age"</span>, <span class="string">"Age"</span>))</span><br><span class="line">    .Append(context.Transforms.Concatenate(<span class="string">"Features"</span>, [|<span class="string">"Cement"</span>; <span class="string">"Slag"</span>; <span class="string">"Ash"</span>; <span class="string">"Water"</span>; <span class="string">"Superplasticizer"</span>; <span class="string">"CoarseAggregate"</span>; <span class="string">"FineAggregate"</span>; <span class="string">"Age"</span>|]))</span><br></pre></td></tr></table></figure><p>Once the data pipeline is configured, it is time to build a model trainer.  Again, ML.NET offers multiple options for training methods.  For the example I use <code>FastTreeTweedie</code> with no parameters.  Hyperparameter options are available for many of the trainers.  I show some additional examples of how to implement alternative trainers with and without hyperparameters.  Once the trainer is defined, it is appended to the pipeline.  Now is the time to create a trained model using <code>Fit</code> against the previously defined training data.  There is one last piece to make this process useful, the prediction engine.  This provides the mechanism to actually perform predictions.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> trainer = context.Regression.Trainers.FastTreeTweedie()</span><br><span class="line"></span><br><span class="line"><span class="comment">// FastTreeRegressor with hyperparameters</span></span><br><span class="line"><span class="keyword">let</span> trainer = context.Regression.Trainers.FastTreeTweedie(numberOfTrees = <span class="number">500</span>, minimumExampleCountPerLeaf = <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// OnlineGradientDescent </span></span><br><span class="line"><span class="keyword">let</span> trainer = context.Regression.Trainers.OnlineGradientDescent(labelColumnName = <span class="string">"Label"</span>, featureColumnName = <span class="string">"Features"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> modelBuilder = pipeline.Append(trainer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> model = modelBuilder.Fit(trainData) </span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> predictionEngine = context.Model.CreatePredictionEngine&lt;ConcreteData,ConcretePrediction&gt;(model)</span><br></pre></td></tr></table></figure><p>The next step is to see how good of a model has been built.  The trained model is now applied to the test data, and performance metrics are extracted.  I cherry-picked a couple of the available metrics. </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> predictions = model.Transform(testData)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> metrics = context.Regression.Evaluate(predictions)</span><br><span class="line"></span><br><span class="line">printfn <span class="string">"R-Squared: %f"</span> (metrics.RSquared)</span><br><span class="line">printfn <span class="string">"RMS      : %f"</span> (metrics.RootMeanSquaredError)</span><br><span class="line">printfn <span class="string">"Loss     : %f"</span> (metrics.LossFunction)</span><br><span class="line">printfn <span class="string">"MAE      : %f"</span> (metrics.MeanAbsoluteError)</span><br><span class="line">printfn <span class="string">"MSE      : %f"</span> (metrics.MeanSquaredError)</span><br></pre></td></tr></table></figure><p>Here are the evaluation metrics for the test data run.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">R-Squared: 0.920959</span><br><span class="line">RMS      : 4.875440</span><br><span class="line">Loss     : 23.769913</span><br><span class="line">MAE      : 2.682631</span><br><span class="line">MSE      : 23.769913</span><br></pre></td></tr></table></figure><p>The trained model is now something that can be used against data.  I pulled one of the rows from the data just to show how this is put together.  Again, I can use a record type to define the data.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> test1 = &#123;</span><br><span class="line">  Cement = <span class="number">198.6</span>f</span><br><span class="line">  Slag = <span class="number">132.4</span>f</span><br><span class="line">  Ash = <span class="number">0.</span>f</span><br><span class="line">  Water = <span class="number">192.</span>f</span><br><span class="line">  Superplasticizer = <span class="number">0.</span>f</span><br><span class="line">  CoarseAggregate = <span class="number">978.4</span>f</span><br><span class="line">  FineAggregate = <span class="number">825.5</span>f</span><br><span class="line">  Age = <span class="number">90.</span>f</span><br><span class="line">  Label =  <span class="number">0.</span>f</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> predictionTest1 = predictionEngine.Predict(test1)</span><br><span class="line">printfn <span class="string">"Predicted Strength: %f"</span> predictionTest1.Score</span><br><span class="line">printfn <span class="string">"Actual Strength   : 38.074243671999994"</span></span><br><span class="line">printfn <span class="string">""</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Predicted Strength: 39.541660</span><br><span class="line">Actual Strength   : 38.074243671999994</span><br></pre></td></tr></table></figure><p>A trained model isn’t much use if it can’t be passed around and used elsewhere.  That is where the ML.NET model save and load methods come into play.  They are both straight forward to use, what I’ve come to expect.  The same prediction as above is run, but this time on a model loaded from a file.  The circle is complete.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Save model to file</span></span><br><span class="line">context.Model.Save(model, trainData.Schema, <span class="string">"model.zip"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Load model from file</span></span><br><span class="line"><span class="keyword">let</span> (modelReloaded, schemaReloaded) = context.Model.Load(<span class="string">"model.zip"</span>)</span><br><span class="line"><span class="keyword">let</span> predictionEngineReloaded = context.Model.CreatePredictionEngine&lt;ConcreteData,ConcretePrediction&gt;(modelReloaded)</span><br><span class="line"><span class="keyword">let</span> predictionReloaded = predictionEngineReloaded.Predict(test1)</span><br><span class="line"></span><br><span class="line">printfn <span class="string">"Predicted Strength RL: %f"</span> predictionReloaded.Score</span><br><span class="line">printfn <span class="string">"Actual Strength      : 38.074243671999994"</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Predicted Strength RL: 39.541660</span><br><span class="line">Actual Strength      : 38.074243671999994</span><br></pre></td></tr></table></figure><p>It has been nice to revisit an old dataset and method, but with the newest ML.NET.  The ergonomics and functionality have certainly improved over time.  This bodes well for the future as they continue to release and improve functionality.  I hope you have found this useful as well, and perhaps enticed you to investigate ML.NET and F# for yourself.  Until next time.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Today I’ll look at using &lt;a href=&quot;http://fsharp.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;F#&lt;/a&gt; and &lt;a href=&quot;https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ML.NET&lt;/a&gt; to perform some model building.  Specifically to predict concrete compressive strength based on its composite ingredients.  If this sounds familiar, it is.  This is a revisit of a previous &lt;a href=&quot;/2018/06/09/F-and-MLNet-Regression/&quot;&gt;post&lt;/a&gt; that explored a beta version of ML.NET.  This time around, the version 1 interface will be used.&lt;/p&gt;
    
    </summary>
    
    
      <category term="F#" scheme="http://codesuji.com/tags/F/"/>
    
      <category term="FSharp" scheme="http://codesuji.com/tags/FSharp/"/>
    
      <category term=".NET Core" scheme="http://codesuji.com/tags/NET-Core/"/>
    
      <category term="Machine Learning" scheme="http://codesuji.com/tags/Machine-Learning/"/>
    
      <category term="MLNet" scheme="http://codesuji.com/tags/MLNet/"/>
    
  </entry>
  
  <entry>
    <title>Nyquist Keyboard Build</title>
    <link href="http://codesuji.com/2019/08/14/Nyquist-Keyboard/"/>
    <id>http://codesuji.com/2019/08/14/Nyquist-Keyboard/</id>
    <published>2019-08-14T22:14:16.000Z</published>
    <updated>2019-08-15T02:29:02.108Z</updated>
    
    <content type="html"><![CDATA[<p>Today’s topic is my most recent keyboard build, the <a href="https://keeb.io/" target="_blank" rel="noopener">keebio</a> Nyquist.  I had so much fun building my <a href="/2019/05/12/Iris-Keyboard/">Iris</a>, it was a good excuse to make a second so I can have a sweet keyboard at home and work.</p><a id="more"></a><p>Here is the final result, equipped with Gateron red switches and SA keycaps.  For those who might be interested doing a build themselves, keebio provides a thorough <a href="https://docs.keeb.io/nyquist-build-guide/" target="_blank" rel="noopener">Build Guide</a>.  Note, this is the same that I used for my previous Iris build.  From a general perspective, they are very similar keyboards, the bottom row format is oriented differently and the Nyquist just has a couple addtional keys. </p><p><img src="/images/nyquist1/final.jpg" alt="Nyquist - final result"></p><p>If you’re curious about the key mapping, checkout my <a href="/2019/05/12/Iris-Keyboard/#keymap">Iris Build</a>.  I kept the same mappings, with a couple exceptions. Esc, Print Screen, and Alt have been moved to the bottom left row.  Arrow keys were added on the bottom right row.  I thought I’d use dedicated arrow keys more, but they have been pretty much untouched.  Additionally, I prefer the new esc location; on the Iris’ thumbpad hasn’t been as convenient as I expected.</p><p>Beyond the stock keyboard build there are a couple custom components.  I only bought top and bottom plates, so I 3d-printed the case and stands to match my desired typing angle.  I designed them using <a href="http://www.openscad.org/" target="_blank" rel="noopener">OpenSCAD</a>.  The stl files are here: <a href="/images/nyquist1/case.stl">case</a> and <a href="/images/nyquist1/stand.stl">stand</a>.  My printer bed isn’t big enough for the case in one piece.  Since it’s symmetric the stl is half the case and I just mirrored it in <a href="https://ultimaker.com/software/ultimaker-cura" target="_blank" rel="noopener">Cura</a> for the other half.  Keeping with the purple/green color theme, I built the TRRS and USB cables to match, I think they really pull the whole thing together.</p><p>As a bonus, I’ve included a couple build process images.</p><p><img src="/images/nyquist1/final2.jpg" alt="Nyquist - final result"></p><p><img src="/images/nyquist1/stands.jpg" alt="Stands"></p><p><img src="/images/nyquist1/mounted_switches.jpg" alt="Mounted Switches"></p><p><img src="/images/nyquist1/pro_micro.jpg" alt="Mounted ProMicros"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Today’s topic is my most recent keyboard build, the &lt;a href=&quot;https://keeb.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;keebio&lt;/a&gt; Nyquist.  I had so much fun building my &lt;a href=&quot;/2019/05/12/Iris-Keyboard/&quot;&gt;Iris&lt;/a&gt;, it was a good excuse to make a second so I can have a sweet keyboard at home and work.&lt;/p&gt;
    
    </summary>
    
    
      <category term="Keyboard" scheme="http://codesuji.com/tags/Keyboard/"/>
    
  </entry>
  
  <entry>
    <title>Fable and Cordova, a Mobile Story</title>
    <link href="http://codesuji.com/2019/06/18/Fable-and-Cordova/"/>
    <id>http://codesuji.com/2019/06/18/Fable-and-Cordova/</id>
    <published>2019-06-18T23:24:02.000Z</published>
    <updated>2019-06-19T22:19:52.620Z</updated>
    
    <content type="html"><![CDATA[<p>Today’s article will look at combining <a href="https://fable.io/" target="_blank" rel="noopener">Fable</a> and <a href="https://cordova.apache.org/" target="_blank" rel="noopener">Cordova</a> to make a mobile application.  For those not familar with these projects, a little context may be helpful.  Fable compiles F# to Javascript and Cordova facilitates mobile app development using HTML and Javascript.  Throw in some <a href="https://elmish.github.io/" target="_blank" rel="noopener">Elmish</a>, and its a party.  Joining these technologies provides some unique possibilities.  Specifically this is an interesting way to leverage <a href="https://fsharp.org" target="_blank" rel="noopener">F#</a> for mobile development.  </p><a id="more"></a><p>The goal will be to make a very simple hello world mobile app.  There are a couple steps to get there, none of which are too complicated.  To follow along, you will need the following prerequisites.  Make sure you have <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core</a> and <a href="https://nodejs.org/en/" target="_blank" rel="noopener">NodeJs</a> installed.  Next, Cordova must be installed: <code>npm install -g cordova</code>.  Now that the building blocks are installed, it is time to get started.</p><p>First, the Cordova project will be created and initialized with the supported platforms.  <code>browser</code> is useful for the development process, while <code>android</code> is the real target.  If you’re of an iOS leaning, it can be the mobile target instead, or as an addition.  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cordova create HelloWorld</span><br><span class="line">cd HelloWorld</span><br><span class="line">cordova platform add browser</span><br><span class="line">cordova platform add android</span><br><span class="line"># For iOS support: cordova platform add ios </span><br></pre></td></tr></table></figure><p>Second, the Fable part of the project needs created. From inside the main project, create a new F# app and add the basic Fable requirements.  The requirements come in two parts: dotnet and javascript.  For this sample app this will be all that is needed, although a fuller functional app may have more dependencies.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dotnet new console -lang F# -n App</span><br><span class="line">cd App</span><br><span class="line">dotnet add package Fable.Core</span><br><span class="line">dotnet add package Fable.Elmish.React</span><br></pre></td></tr></table></figure><p>In the main project directory add the javascript dependencies.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">npm install fable-compiler --save</span><br><span class="line">npm install fable-loader --save</span><br><span class="line">npm install @babel/core --save</span><br><span class="line">npm install react --save</span><br><span class="line">npm install react-dom --save</span><br></pre></td></tr></table></figure><p>Third, it is time to wire the projects together, which is where webpack enters the picture.  The Fable sample project already uses webpack, the config just needs some adjustments in order to publish the results to cordova (instead of a website).</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install webpack  --save</span><br><span class="line">npm install webpack-cli  --save</span><br></pre></td></tr></table></figure><p>In the main project directory, webpack needs a config file <code>webpack.config.js</code> file with the following contents.  This tells webpack to process the newly create F# app project, and use the fable-loader to process files.  The destination bundle file generated is placed in Cordova’s <code>www/js</code> directory.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">"development"</span>,</span><br><span class="line">  entry: <span class="string">"./App/App.fsproj"</span>,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.join(__dirname, <span class="string">"./www/js"</span>),</span><br><span class="line">    filename: <span class="string">"bundle.js"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.fs(x|proj)?$/</span>,</span><br><span class="line">      use: <span class="string">"fable-loader"</span></span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The project directory should look something like this:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">HelloWorld</span><br><span class="line">├── App</span><br><span class="line">│   ├── App.fsproj</span><br><span class="line">│   └── Program.fs</span><br><span class="line">├── config.xml</span><br><span class="line">├── hooks</span><br><span class="line">├── node_modules</span><br><span class="line">├── package.json</span><br><span class="line">├── package-lock.json</span><br><span class="line">├── platforms</span><br><span class="line">├── plugins</span><br><span class="line">├── webpack.config.js</span><br><span class="line">└── www</span><br><span class="line">    ├── css</span><br><span class="line">    ├── img</span><br><span class="line">    ├── index.html</span><br><span class="line">    └── js</span><br></pre></td></tr></table></figure><p>Now that the main project structures have been put into place, it is time to put the code together.  The Cordova project needs to be able to consume the generated Fable bundle created by webpack.  This is done by editing the Cordova index page <code>www/index.html</code>.  The contents can be reduced to below.  The key points here are the <code>elmish-app</code> div and the <code>bundle.js</code> include.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'uns</span></span></span><br><span class="line"><span class="tag"><span class="string">  afe-inline'; media-src *; img-src 'self' data: content:;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"format-detection"</span> <span class="attr">content</span>=<span class="string">"telephone=no"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"msapplication-tap-highlight"</span> <span class="attr">content</span>=<span class="string">"no"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"initial-scale=1, width=device-width, viewport-fit=cover"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"css/index.css"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"elmish-app"</span> <span class="attr">class</span>=<span class="string">"elmish-app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"cordova.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"js/index.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/bundle.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Cordova is set to accept some Fable code, now it is time to get to the F#.  The contents of <code>App/Program.fs</code> are below.  Since this is about wiring Fable to Cordova I don’t want to spend too much time on the specific F# code.  But the code takes a person’s name as input and replies with a Hello message.  To add a bit of mobile flavor, it also tracks current acceleration of the device using the <code>devicemotion</code> event, and publishes that to the screen as well.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> App</span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> System</span><br><span class="line"><span class="keyword">open</span> Browser</span><br><span class="line"><span class="keyword">open</span> Browser.Types</span><br><span class="line"><span class="keyword">open</span> Elmish</span><br><span class="line"><span class="keyword">open</span> Elmish.React</span><br><span class="line"><span class="keyword">open</span> Fable.React</span><br><span class="line"><span class="keyword">open</span> Fable.React.Props</span><br><span class="line"><span class="keyword">open</span> Fable.Import</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Model</span> </span>= </span><br><span class="line">  &#123; Name :string; Message :string; Acceleration :string &#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Msg</span> </span>=</span><br><span class="line">| Greet <span class="keyword">of</span> string</span><br><span class="line">| DeviceMotion <span class="keyword">of</span> float * float * float</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> initModel() = </span><br><span class="line">  &#123; Model.Name = <span class="string">""</span>; Message = <span class="string">""</span>; Acceleration = <span class="string">""</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> newMessage (name :string) = </span><br><span class="line">  sprintf <span class="string">"Hello %s, it is %s"</span> name (DateTime.Now.ToString(<span class="string">"yyyy-MM-dd"</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> newAcceleration x y z = </span><br><span class="line">  sprintf <span class="string">"Acceleration: (%0.3f, %0.3f, %0.3f)"</span> x y z</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> updateModel (msg :Msg) (model :Model) =</span><br><span class="line">    <span class="keyword">match</span> msg <span class="keyword">with</span></span><br><span class="line">    | Greet(name)           -&gt; &#123; model <span class="keyword">with</span> </span><br><span class="line">                                  Name = name; </span><br><span class="line">                                  Message = newMessage name &#125;</span><br><span class="line">    | DeviceMotion(x, y, z) -&gt; &#123; model <span class="keyword">with</span> </span><br><span class="line">                                  Acceleration = newAcceleration x y z &#125;</span><br><span class="line"><span class="keyword">let</span> view (model :Model) dispatch =</span><br><span class="line">  div []</span><br><span class="line">    [</span><br><span class="line">      div []</span><br><span class="line">        [</span><br><span class="line">          str <span class="string">"My name is:"</span></span><br><span class="line">          input </span><br><span class="line">            [ </span><br><span class="line">              AutoFocus <span class="keyword">true</span></span><br><span class="line">              OnInput (<span class="keyword">fun</span> e -&gt; dispatch (Greet ((e.target:?&gt;HTMLInputElement).value)))</span><br><span class="line">              Value (model.Name)</span><br><span class="line">            ]</span><br><span class="line">        ]</span><br><span class="line">      div []</span><br><span class="line">        [</span><br><span class="line">          str model.Message</span><br><span class="line">          br []</span><br><span class="line">          str model.Acceleration</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> deviceMotion initial = </span><br><span class="line">    <span class="keyword">let</span> sub dispatch =</span><br><span class="line">        window.addEventListener(<span class="string">"devicemotion"</span>, <span class="keyword">fun</span> e -&gt;</span><br><span class="line">          <span class="keyword">let</span> e' = e :?&gt; DeviceMotionEvent</span><br><span class="line">          dispatch (DeviceMotion (e'.acceleration.x, e'.acceleration.y, e'.acceleration.z)))</span><br><span class="line">    Cmd.ofSub sub</span><br><span class="line"></span><br><span class="line">Program.mkSimple initModel updateModel view</span><br><span class="line">|&gt; Program.withReactBatched <span class="string">"elmish-app"</span></span><br><span class="line">|&gt; Program.withSubscription deviceMotion</span><br><span class="line">|&gt; Program.withConsoleTrace</span><br><span class="line">|&gt; Program.run</span><br></pre></td></tr></table></figure><p>All that is left now is to build and run the app.  There are a couple things to keep track of: building the Fable app with webpack, running the app in the browser for development, and building.  The commands below touch the surface of development and building, but they at least get you started. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Run webpack on the fable app</span><br><span class="line">npx webpack</span><br><span class="line"></span><br><span class="line"># Run cordova in the browser</span><br><span class="line">cordova run browser</span><br><span class="line"></span><br><span class="line"># Build and run on the phone or emulator</span><br><span class="line">cordova build android</span><br><span class="line">cordova run android</span><br><span class="line"></span><br><span class="line"># Install it on the phone</span><br><span class="line">adb install </span><br></pre></td></tr></table></figure><p>A running app looks like this:</p><p><img src="/images/cordova1/cordova1.png" alt="Cordova App"></p><p>Being able to build is great, but development can be cumbersome without the ability to watch and auto-build file changes.  Taking the next step, let’s add some convenience to the process.  Add the following to <code>package.json</code>.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">"watch"</span>: <span class="string">"npx webpack -w"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The above command is just the interface, it needs some modifications to <code>webpack.config.js</code> to perform the desired actions. The below changes wire into the <code>afterEmit</code> hook to refresh the cordova browser (and start the local service if not already started).  The <code>watchOptions</code> aren’t strictly needed for this, but it helps to stop rebuild spamming, and lower file watch needs.  These values can be tuned more for specific needs.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> exec = <span class="built_in">require</span>(<span class="string">"child_process"</span>).exec;</span><br><span class="line"><span class="keyword">var</span> cordovaServerStarted = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  watchOptions: &#123;</span><br><span class="line">    aggregateTimeout: <span class="number">500</span>,</span><br><span class="line">    ignored: [ <span class="string">"node_modules"</span> ]</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    &#123;</span><br><span class="line">      apply: <span class="function">(<span class="params">compiler</span>) =&gt;</span> &#123;</span><br><span class="line">        compiler.hooks.afterEmit.tap(<span class="string">"AfterEmitPlugin"</span>, (_compilation) =&gt; &#123;</span><br><span class="line">          exec(<span class="string">"cordova prepare browser"</span>, (err, stdout, stderr) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (stdout) &#123; process.stdout.write(stdout); &#125;</span><br><span class="line">            <span class="keyword">if</span> (stderr) &#123; process.stderr.write(stderr); &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">  </span><br><span class="line">          <span class="keyword">if</span> (!cordovaServerStarted) &#123;</span><br><span class="line">            cordovaServerStarted = <span class="literal">true</span>;</span><br><span class="line">            exec(<span class="string">"cordova run browser"</span>, (err, stdout, stderr) =&gt; &#123;</span><br><span class="line">              <span class="keyword">if</span> (stdout) &#123; process.stdout.write(stdout); &#125;</span><br><span class="line">              <span class="keyword">if</span> (stderr) &#123; process.stderr.write(stderr); &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Now, a simple <code>npm run watch</code> will start the Cordova browser, watch for application updates, and auto-build as files are edited.  The development process just got way easier.  As a reminder, this is just a sample; more goes into properly building everything out.  With that said, this provides a good starting point to getting F# running on mobile using Cordova.  I hope you found this useful and/or interesting.  Until next time…</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Today’s article will look at combining &lt;a href=&quot;https://fable.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Fable&lt;/a&gt; and &lt;a href=&quot;https://cordova.apache.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Cordova&lt;/a&gt; to make a mobile application.  For those not familar with these projects, a little context may be helpful.  Fable compiles F# to Javascript and Cordova facilitates mobile app development using HTML and Javascript.  Throw in some &lt;a href=&quot;https://elmish.github.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Elmish&lt;/a&gt;, and its a party.  Joining these technologies provides some unique possibilities.  Specifically this is an interesting way to leverage &lt;a href=&quot;https://fsharp.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;F#&lt;/a&gt; for mobile development.  &lt;/p&gt;
    
    </summary>
    
    
      <category term="F#" scheme="http://codesuji.com/tags/F/"/>
    
      <category term="FSharp" scheme="http://codesuji.com/tags/FSharp/"/>
    
      <category term="Fable" scheme="http://codesuji.com/tags/Fable/"/>
    
      <category term="Elmish" scheme="http://codesuji.com/tags/Elmish/"/>
    
      <category term="Cordova" scheme="http://codesuji.com/tags/Cordova/"/>
    
      <category term="Mobile" scheme="http://codesuji.com/tags/Mobile/"/>
    
  </entry>
  
  <entry>
    <title>Taking Stock of Anomalies with F# and ML.NET</title>
    <link href="http://codesuji.com/2019/05/24/F-and-MLNet-Anomaly/"/>
    <id>http://codesuji.com/2019/05/24/F-and-MLNet-Anomaly/</id>
    <published>2019-05-24T14:34:25.000Z</published>
    <updated>2019-05-25T11:32:18.259Z</updated>
    
    <content type="html"><![CDATA[<p>Today’s task is to analyze stock prices, specifically price anomalies.  Recently <a href="https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet" target="_blank" rel="noopener">ML.NET</a> hit version 1.  So what better way than to use <a href="https://fsharp.org" target="_blank" rel="noopener">F#</a> and <a href="https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet" target="_blank" rel="noopener">ML.NET</a>.</p><a id="more"></a><p>As always, the preliminaries.  For the initial setup, make sure you have <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core version 2.2</a> installed.  If you don’t, head out to the <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core Downloads</a> page.  Select <strong>SDK</strong> for your platform.  The specific methods will use the ML.NET TimeSeries package.  At the time of this writing, it is v0.12, so it hasn’t hit version 1 yet, but it works well enough.  Once that is complete, create a console F# project, then add the necessary ML.NET and Charting packages.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dotnet new console --language F# --name MLNet_StockAnomaly</span><br><span class="line">cd MLNet_StockAnomaly</span><br><span class="line">dotnet add package Microsoft.ML --version 1.0.0</span><br><span class="line">dotnet add package Microsoft.ML.TimeSeries --version 0.12.0</span><br><span class="line">dotnet add package XPlot.GoogleCharts --version 2.0.0</span><br></pre></td></tr></table></figure><p>In order to not pick on one particular stock, the Dow Jones index over the past year will be the target of interest.  Below is a sample of what the data extract looks like.  It is the basic stock price data to be expected, including date, prices, and volume.  This article will only need Date and Close price.  It was exported from <a href="https://finance.yahoo.com/quote/%5EDJI?p=^DJI&amp;.tsrc=fin-srch" target="_blank" rel="noopener">Yahoo! Finance</a>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Data Rows</span><br><span class="line">Date,Open,High,Low,Close,Adj Close,Volume</span><br><span class="line">2018-05-22,25047.550781,25064.990234,24812.060547,24834.410156,24834.410156,288200000</span><br><span class="line">2018-05-23,24757.710938,24889.460938,24667.119141,24886.810547,24886.810547,399610000</span><br><span class="line">2018-05-24,24877.359375,24877.359375,24605.900391,24811.759766,24811.759766,347050000</span><br><span class="line">2018-05-25,24781.289063,24824.220703,24687.810547,24753.089844,24753.089844,257210000</span><br><span class="line">2018-05-29,24606.589844,24635.179688,24247.839844,24361.449219,24361.449219,395810000</span><br><span class="line">2018-05-30,24467.830078,24714.480469,24459.089844,24667.779297,24667.779297,324870000</span><br></pre></td></tr></table></figure><p>Time to start the code.  First, I need to setup the necessary namespaces and types.  These cover the ML.NET namespaces as well as XPlot for charting the results.  When using ML.NET, the easiest way to interact with the data is by defining two types.  <code>PriceData</code> matches the datafile schema.  <code>PricePrediction</code> is for the model results, in this case I’ll use it for both anomaly detection and change point detection results.  The <code>Prediction</code> field is an array containing a 0 or 1 for a detected event, the value at that datapoint, and its respective confidence level. </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> Microsoft.ML</span><br><span class="line"><span class="keyword">open</span> Microsoft.ML.Data</span><br><span class="line"><span class="keyword">open</span> Microsoft.ML.Transforms.TimeSeries</span><br><span class="line"><span class="keyword">open</span> XPlot.GoogleCharts</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">PriceData</span> </span>() =</span><br><span class="line">    <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">    <span class="meta">[&lt;LoadColumn(0)&gt;]</span></span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Date:string</span><br><span class="line"></span><br><span class="line">    <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">    <span class="meta">[&lt;LoadColumn(1)&gt;]</span></span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Open:float32</span><br><span class="line"></span><br><span class="line">    <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">    <span class="meta">[&lt;LoadColumn(2)&gt;]</span></span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> High:float32</span><br><span class="line"></span><br><span class="line">    <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">    <span class="meta">[&lt;LoadColumn(3)&gt;]</span></span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Low:float32</span><br><span class="line"></span><br><span class="line">    <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">    <span class="meta">[&lt;LoadColumn(4)&gt;]</span></span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Close:float32</span><br><span class="line"></span><br><span class="line">    <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">    <span class="meta">[&lt;LoadColumn(5)&gt;]</span></span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> AdjClose:float32</span><br><span class="line"></span><br><span class="line">    <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">    <span class="meta">[&lt;LoadColumn(6)&gt;]</span></span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Volume:float32</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">PricePrediction</span> </span>() =</span><br><span class="line">    <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Date:string</span><br><span class="line"></span><br><span class="line">    <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Prediction:double[]</span><br></pre></td></tr></table></figure><p>Once that is done, it is time for the processing pipeline.  This includes creating the pipeline context and hooking up the data to the file.</p><p>To process the data, there will technically be two pipelines.  The first will use the <code>IidSpike</code> trainer for anomaly detection.  The second will use the <code>IidChangePoint</code> trainer for change point detection.  To get the best results, these aren’t really fire and forget approaches.  There are a couple dials to adjust.  The <code>pvalueHistoryLength</code> defines the sliding window size that is applied when looking for events.  Since this is stock data, multiples of 5 roughly correlate to weeks.  So at anomalies over 6 week windows, and change points over 2 week windows.  Additionally, <code>confidence</code> is on a scale 0-100, higher values requiring a higher level of confidence to trigger an event.  Another dial to turn is <code>AnomalySide</code> to detect either only postive, only negative, or all anomalies.  The default is all, but it’s nice to have options.  All of these values should be adjusted to best meet the needs of the dataset and desired data analysis.  </p><p>Once the pipelines are created, they need to be trained with the <code>Fit</code> method.  Now there is a model that can be used.  <code>Transform</code> will take the dataset and apply the model to build out predictions for the events.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dataPath = <span class="string">"dji.csv"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ctx = MLContext()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> dataView = </span><br><span class="line">  ctx</span><br><span class="line">    .Data</span><br><span class="line">    .LoadFromTextFile&lt;PriceData&gt;(</span><br><span class="line">      path = dataPath,</span><br><span class="line">      hasHeader = <span class="keyword">true</span>,</span><br><span class="line">      separatorChar = ',')</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> anomalyPValueHistoryLength = <span class="number">30</span></span><br><span class="line"><span class="keyword">let</span> changePointPValueHistoryLength = <span class="number">10</span></span><br><span class="line"><span class="keyword">let</span> anomalyConfidence = <span class="number">95</span></span><br><span class="line"><span class="keyword">let</span> changePointConfidence = <span class="number">95</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> anomalyPipeline = </span><br><span class="line">  ctx</span><br><span class="line">    .Transforms</span><br><span class="line">    .DetectIidSpike(</span><br><span class="line">      outputColumnName = <span class="string">"Prediction"</span>,</span><br><span class="line">      inputColumnName = <span class="string">"Close"</span>,</span><br><span class="line">      side = AnomalySide.TwoSided,</span><br><span class="line">      confidence = anomalyConfidence, </span><br><span class="line">      pvalueHistoryLength = anomalyPValueHistoryLength)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> changePointPipeLine = </span><br><span class="line">  ctx</span><br><span class="line">    .Transforms</span><br><span class="line">    .DetectIidChangePoint(</span><br><span class="line">      outputColumnName = <span class="string">"Prediction"</span>, </span><br><span class="line">      inputColumnName = <span class="string">"Close"</span>,</span><br><span class="line">      martingale = MartingaleType.Power,</span><br><span class="line">      confidence = changePointConfidence, </span><br><span class="line">      changeHistoryLength = changePointPValueHistoryLength)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> trainedAnomalyModel = anomalyPipeline.Fit(dataView)</span><br><span class="line"><span class="keyword">let</span> trainedChangePointModel = changePointPipeLine.Fit(dataView)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> transformedAnomalyData = trainedAnomalyModel.Transform(dataView);</span><br><span class="line"><span class="keyword">let</span> transformedChangePointData = trainedChangePointModel.Transform(dataView);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> anomalies = </span><br><span class="line">  ctx</span><br><span class="line">    .Data</span><br><span class="line">    .CreateEnumerable&lt;PricePrediction&gt;(transformedAnomalyData, reuseRowObject = <span class="keyword">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> changePoints = </span><br><span class="line">  ctx</span><br><span class="line">    .Data</span><br><span class="line">    .CreateEnumerable&lt;PricePrediction&gt;(transformedChangePointData, reuseRowObject = <span class="keyword">false</span>)</span><br></pre></td></tr></table></figure><p>Now that the data has been processed, it is time to build some charts and look at the results.  At this point, it is an exercise of formatting the data for charts, a <code>(Date * float32) list</code>.  There are 3 datasets: prices, anomalies, and change points.  Using XPlot, they are combined into a single chart.  The only trick here is I remove the non-events from the prediction datasets and plot their points directly on the price line chart.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Build chart data</span></span><br><span class="line"><span class="keyword">let</span> priceChartData = </span><br><span class="line">  anomalies</span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> p -&gt; <span class="keyword">let</span> p' = float (p.Prediction).[<span class="number">1</span>]</span><br><span class="line">                       (p.Date, p'))</span><br><span class="line">  |&gt; List.ofSeq </span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> anomalyChartData = </span><br><span class="line">  anomalies</span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> p -&gt; <span class="keyword">let</span> p' = <span class="keyword">if</span> (p.Prediction).[<span class="number">0</span>] = <span class="number">0.</span> <span class="keyword">then</span> None <span class="keyword">else</span> Some (float (p.Prediction).[<span class="number">1</span>])</span><br><span class="line">                       (p.Date, p'))</span><br><span class="line">  |&gt; Seq.filter (<span class="keyword">fun</span> (x,y) -&gt; y.IsSome)</span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> (x,y) -&gt; (x, y.Value))</span><br><span class="line">  |&gt; List.ofSeq </span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> changePointChartData = </span><br><span class="line">  changePoints </span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> p -&gt; <span class="keyword">let</span> p' = <span class="keyword">if</span> (p.Prediction).[<span class="number">0</span>] = <span class="number">0.</span> <span class="keyword">then</span> None <span class="keyword">else</span> Some (float (p.Prediction).[<span class="number">1</span>])</span><br><span class="line">                       (p.Date, p'))</span><br><span class="line">  |&gt; Seq.filter (<span class="keyword">fun</span> (x,y) -&gt; y.IsSome)</span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> (x,y) -&gt; (x, y.Value))</span><br><span class="line">  |&gt; List.ofSeq </span><br><span class="line"></span><br><span class="line"><span class="comment">// Show Chart</span></span><br><span class="line">[priceChartData; anomalyChartData; changePointChartData]</span><br><span class="line">|&gt; Chart.Combo</span><br><span class="line">|&gt; Chart.WithOptions </span><br><span class="line">     (Options(title = <span class="string">"Dow Jones Industrial Average Price Anomalies"</span>, </span><br><span class="line">              series = [| Series(<span class="string">"lines"</span>); Series(<span class="string">"scatter"</span>); Series(<span class="string">"scatter"</span>) |],</span><br><span class="line">              displayAnnotations = <span class="keyword">true</span>))</span><br><span class="line">|&gt; Chart.WithLabels [<span class="string">"Price"</span>; <span class="string">"Anomaly"</span>; <span class="string">"ChangePoint"</span> ]</span><br><span class="line">|&gt; Chart.WithLegend <span class="keyword">true</span></span><br><span class="line">|&gt; Chart.WithSize (<span class="number">800</span>, <span class="number">400</span>)</span><br><span class="line">|&gt; Chart.Show</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Here is the resulting Dow Jones price chart for the last year, using the defined models.  Based on the sliding windows and required confidence levels, there are now potentially useful events.</p><p><img src="/images/anomaly1/anomaly1.png" alt="Price Chart (Take 1)"></p><p>Charts offer a convenient way to see how some of those earlier parameters can impact the result.  I’ve reduced the sliding windows by half to 15 (3 weeks) and 5 (1 week), anomaly and changepoints, respectively.  The below chart shows the results of the change.  The anomalies haven’t changed too much, but the changepoints are much more reactive to direction changes.  One key take away here is there isn’t a single right configuration.  It is imperative to understand what types of outliers and attributes are important.</p><p><img src="/images/anomaly1/anomaly2.png" alt="Price Chart (Take 2)"></p><p>I hope you have found this short look into timeseries processing using ML.NET useful.</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Today’s task is to analyze stock prices, specifically price anomalies.  Recently &lt;a href=&quot;https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ML.NET&lt;/a&gt; hit version 1.  So what better way than to use &lt;a href=&quot;https://fsharp.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;F#&lt;/a&gt; and &lt;a href=&quot;https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ML.NET&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
    
      <category term="F#" scheme="http://codesuji.com/tags/F/"/>
    
      <category term="FSharp" scheme="http://codesuji.com/tags/FSharp/"/>
    
      <category term=".NET Core" scheme="http://codesuji.com/tags/NET-Core/"/>
    
      <category term="Machine Learning" scheme="http://codesuji.com/tags/Machine-Learning/"/>
    
      <category term="Signals" scheme="http://codesuji.com/tags/Signals/"/>
    
      <category term="MLNet" scheme="http://codesuji.com/tags/MLNet/"/>
    
      <category term="Timeseries" scheme="http://codesuji.com/tags/Timeseries/"/>
    
  </entry>
  
  <entry>
    <title>Iris Keyboard Build</title>
    <link href="http://codesuji.com/2019/05/12/Iris-Keyboard/"/>
    <id>http://codesuji.com/2019/05/12/Iris-Keyboard/</id>
    <published>2019-05-12T11:09:26.000Z</published>
    <updated>2019-08-15T01:41:49.720Z</updated>
    
    <content type="html"><![CDATA[<p>Deviating from the typical code-centric post, I wanted to share my latest keyboard build.  It is the Iris from <a href="https://keeb.io/" target="_blank" rel="noopener">keebio</a>.  </p><a id="more"></a><p>Here is the final result, equipped with Kailh speed silver switches and DSA keycaps.  For those who might be interested doing a build themselves, keebio provides a thorough <a href="https://docs.keeb.io/iris-build-guide/" target="_blank" rel="noopener">Build Guide</a>.</p><p><img src="/images/iris1/final.jpg" alt="Iris - final result"></p><p>A build isn’t complete without a key mapping.  Below is the current iteration of layer definitions, using <a href="https://github.com/qmk/qmk_firmware/" target="_blank" rel="noopener">QMK firmware</a>.  Finding the best layout can be a continual work in progress, but I’m happy with the layout so far.  </p><p><a name="keymap"></a></p><p><img src="/images/iris1/keymap_layer0.jpg" alt="Keymap - Layer0"></p><p><img src="/images/iris1/keymap_layer1.jpg" alt="Keymap - Layer1"></p><p><img src="/images/iris1/keymap_layer2.jpg" alt="Keymap - Layer2"></p><p>As a bonus, I’ve included a couple build process images, shown in reverse chronological order.</p><p><img src="/images/iris1/mounted_switches.jpg" alt="Mounted Switches"></p><p><img src="/images/iris1/mounting_switches.jpg" alt="Mounting Switches"></p><p><img src="/images/iris1/pro_micro.jpg" alt="Mounted ProMicros"></p><p><img src="/images/iris1/boards.jpg" alt="Circuit Boards"></p><p><img src="/images/iris1/switches.jpg" alt="Kailh Speed Silver Switches"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Deviating from the typical code-centric post, I wanted to share my latest keyboard build.  It is the Iris from &lt;a href=&quot;https://keeb.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;keebio&lt;/a&gt;.  &lt;/p&gt;
    
    </summary>
    
    
      <category term="Keyboard" scheme="http://codesuji.com/tags/Keyboard/"/>
    
  </entry>
  
  <entry>
    <title>Building a Game with SignalR and F#</title>
    <link href="http://codesuji.com/2019/02/19/Building-Game-with-SignalR-and-F/"/>
    <id>http://codesuji.com/2019/02/19/Building-Game-with-SignalR-and-F/</id>
    <published>2019-02-20T02:17:32.000Z</published>
    <updated>2019-02-20T12:15:17.379Z</updated>
    
    <content type="html"><![CDATA[<p>Today’s post is a brief example of how to implement a game using <a href="https://fsharp.org" target="_blank" rel="noopener">F#</a> and <a href="https://dotnet.microsoft.com/apps/aspnet/real-time" target="_blank" rel="noopener">SignalR</a>.  Creating a game for bots to play doesn’t have to be overly difficult.  Since interesting emergent qualities can arise from simple rules, it makes for a fun way to show off SignalR, beyond the standard chat application.  As this post will show, F# and SignalR work well together to create a nice communication framework without requiring a complex setup.</p><a id="more"></a><p>What is the game?  It is a bot-played game of multi-player snakes.  The rules are simple: eat food to grow, and run into opponents to slice off their tails.  To give players a goal, they accrue points based on their length over time.  It is a limited enough concept that a game engine and client can be built without overshadowing the SignalR aspects.  A picture, or movie, is worth a thousand words. So below is a sample of the game player viewer.  What is SignalR?  If you’re not familiar, it is a library that provides real-time capabilities to web applications.  Think websockets and other related technologies.  In this particular case there is a web viewer and a console app leveraging the capability.</p><p><img src="/images/sr1/sr1.gif" alt="GamePlay"></p><p>With definitions out of the way, time for the technical components.  We’ll use <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core version 2.2</a>.  If you don’t have it installed, head out to the <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core Downloads</a> page.  Select <strong>SDK</strong> for your platform.  Tangential, but you can also get here by going to <a href="https://dot.net" target="_blank" rel="noopener">dot.net</a>, then navigating to <code>Downloads</code> and <code>.NET Core</code>.</p><p>The post will be broken up into 3 primary parts: SignalR server, SignalR client, SignalR webviewer.  Discussing the specific game code will be out of scope, since it is the interactions that we really care about.</p><h1 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h1><p>For the server, <a href="https://github.com/giraffe-fsharp/Giraffe" target="_blank" rel="noopener">Giraffe</a> will be the base.  It will host the SignalR services as well as the weS viewer.  Creation is similiar to a typical dotnet app, but it’ll use the Giraffe template.  If you need the templates you can get them by doing <code>dotnet new -i &quot;giraffe-template::*&quot;</code>.  The Giraffe template includes a reference to the <code>Microsoft.AspNetCore.App</code> package, which includes SignalR, so no additional packages are necessary.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet new giraffe -lang F# -n GameServer -o GameServer </span><br></pre></td></tr></table></figure><p>The Giraffe templates thankfully generate all the necessary boilerplate code for a webapp on top of Kestrel.  To simplify, we’ll focus on the components that need to be added to the server code.  Add the necessary namespaces, this is not only for SignalR, but to support the background game engine service.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> System.Threading;</span><br><span class="line"><span class="keyword">open</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">open</span> Microsoft.AspNetCore.SignalR</span><br></pre></td></tr></table></figure><p>The SignalR components must be added to the pipeline.  This is done in two places.  Modify <code>configureApp</code> to include <code>.UseSignalR(...)</code>.  Modify <code>configureServices</code> to include <code>services.AddSignalR()</code>.  In addition, the game runs as a hosted service.  To support this, modify <code>configureServices</code> to also includ <code>services.AddHostedService&lt;GameService&gt;()</code>.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> configureApp (app : IApplicationBuilder) =</span><br><span class="line">  <span class="keyword">let</span> env = app.ApplicationServices.GetService&lt;IHostingEnvironment&gt;()</span><br><span class="line">  (<span class="keyword">match</span> env.IsDevelopment() <span class="keyword">with</span></span><br><span class="line">  | <span class="keyword">true</span>  -&gt; app.UseDeveloperExceptionPage()</span><br><span class="line">  | <span class="keyword">false</span> -&gt; app</span><br><span class="line">              .UseGiraffeErrorHandler errorHandler)</span><br><span class="line">              .UseCors(configureCors)</span><br><span class="line">              .UseStaticFiles()</span><br><span class="line">              .UseSignalR(<span class="keyword">fun</span> routes -&gt; routes.MapHub&lt;GameHub&gt;(PathString <span class="string">"/gameHub"</span>)) <span class="comment">// SignalR</span></span><br><span class="line">              .UseGiraffe(webApp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> configureServices (services : IServiceCollection) =</span><br><span class="line">  services.AddCors()    |&gt; ignore</span><br><span class="line">  services.AddSignalR() |&gt; ignore                    <span class="comment">// SignalR</span></span><br><span class="line">  services.AddGiraffe() |&gt; ignore</span><br><span class="line">  services.AddHostedService&lt;GameService&gt;() |&gt; ignore <span class="comment">// GameService</span></span><br></pre></td></tr></table></figure><p>Now that the components have been injected into the pipeline, they need to be created.  For this we’ll need to create a SignalR hub as well as a GameService.  Starting with the SignalR hub.  We can send messages to the SignalR clients by supplying a function name and payload: <code>this.Clients.All.SendAsync(&quot;Message&quot;, &quot;foo&quot;)</code>.  But, we can do better by defining the interface and making the calls type-safe, so let’s do that.  Below is defined the client api interface.  This ensures that calls from server to client match the required types.  For simplicity, the server only has 3 messages it can send to clients.</p><ul><li><p><code>LoginResponse</code> Reports success or failure, and their PlayerId if login was successful.</p></li><li><p><code>Message</code> Sends general notifications to clients.</p></li><li><p><code>GameState</code> Provides a serialized gamestate that clients act on.</p></li></ul><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">IClientApi</span> </span>= </span><br><span class="line">  <span class="keyword">abstract</span> <span class="keyword">member</span> LoginResponse :bool * string -&gt; System.Threading.Tasks.Task</span><br><span class="line">  <span class="keyword">abstract</span> <span class="keyword">member</span> Message :string -&gt; System.Threading.Tasks.Task</span><br><span class="line">  <span class="keyword">abstract</span> <span class="keyword">member</span> GameState :string -&gt; System.Threading.Tasks.Task</span><br></pre></td></tr></table></figure><p>Now, to define the SignalR hub. This effectively is the listener that all clients connect to.  It leverages the <code>IClientApi</code> that was just created.  Here we need to write the handlers for messages accepted from clients.  Players have four different actions they can signal to the server.</p><ul><li><p><code>Login</code> For brevity, there is no authentication; provide a PlayerName and they get a PlayerId.  It also adds a player to the game.  The below code demonstrates how the server can send messages to all connected clients or just specific ones.</p></li><li><p><code>Logout</code> Removes a player from the game.</p></li><li><p><code>Turn</code> Players have one action they can perform, turn.  They move in a specified direction until they turn, then they proceed in that direction.</p></li><li><p><code>Send</code> Players can blast messages to all clients. Perhaps when the bots become self-aware they can taunt each other.</p></li></ul><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">GameHub</span> </span>() =</span><br><span class="line">  <span class="keyword">inherit</span> Hub&lt;IClientApi&gt; ()</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Accept client logins</span></span><br><span class="line">  <span class="keyword">member</span> this.Login (name :string) =</span><br><span class="line">    <span class="keyword">let</span> connectionId = this.Context.ConnectionId</span><br><span class="line">    <span class="keyword">let</span> success, playerId = addPlayer name</span><br><span class="line">    <span class="keyword">if</span> success <span class="keyword">then</span></span><br><span class="line">      <span class="comment">// Tell client login success and their playerId</span></span><br><span class="line">      this.Clients.Client(connectionId).LoginResponse(<span class="keyword">true</span>, playerId)</span><br><span class="line">      <span class="comment">// Tell clients of new player </span></span><br><span class="line">      this.Clients.All.Message(sprintf <span class="string">"New Player: %s (%s)"</span> name playerId)</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">      <span class="comment">// Tell client login failed</span></span><br><span class="line">      this.Clients.Client(connectionId).LoginResponse(<span class="keyword">false</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Handle client logout</span></span><br><span class="line">  <span class="keyword">member</span> this.Logout (playerId :string) =</span><br><span class="line">    removePlayer playerId</span><br><span class="line">    <span class="comment">// Tell clients of player logout</span></span><br><span class="line">    this.Clients.All.Message(sprintf <span class="string">"Player left: %s"</span> playerId)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Handle player changing direction</span></span><br><span class="line">  <span class="keyword">member</span> this.Turn (playerId :string, direction :string) = </span><br><span class="line">    updatePlayerDirection playerId direction</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Pass along message from one client to all clients</span></span><br><span class="line">  <span class="keyword">member</span> this.Send (message: string) = </span><br><span class="line">    this.Clients.All.Message(message)</span><br></pre></td></tr></table></figure><p>Now that the SignalR hub is done, it’s time to make the GameService that performs the server-side game logic as well as sending updated gamestate to players.  For this a background service is used.  At a set interval it processes current game state <code>updateState</code> and sends it out to all clients.  One note here: because I’ve choosen to use a client interface, the hub context is defined as <code>IHubContext&lt;GameHub, IClientApi&gt;)</code>.  If this wasn’t the case, it would be defined as <code>IHubContext&lt;GameHub&gt;</code> and messages would be sent using <code>this.HubContext.Clients.All.SendAsync(&quot;GameState&quot;, stateSerialized)</code>.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">GameService</span> </span>(hubContext :IHubContext&lt;GameHub, IClientApi&gt;) =</span><br><span class="line">  <span class="keyword">inherit</span> BackgroundService ()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">member</span> this.HubContext :IHubContext&lt;GameHub, IClientApi&gt; = hubContext</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> this.ExecuteAsync (stoppingToken :CancellationToken) =</span><br><span class="line">    <span class="keyword">let</span> pingTimer = <span class="keyword">new</span> System.Timers.Timer(TurnFrequency)</span><br><span class="line">    pingTimer.Elapsed.Add(<span class="keyword">fun</span> _ -&gt; </span><br><span class="line">      updateState ()</span><br><span class="line">      <span class="keyword">let</span> stateSerialized = serializeGameState gState</span><br><span class="line">      this.HubContext.Clients.All.GameState(stateSerialized) |&gt; ignore)</span><br><span class="line"></span><br><span class="line">    pingTimer.Start()</span><br><span class="line">    Task.CompletedTask</span><br></pre></td></tr></table></figure><p>Beyond the specific game logic implementation, that’s all there is to the SignalR server.  It now will send out gamestate updates as well as handle client messages.</p><h1 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h1><p>The next step is building the client.  To do this, a dotnet console app will be created, and then the SignalR package is added.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dotnet new console -lang f# -n ClientFs</span><br><span class="line">cd ClientFs</span><br><span class="line">dotnet add package Microsoft.AspNetCore.SignalR.Client</span><br></pre></td></tr></table></figure><p>Once that is done, it needs the SignalR namespace. </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> Microsoft.AspNetCore.SignalR.Client</span><br></pre></td></tr></table></figure><p>The client needs to make a connection to the SignalR hub.  Similar to the server, the client needs some event handlers for server generated messages. </p><ul><li><p><code>LoginResponse</code> A successful login gives the client a playerId.</p></li><li><p><code>Message</code> - Handle general message notifications.</p></li><li><p><code>GameState</code> - When the server sends the current gamestate, the client evaluates and then sends an action message back.</p></li><li><p><code>Closed</code> - When the connection closes, what does the client do? In this case attempts to reconnect.</p></li></ul><p>Once the event handlers are setup, the client connects and performs a login.  The handlers take care of the rest.  As can be seen below, the client uses <code>InvokeAsync</code> to send messages to the server (as seen in the login).  </p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[&lt;EntryPoint&gt;]</span></span><br><span class="line"><span class="keyword">let</span> main argv = </span><br><span class="line">  <span class="comment">// Create connection to game server</span></span><br><span class="line">  <span class="keyword">let</span> connection = </span><br><span class="line">    (HubConnectionBuilder())</span><br><span class="line">      .WithUrl(<span class="string">"http://localhost:5000/gameHub"</span>)</span><br><span class="line">      .Build()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Event handlers</span></span><br><span class="line">  connection.On&lt;bool, string&gt;(<span class="string">"LoginResponse"</span>, <span class="keyword">fun</span> success id -&gt; loginResponseHandler connection success id) |&gt; ignore</span><br><span class="line">  connection.On&lt;string&gt;(<span class="string">"Message"</span>, <span class="keyword">fun</span> message -&gt; messageHandler message) |&gt; ignore</span><br><span class="line">  connection.On&lt;string&gt;(<span class="string">"GameState"</span>, <span class="keyword">fun</span> gameState -&gt; gameStateHandler connection gameState) |&gt; ignore</span><br><span class="line">  connection.add_Closed(<span class="keyword">fun</span> error -&gt; reconnect connection error)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Start connection and login</span></span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">    connection.StartAsync().Wait()</span><br><span class="line">    connection.InvokeAsync(<span class="string">"login"</span>, myName).Wait()</span><br><span class="line">  <span class="keyword">with</span></span><br><span class="line">  | ex -&gt; printfn <span class="string">"Connection error %s"</span> (ex.ToString())</span><br><span class="line">          Environment.Exit(<span class="number">1</span>)</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Listen for 'q' to quit</span></span><br><span class="line">  getCommand connection</span><br><span class="line"></span><br><span class="line">  <span class="number">0</span></span><br></pre></td></tr></table></figure><p>The handler logic is uninteresting, but it is useful to see the definitions that match with the handlers.  In addition, I’ve included the client’s response back to the server in the gameState handler.  Again, it uses InvokeAsync when contacting the server.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> loginResponseHandler (connection :HubConnection) (success :bool) (id :string) =</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> messageHandler (message :string) =</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> gameStateHandler (connection :HubConnection) (gameState :string) =</span><br><span class="line">  ...</span><br><span class="line">  connection.InvokeAsync(<span class="string">"Turn"</span>, playerId, move.ToString()) |&gt; ignore</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">rec</span> reconnect (connection :HubConnection) (error :<span class="symbol">'a</span>) = </span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><h1 id="Game-Viewer"><a href="#Game-Viewer" class="headerlink" title="Game Viewer"></a>Game Viewer</h1><p>The final piece to address is the game viewer.  This comes in two parts: the layout and the code.  For the layout, we leverage Giraffe’s view engine.  It’s a simple view that contains an html canvas map, player list, messages display, and a state print (for debugging purposes).  This is also where supporting js libraries: signalr, <a href="https://jquery.com/" target="_blank" rel="noopener">jquery</a>, as well as the viewer game-server.js are included.  For this project, the files reside in the <code>WebRoot</code> directory.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> Views =</span><br><span class="line">    <span class="keyword">open</span> GiraffeViewEngine</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> layout (content: XmlNode list) =</span><br><span class="line">        html [] [</span><br><span class="line">            head [] [</span><br><span class="line">                title []  [ encodedText <span class="string">"SnakeWorld"</span> ]</span><br><span class="line">                link [ _rel  <span class="string">"stylesheet"</span></span><br><span class="line">                       _type <span class="string">"text/css"</span></span><br><span class="line">                       _href <span class="string">"/main.css"</span> ]</span><br><span class="line">            ]</span><br><span class="line">            body [] content</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> index (model : Message) =</span><br><span class="line">      [</span><br><span class="line">        div [ _class <span class="string">"container"</span>] [ </span><br><span class="line">          div [ _class <span class="string">"row"</span> ] [</span><br><span class="line">            div [ _id <span class="string">"mapWrapper"</span>; _class <span class="string">"col-6"</span> ] [</span><br><span class="line">              canvas [ _id <span class="string">"worldMap"</span>; _class <span class="string">"world-map"</span>; _width <span class="string">"200"</span>; _height <span class="string">"200"</span> ] [];</span><br><span class="line">              div [ _id <span class="string">"playerList"</span>; _class <span class="string">"player-list"</span> ] []</span><br><span class="line">            ]</span><br><span class="line">          ]</span><br><span class="line">          div [ _class <span class="string">"row"</span> ] [</span><br><span class="line">            div [ _id <span class="string">"message"</span>; _class <span class="string">"col-6"</span> ] []</span><br><span class="line">          ]</span><br><span class="line">          div [ _class <span class="string">"row"</span> ] [</span><br><span class="line">            div [ _id <span class="string">"currentState"</span>; _class <span class="string">"col-6"</span> ] []</span><br><span class="line">          ]</span><br><span class="line">        ]</span><br><span class="line">        script [ _src <span class="string">"signalr.js"</span> ] []</span><br><span class="line">        script [ _src <span class="string">"jquery-3.3.1.min.js"</span> ] []</span><br><span class="line">        script [ _src <span class="string">"game-viewer.js"</span> ] []</span><br><span class="line">      ] |&gt; layout</span><br></pre></td></tr></table></figure><p>This may bring up a question, where did <code>signalr.js</code> come from?  Well, there is one more thing we need to add to the project.  In a real project I’d package this differently, but a quick and dirty way will do for now.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install @aspnet/signalr</span><br><span class="line">cp ./node_modules/@aspnet/signalr/dist/browser/signalr.js ./WebRoot</span><br></pre></td></tr></table></figure><p>The code part of the game viewer is in javascript.  A similar process is required as was performed with the F# client.  A connection is created to the SignalR hub.  Then event handlers are wired up.  The viewer is read-only, to show messages and draw the map and player score list.</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// SignalR connection</span></span><br><span class="line">const connection = <span class="keyword">new</span> signalR.HubConnectionBuilder().withUrl(<span class="string">"/gameHub"</span>).build();</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Handle Connection start</span></span><br><span class="line">connection.start().catch(<span class="keyword">function</span> (err) &#123;</span><br><span class="line">  <span class="keyword">return</span> console.error(err.toString());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Handle incoming message</span></span><br><span class="line">connection.on(<span class="string">"Message"</span>, <span class="keyword">function</span> (message) &#123;</span><br><span class="line">  $(<span class="string">"#message"</span>).text(message);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Handle game state updates (draw map, update player list)</span></span><br><span class="line">connection.on(<span class="string">"GameState"</span>, <span class="keyword">function</span> (gameState) &#123;</span><br><span class="line">  handleGameState(JSON.parse(gameState))</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>At this point, we have all the necessary parts to support a SignalR F# server, F# client, and javascript client.  That closes the loop on the communication framework.  From here the game logic can be added to the server and client, and drawing can be added to the viewer.  Those components are outside of the scope for this post.  I hope you’ve found this to be a useful guide to leveraging a SignalR implementation with F#.  Until next time…</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Today’s post is a brief example of how to implement a game using &lt;a href=&quot;https://fsharp.org&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;F#&lt;/a&gt; and &lt;a href=&quot;https://dotnet.microsoft.com/apps/aspnet/real-time&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;SignalR&lt;/a&gt;.  Creating a game for bots to play doesn’t have to be overly difficult.  Since interesting emergent qualities can arise from simple rules, it makes for a fun way to show off SignalR, beyond the standard chat application.  As this post will show, F# and SignalR work well together to create a nice communication framework without requiring a complex setup.&lt;/p&gt;
    
    </summary>
    
    
      <category term="F#" scheme="http://codesuji.com/tags/F/"/>
    
      <category term="FSharp" scheme="http://codesuji.com/tags/FSharp/"/>
    
      <category term="SignalR" scheme="http://codesuji.com/tags/SignalR/"/>
    
  </entry>
  
</feed>
