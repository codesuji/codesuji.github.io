<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Harnessing the Anthropic API with F# | codesuji</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Since LLMs are currently all the rage, I wanted to spend some time today to dig into how to leverage the Anthropic API using F#. Anthropic provides a language model that can be utilized for various na">
<meta name="keywords" content="F#,FSharp,Machine Learning">
<meta property="og:type" content="article">
<meta property="og:title" content="Harnessing the Anthropic API with F#">
<meta property="og:url" content="http://codesuji.com/2024/05/21/F-and-Anthropic/index.html">
<meta property="og:site_name" content="codesuji">
<meta property="og:description" content="Since LLMs are currently all the rage, I wanted to spend some time today to dig into how to leverage the Anthropic API using F#. Anthropic provides a language model that can be utilized for various na">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://codesuji.com/images/claude1/test_big.jpg">
<meta property="og:updated_time" content="2024-05-23T01:20:04.323Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Harnessing the Anthropic API with F#">
<meta name="twitter:description" content="Since LLMs are currently all the rage, I wanted to spend some time today to dig into how to leverage the Anthropic API using F#. Anthropic provides a language model that can be utilized for various na">
<meta name="twitter:image" content="http://codesuji.com/images/claude1/test_big.jpg">
  
    <link rel="alternate" href="/atom.xml" title="codesuji" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codesuji</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://codesuji.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-F-and-Anthropic" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2024/05/21/F-and-Anthropic/" class="article-date">
  <time datetime="2024-05-22T01:31:58.000Z" itemprop="datePublished">2024-05-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Harnessing the Anthropic API with F#
    </h1>
  

 		<span class="post-count">Read Time: 19 minutes</span>
 	  </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Since LLMs are currently all the rage, I wanted to spend some time today to dig into how to leverage the <a href="https://www.anthropic.com" target="_blank" rel="noopener">Anthropic</a> API using <a href="https://www.fsharp.org" target="_blank" rel="noopener">F#</a>. Anthropic provides a language model that can be utilized for various natural language processing tasks, and it can be a handy tool to add to the application toolkit.</p>
<a id="more"></a>
<p>Although Anthropic provides some language SDKs, they do not have anything for .NET. Thankfully they provide a REST endpoint, so that’s the route I’ll take.  One consideration is the API isn’t free, but api calls are pretty cheap.  The target is their <a href="https://docs.anthropic.com/en/api/messages" target="_blank" rel="noopener">messages API</a>, and their new v3 models: opus, sonnet, and haiku.</p>
<p>As always, there are a couple things to setup first.  There are some record types to be setup for interaction with the api. Additionally there are a couple settings to configure.  Changing this alters the responses.  Regarding the json encoding for the REST calls, the api expects lower snake case.</p>
<p>Most of this is pretty basic, and its best to look at their documentation to get more details.  I’ll call out that temperature is set 1.0, which is more “creative”. That’s exactly what I want in a programming assistant, so I’ll go with that. The system prompt provides some direction on how I want answers to come back.  <a href="https://docs.anthropic.com/en/docs/prompt-engineering" target="_blank" rel="noopener">Prompt engineering</a> is a whole thing, so I won’t go into details.  But as an example, with no prompt “namesome German cities”, gives me a list of major cities as well as details about them. With the prompt below I’m more likely to get a plain comma-delimited list, or sometimes even a Python array.  The key here is, you can hone the shape of the answers. </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Message</span> </span>= &#123;</span><br><span class="line">  Role: string</span><br><span class="line">  Content: string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Request</span> </span>= &#123;</span><br><span class="line">  Model: string</span><br><span class="line">  Messages: Message[]</span><br><span class="line">  <span class="meta">[&lt;JsonPropertyName("max_tokens")&gt;]</span></span><br><span class="line">  MaxTokens: int</span><br><span class="line">  Temperature: float</span><br><span class="line">  System: string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Usage</span> </span>= &#123;</span><br><span class="line">  <span class="meta">[&lt;JsonPropertyName("input_tokens")&gt;]</span></span><br><span class="line">  InputTokens: int</span><br><span class="line">  <span class="meta">[&lt;JsonPropertyName("output_tokens")&gt;]</span></span><br><span class="line">  OutputTokens: int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Content</span> </span>= &#123;</span><br><span class="line">  Type: string</span><br><span class="line">  Text: string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Response</span> </span>= &#123;</span><br><span class="line">  Id: string</span><br><span class="line">  Type: string</span><br><span class="line">  Role: string</span><br><span class="line">  Model: string</span><br><span class="line">  <span class="meta">[&lt;JsonPropertyName("stop_sequence")&gt;]</span></span><br><span class="line">  StopSequence: string option</span><br><span class="line">  Usage: Usage</span><br><span class="line">  Content: Content[]</span><br><span class="line">  <span class="meta">[&lt;JsonPropertyName("stop_reason")&gt;]</span></span><br><span class="line">  StopReason: string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> anthropicUrl = <span class="string">"https://api.anthropic.com/v1/messages"</span></span><br><span class="line"><span class="keyword">let</span> anthropicVersion = <span class="string">"2023-06-01"</span></span><br><span class="line"><span class="keyword">let</span> apiKey = Environment.GetEnvironmentVariable(<span class="string">"ANTHROPIC_API_KEY"</span>)</span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mutable</span> model =</span><br><span class="line">  <span class="string">"claude-3-opus-20240229"</span>   <span class="comment">// opus</span></span><br><span class="line">  <span class="comment">//"claude-3-sonnet-20240229" // sonnet</span></span><br><span class="line">  <span class="comment">//"claude-3-haiku-20240307"  // haiku</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mutable</span> temperature = <span class="number">1.0</span> <span class="comment">// 0.0 - 1.0</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mutable</span> max_tokens = <span class="number">1000</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mutable</span> systemMessage = <span class="string">"You are a programming assistant"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> jsonSerializerOptions = JsonSerializerOptions(</span><br><span class="line">  PropertyNamingPolicy = JsonNamingPolicy.CamelCase)</span><br></pre></td></tr></table></figure>
<p>At this point, the function can be written to interface with the api.  There isn’t anything crazy in the function. It’s a basic REST call, just formatted as the Anthropic api requires.  Once the function is together, it can be called with simple message.  The response json is different whether the call was a success or failure so it is helpful to accomodate those situations.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> sendMessage (message: string) = task &#123;</span><br><span class="line">  <span class="keyword">use</span> httpClient = <span class="keyword">new</span> HttpClient()</span><br><span class="line">  httpClient.DefaultRequestHeaders.Add(<span class="string">"x-api-key"</span>, apiKey)</span><br><span class="line">  httpClient.DefaultRequestHeaders.Add(<span class="string">"anthropic-version"</span>, anthropicVersion)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> userMessage =</span><br><span class="line">    &#123; Role = <span class="string">"user"</span></span><br><span class="line">      Content = message &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> requestData =</span><br><span class="line">    &#123; Model = model</span><br><span class="line">      Messages = [| userMessage |]</span><br><span class="line">      MaxTokens = max_tokens</span><br><span class="line">      Temperature = temperature</span><br><span class="line">      System = systemMessage &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> requestJson = JsonSerializer.Serialize(requestData, jsonSerializerOptions)</span><br><span class="line">  <span class="keyword">let</span> requestContent = <span class="keyword">new</span> StringContent(requestJson, Encoding.UTF8, <span class="string">"application/json"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let!</span> response = httpClient.PostAsync(anthropicUrl, requestContent)</span><br><span class="line">  <span class="keyword">let!</span> responseJson = response.Content.ReadAsStringAsync()</span><br><span class="line">  <span class="keyword">let</span> responseData = JsonSerializer.Deserialize&lt;Response&gt;(responseJson, jsonSerializerOptions)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> not (responseData.Content = <span class="keyword">null</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">// Success</span></span><br><span class="line">    <span class="keyword">if</span> not (Array.isEmpty responseData.Content) <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">let</span> responseText =</span><br><span class="line">        responseData.Content</span><br><span class="line">        |&gt; Array.filter (<span class="keyword">fun</span> x -&gt; x.Type = <span class="string">"text"</span>)</span><br><span class="line">        |&gt; Array.map (<span class="keyword">fun</span> x -&gt; x.Text)</span><br><span class="line">        |&gt; String.concat <span class="string">"\n"</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> Some responseText</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> None</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="comment">// Error</span></span><br><span class="line">    <span class="keyword">let</span> errorResponseData = JsonSerializer.Deserialize&lt;ErrorResponse&gt;(responseJson, jsonSerializerOptions)</span><br><span class="line">    printfn <span class="string">"Error processing request: %A"</span> errorResponseData</span><br><span class="line">    <span class="keyword">return</span> None</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> message = <span class="string">"Write an F# function to factor a number"</span></span><br><span class="line"><span class="keyword">let</span> response =</span><br><span class="line">  sendMessage message</span><br><span class="line">  |&gt; Async.AwaitTask</span><br><span class="line">  |&gt; Async.RunSynchronously</span><br><span class="line">printfn $<span class="string">"response: &#123;response&#125;"</span></span><br></pre></td></tr></table></figure>
<p>So, what does an F# function that factors a number look like?  The output below shows what Anthropic’s opus thinks at least.  In addition to the textual result shown, the api response structure, includes other details, like input tokens (21) and output tokens (695).  Depending on the application, these extras can be useful.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">response: Here&apos;s an F# function to factor a number:</span><br><span class="line"></span><br><span class="line">``fsharp</span><br><span class="line">let rec factorize n =</span><br><span class="line">    let rec findFactor i =</span><br><span class="line">        if i * i &gt; n then</span><br><span class="line">            [n]</span><br><span class="line">        elif n % i = 0 then</span><br><span class="line">            i :: factorize (n / i)</span><br><span class="line">        else</span><br><span class="line">            findFactor (i + 1)</span><br><span class="line"></span><br><span class="line">    if n &lt;= 1 then</span><br><span class="line">        []</span><br><span class="line">    else</span><br><span class="line">        findFactor 2</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">This function uses a recursive approach to find the factors of a given number `n`. Here&apos;s how it works:</span><br><span class="line"></span><br><span class="line">1. The main function `factorize` takes an integer `n` as input.</span><br><span class="line">2. It first checks if `n` is less than or equal to 1. If so, it returns an empty list since numbers less than or equal to 1 have no factors.</span><br><span class="line">3. If `n` is greater than 1, it calls the inner recursive function `findFactor` with an initial value of 2.</span><br><span class="line">4. The `findFactor` function takes an integer `i` as input and does the following:</span><br><span class="line">   - If `i * i` is greater than `n`, it means that `n` is a prime number and cannot be factored further. In this case, it returns a list containing only `n`.</span><br><span class="line">   - If `n` is divisible by `i` (i.e., `n % i = 0`), it means that `i` is a factor of `n`. It adds `i` to the list of factors and recursively calls `factorize` with `n / i` to find the factors of the remaining part.</span><br><span class="line">   - If `n` is not divisible by `i`, it calls `findFactor` with `i + 1` to check the next potential factor.</span><br><span class="line">5. The function continues recursively until all factors are found, and it returns the list of factors.</span><br><span class="line"></span><br><span class="line">Here are a few examples of using the `factorize` function:</span><br><span class="line"></span><br><span class="line">``fsharp</span><br><span class="line">printfn &quot;%A&quot; (factorize 12)  // Output: [2; 2; 3]</span><br><span class="line">printfn &quot;%A&quot; (factorize 18)  // Output: [2; 3; 3]</span><br><span class="line">printfn &quot;%A&quot; (factorize 17)  // Output: [17]</span><br><span class="line">printfn &quot;%A&quot; (factorize 1)   // Output: []</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">In the above examples:</span><br><span class="line">- `factorize 12` returns `[2; 2; 3]` because 12 = 2 * 2 * 3.</span><br><span class="line">- `factorize 18` returns `[2; 3; 3]` because 18 = 2 * 3 * 3.</span><br><span class="line">- `factorize 17` returns `[17]` because 17 is a prime number.</span><br><span class="line">- `factorize 1` returns an empty list because 1 has no factors.</span><br><span class="line"></span><br><span class="line">Note that this function returns the factors in the order they are found, which may not necessarily be in ascending order.</span><br></pre></td></tr></table></figure>
<p>One aspect of how LLMs work is they can leverage more than a single message, but an entire conversation history. This is where context comes from when you need to tweak something.  Doing this is pretty easy.  Here I make a modification to store user messages and response, then I feed this into the api.  For a bit more detail, the main changes are: I append user messages and LLM responses to conversation history, I send the history to the api, and I add a REPL for the user to send a message, see the result, then provide follow-up information.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Conversation history</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">mutable</span> history = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sendMessageWithHistory (message: string) = task &#123;</span><br><span class="line">  <span class="keyword">use</span> httpClient = <span class="keyword">new</span> HttpClient()</span><br><span class="line">  httpClient.DefaultRequestHeaders.Add(<span class="string">"x-api-key"</span>, apiKey)</span><br><span class="line">  httpClient.DefaultRequestHeaders.Add(<span class="string">"anthropic-version"</span>, anthropicVersion)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> systemMessage = systemMessage</span><br><span class="line">  <span class="keyword">let</span> userMessage =</span><br><span class="line">    &#123; Role = <span class="string">"user"</span></span><br><span class="line">      Content = message &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add user message to conversation</span></span><br><span class="line">  history &lt;- List.append history [ userMessage ]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> requestData =</span><br><span class="line">    &#123; Model = model</span><br><span class="line">      Messages = List.toArray history</span><br><span class="line">      MaxTokens = max_tokens</span><br><span class="line">      Temperature = temperature</span><br><span class="line">      System = systemMessage &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> requestJson = JsonSerializer.Serialize(requestData, jsonSerializerOptions)</span><br><span class="line">  <span class="keyword">let</span> requestContent = <span class="keyword">new</span> StringContent(requestJson, Encoding.UTF8, <span class="string">"application/json"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let!</span> response = httpClient.PostAsync(anthropicUrl, requestContent)</span><br><span class="line">  <span class="keyword">let!</span> responseJson = response.Content.ReadAsStringAsync()</span><br><span class="line">  <span class="keyword">let</span> responseData = JsonSerializer.Deserialize&lt;Response&gt;(responseJson, jsonSerializerOptions)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> not (responseData.Content = <span class="keyword">null</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">// Success</span></span><br><span class="line">    <span class="keyword">if</span> not (Array.isEmpty responseData.Content) <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">let</span> responseText =</span><br><span class="line">        responseData.Content</span><br><span class="line">        |&gt; Array.filter (<span class="keyword">fun</span> x -&gt; x.Type = <span class="string">"text"</span>)</span><br><span class="line">        |&gt; Array.map (<span class="keyword">fun</span> x -&gt; x.Text)</span><br><span class="line">        |&gt; String.concat <span class="string">"\n"</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> assistantMessage =</span><br><span class="line">        &#123; Role = <span class="string">"assistant"</span></span><br><span class="line">          Content = responseText &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Add response to conversation</span></span><br><span class="line">      history &lt;- List.append history [ assistantMessage ]</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> Some responseText</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> None</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="comment">// Error</span></span><br><span class="line">    <span class="keyword">let</span> errorResponseData = JsonSerializer.Deserialize&lt;ErrorResponse&gt;(responseJson, jsonSerializerOptions)</span><br><span class="line">    printfn <span class="string">"Error processing request: %A"</span> errorResponseData</span><br><span class="line">    <span class="keyword">return</span> None</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">rec</span> loop() = task &#123;</span><br><span class="line">  printf <span class="string">"&gt; "</span></span><br><span class="line">  <span class="keyword">let</span> input = Console.ReadLine()</span><br><span class="line">  <span class="keyword">match</span> input <span class="keyword">with</span></span><br><span class="line">  | <span class="string">"quit"</span>  -&gt; ()</span><br><span class="line">  | message -&gt;</span><br><span class="line">      <span class="keyword">let!</span> response = sendMessageWithHistory message</span><br><span class="line">      <span class="keyword">match</span> response <span class="keyword">with</span></span><br><span class="line">      | Some r -&gt; printfn $<span class="string">"&#123;r&#125;"</span></span><br><span class="line">      | None   -&gt; printfn <span class="string">"No content from api call"</span></span><br><span class="line">      <span class="keyword">return!</span> loop()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">loop()</span><br><span class="line">|&gt; Async.AwaitTask</span><br><span class="line">|&gt; Async.RunSynchronously</span><br></pre></td></tr></table></figure>
<p>Here is what it looks the output from this looks like.  You can see the ability to include conversation history provides a nice experience.  If you’ve used any of the web interfaces for these LLMs, this is the experience you are probably used to. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">&gt; write and F# function to split a paragraph into sentences</span><br><span class="line">Here&apos;s an F# function that splits a paragraph into sentences:</span><br><span class="line"></span><br><span class="line">``fsharp</span><br><span class="line">open System</span><br><span class="line">open System.Text.RegularExpressions</span><br><span class="line"></span><br><span class="line">let splitIntoSentences (paragraph: string) =</span><br><span class="line">    let sentenceEnders = [| &apos;.&apos;; &apos;!&apos;; &apos;?&apos; |]</span><br><span class="line">    let mutable sentences = []</span><br><span class="line">    let mutable currentSentence = &quot;&quot;</span><br><span class="line"></span><br><span class="line">    for c in paragraph do</span><br><span class="line">        currentSentence &lt;- currentSentence + string c</span><br><span class="line">        if Array.contains c sentenceEnders then</span><br><span class="line">            sentences &lt;- sentences @ [currentSentence.Trim()]</span><br><span class="line">            currentSentence &lt;- &quot;&quot;</span><br><span class="line"></span><br><span class="line">    if not (String.IsNullOrWhiteSpace(currentSentence)) then</span><br><span class="line">        sentences &lt;- sentences @ [currentSentence.Trim()]</span><br><span class="line"></span><br><span class="line">    sentences</span><br><span class="line"></span><br><span class="line">// Example usage</span><br><span class="line">let paragraph = &quot;This is the first sentence. This is the second sentence! And this is the third sentence? This is the fourth and final sentence.&quot;</span><br><span class="line">let sentences = splitIntoSentences paragraph</span><br><span class="line">printfn &quot;%A&quot; sentences</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">In this function:</span><br><span class="line"></span><br><span class="line">1. We define an array `sentenceEnders` that contains the characters that typically end a sentence: period (`.`), exclamation mark (`!`), and question mark (`?`).</span><br><span class="line"></span><br><span class="line">2. We initialize a mutable list `sentences` to store the individual sentences and a mutable string `currentSentence` to build each sentence.</span><br><span class="line"></span><br><span class="line">3. We iterate over each character `c` in the input `paragraph`:</span><br><span class="line">   - We append the character to `currentSentence`.</span><br><span class="line">   - If the character is found in `sentenceEnders`, we consider it the end of a sentence:</span><br><span class="line">     - We add the `currentSentence` (after trimming any leading/trailing whitespace) to the `sentences` list.</span><br><span class="line">     - We reset `currentSentence` to an empty string to start building the next sentence.</span><br><span class="line"></span><br><span class="line">4. After the loop, if `currentSentence` is not empty or whitespace, we add it to the `sentences` list as the last sentence.</span><br><span class="line"></span><br><span class="line">5. Finally, we return the `sentences` list containing the individual sentences.</span><br><span class="line"></span><br><span class="line">In the example usage, we have a paragraph string that consists of multiple sentences. We pass this paragraph to the `splitIntoSentences` function, which returns a list of individual sentences. We then print the list of sentences using `printfn &quot;%A&quot;`.</span><br><span class="line"></span><br><span class="line">Output:</span><br><span class="line">``</span><br><span class="line">[&quot;This is the first sentence.&quot;; &quot;This is the second sentence!&quot;; &quot;And this is the third sentence?&quot;; &quot;This is the fourth and final sentence.&quot;]</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">The function splits the paragraph into individual sentences based on the presence of sentence-ending punctuation marks (`.`, `!`, `?`). Note that this is a basic implementation and may not handle all edge cases or complex sentence structures perfectly.</span><br><span class="line">&gt; modify the function to return word count with each sentence</span><br><span class="line">Sure! Here&apos;s the modified F# function that returns a tuple containing each sentence along with its word count:</span><br><span class="line"></span><br><span class="line">``fsharp</span><br><span class="line">open System</span><br><span class="line">open System.Text.RegularExpressions</span><br><span class="line"></span><br><span class="line">let splitIntoSentencesWithWordCount (paragraph: string) =</span><br><span class="line">    let sentenceEnders = [| &apos;.&apos;; &apos;!&apos;; &apos;?&apos; |]</span><br><span class="line">    let mutable sentences = []</span><br><span class="line">    let mutable currentSentence = &quot;&quot;</span><br><span class="line"></span><br><span class="line">    for c in paragraph do</span><br><span class="line">        currentSentence &lt;- currentSentence + string c</span><br><span class="line">        if Array.contains c sentenceEnders then</span><br><span class="line">            let sentence = currentSentence.Trim()</span><br><span class="line">            let wordCount = sentence.Split([| &apos; &apos;; &apos;\t&apos;; &apos;\r&apos;; &apos;\n&apos; |], StringSplitOptions.RemoveEmptyEntries).Length</span><br><span class="line">            sentences &lt;- sentences @ [(sentence, wordCount)]</span><br><span class="line">            currentSentence &lt;- &quot;&quot;</span><br><span class="line"></span><br><span class="line">    if not (String.IsNullOrWhiteSpace(currentSentence)) then</span><br><span class="line">        let sentence = currentSentence.Trim()</span><br><span class="line">        let wordCount = sentence.Split([| &apos; &apos;; &apos;\t&apos;; &apos;\r&apos;; &apos;\n&apos; |], StringSplitOptions.RemoveEmptyEntries).Length</span><br><span class="line">        sentences &lt;- sentences @ [(sentence, wordCount)]</span><br><span class="line"></span><br><span class="line">    sentences</span><br><span class="line"></span><br><span class="line">// Example usage</span><br><span class="line">let paragraph = &quot;This is the first sentence. This is the second sentence! And this is the third sentence? This is the fourth and final sentence.&quot;</span><br><span class="line">let sentencesWithWordCount = splitIntoSentencesWithWordCount paragraph</span><br><span class="line">printfn &quot;%A&quot; sentencesWithWordCount</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">The modifications made to the function are as follows:</span><br><span class="line"></span><br><span class="line">1. Instead of just storing the sentence in the `sentences` list, we now store a tuple `(sentence, wordCount)` for each sentence.</span><br><span class="line"></span><br><span class="line">2. After extracting a sentence (trimming leading/trailing whitespace), we calculate its word count using the following steps:</span><br><span class="line">   - We split the sentence using the `Split` method with an array of delimiters including space, tab, carriage return, and newline characters.</span><br><span class="line">   - We use `StringSplitOptions.RemoveEmptyEntries` to remove any empty substrings resulting from consecutive delimiters.</span><br><span class="line">   - We count the length of the resulting array, which gives us the word count for the sentence.</span><br><span class="line"></span><br><span class="line">3. We add the tuple `(sentence, wordCount)` to the `sentences` list.</span><br><span class="line"></span><br><span class="line">4. After the loop, if `currentSentence` is not empty or whitespace, we process it as the last sentence, calculate its word count, and add it to the `sentences` list as a tuple.</span><br><span class="line"></span><br><span class="line">5. Finally, we return the `sentences` list containing tuples of individual sentences and their corresponding word counts.</span><br><span class="line"></span><br><span class="line">In the example usage, we have the same paragraph string as before. We pass this paragraph to the `splitIntoSentencesWithWordCount` function, which returns a list of tuples, where each tuple contains a sentence and its word count. We then print the list of sentence-word count tuples using `printfn &quot;%A&quot;`.</span><br><span class="line"></span><br><span class="line">Output:</span><br><span class="line">``</span><br><span class="line">[(&quot;This is the first sentence.&quot;, 5); (&quot;This is the second sentence!&quot;, 5); (&quot;And this is the third sentence?&quot;, 6); (&quot;This is the fourth and final sentence.&quot;, 7)]</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">The function splits the paragraph into individual sentences and returns each sentence along with its word count. Note that this implementation considers words as substrings separated by spaces, tabs, carriage returns, or newlines. It may not handle all edge cases or complex word structures perfectly.</span><br><span class="line">&gt; quit</span><br></pre></td></tr></table></figure>
<p>In addition to sending text-based messages, the Anthropic API also supports sending image data as part of the conversation. Let’s explore how to handle image data using F#.  For this I’ll need to modify some of the definitions to support image-related fields.  I also modify the json serializer to exclude empty (None) values when serializing. The api fails when extra fields are sent, and this is a good way to handle that.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="meta">[&lt;Struct&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">ImageSource</span> </span>=</span><br><span class="line">  &#123; Type: string</span><br><span class="line">    <span class="meta">[&lt;JsonPropertyName("media_type")&gt;]</span></span><br><span class="line">    MediaType: string</span><br><span class="line">    Data: string &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">MessageContent</span> </span>=</span><br><span class="line">  &#123; Type: string</span><br><span class="line">    Source: ImageSource option</span><br><span class="line">    Text: string option</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Message</span> </span>= &#123;</span><br><span class="line">  Role: string</span><br><span class="line">  Content: MessageContent[]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Request</span> </span>= &#123;</span><br><span class="line">  Model: string</span><br><span class="line">  Messages: Message[]</span><br><span class="line">  <span class="meta">[&lt;JsonPropertyName("max_tokens")&gt;]</span></span><br><span class="line">  MaxTokens: int</span><br><span class="line">  Temperature: float</span><br><span class="line">  System: string option</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jsonSerializerOptions.DefaultIgnoreCondition &lt;- JsonIgnoreCondition.WhenWritingNull</span><br></pre></td></tr></table></figure>
<p>When sending an image, it is similar to text, the primary different is sending a slightly different message structure. The image itself is sent as a Base64 encoded string.  An additional note with images, you should be careful of the cost when sending images.  There is a <a href="https://docs.anthropic.com/en/docs/vision#image-size" target="_blank" rel="noopener">calcuation</a> of image size to token, for this particular example, I use a 200x151 sized image to keep the token count down (The image here is bigger, just so its easier to see).</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> sendImageMessage (imagePath: string) (message: string) = task &#123;</span><br><span class="line">  <span class="keyword">use</span> httpClient = <span class="keyword">new</span> HttpClient()</span><br><span class="line">  httpClient.DefaultRequestHeaders.Add(<span class="string">"x-api-key"</span>, apiKey)</span><br><span class="line">  httpClient.DefaultRequestHeaders.Add(<span class="string">"anthropic-version"</span>, anthropicVersion)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> imageBytes = System.IO.File.ReadAllBytes(imagePath)</span><br><span class="line">  <span class="keyword">let</span> encodedImage = Convert.ToBase64String(imageBytes)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> imageData =</span><br><span class="line">    &#123; Type = <span class="string">"image"</span></span><br><span class="line">      Source = Some</span><br><span class="line">        &#123; Type = <span class="string">"base64"</span></span><br><span class="line">          MediaType = <span class="string">"image/jpeg"</span></span><br><span class="line">          Data = encodedImage &#125;</span><br><span class="line">      Text = None &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> messageData =</span><br><span class="line">    &#123; Type = <span class="string">"text"</span></span><br><span class="line">      Source = None</span><br><span class="line">      Text = Some message &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> userMessage =</span><br><span class="line">    &#123; Role = <span class="string">"user"</span></span><br><span class="line">      Content = [| imageData; messageData |] &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> requestData =</span><br><span class="line">    &#123; Model = model</span><br><span class="line">      Messages = [| userMessage |]</span><br><span class="line">      MaxTokens = maxTokens</span><br><span class="line">      Temperature = temperature</span><br><span class="line">      System = None &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> requestJson = JsonSerializer.Serialize(requestData, jsonSerializerOptions)</span><br><span class="line">  <span class="keyword">let</span> requestContent = <span class="keyword">new</span> StringContent(requestJson, Encoding.UTF8, <span class="string">"application/json"</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let!</span> response = httpClient.PostAsync(anthropicUrl, requestContent)</span><br><span class="line">  <span class="keyword">let!</span> responseJson = response.Content.ReadAsStringAsync()</span><br><span class="line">  <span class="keyword">let</span> responseData = JsonSerializer.Deserialize&lt;Response&gt;(responseJson, jsonSerializerOptions)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> not (responseData.Content = <span class="keyword">null</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">// Success</span></span><br><span class="line">    <span class="keyword">if</span> not (Array.isEmpty responseData.Content) <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">let</span> responseText =</span><br><span class="line">        responseData.Content</span><br><span class="line">        |&gt; Array.filter (<span class="keyword">fun</span> x -&gt; x.Type = <span class="string">"text"</span>)</span><br><span class="line">        |&gt; Array.map (<span class="keyword">fun</span> x -&gt; x.Text)</span><br><span class="line">        |&gt; String.concat <span class="string">"\n"</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> Some responseText</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">return</span> None</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="comment">// Error</span></span><br><span class="line">    <span class="keyword">let</span> errorResponseData = JsonSerializer.Deserialize&lt;ErrorResponse&gt;(responseJson, jsonSerializerOptions)</span><br><span class="line">    printfn <span class="string">"Error processing request: %A"</span> errorResponseData</span><br><span class="line">    <span class="keyword">return</span> None</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> message = <span class="string">"What is in the image?"</span></span><br><span class="line"><span class="keyword">let</span> response =</span><br><span class="line">  sendImageMessage <span class="string">"test.jpg"</span> message</span><br><span class="line">  |&gt; Async.AwaitTask</span><br><span class="line">  |&gt; Async.RunSynchronously</span><br><span class="line">printfn $<span class="string">"response: &#123;response&#125;"</span></span><br></pre></td></tr></table></figure>
<p>:<img src="/images/claude1/test_big.jpg" alt="Sample Image"></p>
<p>Here is description of the image, not too bad.</p>
<p>“<br>response: The image shows a winter landscape covered in snow. It depicts a park or garden setting with bare trees and bushes blanketed in snow. In the foreground, there is a fence or railing, also covered in snow. The scene has a serene, tranquil feel with the monochromatic gray tones created by the snowy conditions. The trees appear slightly obscured or hazy, likely due to falling snow or overcast sky conditions during the winter snowfall captured in the photograph.<br>“</p>
<p>So, that’s about it for now.  I’ve explored how to use the Anthropic API with F#, using a couple different scenarios.  Hopefully this offers some inspiration to go out in play with this LLM or another one yourself.  Until next time, happy coding with F# and Anthropic.</p>

        <div class="related-posts-box">
        Related Posts:<ul class="related-posts"><li class="related-posts-item"><a class="related-posts-link" href="/2017/08/27/K-Means-Clustering-with-F/">K-Means Clustering with F#</a></li><li class="related-posts-item"><a class="related-posts-link" href="/2018/07/07/F-and-MLNet-Clustering/">F# and ML.NET Clustering</a></li><li class="related-posts-item"><a class="related-posts-link" href="/2018/01/06/Tackling-Kaggle-FSharp-XGBoost/">Tackling Kaggle with F# and XGBoost</a></li></ul>        </div>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codesuji.com/2024/05/21/F-and-Anthropic/" data-id="clwik3mw1000a9qmwvym9ko4l" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/F/">F#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FSharp/">FSharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Machine-Learning/">Machine Learning</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/05/24/Distinct-Counting-in-F/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Estimating Distinct Element Counts with F#
        
      </div>
    </a>
  
  
    <a href="/2023/09/23/F-Flurl/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Using F# and Flurl</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/NET-Core/" style="font-size: 17.27px;">.NET Core</a> <a href="/tags/Accord-NET/" style="font-size: 14.55px;">Accord.NET</a> <a href="/tags/Algorithms/" style="font-size: 15.45px;">Algorithms</a> <a href="/tags/Analytics/" style="font-size: 13.64px;">Analytics</a> <a href="/tags/Audio/" style="font-size: 10px;">Audio</a> <a href="/tags/Benchmarking/" style="font-size: 10.91px;">Benchmarking</a> <a href="/tags/Chiron/" style="font-size: 10px;">Chiron</a> <a href="/tags/Classification/" style="font-size: 10.91px;">Classification</a> <a href="/tags/Cognitive-Services/" style="font-size: 10.91px;">Cognitive Services</a> <a href="/tags/Compiler/" style="font-size: 12.73px;">Compiler</a> <a href="/tags/Computer-Vision/" style="font-size: 10.91px;">Computer Vision</a> <a href="/tags/Cordova/" style="font-size: 10px;">Cordova</a> <a href="/tags/DTW/" style="font-size: 13.64px;">DTW</a> <a href="/tags/Data/" style="font-size: 18.18px;">Data</a> <a href="/tags/Database/" style="font-size: 12.73px;">Database</a> <a href="/tags/Decision-Trees/" style="font-size: 10.91px;">Decision Trees</a> <a href="/tags/Deedle/" style="font-size: 10px;">Deedle</a> <a href="/tags/Delegate/" style="font-size: 10px;">Delegate</a> <a href="/tags/Detection/" style="font-size: 10px;">Detection</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Dynamic-Time-Warping/" style="font-size: 12.73px;">Dynamic Time Warping</a> <a href="/tags/EEG/" style="font-size: 10px;">EEG</a> <a href="/tags/Edges/" style="font-size: 10px;">Edges</a> <a href="/tags/Education/" style="font-size: 10px;">Education</a> <a href="/tags/Elmish/" style="font-size: 10px;">Elmish</a> <a href="/tags/EmguCV/" style="font-size: 10px;">EmguCV</a> <a href="/tags/Entropy/" style="font-size: 10px;">Entropy</a> <a href="/tags/F/" style="font-size: 20px;">F#</a> <a href="/tags/FParsec/" style="font-size: 11.82px;">FParsec</a> <a href="/tags/FSAdvent/" style="font-size: 10px;">FSAdvent</a> <a href="/tags/FSharp/" style="font-size: 20px;">FSharp</a> <a href="/tags/Fable/" style="font-size: 10px;">Fable</a> <a href="/tags/Faces/" style="font-size: 10.91px;">Faces</a> <a href="/tags/Filters/" style="font-size: 10px;">Filters</a> <a href="/tags/Http/" style="font-size: 10.91px;">Http</a> <a href="/tags/Images/" style="font-size: 11.82px;">Images</a> <a href="/tags/Ionide/" style="font-size: 10px;">Ionide</a> <a href="/tags/Kaggle/" style="font-size: 11.82px;">Kaggle</a> <a href="/tags/Keyboard/" style="font-size: 12.73px;">Keyboard</a> <a href="/tags/Legos/" style="font-size: 10.91px;">Legos</a> <a href="/tags/Logging/" style="font-size: 10px;">Logging</a> <a href="/tags/MLNet/" style="font-size: 16.36px;">MLNet</a> <a href="/tags/MSIL/" style="font-size: 11.82px;">MSIL</a> <a href="/tags/Machine-Learning/" style="font-size: 19.09px;">Machine Learning</a> <a href="/tags/MathNet/" style="font-size: 10px;">MathNet</a> <a href="/tags/Messaging/" style="font-size: 10px;">Messaging</a> <a href="/tags/Mobile/" style="font-size: 10px;">Mobile</a> <a href="/tags/Mono/" style="font-size: 10px;">Mono</a> <a href="/tags/Morse-Code/" style="font-size: 10px;">Morse Code</a> <a href="/tags/Mqtt/" style="font-size: 11.82px;">Mqtt</a> <a href="/tags/Nix/" style="font-size: 10px;">Nix</a> <a href="/tags/OpenCV/" style="font-size: 10px;">OpenCV</a> <a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a> <a href="/tags/Parsing/" style="font-size: 11.82px;">Parsing</a> <a href="/tags/Performance/" style="font-size: 12.73px;">Performance</a> <a href="/tags/Presentations/" style="font-size: 10px;">Presentations</a> <a href="/tags/Propagator/" style="font-size: 10px;">Propagator</a> <a href="/tags/Racket/" style="font-size: 10px;">Racket</a> <a href="/tags/Regression/" style="font-size: 10px;">Regression</a> <a href="/tags/Rekognition/" style="font-size: 10px;">Rekognition</a> <a href="/tags/Robotics/" style="font-size: 10px;">Robotics</a> <a href="/tags/Rust/" style="font-size: 10px;">Rust</a> <a href="/tags/STEM/" style="font-size: 10.91px;">STEM</a> <a href="/tags/Scoring/" style="font-size: 10px;">Scoring</a> <a href="/tags/Search/" style="font-size: 10.91px;">Search</a> <a href="/tags/Serialization/" style="font-size: 10px;">Serialization</a> <a href="/tags/SignalR/" style="font-size: 10px;">SignalR</a> <a href="/tags/Signals/" style="font-size: 12.73px;">Signals</a> <a href="/tags/Similarity/" style="font-size: 10.91px;">Similarity</a> <a href="/tags/Sound/" style="font-size: 10px;">Sound</a> <a href="/tags/Statistics/" style="font-size: 12.73px;">Statistics</a> <a href="/tags/Text/" style="font-size: 13.64px;">Text</a> <a href="/tags/Timeseries/" style="font-size: 10.91px;">Timeseries</a> <a href="/tags/Tips/" style="font-size: 12.73px;">Tips</a> <a href="/tags/Tools/" style="font-size: 10px;">Tools</a> <a href="/tags/Translation/" style="font-size: 10px;">Translation</a> <a href="/tags/Types/" style="font-size: 10px;">Types</a> <a href="/tags/VS-Code/" style="font-size: 10px;">VS Code</a> <a href="/tags/Web/" style="font-size: 10.91px;">Web</a> <a href="/tags/Webapi/" style="font-size: 10.91px;">Webapi</a> <a href="/tags/admin/" style="font-size: 10.91px;">admin</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/05/24/Distinct-Counting-in-F/">Estimating Distinct Element Counts with F#</a>
          </li>
        
          <li>
            <a href="/2024/05/21/F-and-Anthropic/">Harnessing the Anthropic API with F#</a>
          </li>
        
          <li>
            <a href="/2023/09/23/F-Flurl/">Using F# and Flurl</a>
          </li>
        
          <li>
            <a href="/2023/04/08/VectorSearch-F-1/">Vector Search using F#</a>
          </li>
        
          <li>
            <a href="/2023/03/07/Json-Bakeoff/">The Great Json Bake-Off</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 codesuji.com<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>