<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Discriminated Unions and Dapper | codesuji</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Persisting data can be a subtle art.  Today I am taking a look at how F#’s Discriminated Unions can interact with Dapper.  I’ve discussed Dapper before, but never really discussed its facilities for i">
<meta name="keywords" content="F#,FSharp,Database,Types">
<meta property="og:type" content="article">
<meta property="og:title" content="Discriminated Unions and Dapper">
<meta property="og:url" content="http://codesuji.com/2021/12/11/Discriminated-Unions-and-Dapper/index.html">
<meta property="og:site_name" content="codesuji">
<meta property="og:description" content="Persisting data can be a subtle art.  Today I am taking a look at how F#’s Discriminated Unions can interact with Dapper.  I’ve discussed Dapper before, but never really discussed its facilities for i">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2021-12-11T15:19:51.607Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Discriminated Unions and Dapper">
<meta name="twitter:description" content="Persisting data can be a subtle art.  Today I am taking a look at how F#’s Discriminated Unions can interact with Dapper.  I’ve discussed Dapper before, but never really discussed its facilities for i">
  
    <link rel="alternate" href="/atom.xml" title="codesuji" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-89982547-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codesuji</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://codesuji.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Discriminated-Unions-and-Dapper" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/12/11/Discriminated-Unions-and-Dapper/" class="article-date">
  <time datetime="2021-12-11T14:18:39.000Z" itemprop="datePublished">2021-12-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Discriminated Unions and Dapper
    </h1>
  

 		<span class="post-count">Read Time: 11 minutes</span>
 	  </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Persisting data can be a subtle art.  Today I am taking a look at how <a href="http://fsharp.org/" target="_blank" rel="noopener">F#’s</a> Discriminated Unions can interact with <a href="https://github.com/StackExchange/Dapper" target="_blank" rel="noopener">Dapper</a>.  I’ve discussed Dapper before, but never really discussed its facilities for interacting with Discriminated Unions.  It is a useful bit of knowledge when determining project data structures.</p>
<a id="more"></a>
<p>For example purposes, I have a snippet from a financial tracking application.  The part of interest is the definition of an Account along with it’s AccountType.  For explanatory purposes, I am using abbreviated record and type definitions.  Since it is so convenient, examples will leverage <a href="https://sqlite.org/" target="_blank" rel="noopener">SQLite</a> as a database.  For reference, below are the package versions I’m using, along with .NET 5.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ dotnet add package Dapper --version <span class="number">2.0</span><span class="number">.123</span></span><br><span class="line">$ dotnet add package System.Data.SQLite --version <span class="number">1.0</span><span class="number">.115</span><span class="number">.5</span></span><br><span class="line">$ Thoth.Json.Net --version <span class="number">7.1</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
<p>First, to start with some foundational parts.  Half of this equation, is the database structure.  The examples below use a simple table definition.  For the first (enum) example AccountType is an int.  For the other examples it is stored as a string.  With the structural pieces out of the way I get to the most interesting aspects. </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> System</span><br><span class="line"><span class="keyword">open</span> System.Data.SQLite</span><br><span class="line"><span class="keyword">open</span> Dapper</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> databaseFileName = <span class="string">"../data/db.sqlite"</span></span><br><span class="line"><span class="keyword">let</span> connectionString = <span class="string">"Data Source=../data/db.sqlite;Version=3;"</span></span><br><span class="line"><span class="keyword">let</span> sqlEnumExample =</span><br><span class="line">  <span class="string">"""</span></span><br><span class="line"><span class="string">    create table Accounts (</span></span><br><span class="line"><span class="string">      AccountId varchar(100),</span></span><br><span class="line"><span class="string">      AccountName varchar(200),</span></span><br><span class="line"><span class="string">      AccountType int,</span></span><br><span class="line"><span class="string">      primary key (accountid)</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">  """</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> sqlOtherExamples =</span><br><span class="line">  <span class="string">"""</span></span><br><span class="line"><span class="string">    create table Accounts (</span></span><br><span class="line"><span class="string">      AccountId varchar(100),</span></span><br><span class="line"><span class="string">      AccountName varchar(200),</span></span><br><span class="line"><span class="string">      AccountType varchar(100),</span></span><br><span class="line"><span class="string">      primary key (accountid)</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">  """</span></span><br><span class="line"></span><br><span class="line">SQLiteConnection.CreateFile(databaseFileName)</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> db = <span class="keyword">new</span> SQLiteConnection(connectionString)</span><br><span class="line">db.Open()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> command = <span class="keyword">new</span> SQLiteCommand(sql, db)</span><br><span class="line"><span class="keyword">let</span> result = command.ExecuteNonQuery()</span><br><span class="line">db.Close()</span><br></pre></td></tr></table></figure>
<p>Some Discriminated Unions have a simple structure.  Depending on intent, these can simply be represented as an enum.  When this approach is chosen, the numeric value of the Discriminated Union is saved to the database.  If you are looking at a fully normalized database structure with ids to external tables, this can be a perfectly reasonable approach.  This does of course require a manual synchronization of the magic numbers between the type and database table.  Like anything else, there are trade-offs. Digging in a bit deeper, below is one way this can be implemented.  Because it is useful to see some of the underlying details, I include the results of a generic Dapper call as well as the one that directly casts the results into the <code>Account</code> type.</p>
<p>The example code is typical Dapper/F# example code.  Database inserting and selecting map cleanly to F# record and discriminated union types.  With this approach, everything is just handled.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">AccountType</span> </span>=</span><br><span class="line">  | Checking = <span class="number">100</span></span><br><span class="line">  | CreditCard = <span class="number">200</span></span><br><span class="line">  | Investing = <span class="number">300</span></span><br><span class="line">  | Ira = <span class="number">400</span></span><br><span class="line">  | Savings = <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Account</span> </span>=</span><br><span class="line">  &#123; AccountId: string</span><br><span class="line">    AccountName: string</span><br><span class="line">    AccountType: AccountType &#125;</span><br><span class="line">  <span class="keyword">override</span> __.ToString() =</span><br><span class="line">    sprintf <span class="string">"%-10s %-25s %-25s"</span> __.AccountId __.AccountName (__.AccountType.ToString())</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> accounts =</span><br><span class="line">  [ &#123; AccountId = <span class="string">"1001"</span></span><br><span class="line">      AccountName = <span class="string">"Savings Account 1"</span></span><br><span class="line">      AccountType = AccountType.Savings &#125;</span><br><span class="line">    &#123; AccountId = <span class="string">"1002"</span></span><br><span class="line">      AccountName = <span class="string">"Retirement Account 1"</span></span><br><span class="line">      AccountType = AccountType.Ira &#125; ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> db = <span class="keyword">new</span> SQLiteConnection(connectionString)</span><br><span class="line">db.Open()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> insertSql = <span class="string">"insert into accounts (accountid, accountname, accounttype) values (@accountid, @accountname, @accounttype)"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> count =</span><br><span class="line">  accounts</span><br><span class="line">  |&gt; List.sumBy (<span class="keyword">fun</span> record -&gt; db.Execute(insertSql, record))</span><br><span class="line"></span><br><span class="line">printfn $<span class="string">"&#123;count&#125; records inserted."</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> selectSql = <span class="string">"select accountid, accountname, accounttype from accounts"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> record <span class="keyword">in</span> db.Query(selectSql) <span class="keyword">do</span></span><br><span class="line">  printfn $<span class="string">"&#123;record&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> record <span class="keyword">in</span> db.Query&lt;Account&gt;(selectSql) <span class="keyword">do</span></span><br><span class="line">  printfn $<span class="string">"&#123;record&#125;"</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2 records inserted.</span><br><span class="line"></span><br><span class="line">&#123;DapperRow, AccountId = &apos;1001&apos;, AccountName = &apos;Savings Account 1&apos;, AccountType = &apos;500&apos;&#125;</span><br><span class="line">&#123;DapperRow, AccountId = &apos;1002&apos;, AccountName = &apos;Retirement Account 1&apos;, AccountType = &apos;400&apos;&#125;</span><br><span class="line"></span><br><span class="line">1001       Savings Account 1         Savings</span><br><span class="line">1002       Retirement Account 1      Ira</span><br></pre></td></tr></table></figure>
<p>There are multiple ways to tackle the problem, so it is time to look at a different approach.  Let’s say I don’t want AccountType to be an enum.  Perhaps I want to store data “truer” to the F# type shape. What options do I have.  One way is to treat this simple discriminated union by mapping it’s underlying values to string values (e.g. AccountType.Savings maps to the string “Savings”). It is easy to understand, but this doesn’t work directly with Dapper, with no intervention.  I need to build out a little support for this to work.  First, I create <code>Serialize</code> and <code>Deserialize</code> methods on <code>AccountType</code>.  Second, I need to create a handler to map from/to the discriminated union and the stored sql string.  For this Dapper provides a <code>TypeHandler</code>, from that I inherit and create an <code>AccountTypeHandler</code>.  The contained methods tell Dapper how to proxy the data between the worlds of the database and application.  <code>Parse</code> takes the string value in the database and returns an <code>AccountType</code>.  <code>SetValue</code> does the reverse, by converting an <code>AccountType</code> to a string.  It should be noted at this point I am doing simple string serialization and deserialization.  If I wanted to do something fancier in here I could, but this is a direct approach meets my goals.  The third, and final, piece is to activate the <code>AccountTypeHandler</code> with the <code>SqlMapper.AddTypeHandler</code> method.  Now I can do inserts and selects like I did before. But the data is stored using my specified string serialization.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">AccountType</span> </span>=</span><br><span class="line">  | Checking</span><br><span class="line">  | CreditCard</span><br><span class="line">  | Investing</span><br><span class="line">  | Ira</span><br><span class="line">  | Savings</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">member</span> Serialize(accountType: AccountType) = accountType.ToString()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">member</span> Deserialize(s: string) =</span><br><span class="line">    <span class="keyword">match</span> s <span class="keyword">with</span></span><br><span class="line">    | nameof Checking -&gt; Ok Checking</span><br><span class="line">    | nameof Savings -&gt; Ok Savings</span><br><span class="line">    | nameof Investing -&gt; Ok Investing</span><br><span class="line">    | nameof Ira -&gt; Ok Ira</span><br><span class="line">    | nameof CreditCard -&gt; Ok CreditCard</span><br><span class="line">    | _ -&gt; Error(sprintf <span class="string">"Invalid account type '%s'"</span> s)</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Account</span> </span>=</span><br><span class="line">  &#123; AccountId: string</span><br><span class="line">    AccountName: string</span><br><span class="line">    AccountType: AccountType &#125;</span><br><span class="line">  <span class="keyword">override</span> __.ToString() =</span><br><span class="line">    sprintf <span class="string">"%-10s %-25s %-25s"</span> __.AccountId __.AccountName (__.AccountType.ToString())</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">AccountTypeHandler</span></span>() =</span><br><span class="line">  <span class="keyword">inherit</span> SqlMapper.TypeHandler&lt;AccountType&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> __.Parse(value) =</span><br><span class="line">    <span class="keyword">match</span> AccountType.Deserialize(string value) <span class="keyword">with</span></span><br><span class="line">    | Ok (y) -&gt; y</span><br><span class="line">    | Error (e) -&gt; failwith e</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> __.SetValue(p, value) =</span><br><span class="line">    p.DbType &lt;- Data.DbType.String</span><br><span class="line">    p.Size &lt;- <span class="number">100</span></span><br><span class="line">    p.Value &lt;- AccountType.Serialize value</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> accounts =</span><br><span class="line">  [ &#123; AccountId = <span class="string">"1001"</span></span><br><span class="line">      AccountName = <span class="string">"Savings Account 1"</span></span><br><span class="line">      AccountType = AccountType.Savings &#125;</span><br><span class="line">    &#123; AccountId = <span class="string">"1002"</span></span><br><span class="line">      AccountName = <span class="string">"Retirement Account 1"</span></span><br><span class="line">      AccountType = AccountType.Ira &#125; ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> db = <span class="keyword">new</span> SQLiteConnection(connectionString)</span><br><span class="line">db.Open()</span><br><span class="line">SqlMapper.AddTypeHandler(typeof&lt;AccountType&gt;, AccountTypeHandler())</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> insertSql = <span class="string">"insert into accounts (accountid, accountname, accounttype) values (@accountid, @accountname, @accounttype)"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> count =</span><br><span class="line">  accounts</span><br><span class="line">  |&gt; List.sumBy (<span class="keyword">fun</span> record -&gt; db.Execute(insertSql, record))</span><br><span class="line"></span><br><span class="line">printfn $<span class="string">"&#123;count&#125; records inserted."</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> selectSql = <span class="string">"select accountid, accountname, accounttype from accounts"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> record <span class="keyword">in</span> db.Query(selectSql) <span class="keyword">do</span></span><br><span class="line">  printfn $<span class="string">"&#123;record&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> record <span class="keyword">in</span> db.Query&lt;Account&gt;(selectSql) <span class="keyword">do</span></span><br><span class="line">  printfn $<span class="string">"&#123;record&#125;"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2 records inserted.</span><br><span class="line"></span><br><span class="line">&#123;DapperRow, AccountId = &apos;1001&apos;, AccountName = &apos;Savings Account 1&apos;, AccountType = &apos;Savings&apos;&#125;</span><br><span class="line">&#123;DapperRow, AccountId = &apos;1002&apos;, AccountName = &apos;Retirement Account 1&apos;, AccountType = &apos;Ira&apos;&#125;</span><br><span class="line"></span><br><span class="line">1001       Savings Account 1         Savings</span><br><span class="line">1002       Retirement Account 1      Ira</span><br></pre></td></tr></table></figure>
<p>There is a natural next question, what if the discriminated union isn’t so simple? One of F#’s strengths is modeling complex data.  So this seems like another good example of the power of different approaches.  The fundamental question is how to represent the data.  There are a multitude of ways to address this.  I’ve decided on something really simple; use <a href="https://github.com/thoth-org/Thoth.Json.Net" target="_blank" rel="noopener">Thoth</a> to serialize the Discriminated Union.  As you can see below, there are now different types of IRAs, and Savings accounts need a bank name attached.  How does this change the previous approach?  The <code>Serialize</code> and <code>Deserialize</code> methods of <code>AccountType</code> are modified to use Thoth Auto-Encoding and Auto-Decoding (respectively).  Everything else stays the same as the previous example.  This can be a point of debate if this is the best serialization method, but changing the serialization functions give enough flexibility to meet your specific needs.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> Thoth.Json.Net</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">IraType</span> </span>=</span><br><span class="line">  | Roth</span><br><span class="line">  | Simple</span><br><span class="line">  | Traditional</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">AccountType</span> </span>=</span><br><span class="line">  | Checking</span><br><span class="line">  | CreditCard</span><br><span class="line">  | Investing</span><br><span class="line">  | Ira <span class="keyword">of</span> IraType</span><br><span class="line">  | Savings <span class="keyword">of</span> string</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">member</span> Serialize(accountType: AccountType) = Encode.Auto.toString (<span class="number">2</span>, accountType)</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">member</span> Deserialize(s: string) = Decode.Auto.fromString&lt;AccountType&gt; (s)</span><br><span class="line"></span><br><span class="line"><span class="meta">[&lt;CLIMutable&gt;]</span></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Account</span> </span>=</span><br><span class="line">  &#123; AccountId: string</span><br><span class="line">    AccountName: string</span><br><span class="line">    AccountType: AccountType &#125;</span><br><span class="line">  <span class="keyword">override</span> __.ToString() =</span><br><span class="line">    sprintf <span class="string">"%-10s %-25s %-25s"</span> __.AccountId __.AccountName (__.AccountType.ToString())</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">AccountTypeHandler</span></span>() =</span><br><span class="line">  <span class="keyword">inherit</span> SqlMapper.TypeHandler&lt;AccountType&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> __.Parse(value) =</span><br><span class="line">    <span class="keyword">match</span> AccountType.Deserialize(string value) <span class="keyword">with</span></span><br><span class="line">    | Ok (y) -&gt; y</span><br><span class="line">    | Error (e) -&gt; failwith e</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> __.SetValue(p, value) =</span><br><span class="line">    p.DbType &lt;- Data.DbType.String</span><br><span class="line">    p.Size &lt;- <span class="number">100</span></span><br><span class="line">    p.Value &lt;- AccountType.Serialize value</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> accounts =</span><br><span class="line">  [ &#123; AccountId = <span class="string">"1001"</span></span><br><span class="line">      AccountName = <span class="string">"Savings Account 1"</span></span><br><span class="line">      AccountType = AccountType.Savings <span class="string">"First Bank"</span> &#125;</span><br><span class="line">    &#123; AccountId = <span class="string">"1002"</span></span><br><span class="line">      AccountName = <span class="string">"Retirement Account 1"</span></span><br><span class="line">      AccountType = AccountType.Ira Roth &#125;</span><br><span class="line">    &#123; AccountId = <span class="string">"1003"</span></span><br><span class="line">      AccountName = <span class="string">"Retirement Account 2"</span></span><br><span class="line">      AccountType = AccountType.Ira Traditional &#125;</span><br><span class="line">    &#123; AccountId = <span class="string">"1004"</span></span><br><span class="line">      AccountName = <span class="string">"Checking Account 1"</span></span><br><span class="line">      AccountType = AccountType.Checking &#125; ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> db = <span class="keyword">new</span> SQLiteConnection(connectionString)</span><br><span class="line">db.Open()</span><br><span class="line">SqlMapper.AddTypeHandler(typeof&lt;AccountType&gt;, AccountTypeHandler())</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> insertSql = <span class="string">"insert into accounts (accountid, accountname, accounttype) values (@accountid, @accountname, @accounttype)"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> count =</span><br><span class="line">  accounts</span><br><span class="line">  |&gt; List.sumBy (<span class="keyword">fun</span> record -&gt; db.Execute(insertSql, record))</span><br><span class="line"></span><br><span class="line">printfn $<span class="string">"&#123;count&#125; records inserted."</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> selectSql = <span class="string">"select accountid, accountname, accounttype from accounts"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> record <span class="keyword">in</span> db.Query(selectSql) <span class="keyword">do</span></span><br><span class="line">  printfn $<span class="string">"&#123;record&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> record <span class="keyword">in</span> db.Query&lt;Account&gt;(selectSql) <span class="keyword">do</span></span><br><span class="line">  printfn $<span class="string">"&#123;record&#125;"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">4 records inserted.</span><br><span class="line"></span><br><span class="line">&#123;DapperRow, AccountId = &apos;1001&apos;, AccountName = &apos;Savings Account 1&apos;, AccountType = &apos;[</span><br><span class="line">  &quot;Savings&quot;,</span><br><span class="line">  &quot;First Bank&quot;</span><br><span class="line">]&apos;&#125;</span><br><span class="line">&#123;DapperRow, AccountId = &apos;1002&apos;, AccountName = &apos;Retirement Account 1&apos;, AccountType = &apos;[</span><br><span class="line">  &quot;Ira&quot;,</span><br><span class="line">  &quot;Roth&quot;</span><br><span class="line">]&apos;&#125;</span><br><span class="line">&#123;DapperRow, AccountId = &apos;1003&apos;, AccountName = &apos;Retirement Account 2&apos;, AccountType = &apos;[</span><br><span class="line">  &quot;Ira&quot;,</span><br><span class="line">  &quot;Traditional&quot;</span><br><span class="line">]&apos;&#125;</span><br><span class="line"></span><br><span class="line">&#123;DapperRow, AccountId = &apos;1004&apos;, AccountName = &apos;Checking Account 1&apos;, AccountType = &apos;&quot;Checking&quot;&apos;&#125;</span><br><span class="line">1001       Savings Account 1         Savings &quot;First Bank&quot;</span><br><span class="line">1002       Retirement Account 1      Ira Roth</span><br><span class="line">1003       Retirement Account 2      Ira Traditional</span><br><span class="line">1004       Checking Account 1        Checking</span><br></pre></td></tr></table></figure>
<p>As you can see, Dapper provides good support for flexible data type mapping.  Hopefully these different approaches give you some ideas regarding how you can integrate Dapper and its type handlers with F# for your applications.</p>

        <div class="related-posts-box">
        Related Posts:<ul class="related-posts"><li class="related-posts-item"><a class="related-posts-link" href="/2021/11/21/F-RocksDB/">Leveraging RocksDB with F#</a></li><li class="related-posts-item"><a class="related-posts-link" href="/2017/07/28/F-and-SQLite/">F# and SQLite</a></li><li class="related-posts-item"><a class="related-posts-link" href="/2017/07/29/F-and-Dapper/">F# and Dapper</a></li></ul>        </div>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codesuji.com/2021/12/11/Discriminated-Unions-and-Dapper/" data-id="ckwya2li80000pxmwd1thkuw9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Database/">Database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/F/">F#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FSharp/">FSharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Types/">Types</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2021/11/27/Data-in-Motion-Precipitation/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Data in Motion - Precipitation Map</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/NET-Core/" style="font-size: 17.78px;">.NET Core</a> <a href="/tags/Accord-NET/" style="font-size: 15.56px;">Accord.NET</a> <a href="/tags/Analytics/" style="font-size: 14.44px;">Analytics</a> <a href="/tags/Audio/" style="font-size: 10px;">Audio</a> <a href="/tags/Benchmarking/" style="font-size: 10px;">Benchmarking</a> <a href="/tags/Chiron/" style="font-size: 10px;">Chiron</a> <a href="/tags/Classification/" style="font-size: 11.11px;">Classification</a> <a href="/tags/Cognitive-Services/" style="font-size: 11.11px;">Cognitive Services</a> <a href="/tags/Compiler/" style="font-size: 13.33px;">Compiler</a> <a href="/tags/Computer-Vision/" style="font-size: 11.11px;">Computer Vision</a> <a href="/tags/Cordova/" style="font-size: 10px;">Cordova</a> <a href="/tags/DTW/" style="font-size: 14.44px;">DTW</a> <a href="/tags/Data/" style="font-size: 17.78px;">Data</a> <a href="/tags/Database/" style="font-size: 13.33px;">Database</a> <a href="/tags/Decision-Trees/" style="font-size: 11.11px;">Decision Trees</a> <a href="/tags/Deedle/" style="font-size: 10px;">Deedle</a> <a href="/tags/Delegate/" style="font-size: 10px;">Delegate</a> <a href="/tags/Detection/" style="font-size: 10px;">Detection</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Dynamic-Time-Warping/" style="font-size: 13.33px;">Dynamic Time Warping</a> <a href="/tags/EEG/" style="font-size: 10px;">EEG</a> <a href="/tags/Edges/" style="font-size: 10px;">Edges</a> <a href="/tags/Education/" style="font-size: 10px;">Education</a> <a href="/tags/Elmish/" style="font-size: 10px;">Elmish</a> <a href="/tags/EmguCV/" style="font-size: 10px;">EmguCV</a> <a href="/tags/Entropy/" style="font-size: 10px;">Entropy</a> <a href="/tags/F/" style="font-size: 20px;">F#</a> <a href="/tags/FParsec/" style="font-size: 12.22px;">FParsec</a> <a href="/tags/FSAdvent/" style="font-size: 10px;">FSAdvent</a> <a href="/tags/FSharp/" style="font-size: 20px;">FSharp</a> <a href="/tags/Fable/" style="font-size: 10px;">Fable</a> <a href="/tags/Faces/" style="font-size: 11.11px;">Faces</a> <a href="/tags/Filters/" style="font-size: 10px;">Filters</a> <a href="/tags/Http/" style="font-size: 11.11px;">Http</a> <a href="/tags/Images/" style="font-size: 12.22px;">Images</a> <a href="/tags/Ionide/" style="font-size: 10px;">Ionide</a> <a href="/tags/Kaggle/" style="font-size: 12.22px;">Kaggle</a> <a href="/tags/Keyboard/" style="font-size: 13.33px;">Keyboard</a> <a href="/tags/Legos/" style="font-size: 11.11px;">Legos</a> <a href="/tags/Logging/" style="font-size: 10px;">Logging</a> <a href="/tags/MLNet/" style="font-size: 16.67px;">MLNet</a> <a href="/tags/MSIL/" style="font-size: 12.22px;">MSIL</a> <a href="/tags/Machine-Learning/" style="font-size: 18.89px;">Machine Learning</a> <a href="/tags/MathNet/" style="font-size: 10px;">MathNet</a> <a href="/tags/Messaging/" style="font-size: 10px;">Messaging</a> <a href="/tags/Mobile/" style="font-size: 10px;">Mobile</a> <a href="/tags/Mono/" style="font-size: 10px;">Mono</a> <a href="/tags/Morse-Code/" style="font-size: 10px;">Morse Code</a> <a href="/tags/Mqtt/" style="font-size: 12.22px;">Mqtt</a> <a href="/tags/Nix/" style="font-size: 10px;">Nix</a> <a href="/tags/OpenCV/" style="font-size: 10px;">OpenCV</a> <a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a> <a href="/tags/Parsing/" style="font-size: 12.22px;">Parsing</a> <a href="/tags/Performance/" style="font-size: 11.11px;">Performance</a> <a href="/tags/Presentations/" style="font-size: 10px;">Presentations</a> <a href="/tags/Propagator/" style="font-size: 10px;">Propagator</a> <a href="/tags/Racket/" style="font-size: 10px;">Racket</a> <a href="/tags/Regression/" style="font-size: 10px;">Regression</a> <a href="/tags/Rekognition/" style="font-size: 10px;">Rekognition</a> <a href="/tags/Robotics/" style="font-size: 10px;">Robotics</a> <a href="/tags/Rust/" style="font-size: 10px;">Rust</a> <a href="/tags/STEM/" style="font-size: 11.11px;">STEM</a> <a href="/tags/Scoring/" style="font-size: 10px;">Scoring</a> <a href="/tags/Search/" style="font-size: 11.11px;">Search</a> <a href="/tags/Serialization/" style="font-size: 10px;">Serialization</a> <a href="/tags/SignalR/" style="font-size: 10px;">SignalR</a> <a href="/tags/Signals/" style="font-size: 12.22px;">Signals</a> <a href="/tags/Similarity/" style="font-size: 11.11px;">Similarity</a> <a href="/tags/Sound/" style="font-size: 10px;">Sound</a> <a href="/tags/Statistics/" style="font-size: 13.33px;">Statistics</a> <a href="/tags/Text/" style="font-size: 14.44px;">Text</a> <a href="/tags/Timeseries/" style="font-size: 10px;">Timeseries</a> <a href="/tags/Tips/" style="font-size: 12.22px;">Tips</a> <a href="/tags/Translation/" style="font-size: 10px;">Translation</a> <a href="/tags/Types/" style="font-size: 10px;">Types</a> <a href="/tags/VS-Code/" style="font-size: 10px;">VS Code</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/Webapi/" style="font-size: 11.11px;">Webapi</a> <a href="/tags/admin/" style="font-size: 11.11px;">admin</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/12/11/Discriminated-Unions-and-Dapper/">Discriminated Unions and Dapper</a>
          </li>
        
          <li>
            <a href="/2021/11/27/Data-in-Motion-Precipitation/">Data in Motion - Precipitation Map</a>
          </li>
        
          <li>
            <a href="/2021/11/21/F-RocksDB/">Leveraging RocksDB with F#</a>
          </li>
        
          <li>
            <a href="/2021/08/07/F-String-Search/">Examining Boyer-Moore String Search with F#</a>
          </li>
        
          <li>
            <a href="/2021/07/28/Data-in-Motion-Drought/">Data in Motion - Drought Map</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 codesuji.com<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>