<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Decision Trees with F# and Accord.NET (Part 1) | codesuji</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="It is time for an exploration into using a Decision Tree to classify Lego set themes using F# and Accord.NET.  
First things first, the data. Rebrickable has downloadable datasets for Lego sets and pi">
<meta property="og:type" content="article">
<meta property="og:title" content="Decision Trees with F# and Accord.NET (Part 1)">
<meta property="og:url" content="http://codesuji.com/2016/12/05/Decision-Trees-with-F-and-Accord-NET-Part-1/index.html">
<meta property="og:site_name" content="codesuji">
<meta property="og:description" content="It is time for an exploration into using a Decision Tree to classify Lego set themes using F# and Accord.NET.  
First things first, the data. Rebrickable has downloadable datasets for Lego sets and pi">
<meta property="og:updated_time" content="2017-01-14T19:46:17.309Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Decision Trees with F# and Accord.NET (Part 1)">
<meta name="twitter:description" content="It is time for an exploration into using a Decision Tree to classify Lego set themes using F# and Accord.NET.  
First things first, the data. Rebrickable has downloadable datasets for Lego sets and pi">
  
    <link rel="alternate" href="/atom.xml" title="codesuji" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-89982547-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codesuji</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://codesuji.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Decision-Trees-with-F-and-Accord-NET-Part-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/05/Decision-Trees-with-F-and-Accord-NET-Part-1/" class="article-date">
  <time datetime="2016-12-06T02:13:22.000Z" itemprop="datePublished">2016-12-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Decision Trees with F# and Accord.NET (Part 1)
    </h1>
  

 		<span class="post-count">Read Time: 13 minutes</span>
 	  </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>It is time for an exploration into using a Decision Tree to classify Lego set themes using <a href="http://fsharp.org/" target="_blank" rel="external">F#</a> and <a href="http://accord-framework.net/" target="_blank" rel="external">Accord.NET</a>.  </p>
<p>First things first, the data. <a href="http://rebrickable.com/downloads" target="_blank" rel="external">Rebrickable</a> has downloadable datasets for Lego sets and pieces.  I’ll use the <code>sets.csv</code> file as the primary dataset driver, but will grab information from <code>sets_pieces.csv</code>, <code>pieces.csv</code>, and <code>colors.csv</code> for feature creation.  The files are not in an format appropriate for a decision tree, so some transformations will need to happen first.  I don’t want the post to get too long, so this project will be broken into two components.  Part 1 will be building the feature file and getting the data into the desired comsumable format, <a href="/2016/12/07/Decision-Trees-with-F-and-Accord-NET-Part-2">Part 2</a> will actually use the file to get to the end goal.</p>
<a id="more"></a>
<p>Second, the approach.  The goal of part 1 is to do all transformations here.  I want the end result to be a file that can be directly loaded into part 2’s code.  I will use/create a series of features.  Year is the set’s year, and is directly provided.  The following features will need to be grouped and calculated.  First is “% of the set’s pieces are <x> type” for a couple major piece types.  Second, is “% of the set’s pieces are <x> color” for major color groups.  Lastly, the prediction target is theme.  The dataset has up to three themes per set (T1, T2, T3).  For simplicity sake I am only going to use one theme (T1) as the target theme to predict.  This will restrict the quality of my results, but as a proof-of-concept it will be good enough.  Hopefully all this give me some interesting results.</x></x></p>
<p>Using <a href="https://github.com/fsprojects/Paket" target="_blank" rel="external">Paket</a>, here is a sample <code>paket.dependencies</code> file.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">source https:<span class="comment">//nuget.org/api/v2</span></div><div class="line">nuget FSharp.Data</div></pre></td></tr></table></figure>
<p>This is the boring setup stuff.  </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#r <span class="string">"../packages/FSharp.Data/lib/net40/FSharp.Data.dll"</span></div><div class="line"></div><div class="line"><span class="keyword">open</span> System</div><div class="line"><span class="keyword">open</span> System.IO</div><div class="line"><span class="keyword">open</span> FSharp.Data</div></pre></td></tr></table></figure>
<p>Next it is time to leverage the CsvProvider for the input files.  The below code configures the types as well as loads the data. You’ve probably read it a million times, but Type Providers are really helpful to get get working with the data quickly.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// File structures</span></div><div class="line"><span class="class"><span class="keyword">type</span> <span class="title">LegoSets</span> </span>= CsvProvider&lt;<span class="string">"../data/legos/sets.csv"</span>&gt;</div><div class="line"><span class="class"><span class="keyword">type</span> <span class="title">LegoSetPieces</span> </span>= CsvProvider&lt;<span class="string">"../data/legos/set_pieces.csv"</span>&gt;</div><div class="line"><span class="class"><span class="keyword">type</span> <span class="title">LegoPieces</span> </span>= CsvProvider&lt;<span class="string">"../data/legos/pieces.csv"</span>&gt;</div><div class="line"><span class="class"><span class="keyword">type</span> <span class="title">LegoColors</span> </span>= CsvProvider&lt;<span class="string">"../data/legos/colors.csv"</span>&gt;</div><div class="line"></div><div class="line"><span class="comment">// Load files</span></div><div class="line"><span class="keyword">let</span> legoSets = LegoSets.Load <span class="string">"../data/legos/sets.csv"</span></div><div class="line"><span class="keyword">let</span> legoSetPieces = LegoSetPieces.Load <span class="string">"../data/legos/set_pieces.csv"</span></div><div class="line"><span class="keyword">let</span> legoPieces = LegoPieces.Load <span class="string">"../data/legos/pieces.csv"</span></div><div class="line"><span class="keyword">let</span> legoColors = LegoColors.Load <span class="string">"../data/legos/colors.csv"</span></div></pre></td></tr></table></figure>
<p>When building the features, I will be counting the number of specific colors in the set.  There are 135 different colors.  I only care about eight different colors: Red, Green, Blue, White, Black, Gray, Silver, and Translucent.  I will ignore the rest.  As an expedient hack, I search for the color text in the description.  So ‘Red’, ‘Trans-Red’, and ‘Dark Red’ all count as ‘Red’.  I then store these indexes for later searching.  This method misses things like ‘Pink’, which is in the red family.  It also means ‘Trans-Red’ counts as a red piece and a translucent piece.  For a real problem I would be more thorough, but I just want to get to the decision tree.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> getColorIndexes color =</div><div class="line">    legoColors.Rows </div><div class="line">    |&gt; Seq.filter (<span class="keyword">fun</span> x -&gt; x.Descr.Contains(color)) </div><div class="line">    |&gt; Seq.map (<span class="keyword">fun</span> x -&gt; x.Id) </div><div class="line">    |&gt; Seq.toList</div><div class="line"></div><div class="line"><span class="keyword">let</span> redIndexes = getColorIndexes <span class="string">"Red"</span></div><div class="line"><span class="keyword">let</span> greenIndexes = getColorIndexes <span class="string">"Green"</span></div><div class="line"><span class="keyword">let</span> blueIndexes = getColorIndexes <span class="string">"Blue"</span></div><div class="line"><span class="keyword">let</span> whiteIndexes = getColorIndexes <span class="string">"White"</span></div><div class="line"><span class="keyword">let</span> blackIndexes = getColorIndexes <span class="string">"Black"</span></div><div class="line"><span class="keyword">let</span> grayIndexes = getColorIndexes <span class="string">"Gray"</span></div><div class="line"><span class="keyword">let</span> silverIndexes = getColorIndexes <span class="string">"Silver"</span></div><div class="line"><span class="keyword">let</span> translucentIndexes = getColorIndexes <span class="string">"Trans"</span></div></pre></td></tr></table></figure>
<p>To perform piece counts in the sets I’ll need to do some grouping.  I will use <em>SetCountsDetail</em> as an intermediate aggregation record type.  <em>SetDetail</em> will be my final output form.  You may notice I use counts for the aggregation, but in the final output I store “Percent of the set”.  I feel this should allow the feature values to be consistent across sets.  I also use the function <em>setCountsDetailSum</em> when folding group sums together.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Piece-type counts for sets (used for aggregation)</span></div><div class="line"><span class="class"><span class="keyword">type</span> <span class="title">SetCountsDetail</span> </span>= &#123; </div><div class="line">    SetId: string; </div><div class="line">    BricksCount: int; </div><div class="line">    PlatesCount: int; </div><div class="line">    MinifigsCount: int;</div><div class="line">    PanelsCount: int;</div><div class="line">    PlantsAndAnimalsCount: int;</div><div class="line">    TilesCount: int;</div><div class="line">    TechnicsCount: int;</div><div class="line">    RedCount: int;</div><div class="line">    GreenCount: int;</div><div class="line">    BlueCount: int;</div><div class="line">    WhiteCount: int;</div><div class="line">    BlackCount: int;</div><div class="line">    GrayCount: int;</div><div class="line">    SilverCount: int;</div><div class="line">    TranslucentCount: int&#125;</div><div class="line"></div><div class="line"><span class="comment">// Set detail record (this is what gets written to the output file)</span></div><div class="line"><span class="class"><span class="keyword">type</span> <span class="title">SetDetail</span> </span>= &#123; </div><div class="line">    SetId: string; </div><div class="line">    Year: int;</div><div class="line">    ThemeId: int;</div><div class="line">    PiecesCount: int; </div><div class="line">    BricksPct: float; </div><div class="line">    PlatesPct: float; </div><div class="line">    MinifigsPct: float </div><div class="line">    PanelsPct: float;</div><div class="line">    PlantsAndAnimalsPct: float;</div><div class="line">    TilesPct: float;</div><div class="line">    TechnicsPct: float;</div><div class="line">    RedPct: float;</div><div class="line">    GreenPct: float;</div><div class="line">    BluePct: float;</div><div class="line">    WhitePct: float;</div><div class="line">    BlackPct: float;</div><div class="line">    GrayPct: float;</div><div class="line">    SilverPct: float;</div><div class="line">    TranslucentPct: float&#125; <span class="keyword">with</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">member</span> toCsv d =</div><div class="line">        sprintf <span class="string">"%d,%d,%d,%.4f,%.4f,%.4f,%.4f,%.4f,%.4f,%.4f,%.4f,%.4f,%.4f,%.4f,%.4f,%.4f,%.4f,%.4f"</span> </div><div class="line">            d.ThemeId d.Year d.PiecesCount d.BricksPct d.PlatesPct d.MinifigsPct d.PanelsPct d.PlantsAndAnimalsPct d.TilesPct d.TechnicsPct d.RedPct d.GreenPct d.BluePct d.WhitePct d.BlackPct d.GrayPct d.SilverPct d.TranslucentPct</div><div class="line">    </div><div class="line"><span class="comment">// Sum counts for SetCountsDetail (use in fold)</span></div><div class="line"><span class="keyword">let</span> setCountsDetailSum (a:SetCountsDetail) (b:SetCountsDetail) = </div><div class="line">    &#123;a <span class="keyword">with</span> </div><div class="line">        BricksCount = a.BricksCount + b.BricksCount;</div><div class="line">        PlatesCount = a.PlatesCount + b.PlatesCount;</div><div class="line">        MinifigsCount = a.MinifigsCount + b.MinifigsCount;</div><div class="line">        PanelsCount = a.PanelsCount + b.PanelsCount;</div><div class="line">        PlantsAndAnimalsCount = a.PlantsAndAnimalsCount + b.PlantsAndAnimalsCount;</div><div class="line">        TilesCount = a.TilesCount + b.TilesCount;</div><div class="line">        TechnicsCount = a.TechnicsCount + b.TechnicsCount;</div><div class="line">        RedCount = a.RedCount + b.RedCount;</div><div class="line">        GreenCount = a.GreenCount + b.GreenCount;</div><div class="line">        BlueCount = a.BlueCount + b.BlueCount;</div><div class="line">        WhiteCount = a.WhiteCount + b.WhiteCount;</div><div class="line">        BlackCount = a.BlackCount + b.BlackCount;</div><div class="line">        GrayCount = a.GrayCount + b.GrayCount;</div><div class="line">        SilverCount = a.SilverCount + b.SilverCount;</div><div class="line">        TranslucentCount = a.TranslucentCount + b.TranslucentCount&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>Now I create a piece lookup using a Map (for the non-F#ers, think Dictionary).  I also filter only the piece type categories I care about.  There are 56, and for simplicity I will only look at seven.  I also group all “Technic*” categories into a single “Technic” category.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// Build lookup for pieces</span></div><div class="line"><span class="keyword">let</span> pieceLookup = </div><div class="line">    legoPieces.Rows</div><div class="line">    <span class="comment">// Only include these categories</span></div><div class="line">    |&gt; Seq.filter (<span class="keyword">fun</span> row -&gt; </div><div class="line">        row.Category = <span class="string">"Bricks"</span> || </div><div class="line">        row.Category = <span class="string">"Plates"</span> || </div><div class="line">        row.Category = <span class="string">"Minifigs"</span> ||</div><div class="line">        row.Category = <span class="string">"Panels"</span> ||</div><div class="line">        row.Category = <span class="string">"Plants and Animals"</span> ||</div><div class="line">        row.Category = <span class="string">"Tiles"</span> ||</div><div class="line">        row.Category.Contains(<span class="string">"Technic"</span>)</div><div class="line">        )</div><div class="line">    |&gt; Seq.map (<span class="keyword">fun</span> row -&gt; (row.Piece_id, <span class="keyword">if</span> row.Category.Contains(<span class="string">"Technic"</span>) <span class="keyword">then</span> <span class="string">"Technic"</span> <span class="keyword">else</span> row.Category))</div><div class="line">    |&gt; Map</div><div class="line"></div></pre></td></tr></table></figure>
<p>Here I take a row and transpose it in the intermediate feature columns I want.  <em>isColorIndex</em> is a helper function to determine if the specified piece color is part of one my color groupings.  </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Convert data row to a SetCountsDetail record</span></div><div class="line"><span class="keyword">let</span> isColorIndex indexList colorIndex = </div><div class="line">    indexList |&gt; List.filter (<span class="keyword">fun</span> x -&gt; x = colorIndex) |&gt; List.length &gt; <span class="number">0</span></div><div class="line"></div><div class="line"><span class="comment">// Convert data row to a SetCountsDetail record</span></div><div class="line"><span class="keyword">let</span> rowToSetCountsDetail (row:CsvProvider&lt;<span class="string">"../data/legos/set_pieces.csv"</span>&gt;.Row) = </div><div class="line">    <span class="keyword">let</span> c = pieceLookup.Item row.Piece_id</div><div class="line">    &#123;        </div><div class="line">        SetCountsDetail.SetId = row.Set_id;  </div><div class="line">        BricksCount = <span class="keyword">if</span> c = <span class="string">"Bricks"</span> <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        PlatesCount = <span class="keyword">if</span> c = <span class="string">"Plates"</span> <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        MinifigsCount = <span class="keyword">if</span> c = <span class="string">"Minifigs"</span> <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        PanelsCount = <span class="keyword">if</span> c = <span class="string">"Panels"</span> <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        PlantsAndAnimalsCount = <span class="keyword">if</span> c = <span class="string">"Plants and Animals"</span> <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        TilesCount = <span class="keyword">if</span> c = <span class="string">"Tiles"</span> <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        TechnicsCount = <span class="keyword">if</span> c = <span class="string">"Technic"</span> <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        RedCount = <span class="keyword">if</span> isColorIndex redIndexes row.Color <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        GreenCount = <span class="keyword">if</span> isColorIndex greenIndexes row.Color <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        BlueCount = <span class="keyword">if</span> isColorIndex blueIndexes row.Color <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        WhiteCount = <span class="keyword">if</span> isColorIndex whiteIndexes row.Color <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        BlackCount = <span class="keyword">if</span> isColorIndex blackIndexes row.Color <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        GrayCount = <span class="keyword">if</span> isColorIndex grayIndexes row.Color <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        SilverCount = <span class="keyword">if</span> isColorIndex silverIndexes row.Color <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>;</div><div class="line">        TranslucentCount = <span class="keyword">if</span> isColorIndex translucentIndexes row.Color <span class="keyword">then</span> row.Num <span class="keyword">else</span> <span class="number">0</span>&#125;</div></pre></td></tr></table></figure>
<p>I then create a series of lookup functions to support the transformation process. In <em>setPiecesLookup</em> I make a Map for piece counts by SetId.  It gets alittle gnarly, but it does a group by on SetId, then sums all columns up to that level. <em>getCountLookup</em> is used to get piece counts by setid. <em>themesLookup</em> maps the set’s theme text to an arbitrary int.  I will save that into a lookup table/file as well for later access.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Build lookup for setpieces</span></div><div class="line"><span class="keyword">let</span> setPiecesLookup = </div><div class="line">    legoSetPieces.Rows</div><div class="line">    |&gt; Seq.filter (<span class="keyword">fun</span> r -&gt; Map.containsKey r.Piece_id pieceLookup)</div><div class="line">    |&gt; Seq.map rowToSetCountsDetail</div><div class="line">    <span class="comment">// Sum counts up to SetId                             </span></div><div class="line">    |&gt; Seq.groupBy (<span class="keyword">fun</span> x -&gt; x.SetId)</div><div class="line">    |&gt; Seq.map (<span class="keyword">fun</span> (k, v) -&gt; </div><div class="line">        (k, </div><div class="line">         v |&gt; Seq.fold setCountsDetailSum &#123; SetCountsDetail.SetId = k; BricksCount = <span class="number">0</span>; PlatesCount = <span class="number">0</span>; MinifigsCount = <span class="number">0</span>; PanelsCount = <span class="number">0</span>;  PlantsAndAnimalsCount = <span class="number">0</span>; TilesCount = <span class="number">0</span>; TechnicsCount = <span class="number">0</span>; RedCount = <span class="number">0</span>; GreenCount = <span class="number">0</span>; BlueCount = <span class="number">0</span>; WhiteCount = <span class="number">0</span>; BlackCount = <span class="number">0</span>; GrayCount = <span class="number">0</span>; SilverCount = <span class="number">0</span>; TranslucentCount = <span class="number">0</span>&#125;))                                </div><div class="line">    <span class="comment">// Create lookup</span></div><div class="line">    |&gt; Map</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Lookup piece count in the set, if not found, return 0</span></div><div class="line"><span class="keyword">let</span> getCountLookup k =</div><div class="line">    <span class="keyword">match</span> Map.tryFind k setPiecesLookup <span class="keyword">with</span></div><div class="line">    | Some(x) -&gt; x</div><div class="line">    | _       -&gt; &#123; SetId = k; BricksCount = <span class="number">0</span>; PlatesCount = <span class="number">0</span>; MinifigsCount = <span class="number">0</span>; PanelsCount = <span class="number">0</span>; PlantsAndAnimalsCount = <span class="number">0</span>; TilesCount = <span class="number">0</span>; TechnicsCount = <span class="number">0</span>; RedCount = <span class="number">0</span>; GreenCount = <span class="number">0</span>; BlueCount = <span class="number">0</span>; WhiteCount = <span class="number">0</span>; BlackCount = <span class="number">0</span>; GrayCount = <span class="number">0</span>; SilverCount = <span class="number">0</span>; TranslucentCount = <span class="number">0</span>&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Create theme lookups from the sets files</span></div><div class="line"><span class="keyword">let</span> themesLookup =</div><div class="line">    <span class="keyword">let</span> distinctThemes = legoSets.Rows |&gt; Seq.map (<span class="keyword">fun</span> row -&gt; row.T1) |&gt; Seq.distinct</div><div class="line"></div><div class="line">    <span class="comment">// Pair theme string with an int</span></div><div class="line">    (distinctThemes, seq [<span class="number">0.</span>.Seq.length distinctThemes])</div><div class="line">    ||&gt; Seq.zip</div><div class="line">    |&gt; Map</div><div class="line"></div></pre></td></tr></table></figure>
<p>All the hard work is done.  I now just take the data from the file and run it through a series of filters and transformations to transpose the bricktype and piece color counts into “percent of the set” columns.  Once that is done I write out a file <code>aggregatedata.csv</code> that will be used in Part 2.  I also save a themes lookup file.  The lookup isn’t actually needed for the decision tree processing, but its a nice-to-have if I want to remap the int ids back to text values for evaluation.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Build dataset</span></div><div class="line"><span class="keyword">let</span> dataset = </div><div class="line">    legoSets.Rows</div><div class="line">    <span class="comment">// Exclude blank themes</span></div><div class="line">    |&gt; Seq.filter (<span class="keyword">fun</span> row -&gt; not (String.IsNullOrEmpty(row.T1)))</div><div class="line">    <span class="comment">// Exclude sets with 0 pieces</span></div><div class="line">    |&gt; Seq.filter (<span class="keyword">fun</span> row -&gt; row.Pieces &lt;&gt; <span class="number">0</span>)</div><div class="line">    |&gt; Seq.map (<span class="keyword">fun</span> row -&gt;</div><div class="line">        <span class="comment">// Get item type counts for each row (ie set)</span></div><div class="line">        <span class="keyword">let</span> bricksCount = (getCountLookup row.Set_id).BricksCount</div><div class="line">        <span class="keyword">let</span> platesCount = (getCountLookup row.Set_id).PlatesCount</div><div class="line">        <span class="keyword">let</span> minifigsCount = (getCountLookup row.Set_id).MinifigsCount</div><div class="line">        <span class="keyword">let</span> panelsCount = (getCountLookup row.Set_id).PanelsCount</div><div class="line">        <span class="keyword">let</span> plantsAndAnimalsCount = (getCountLookup row.Set_id).PlantsAndAnimalsCount</div><div class="line">        <span class="keyword">let</span> tilesCount = (getCountLookup row.Set_id).TilesCount</div><div class="line">        <span class="keyword">let</span> technicsCount = (getCountLookup row.Set_id).TechnicsCount</div><div class="line">        <span class="keyword">let</span> redCount = (getCountLookup row.Set_id).RedCount</div><div class="line">        <span class="keyword">let</span> greenCount = (getCountLookup row.Set_id).GreenCount</div><div class="line">        <span class="keyword">let</span> blueCount = (getCountLookup row.Set_id).BlueCount</div><div class="line">        <span class="keyword">let</span> whiteCount = (getCountLookup row.Set_id).WhiteCount</div><div class="line">        <span class="keyword">let</span> blackCount = (getCountLookup row.Set_id).BlackCount</div><div class="line">        <span class="keyword">let</span> grayCount = (getCountLookup row.Set_id).GrayCount</div><div class="line">        <span class="keyword">let</span> silverCount = (getCountLookup row.Set_id).SilverCount</div><div class="line">        <span class="keyword">let</span> translucentCount = (getCountLookup row.Set_id).TranslucentCount</div><div class="line"></div><div class="line">        <span class="comment">// Build a record for writing</span></div><div class="line">        &#123;SetId = row.Set_id;</div><div class="line">         Year = row.Year;</div><div class="line">         ThemeId = themesLookup.Item row.T1;</div><div class="line">         PiecesCount = row.Pieces;</div><div class="line">         BricksPct = float(bricksCount) / float(row.Pieces);</div><div class="line">         PlatesPct = float(platesCount) / float(row.Pieces);</div><div class="line">         MinifigsPct = float(minifigsCount) / float(row.Pieces);          </div><div class="line">         PanelsPct = float(panelsCount) / float(row.Pieces); </div><div class="line">         PlantsAndAnimalsPct = float(plantsAndAnimalsCount) / float(row.Pieces); </div><div class="line">         TilesPct = float(tilesCount) / float(row.Pieces);</div><div class="line">         TechnicsPct = float(technicsCount) / float(row.Pieces);</div><div class="line">         RedPct = float(redCount) / float(row.Pieces);</div><div class="line">         GreenPct = float(greenCount) / float(row.Pieces);</div><div class="line">         BluePct = float(blueCount) / float(row.Pieces);</div><div class="line">         WhitePct = float(whiteCount) / float(row.Pieces);</div><div class="line">         BlackPct = float(blackCount) / float(row.Pieces);</div><div class="line">         GrayPct = float(grayCount) / float(row.Pieces);</div><div class="line">         SilverPct = float(silverCount) / float(row.Pieces);</div><div class="line">         TranslucentPct = float(translucentCount) / float(row.Pieces)&#125;)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Write dataset to output file</span></div><div class="line"><span class="keyword">let</span> dataFile = List.Cons (</div><div class="line">    <span class="string">"ThemeId,Year,PiecesCount,BricksPct,PlatesPct,MinifigsPct,PanelsPct,PlantsAndAnimalsPct,TilesPct,TechnicsCount,RedPct,GreenPct,BluePct,WhitePct,BlackPct,GrayPct,SilverPct,TranslucentPct"</span>, </div><div class="line">    dataset</div><div class="line">    |&gt; Seq.toList</div><div class="line">    |&gt; List.map SetDetail.toCsv)</div><div class="line">	</div><div class="line">File.WriteAllLines(Path.Combine(__SOURCE_DIRECTORY__, <span class="string">@"..\\data\\legos\\aggregatedata.csv"</span>), dataFile)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Write themes lookup to a file</span></div><div class="line"><span class="keyword">let</span> themesFile = List.Cons (</div><div class="line">    <span class="string">"ThemeId,Theme"</span>,</div><div class="line">    themesLookup</div><div class="line">    |&gt; Map.toList </div><div class="line">    |&gt; List.map (<span class="keyword">fun</span> (key, value) -&gt; sprintf <span class="string">"%s,%d"</span> key value))</div><div class="line"></div><div class="line">File.WriteAllLines(Path.Combine(__SOURCE_DIRECTORY__, <span class="string">@"..\\data\\legos\\aggregatedata_themes.csv"</span>), themesFile)</div></pre></td></tr></table></figure>
<p>Here are samples of the aggregate data and lookups files.</p>
<p>File: aggregatedata.csv<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ThemeId,Year,PiecesCount,BricksPct,PlatesPct,MinifigsPct,PanelsPct,PlantsAndAnimalsPct,TilesPct,TechnicsCount,RedPct,GreenPct,BluePct,WhitePct,BlackPct,GrayPct,SilverPct,TranslucentPct</div><div class="line">0,1970,471,0.8110,0.0892,0.0000,0.0000,0.0000,0.0000,0.0000,0.1359,0.0000,0.0212,0.4480,0.0000,0.0828,0.0000,0.0000</div><div class="line">1,1978,12,0.0000,0.0000,0.8333,0.0000,0.0000,0.0000,0.0000,0.1667,0.0000,0.1667,0.0000,0.2500,0.0000,0.0000,0.0000</div><div class="line">2,1987,2,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>File: aggregatedata_themes.csv<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ThemeId,Theme</div><div class="line">4 Juniors,47</div><div class="line">Adventurers,28</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p><a href="/data/legodecisiontree.zip">Data Files</a></p>
<p>So there are the data transformations.  Until next time…</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://codesuji.com/2016/12/05/Decision-Trees-with-F-and-Accord-NET-Part-1/" data-id="ciz7rohgz0000vwlihfjh0nu4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Accord-NET/">Accord.NET</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Classification/">Classification</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Data/">Data</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Decision-Trees/">Decision Trees</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/F/">F#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FSharp/">FSharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Legos/">Legos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Machine-Learning/">Machine Learning</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/12/07/Decision-Trees-with-F-and-Accord-NET-Part-2/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Decision Trees with F# and Accord.NET (Part 2)
        
      </div>
    </a>
  
  
    <a href="/2016/11/23/Edge-Filter-using-F-and-Accord-NET/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Edge Filter using F# and Accord.NET</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Accord-NET/" style="font-size: 16.67px;">Accord.NET</a> <a href="/tags/Analytics/" style="font-size: 11.67px;">Analytics</a> <a href="/tags/Audio/" style="font-size: 10px;">Audio</a> <a href="/tags/Classification/" style="font-size: 11.67px;">Classification</a> <a href="/tags/Cognitive-Services/" style="font-size: 11.67px;">Cognitive Services</a> <a href="/tags/Compiler/" style="font-size: 11.67px;">Compiler</a> <a href="/tags/Computer-Vision/" style="font-size: 10px;">Computer Vision</a> <a href="/tags/DTW/" style="font-size: 11.67px;">DTW</a> <a href="/tags/Data/" style="font-size: 18.33px;">Data</a> <a href="/tags/Decision-Trees/" style="font-size: 11.67px;">Decision Trees</a> <a href="/tags/Deedle/" style="font-size: 10px;">Deedle</a> <a href="/tags/Delegate/" style="font-size: 10px;">Delegate</a> <a href="/tags/Detection/" style="font-size: 10px;">Detection</a> <a href="/tags/Dynamic-Time-Warping/" style="font-size: 11.67px;">Dynamic Time Warping</a> <a href="/tags/EEG/" style="font-size: 10px;">EEG</a> <a href="/tags/Edges/" style="font-size: 10px;">Edges</a> <a href="/tags/F/" style="font-size: 20px;">F#</a> <a href="/tags/FParsec/" style="font-size: 10px;">FParsec</a> <a href="/tags/FSharp/" style="font-size: 20px;">FSharp</a> <a href="/tags/Faces/" style="font-size: 10px;">Faces</a> <a href="/tags/Filters/" style="font-size: 10px;">Filters</a> <a href="/tags/Http/" style="font-size: 11.67px;">Http</a> <a href="/tags/Images/" style="font-size: 11.67px;">Images</a> <a href="/tags/Ionide/" style="font-size: 10px;">Ionide</a> <a href="/tags/Kaggle/" style="font-size: 10px;">Kaggle</a> <a href="/tags/Legos/" style="font-size: 11.67px;">Legos</a> <a href="/tags/MSIL/" style="font-size: 10px;">MSIL</a> <a href="/tags/Machine-Learning/" style="font-size: 15px;">Machine Learning</a> <a href="/tags/MathNet/" style="font-size: 10px;">MathNet</a> <a href="/tags/Mono/" style="font-size: 10px;">Mono</a> <a href="/tags/Morse-Code/" style="font-size: 10px;">Morse Code</a> <a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a> <a href="/tags/Parsing/" style="font-size: 10px;">Parsing</a> <a href="/tags/Racket/" style="font-size: 10px;">Racket</a> <a href="/tags/Regression/" style="font-size: 10px;">Regression</a> <a href="/tags/Scoring/" style="font-size: 10px;">Scoring</a> <a href="/tags/Signals/" style="font-size: 11.67px;">Signals</a> <a href="/tags/Similarity/" style="font-size: 11.67px;">Similarity</a> <a href="/tags/Sound/" style="font-size: 10px;">Sound</a> <a href="/tags/Statistics/" style="font-size: 13.33px;">Statistics</a> <a href="/tags/Tail-calls/" style="font-size: 10px;">Tail calls</a> <a href="/tags/Text/" style="font-size: 11.67px;">Text</a> <a href="/tags/Translation/" style="font-size: 10px;">Translation</a> <a href="/tags/VS-Code/" style="font-size: 10px;">VS Code</a> <a href="/tags/Webapi/" style="font-size: 11.67px;">Webapi</a> <a href="/tags/admin/" style="font-size: 10px;">admin</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 codesuji.com<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>