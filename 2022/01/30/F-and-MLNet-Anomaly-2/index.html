<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Taking Stock of More Anomalies with F# and ML.NET | codesuji</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="It has been awhile since I posted about Anomaly detection using F# and ML.NET.  Since the ML.NET framework continues to evolve, so it is worth a revisit to investigate changes.  This also provides a g">
<meta name="keywords" content="F#,FSharp,.NET Core,Machine Learning,Signals,MLNet,Timeseries">
<meta property="og:type" content="article">
<meta property="og:title" content="Taking Stock of More Anomalies with F# and ML.NET">
<meta property="og:url" content="http://codesuji.com/2022/01/30/F-and-MLNet-Anomaly-2/index.html">
<meta property="og:site_name" content="codesuji">
<meta property="og:description" content="It has been awhile since I posted about Anomaly detection using F# and ML.NET.  Since the ML.NET framework continues to evolve, so it is worth a revisit to investigate changes.  This also provides a g">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://codesuji.com/images/anomaly2/iidspike.png">
<meta property="og:image" content="http://codesuji.com/images/anomaly2/srcnn.png">
<meta property="og:image" content="http://codesuji.com/images/anomaly2/spikessa.png">
<meta property="og:updated_time" content="2022-05-27T18:49:11.033Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Taking Stock of More Anomalies with F# and ML.NET">
<meta name="twitter:description" content="It has been awhile since I posted about Anomaly detection using F# and ML.NET.  Since the ML.NET framework continues to evolve, so it is worth a revisit to investigate changes.  This also provides a g">
<meta name="twitter:image" content="http://codesuji.com/images/anomaly2/iidspike.png">
  
    <link rel="alternate" href="/atom.xml" title="codesuji" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-89982547-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codesuji</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://codesuji.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-F-and-MLNet-Anomaly-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/01/30/F-and-MLNet-Anomaly-2/" class="article-date">
  <time datetime="2022-01-30T11:52:44.000Z" itemprop="datePublished">2022-01-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Taking Stock of More Anomalies with F# and ML.NET
    </h1>
  

 		<span class="post-count">Read Time: 10 minutes</span>
 	  </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>It has been <a href="https://www.codesuji.com/2019/05/24/F-and-MLNet-Anomaly" target="_blank" rel="noopener">awhile</a> since I posted about Anomaly detection using <a href="https://fsharp.org" target="_blank" rel="noopener">F#</a> and <a href="https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet" target="_blank" rel="noopener">ML.NET</a>.  Since the ML.NET framework continues to evolve, so it is worth a revisit to investigate changes.  This also provides a good opportunity to dig deeper into the anomaly detection options that are provided.</p>
<a id="more"></a>
<p>Setting up dependencies is a two-part process, depending on the operating system. First, add the necessary packages.  Second, <code>Mkl.Redist</code> may require an additional library install.  Microsoft has details at <a href="https://docs.microsoft.com/en-us/dotnet/machine-learning/how-to-guides/install-extra-dependencies" target="_blank" rel="noopener">install extra dependencies</a> for the specific requirements, but I include an example of installing and loading the library on Ubuntu.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dotnet add package Microsoft.ML --version 1.7.1</span><br><span class="line">dotnet add package Microsoft.ML.FastTree --version 1.7.1</span><br><span class="line">dotnet add package Microsoft.ML.Mkl.Components --version 1.7.1</span><br><span class="line">dotnet add package Microsoft.ML.MklRedist --version 1.7.1</span><br><span class="line">dotnet add package Microsoft.ML.TimeSeries --version 1.7.1</span><br><span class="line">dotnet add package Plotly.NET --version 2.0.0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Additional requirement installation (For Linux)</span><br><span class="line">sudo bash</span><br><span class="line">cd /tmp</span><br><span class="line">wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB</span><br><span class="line">apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB</span><br><span class="line">rm GPG-PUB-KEY-INTEL-SW-PRODUCTS-2019.PUB</span><br><span class="line">exit</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install intel-mkl-64bit-2020.4-912</span><br><span class="line">sudo ldconfig /opt/intel/compilers_and_libraries_2020.4.304/linux/compiler/lib/intel64_lin</span><br></pre></td></tr></table></figure>
<p>Last time I used the Dow Jones stock index for my example.  This time I’m going to shift a bit, and use the NASDAQ index.  I’m using the same data format as before, below is a snippet of the source data.  It is extensive stock price data, but I will only use Date and Close price today.  It was exported from <a href="https://finance.yahoo.com/quote/%5EIXIC?p=^IXIC&amp;.tsrc=fin-srch" target="_blank" rel="noopener">Yahoo! Finance</a>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># Data Rows</span><br><span class="line">Date,Open,High,Low,Close,Adj Close,Volume</span><br><span class="line">2010-01-04,2294.409912,2311.149902,2294.409912,2308.419922,2308.419922,1931380000</span><br><span class="line">2010-01-05,2307.270020,2313.729980,2295.620117,2308.709961,2308.709961,2367860000</span><br><span class="line">2010-01-06,2307.709961,2314.070068,2295.679932,2301.090088,2301.090088,2253340000</span><br><span class="line">2010-01-07,2298.090088,2301.300049,2285.219971,2300.050049,2300.050049,2270050000</span><br><span class="line">2010-01-08,2292.239990,2317.600098,2290.610107,2317.169922,2317.169922,2145390000</span><br><span class="line">2010-01-11,2324.780029,2326.280029,2302.209961,2312.409912,2312.409912,2077890000</span><br><span class="line">2010-01-12,2297.280029,2298.850098,2272.699951,2282.310059,2282.310059,2368320000</span><br><span class="line">2010-01-13,2289.459961,2313.030029,2274.120117,2307.899902,2307.899902,2318350000</span><br><span class="line">2010-01-14,2303.310059,2322.560059,2303.290039,2316.739990,2316.739990,2254170000</span><br></pre></td></tr></table></figure>
<p>The setup is similar to before. I need to setup a PriceData type for data loading, and PricePrediction for the anomaly detection. </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> System</span><br><span class="line"><span class="keyword">open</span> Microsoft.ML</span><br><span class="line"><span class="keyword">open</span> Microsoft.ML.Data</span><br><span class="line"><span class="keyword">open</span> Microsoft.ML.Transforms.TimeSeries</span><br><span class="line"><span class="keyword">open</span> Plotly.NET</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">PriceData</span> </span>() =</span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(0)&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Date: string</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(1)&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Open: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(2)&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> High: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(3)&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Low: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(4)&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Close: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(5)&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> AdjClose: float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;LoadColumn(6)&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Volume: float32</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">PricePrediction</span> </span>() =</span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Date: string</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Prediction: double[]</span><br></pre></td></tr></table></figure>
<p>Before I get into the detection, there is some work to be done.  First is setting up the MLContext that will be used in the transformations and detections.  I will also load the actual price data into its own array and chart,, so I can use it in the final display phase later. </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> dataPath = <span class="string">"nasdaq.csv"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> context = MLContext()</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data = </span><br><span class="line">  context</span><br><span class="line">    .Data</span><br><span class="line">    .LoadFromTextFile&lt;PriceData&gt; (</span><br><span class="line">      path = dataPath,</span><br><span class="line">      hasHeader = <span class="keyword">true</span>,</span><br><span class="line">      separatorChar = ',')</span><br><span class="line"></span><br><span class="line"><span class="comment">///////////////</span></span><br><span class="line"><span class="comment">// Pricing data</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> priceData =</span><br><span class="line">  context</span><br><span class="line">    .Data</span><br><span class="line">    .CreateEnumerable&lt;PriceData&gt;(data, <span class="keyword">false</span>)</span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> x -&gt; (x.Date, float (x.Close)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> priceChart =</span><br><span class="line">  Chart.Line(priceData, Name = <span class="string">"Price"</span>)</span><br></pre></td></tr></table></figure>
<p>The first anomaly detection method to look at is IidSpike.  This is the method used in the original <a href="https://www.codesuji.com/2019/05/24/F-and-MLNet-Anomaly" target="_blank" rel="noopener">post</a>.  Creating an anomaly detector hasn’t changed too much between versions. There are a couple small parameter issues, but the transition is pretty clean.  As is often the case, the values for confidence and pvalueHistoryLength can/will be situation dependent, but for example purposes these work reasonably well.  After determining the anomalies for the data, I pair the detected anomalies with the price data for a chart.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> iidSpikeData = </span><br><span class="line">  context</span><br><span class="line">    .Transforms</span><br><span class="line">    .DetectIidSpike(</span><br><span class="line">      outputColumnName = <span class="string">"Prediction"</span>,</span><br><span class="line">      inputColumnName = <span class="string">"Close"</span>,</span><br><span class="line">      side = AnomalySide.TwoSided,</span><br><span class="line">      confidence = <span class="number">95.</span>, </span><br><span class="line">      pvalueHistoryLength = <span class="number">50</span>)</span><br><span class="line">    .Fit(data)</span><br><span class="line">    .Transform(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> iidSpikeAnomalies = </span><br><span class="line">  context</span><br><span class="line">    .Data</span><br><span class="line">    .CreateEnumerable&lt;PricePrediction&gt;(iidSpikeData, reuseRowObject = <span class="keyword">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> iidSpikeChartData = </span><br><span class="line">  (priceData, iidSpikeAnomalies)</span><br><span class="line">  ||&gt; Seq.zip</span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> (p, a) -&gt;</span><br><span class="line">      <span class="comment">// For all anomalies, use closing price to show on the chart</span></span><br><span class="line">      (a.Date, <span class="keyword">if</span> (a.Prediction).[<span class="number">0</span>] = <span class="number">0.</span> <span class="keyword">then</span> None <span class="keyword">else</span> Some (snd p)))</span><br><span class="line">  |&gt; Seq.filter (<span class="keyword">fun</span> (_x, y) -&gt; y.IsSome)</span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> (x, y) -&gt; (x, y.Value))</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> iidSpikeChart = </span><br><span class="line">  Chart.Scatter (iidSpikeChartData, StyleParam.Mode.Markers, Name = <span class="string">"iidSpike"</span>)</span><br><span class="line"></span><br><span class="line">[ priceChart; iidSpikeChart ]</span><br><span class="line">|&gt; Chart.combine</span><br><span class="line">|&gt; Chart.withTitle <span class="string">"Close Price (IidSpike)"</span></span><br><span class="line">|&gt; Chart.show</span><br></pre></td></tr></table></figure>
<p><img src="/images/anomaly2/iidspike.png" alt="Price Anomalies - IidSpike"></p>
<p>One of the main goals of this posts is to investigate additional anomaly detection methods that ML.NET provides.  The second anomaly detection method to look at is SrCnn.  Its methodology is based on leveraging Spectral Residual and a Convolutional Neural Network.  You can read more details on the underlying mechanisms and reasoning on their website <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.ml.transforms.timeseries.srcnnanomalyestimator?view=ml-dotnet" target="_blank" rel="noopener"> SrCnnAnomalyEstimator</a> and whitepaper <a href="https://arxiv.org/pdf/1906.03821.pdf" target="_blank" rel="noopener">Time-Series Anomaly Detection Service at Microsoft</a>.  Below is a pipeline for detection using SrCnn. One takeaway is the code is nearly identical to the IidSpike example; just replace the <code>DetectIidSpike</code> call with <code>DetectAnomalyBySrCnn</code>.  Perhaps this isn’t surprising, but it makes experimentation easy as snapping pieces in and out.  Since the parameter support is different for the calls there is a bit more work.  I’m only using windowSize to define the sliding window, but it does have more knobs (like threshold) to tweak.  Like before, I pair the detected anomalies with the price data for a chart.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> srCnnData = </span><br><span class="line">  context</span><br><span class="line">    .Transforms</span><br><span class="line">    .DetectAnomalyBySrCnn(</span><br><span class="line">      outputColumnName = <span class="string">"Prediction"</span>,</span><br><span class="line">      inputColumnName = <span class="string">"Close"</span>,</span><br><span class="line">      windowSize = <span class="number">50</span>)</span><br><span class="line">    .Fit(data)</span><br><span class="line">    .Transform(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> srCnnAnomalies = </span><br><span class="line">  context</span><br><span class="line">    .Data</span><br><span class="line">    .CreateEnumerable&lt;PricePrediction&gt;(srCnnData, reuseRowObject = <span class="keyword">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> srCnnChartData = </span><br><span class="line">  (priceData, srCnnAnomalies)</span><br><span class="line">  ||&gt; Seq.zip</span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> (p, a) -&gt;</span><br><span class="line">      <span class="comment">// For all anomalies, use closing price to show on the chart</span></span><br><span class="line">      (a.Date, <span class="keyword">if</span> (a.Prediction).[<span class="number">0</span>] = <span class="number">0.</span> <span class="keyword">then</span> None <span class="keyword">else</span> Some (snd p)))</span><br><span class="line">  |&gt; Seq.filter (<span class="keyword">fun</span> (_x, y) -&gt; y.IsSome)</span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> (x, y) -&gt; (x, y.Value))</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> srCnnChart = </span><br><span class="line">  Chart.Scatter (srCnnChartData, StyleParam.Mode.Markers, Name = <span class="string">"srCnn"</span>)</span><br><span class="line"></span><br><span class="line">[ priceChart; srCnnChart ]</span><br><span class="line">|&gt; Chart.combine</span><br><span class="line">|&gt; Chart.withTitle <span class="string">"Close Price (SrCnn)"</span></span><br><span class="line">|&gt; Chart.show</span><br></pre></td></tr></table></figure>
<p><img src="/images/anomaly2/srcnn.png" alt="Price Anomalies - SrCnn"></p>
<p>The next anomaly detection method up for experimentation is spikeSSa.  This method uses Singular spectrum analysis to detect anomalies.  Microsoft has more details regarding its methodology at <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.ml.transforms.timeseries.ssaspikeestimator?view=ml-dotnet" target="_blank" rel="noopener">SsaSpikeEstimator</a> and with the whitepaper <a href="https://arxiv.org/pdf/1206.6910.pdf" target="_blank" rel="noopener">Basic Singular Spectrum Analysis and Forecasting with R</a>.  As with SrCnn, I can snap in the <code>DetectBySsa</code> estimator into the pipeline.  This does have more knobs to tweak, so some experimentation is worthwhile to determine the best settings for your particular situation.  Once detected, I link the anomalies with the data to make a nice chart.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> spikeSsaData = </span><br><span class="line">  context</span><br><span class="line">    .Transforms</span><br><span class="line">    .DetectSpikeBySsa(</span><br><span class="line">      outputColumnName = <span class="string">"Prediction"</span>,</span><br><span class="line">      inputColumnName = <span class="string">"Close"</span>,</span><br><span class="line">      confidence = <span class="number">95.</span>,</span><br><span class="line">      pvalueHistoryLength = <span class="number">100</span>,</span><br><span class="line">      trainingWindowSize = <span class="number">1000</span>,</span><br><span class="line">      seasonalityWindowSize = <span class="number">100</span>,</span><br><span class="line">      side = AnomalySide.TwoSided)</span><br><span class="line">    .Fit(data)</span><br><span class="line">    .Transform(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> spikeSsaAnomalies = </span><br><span class="line">  context</span><br><span class="line">    .Data</span><br><span class="line">    .CreateEnumerable&lt;PricePrediction&gt;(spikeSsaData, reuseRowObject = <span class="keyword">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> spikeSsaChartData = </span><br><span class="line">  (priceData, spikeSsaAnomalies)</span><br><span class="line">  ||&gt; Seq.zip</span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> (p, a) -&gt;</span><br><span class="line">      <span class="comment">// For all anomalies, use closing price to show on the chart</span></span><br><span class="line">      (a.Date, <span class="keyword">if</span> (a.Prediction).[<span class="number">0</span>] = <span class="number">0.</span> <span class="keyword">then</span> None <span class="keyword">else</span> Some (snd p)))</span><br><span class="line">  |&gt; Seq.filter (<span class="keyword">fun</span> (_x, y) -&gt; y.IsSome)</span><br><span class="line">  |&gt; Seq.map (<span class="keyword">fun</span> (x, y) -&gt; (x, y.Value))</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> spikeSsaChart = </span><br><span class="line">  Chart.Scatter (spikeSsaChartData, StyleParam.Mode.Markers, Name = <span class="string">"spikeSsa"</span>)</span><br><span class="line"></span><br><span class="line">[ priceChart; spikeSsaChart ]</span><br><span class="line">|&gt; Chart.combine</span><br><span class="line">|&gt; Chart.withTitle <span class="string">"Close Price (SpikeSsa)"</span></span><br><span class="line">|&gt; Chart.show</span><br></pre></td></tr></table></figure>
<p><img src="/images/anomaly2/spikessa.png" alt="Price Anomalies - SpikeSsa"></p>
<p>Now that we’ve gone over these three methods, you can see from their charts they have differing sensitivies to anomalies.  This doesn’t even take into account hyperparameter optimization for options such as window-size, confidence, and ovaluehistory.  As always, its great to have options, and I’ve found that depending on my needs I graviate to different methods.  This has been a short foray into additional anomaly detection methods provided by ML.NET.  Examples can go a long way to help wrapping your head around the possiblities.  I hope you found this useful in your ML.NET projects, or perhaps has intrigued you enough to try it.  Until next time. </p>

        <div class="related-posts-box">
        Related Posts:<ul class="related-posts"><li class="related-posts-item"><a class="related-posts-link" href="/2019/05/24/F-and-MLNet-Anomaly/">Taking Stock of Anomalies with F# and ML.NET</a></li><li class="related-posts-item"><a class="related-posts-link" href="/2018/11/30/F-and-MLNet-Clustering-V2/">F# and ML.NET Clustering (V2)</a></li><li class="related-posts-item"><a class="related-posts-link" href="/2018/06/23/F-and-MLNet-Classification/">F# and ML.NET Classification</a></li></ul>        </div>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codesuji.com/2022/01/30/F-and-MLNet-Anomaly-2/" data-id="cl3kwsbxp0000jhmwi9trrfnu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET-Core/">.NET Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/F/">F#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FSharp/">FSharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MLNet/">MLNet</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Machine-Learning/">Machine Learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Signals/">Signals</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Timeseries/">Timeseries</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/05/17/Data-in-Motion-Population/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Data in Motion - Population Map
        
      </div>
    </a>
  
  
    <a href="/2021/12/11/Discriminated-Unions-and-Dapper/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Discriminated Unions and Dapper</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/NET-Core/" style="font-size: 17px;">.NET Core</a> <a href="/tags/Accord-NET/" style="font-size: 15px;">Accord.NET</a> <a href="/tags/Analytics/" style="font-size: 14px;">Analytics</a> <a href="/tags/Audio/" style="font-size: 10px;">Audio</a> <a href="/tags/Benchmarking/" style="font-size: 10px;">Benchmarking</a> <a href="/tags/Chiron/" style="font-size: 10px;">Chiron</a> <a href="/tags/Classification/" style="font-size: 11px;">Classification</a> <a href="/tags/Cognitive-Services/" style="font-size: 11px;">Cognitive Services</a> <a href="/tags/Compiler/" style="font-size: 13px;">Compiler</a> <a href="/tags/Computer-Vision/" style="font-size: 11px;">Computer Vision</a> <a href="/tags/Cordova/" style="font-size: 10px;">Cordova</a> <a href="/tags/DTW/" style="font-size: 14px;">DTW</a> <a href="/tags/Data/" style="font-size: 18px;">Data</a> <a href="/tags/Database/" style="font-size: 13px;">Database</a> <a href="/tags/Decision-Trees/" style="font-size: 11px;">Decision Trees</a> <a href="/tags/Deedle/" style="font-size: 10px;">Deedle</a> <a href="/tags/Delegate/" style="font-size: 10px;">Delegate</a> <a href="/tags/Detection/" style="font-size: 10px;">Detection</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Dynamic-Time-Warping/" style="font-size: 13px;">Dynamic Time Warping</a> <a href="/tags/EEG/" style="font-size: 10px;">EEG</a> <a href="/tags/Edges/" style="font-size: 10px;">Edges</a> <a href="/tags/Education/" style="font-size: 10px;">Education</a> <a href="/tags/Elmish/" style="font-size: 10px;">Elmish</a> <a href="/tags/EmguCV/" style="font-size: 10px;">EmguCV</a> <a href="/tags/Entropy/" style="font-size: 10px;">Entropy</a> <a href="/tags/F/" style="font-size: 20px;">F#</a> <a href="/tags/FParsec/" style="font-size: 12px;">FParsec</a> <a href="/tags/FSAdvent/" style="font-size: 10px;">FSAdvent</a> <a href="/tags/FSharp/" style="font-size: 20px;">FSharp</a> <a href="/tags/Fable/" style="font-size: 10px;">Fable</a> <a href="/tags/Faces/" style="font-size: 11px;">Faces</a> <a href="/tags/Filters/" style="font-size: 10px;">Filters</a> <a href="/tags/Http/" style="font-size: 11px;">Http</a> <a href="/tags/Images/" style="font-size: 12px;">Images</a> <a href="/tags/Ionide/" style="font-size: 10px;">Ionide</a> <a href="/tags/Kaggle/" style="font-size: 12px;">Kaggle</a> <a href="/tags/Keyboard/" style="font-size: 13px;">Keyboard</a> <a href="/tags/Legos/" style="font-size: 11px;">Legos</a> <a href="/tags/Logging/" style="font-size: 10px;">Logging</a> <a href="/tags/MLNet/" style="font-size: 16px;">MLNet</a> <a href="/tags/MSIL/" style="font-size: 12px;">MSIL</a> <a href="/tags/Machine-Learning/" style="font-size: 19px;">Machine Learning</a> <a href="/tags/MathNet/" style="font-size: 10px;">MathNet</a> <a href="/tags/Messaging/" style="font-size: 10px;">Messaging</a> <a href="/tags/Mobile/" style="font-size: 10px;">Mobile</a> <a href="/tags/Mono/" style="font-size: 10px;">Mono</a> <a href="/tags/Morse-Code/" style="font-size: 10px;">Morse Code</a> <a href="/tags/Mqtt/" style="font-size: 12px;">Mqtt</a> <a href="/tags/Nix/" style="font-size: 10px;">Nix</a> <a href="/tags/OpenCV/" style="font-size: 10px;">OpenCV</a> <a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a> <a href="/tags/Parsing/" style="font-size: 12px;">Parsing</a> <a href="/tags/Performance/" style="font-size: 12px;">Performance</a> <a href="/tags/Presentations/" style="font-size: 10px;">Presentations</a> <a href="/tags/Propagator/" style="font-size: 10px;">Propagator</a> <a href="/tags/Racket/" style="font-size: 10px;">Racket</a> <a href="/tags/Regression/" style="font-size: 10px;">Regression</a> <a href="/tags/Rekognition/" style="font-size: 10px;">Rekognition</a> <a href="/tags/Robotics/" style="font-size: 10px;">Robotics</a> <a href="/tags/Rust/" style="font-size: 10px;">Rust</a> <a href="/tags/STEM/" style="font-size: 11px;">STEM</a> <a href="/tags/Scoring/" style="font-size: 10px;">Scoring</a> <a href="/tags/Search/" style="font-size: 11px;">Search</a> <a href="/tags/Serialization/" style="font-size: 10px;">Serialization</a> <a href="/tags/SignalR/" style="font-size: 10px;">SignalR</a> <a href="/tags/Signals/" style="font-size: 13px;">Signals</a> <a href="/tags/Similarity/" style="font-size: 11px;">Similarity</a> <a href="/tags/Sound/" style="font-size: 10px;">Sound</a> <a href="/tags/Statistics/" style="font-size: 13px;">Statistics</a> <a href="/tags/Text/" style="font-size: 14px;">Text</a> <a href="/tags/Timeseries/" style="font-size: 11px;">Timeseries</a> <a href="/tags/Tips/" style="font-size: 12px;">Tips</a> <a href="/tags/Tools/" style="font-size: 10px;">Tools</a> <a href="/tags/Translation/" style="font-size: 10px;">Translation</a> <a href="/tags/Types/" style="font-size: 10px;">Types</a> <a href="/tags/VS-Code/" style="font-size: 10px;">VS Code</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/Webapi/" style="font-size: 11px;">Webapi</a> <a href="/tags/admin/" style="font-size: 11px;">admin</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/08/13/Watc/">Watc</a>
          </li>
        
          <li>
            <a href="/2022/07/24/Data-in-Motion-Earthquakes/">Data in Motion - Earthquakes Map</a>
          </li>
        
          <li>
            <a href="/2022/05/17/Data-in-Motion-Population/">Data in Motion - Population Map</a>
          </li>
        
          <li>
            <a href="/2022/01/30/F-and-MLNet-Anomaly-2/">Taking Stock of More Anomalies with F# and ML.NET</a>
          </li>
        
          <li>
            <a href="/2021/12/11/Discriminated-Unions-and-Dapper/">Discriminated Unions and Dapper</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 codesuji.com<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>