<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Facial Recognition using F# and EmguCV | codesuji</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="As the future rushes upon us, there is the growing desire to have a more integrated interaction with our computers.  One way is to have our computers recognize us; enter facial recognition.  Often thi">
<meta name="keywords" content="F#,FSharp,Machine Learning,Images,EmguCV,OpenCV,Computer Vision,Faces,Rekognition">
<meta property="og:type" content="article">
<meta property="og:title" content="Facial Recognition using F# and EmguCV">
<meta property="og:url" content="http://codesuji.com/2017/05/20/F-and-EmguCV/index.html">
<meta property="og:site_name" content="codesuji">
<meta property="og:description" content="As the future rushes upon us, there is the growing desire to have a more integrated interaction with our computers.  One way is to have our computers recognize us; enter facial recognition.  Often thi">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://codesuji.com/images/emgu1/tooltip-captureimagebitmap.png">
<meta property="og:image" content="http://codesuji.com/images/emgu1/demo.png">
<meta property="og:image" content="http://codesuji.com/images/emgu1/demo-emotion.png">
<meta property="og:updated_time" content="2017-08-02T03:00:29.064Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Facial Recognition using F# and EmguCV">
<meta name="twitter:description" content="As the future rushes upon us, there is the growing desire to have a more integrated interaction with our computers.  One way is to have our computers recognize us; enter facial recognition.  Often thi">
<meta name="twitter:image" content="http://codesuji.com/images/emgu1/tooltip-captureimagebitmap.png">
  
    <link rel="alternate" href="/atom.xml" title="codesuji" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-89982547-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codesuji</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://codesuji.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-F-and-EmguCV" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/20/F-and-EmguCV/" class="article-date">
  <time datetime="2017-05-21T00:32:04.000Z" itemprop="datePublished">2017-05-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Facial Recognition using F# and EmguCV
    </h1>
  

 		<span class="post-count">Read Time: 19 minutes</span>
 	  </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>As the future rushes upon us, there is the growing desire to have a more integrated interaction with our computers.  One way is to have our computers recognize us; enter facial recognition.  Often this can be done with complex tools, but it is encouraging to be able to do it with something as simple as <a href="http://fsharp.org/" target="_blank" rel="external">F#</a> and <a href="http://www.emgu.com" target="_blank" rel="external">EmguCV</a>.  With these tools in hand, facial recognition can be built into personal projects with ease.</p>
<a id="more"></a>
<p>For those not familiar, EmguCV is a one of the available <a href="http://opencv.org/" target="_blank" rel="external">OpenCV</a> .NET wrapper packages.  OpenCV has facial recognition built in, so this post will mostly devolve into the details of wiring it up using F#.  But once complete, this is a good integration point for additional functionality.  Time to get started.</p>
<p>Using <a href="https://github.com/fsprojects/Paket" target="_blank" rel="external">Paket</a>, here is a sample paket.dependencies file.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">source https:<span class="comment">//nuget.org/api/v2</span></div><div class="line"></div><div class="line">nuget EmguCV</div></pre></td></tr></table></figure>
<p><strong>Note:</strong> This project requires an additional step.  I prefer Paket for package management, but that has it’s own set of implications.  For this project there is a manual step after Paket has downloaded the packages.  To get all things to work, the native dlls must be copied into the same directory as the EmguCV dlls.  For me, the command looked like:</p>
<p><code>cp packages\EmguCV\build\native\x64\* packages\EmguCV\lib\net30</code></p>
<p>If you don’t do this, you’re likely to get an error that looks like this:</p>
<p><code>System.TypeInitializationException: The type initializer for &#39;Emgu.CV.CvInvoke&#39; threw an exception. ---&gt; System.DllNotFoundException: cvextern ...</code></p>
<p>Once package installation is complete, it is time to link up the library references.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">System.IO.Directory.SetCurrentDirectory(__SOURCE_DIRECTORY__)</div><div class="line"></div><div class="line">#I <span class="string">"../packages"</span></div><div class="line">#r <span class="string">"../packages/EmguCV/lib/net30/Emgu.CV.UI.dll"</span></div><div class="line">#r <span class="string">"../packages/EmguCV/lib/net30/Emgu.CV.World.dll"</span></div><div class="line"></div><div class="line"><span class="keyword">open</span> System</div><div class="line"><span class="keyword">open</span> System.Drawing</div><div class="line"><span class="keyword">open</span> System.Drawing.Imaging</div><div class="line"><span class="keyword">open</span> System.IO</div><div class="line"><span class="keyword">open</span> Emgu</div><div class="line"><span class="keyword">open</span> Emgu.CV</div><div class="line"><span class="keyword">open</span> Emgu.CV.CvEnum</div><div class="line"><span class="keyword">open</span> Emgu.CV.Structure</div><div class="line"><span class="keyword">open</span> Emgu.CV.UI</div><div class="line"><span class="keyword">open</span> Emgu.Util</div></pre></td></tr></table></figure>
<p>Aiming toward my goal of higher interactivity, I put together a little starter app that uses the webcam to see who is sitting at the computer.  If it doesn’t recognize the person, it prompts to add them to its database so they can be recognized in the future.  Once it knows who they are, it just says hi.  There are also some exploratory commands.  I know, it isn’t much, but its a nice start to a larger, long-term project.</p>
<p>Building from the ground up, the first part is interacting with the camera.  A simple <code>capture.QueryFrame().Bitmap</code> pulls a bitmap.  I use a couple wrapper functions to support returning an image appropriate (<code>Image&lt;Gray,Byte&gt;</code>) for the FacialRecognition calls as well as the ability to save a single and series of images from the camera.  </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// Camera/photo code</span></div><div class="line"><span class="keyword">module</span> Camera =</div><div class="line">    <span class="keyword">let</span> rand = <span class="keyword">new</span> Random()</div><div class="line"></div><div class="line">    <span class="comment">/// Capture image from webcam as a bitmap </span></div><div class="line">    <span class="keyword">let</span> captureImageBitmap () =</div><div class="line">        <span class="keyword">let</span> (capture:Capture) = <span class="keyword">new</span> Capture() </div><div class="line">        <span class="keyword">let</span> (imageBitmap:Bitmap) = capture.QueryFrame().Bitmap </div><div class="line">        imageBitmap </div><div class="line"></div><div class="line">    <span class="comment">/// Capture image from webcam and return a FacialRecognition image</span></div><div class="line">    <span class="keyword">let</span> captureImage () = </div><div class="line">        <span class="keyword">let</span> (image:Image&lt;Gray,Byte&gt;) = <span class="keyword">new</span> Emgu.CV.Image&lt;Gray,Byte&gt;(captureImageBitmap())</div><div class="line">        image</div><div class="line"></div><div class="line">    <span class="comment">/// Capture image from webcam and save as jpg</span></div><div class="line">    <span class="keyword">let</span> captureAndSaveImage (filename:string) = </div><div class="line">        <span class="keyword">let</span> imageBitmap = captureImageBitmap()</div><div class="line">        imageBitmap.Save(filename, ImageFormat.Jpeg)</div><div class="line"></div><div class="line">    <span class="comment">/// Take photos of person and return list of result photo files</span></div><div class="line">    <span class="keyword">let</span> takePhotos count (delayMs:int) dir person =</div><div class="line">        [<span class="number">1.</span>.count]</div><div class="line">        |&gt; List.map (<span class="keyword">fun</span> i -&gt; </div><div class="line">            <span class="keyword">let</span> filename = Path.Combine(dir, (sprintf <span class="string">"%s_%d.jpg"</span> person (rand.Next(<span class="number">1000000000</span>))))</div><div class="line">            captureAndSaveImage filename</div><div class="line">            System.Threading.Thread.Sleep(delayMs)</div><div class="line">            filename)</div></pre></td></tr></table></figure>
<p><em>Note: One extra take-away from the above code is that F# supports triple slash comments that show up in tooltips.</em></p>
<p><img src="/images/emgu1/tooltip-captureimagebitmap.png" alt="Triple-slash Tooltip"></p>
<p>Next, I setup a simple database of photos and people.  There are two components to the database module.  The first is general db-ish type things.  This includes person id/name lookup (person.txt), as well as a list of all photos taken (photos.txt).  I wrap a couple lookup functions using <code>Map</code> as well as the ability to add to the files.  In the future, these will be refactored into a real database, but simple text files work well for a demo.  The second component is the OpenCV trained facial recognizer.  It consists of the ability to train, as well as save the training results (trained.txt).</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// Recognition database</span></div><div class="line"><span class="keyword">module</span> Db =</div><div class="line"></div><div class="line">    <span class="comment">/// Number of photos during image capture</span></div><div class="line">    <span class="keyword">let</span> photosToTake = <span class="number">50</span></div><div class="line"></div><div class="line">    <span class="comment">/// Delay (ms) between photos during image capture</span></div><div class="line">    <span class="keyword">let</span> delayMs = <span class="number">100</span></div><div class="line"></div><div class="line">    <span class="comment">/// Data directory</span></div><div class="line">    <span class="keyword">let</span> dataDir = <span class="string">"../data/"</span></div><div class="line"></div><div class="line">    <span class="comment">/// Lookup table filename: Person id, name</span></div><div class="line">    <span class="keyword">let</span> personFilename = Path.Combine(dataDir, <span class="string">"person.txt"</span>)</div><div class="line"></div><div class="line">    <span class="comment">/// Lookup table filename: Photos id, path</span></div><div class="line">    <span class="keyword">let</span> photosFilename = Path.Combine(dataDir,  <span class="string">"photos.txt"</span>)</div><div class="line"></div><div class="line">    <span class="comment">/// Trained data filename</span></div><div class="line">    <span class="keyword">let</span> trainedFilename = Path.Combine(dataDir, <span class="string">"trained.txt"</span>)</div><div class="line"></div><div class="line">    <span class="comment">/// Person-level summary of prediction match v total result</span></div><div class="line">    <span class="class"><span class="keyword">type</span> <span class="title">ValidationResult</span> </span>= &#123; name:string; matchCount:int; totalCount:int &#125;</div><div class="line"></div><div class="line">    <span class="comment">/// Create a map from a lookup file</span></div><div class="line">    <span class="keyword">let</span> <span class="keyword">private</span> makeMap filename fn = </div><div class="line">        <span class="keyword">if</span> File.Exists(filename) </div><div class="line">        <span class="keyword">then</span> </div><div class="line">            File.ReadAllLines(filename)</div><div class="line">            |&gt; Array.map (<span class="keyword">fun</span> x -&gt; x.Split [| '|' |])</div><div class="line">            |&gt; Array.map fn</div><div class="line">            |&gt; Map.ofArray</div><div class="line">        <span class="keyword">else</span> Map.ofList []</div><div class="line">        </div><div class="line">    <span class="comment">/// Lookup person's id (using name)</span></div><div class="line">    <span class="keyword">let</span> <span class="keyword">private</span> lookupId () = makeMap personFilename (<span class="keyword">fun</span> x -&gt; (x.[<span class="number">1</span>], int x.[<span class="number">0</span>]))</div><div class="line"></div><div class="line">    <span class="comment">/// Lookup person's name (using id)</span></div><div class="line">    <span class="keyword">let</span> <span class="keyword">private</span> lookupName () = makeMap personFilename (<span class="keyword">fun</span> x -&gt; (int x.[<span class="number">0</span>], x.[<span class="number">1</span>]))</div><div class="line"></div><div class="line">    <span class="comment">/// Get a new id for a person</span></div><div class="line">    <span class="keyword">let</span> <span class="keyword">private</span> getNewId () = </div><div class="line">        <span class="keyword">let</span> ids = </div><div class="line">            Map.toArray (lookupName())</div><div class="line">            |&gt; Array.map fst</div><div class="line">        <span class="keyword">if</span> Array.length ids = <span class="number">0</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> (Array.max ids) + <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="comment">/// Get person's id (by name)</span></div><div class="line">    <span class="keyword">let</span> <span class="keyword">private</span> getPersonId (map:Collections.Map&lt;string,int&gt;) (name:string) =</div><div class="line">        <span class="keyword">if</span> map.ContainsKey name <span class="keyword">then</span> Some (map.Item name) <span class="keyword">else</span> None</div><div class="line"></div><div class="line">    <span class="comment">/// Get person's name (by id)</span></div><div class="line">    <span class="keyword">let</span> <span class="keyword">private</span> getPersonName (map:Collections.Map&lt;int,string&gt;) (id:int) =</div><div class="line">        <span class="keyword">if</span> map.ContainsKey id <span class="keyword">then</span> Some (map.Item id) <span class="keyword">else</span> None</div><div class="line"></div><div class="line">    <span class="comment">/// Append to new entries to photo db</span></div><div class="line">    <span class="keyword">let</span> <span class="keyword">private</span> appendPhotosLines photosFilename lines =</div><div class="line">        IO.File.AppendAllLines(photosFilename, lines)</div><div class="line"></div><div class="line">    <span class="comment">/// Add a person to the person lookup file</span></div><div class="line">    <span class="keyword">let</span> <span class="keyword">private</span> addPersonId filename person id = </div><div class="line">        File.AppendAllLines(filename, [| sprintf <span class="string">"%d|%s"</span> id person |])</div><div class="line"></div><div class="line">    <span class="comment">/// Add new photos just taken to photos file</span></div><div class="line">    <span class="keyword">let</span> <span class="keyword">private</span> appendToPhotosFile dbFilename imageNames person = </div><div class="line">        <span class="keyword">let</span> id =</div><div class="line">            <span class="keyword">match</span> getPersonId (lookupId()) person <span class="keyword">with</span></div><div class="line">            | Some(x) -&gt; x</div><div class="line">            | None    -&gt;</div><div class="line">                        <span class="keyword">let</span> id' = getNewId()</div><div class="line">                        addPersonId personFilename person id' |&gt; ignore</div><div class="line">                        id'</div><div class="line"></div><div class="line">        imageNames</div><div class="line">        |&gt; List.map (<span class="keyword">fun</span> x -&gt; sprintf <span class="string">"%d|%s"</span> id x)</div><div class="line">        |&gt; appendPhotosLines dbFilename  </div><div class="line"></div><div class="line">    <span class="comment">/// ... Face Detection Functions (see below) ...</span></div><div class="line"></div><div class="line">    <span class="comment">/// List of people in the db</span></div><div class="line">    <span class="keyword">let</span> PersonList () =</div><div class="line">        lookupId() </div><div class="line">        |&gt; Map.toSeq </div><div class="line">        |&gt; Seq.map fst</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/// Take a photo and lookup person's name</span></div><div class="line">    <span class="comment">/// Return their name</span></div><div class="line">    <span class="keyword">let</span> lookupPerson () =</div><div class="line">        <span class="comment">// take photo</span></div><div class="line">        <span class="keyword">let</span> image = Camera.captureImage()</div><div class="line"></div><div class="line">        <span class="comment">// Lookup in db</span></div><div class="line">        <span class="comment">// if found, return name, else return none</span></div><div class="line">        <span class="keyword">let</span> trainer = getTrainer()</div><div class="line">        <span class="keyword">match</span> trainer <span class="keyword">with</span></div><div class="line">        | Some(trainer) -&gt; getPersonName (lookupName()) (trainer.Predict(image).Label)</div><div class="line">        | _             -&gt; None</div><div class="line"></div><div class="line">    <span class="comment">/// Take photos and add person to database</span></div><div class="line">    <span class="keyword">let</span> addPerson name =</div><div class="line">        <span class="comment">// take photos</span></div><div class="line">        <span class="keyword">let</span> photoList = Camera.takePhotos photosToTake delayMs dataDir name </div><div class="line"></div><div class="line">        <span class="comment">// Add to photosfile</span></div><div class="line">        appendToPhotosFile photosFilename photoList name </div><div class="line"></div><div class="line">        <span class="comment">// Train with new photos</span></div><div class="line">        <span class="keyword">let</span> trainer = trainFaceDetector photosFilename trainedFilename</div><div class="line">        trainer.Save trainedFilename</div><div class="line"></div><div class="line">    <span class="comment">/// Create a blank user (with a smiley face photo)</span></div><div class="line">    <span class="keyword">let</span> createBlankUser () =</div><div class="line">        <span class="keyword">let</span> blankUserId = <span class="number">0</span></div><div class="line">        <span class="keyword">let</span> blankUserName = <span class="string">"blank"</span></div><div class="line">        <span class="keyword">let</span> blankImageName = Path.Combine(dataDir, <span class="string">"blank.jpg"</span>)</div><div class="line"></div><div class="line">        <span class="keyword">let</span> createBlankImage (filename:string) =</div><div class="line">            <span class="keyword">let</span> blankImage = <span class="keyword">new</span> Bitmap(<span class="number">640</span>, <span class="number">480</span>)</div><div class="line">            <span class="keyword">let</span> g = Graphics.FromImage(blankImage)</div><div class="line">            g.FillEllipse(<span class="keyword">new</span> SolidBrush(Color.Yellow), <span class="number">220</span>, <span class="number">140</span>, <span class="number">200</span>, <span class="number">200</span>)</div><div class="line">            g.FillEllipse(<span class="keyword">new</span> SolidBrush(Color.White), <span class="number">260</span>, <span class="number">180</span>, <span class="number">40</span>, <span class="number">40</span>)</div><div class="line">            g.FillEllipse(<span class="keyword">new</span> SolidBrush(Color.White), <span class="number">340</span>, <span class="number">180</span>, <span class="number">40</span>, <span class="number">40</span>)</div><div class="line">            g.DrawArc(<span class="keyword">new</span> Pen(Color.White, <span class="number">5.</span>F), <span class="keyword">new</span> Rectangle(<span class="number">260</span>, <span class="number">230</span>, <span class="number">120</span>, <span class="number">70</span>), <span class="number">10.</span>F, <span class="number">160.</span>F)</div><div class="line">            blankImage.Save(filename, ImageFormat.Jpeg)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> not (File.Exists(personFilename)) </div><div class="line">        <span class="keyword">then</span> </div><div class="line">            addPersonId personFilename blankUserName blankUserId</div><div class="line">            createBlankImage blankImageName</div><div class="line">            appendPhotosLines photosFilename [ sprintf <span class="string">"%d|%s"</span> blankUserId blankImageName ]</div><div class="line">        <span class="keyword">else</span> ()</div><div class="line"></div><div class="line">    <span class="comment">/// Db initial setup</span></div><div class="line">    <span class="keyword">let</span> init() = </div><div class="line">        createBlankUser()</div><div class="line">		</div></pre></td></tr></table></figure>
<p>The application is a fun way to demonstrate functionality, but the really interesting parts (the OpenCV calls) can get lost of big blocks of code. I’ve pulled them out to make scanning for the interesting bits easier.  Training turns out to be pretty easy.  I’ve opted to use the <code>FisherFace</code> model, but Emgu also supports <code>EigenFace</code> and <code>LBPHFace</code> models.  To train, call the <code>CV.Face.FischerFaceRecognizer.Train</code> function. It takes two arrays; one of images, and a corresponding one of int labels.  It also assumes you have multiple classes, which makes sense, since what would you be training otherwise?  To accomodate always having at least two classes, I created a Db.init() function that creates a blank user with a single smiley face image.  Hopefully I don’t get classified as a &#9786;. Currently the training is one big pass, a future refactor will include iterative training.  </p>
<p>Once trained, face prediction is done with the <code>CV.Face.FischerFaceRecognizer.Predict</code> call.  It returns the predicted int label of the face.  This maps to id, so its a simple lookup at that point for the name.  All of the other stuff is boilerplate to load images and return results.  The last part of this puzzle is loading saved predictions, using <code>CV.Face.FisherFaceRecognizer.Load</code>. </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// Train face detector</span></div><div class="line"><span class="keyword">let</span> <span class="keyword">private</span> trainFaceDetector photosFilename trainedFilename =</div><div class="line">    <span class="comment">// Get labels and photos for training</span></div><div class="line">    <span class="keyword">let</span> (ids, photos) = </div><div class="line">        IO.File.ReadAllLines(photosFilename)</div><div class="line">        |&gt; Array.map (<span class="keyword">fun</span> x -&gt; </div><div class="line">            <span class="keyword">let</span> columns = x.Split [| '|' |]</div><div class="line">            (int columns.[<span class="number">0</span>], columns.[<span class="number">1</span>]))</div><div class="line">        |&gt; Array.map (<span class="keyword">fun</span> (id, photoFilename) -&gt;</div><div class="line">            <span class="keyword">let</span> image = <span class="keyword">new</span> Image&lt;Gray, Byte&gt;(photoFilename)</div><div class="line">            (id, image))</div><div class="line">        |&gt; Array.unzip </div><div class="line"></div><div class="line">    <span class="comment">// Train based on photos</span></div><div class="line">    <span class="keyword">let</span> trainer = <span class="keyword">new</span> CV.Face.FisherFaceRecognizer() </div><div class="line">    trainer.Train&lt;Gray, Byte&gt;(photos, ids)</div><div class="line"></div><div class="line">    <span class="comment">// Save trained data</span></div><div class="line">    trainer.Save(trainedFilename)</div><div class="line"></div><div class="line">    trainer</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/// Perform prediction validation for a set of photos and trainer</span></div><div class="line"><span class="keyword">let</span> validatePredictions photosFilename (trainer:Face.FisherFaceRecognizer) =</div><div class="line">        File.ReadAllLines(photosFilename)</div><div class="line">        |&gt; Array.map (<span class="keyword">fun</span> x -&gt; x.Split [| '|' |])</div><div class="line">        |&gt; Array.map (<span class="keyword">fun</span> x -&gt;</div><div class="line">            <span class="keyword">let</span> image = <span class="keyword">new</span> Image&lt;Gray, Byte&gt;(x.[<span class="number">1</span>])</div><div class="line">            <span class="keyword">let</span> predicted = trainer.Predict(image)</div><div class="line">            &#123; </div><div class="line">                ValidationResult.name = lookupName().Item predicted.Label;</div><div class="line">                matchCount = (<span class="keyword">if</span> int x.[<span class="number">0</span>] = predicted.Label <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span>);</div><div class="line">                totalCount = <span class="number">1</span></div><div class="line">            &#125;)</div><div class="line">        |&gt; Array.groupBy (<span class="keyword">fun</span> x -&gt; x.name)</div><div class="line">        |&gt; Array.map (<span class="keyword">fun</span> x -&gt; </div><div class="line">            &#123; </div><div class="line">                ValidationResult.name = fst x;</div><div class="line">                matchCount = snd x |&gt; Array.map (<span class="keyword">fun</span> y -&gt; y.matchCount) |&gt; Array.sum;</div><div class="line">                totalCount = snd x |&gt; Array.map (<span class="keyword">fun</span> y -&gt; y.totalCount) |&gt; Array.sum</div><div class="line">            &#125;)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/// Load the trained face recognizer</span></div><div class="line"><span class="keyword">let</span> getTrainer () =</div><div class="line">    <span class="keyword">let</span> trainer = <span class="keyword">new</span> CV.Face.FisherFaceRecognizer()</div><div class="line">    <span class="keyword">if</span> File.Exists(trainedFilename) </div><div class="line">    <span class="keyword">then</span> </div><div class="line">        trainer.Load(trainedFilename)</div><div class="line">        Some trainer</div><div class="line">    <span class="keyword">else</span> None</div></pre></td></tr></table></figure>
<p>Next, putting it all together.  By this point the interesting things are already complete, all that’s left is wrapper code.  In the <code>App</code> module I build out the commands as well as the main loop.  I also have a small Db.init() call to create the blank image that I mentioned earlier.  Beyond that, the functions speak for themselves (and there are comments), so I won’t go into detail here.  </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// Application</span></div><div class="line"><span class="keyword">module</span> App = </div><div class="line"></div><div class="line">    <span class="comment">/// Add a person to the photo db</span></div><div class="line">    <span class="keyword">let</span> addPerson () = </div><div class="line">        printfn <span class="string">"Name to add (ensure person is in front of the camera): "</span></div><div class="line">        <span class="keyword">let</span> name = Console.ReadLine()</div><div class="line">        printfn <span class="string">"Taking photos and training..."</span></div><div class="line">        Db.addPerson name</div><div class="line"></div><div class="line">    <span class="comment">/// Lookup person currently in front of camera</span></div><div class="line">    <span class="keyword">let</span> whoAmI () =</div><div class="line">        <span class="keyword">let</span> person = Db.lookupPerson()</div><div class="line">        <span class="keyword">match</span> person <span class="keyword">with</span> </div><div class="line">        | Some(person) -&gt;</div><div class="line">            printfn <span class="string">"You are %s"</span> person</div><div class="line">        | None -&gt; </div><div class="line">            printfn <span class="string">"I don't recognize you.  Sorry."</span></div><div class="line"></div><div class="line">    <span class="comment">/// Display a list of known people in the db</span></div><div class="line">    <span class="keyword">let</span> reportPeople () =</div><div class="line">        printfn <span class="string">"People"</span></div><div class="line">        printfn <span class="string">"------"</span></div><div class="line">        Db.PersonList()</div><div class="line">        |&gt; Seq.iter (printfn <span class="string">"%s"</span>)</div><div class="line"></div><div class="line">    <span class="comment">/// Display a validation report for recognition</span></div><div class="line">    <span class="keyword">let</span> reportValidation () =</div><div class="line">        <span class="comment">// run validation against existing photos</span></div><div class="line">        <span class="keyword">let</span> trainer = Db.getTrainer()</div><div class="line">        <span class="keyword">match</span> trainer <span class="keyword">with</span></div><div class="line">        | Some(trainer) -&gt; </div><div class="line">            Db.validatePredictions Db.photosFilename trainer</div><div class="line">            |&gt; Array.iter (<span class="keyword">fun</span> x -&gt; printfn <span class="string">"%10s %5d %5d %5.2f"</span> x.name x.matchCount x.totalCount ((float x.matchCount) / (float x.totalCount)))</div><div class="line">        | _             -&gt; printfn <span class="string">"No training data"</span></div><div class="line"></div><div class="line">    <span class="comment">/// Show available commands</span></div><div class="line">    <span class="keyword">let</span> showHelp() =</div><div class="line">        printfn <span class="string">"Commands: [addperson|whoami|people|validate|help|exit]"</span></div><div class="line"></div><div class="line">    <span class="comment">/// Execute provided command</span></div><div class="line">    <span class="comment">/// Return true to keep processing, false to exit</span></div><div class="line">    <span class="keyword">let</span> doCommand (command:string) = </div><div class="line">        <span class="keyword">match</span> command.ToLower() <span class="keyword">with</span></div><div class="line">        | <span class="string">"addperson"</span>   -&gt; addPerson(); <span class="keyword">true</span></div><div class="line">        | <span class="string">"whoami"</span>      -&gt; whoAmI(); <span class="keyword">true</span></div><div class="line">        | <span class="string">"people"</span>      -&gt; reportPeople(); <span class="keyword">true</span></div><div class="line">        | <span class="string">"validate"</span>    -&gt; reportValidation(); <span class="keyword">true</span></div><div class="line">        | <span class="string">"help"</span>        -&gt; showHelp(); <span class="keyword">true</span></div><div class="line">        | <span class="string">"exit"</span>        -&gt; <span class="keyword">false</span></div><div class="line">        | _             -&gt; printfn <span class="string">"unknown command"</span>; <span class="keyword">true</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/// Get a person's name (by lookup or prompt to add to db)</span></div><div class="line">    <span class="keyword">let</span> getName() =</div><div class="line">        <span class="keyword">let</span> person = Db.lookupPerson()</div><div class="line">        <span class="keyword">match</span> person <span class="keyword">with</span> </div><div class="line">        | Some(person) -&gt;</div><div class="line">            printfn <span class="string">"Hi %s"</span> person</div><div class="line">            Some person</div><div class="line">        | None -&gt; </div><div class="line">            printfn <span class="string">"I don't recognize you. What is your name? "</span></div><div class="line">            <span class="keyword">let</span> name = Console.ReadLine()</div><div class="line">            printfn <span class="string">"Taking photos and training..."</span></div><div class="line">            Db.addPerson name</div><div class="line">            <span class="comment">// Note: Could return name, but I want to explicitly force a lookup</span></div><div class="line">            <span class="comment">//Some name    </span></div><div class="line">            None</div><div class="line"></div><div class="line">    <span class="comment">/// Main</span></div><div class="line">    <span class="keyword">let</span> <span class="keyword">rec</span> main name = </div><div class="line">        <span class="keyword">match</span> name <span class="keyword">with</span></div><div class="line">        | Some(name) -&gt;</div><div class="line">            Console.Write(<span class="string">"&gt; "</span>)</div><div class="line">            <span class="keyword">let</span> line = Console.ReadLine()</div><div class="line">            <span class="keyword">let</span> keepGoing = doCommand line</div><div class="line">            <span class="keyword">if</span> keepGoing <span class="keyword">then</span> main (Some name) <span class="keyword">else</span> ()</div><div class="line">        | None       -&gt;</div><div class="line">            <span class="keyword">let</span> name = getName()</div><div class="line">            main name</div><div class="line"></div><div class="line">Db.init()</div><div class="line">App.main None</div></pre></td></tr></table></figure>
<p>The code is all together, it’s time to take the application for a test drive.  </p>
<p><img src="/images/emgu1/demo.png" alt="Application Execution"></p>
<p>Great! It can tell the difference between people. <em>(Sidebar: the detection isn’t perfect; but more, and better quality, data often helps with accuracy.)</em> But I can’t leave well enough alone.  It feels too impersonal, if only it knew how I was feeling.  Lucky for me, Amazon’s <a href="https://aws.amazon.com/rekognition/" target="_blank" rel="external">Rekognition</a> api holds the key to some fun bits.  The TLDR; the api provides, among other things, its prediction of how a person in a picture is feeling.  Other interesting components are: age range, gender, do they have glasses, and feature location.</p>
<p>Before I get into the code, the first requirement is an AWS account.  Second, an IAM must be created with Rekognition service permissions.  Third, add the IAM credentials to the credentials file, <code>~/.aws/credentials</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[default]</div><div class="line">aws_access_key_id = &lt;your id here&gt;</div><div class="line">aws_secret_access_key = &lt;your key here&gt;</div></pre></td></tr></table></figure>
<p><em>Note: I’ll make a quick mention here about SSL certs.  There was an easy to overcome snag when making the AWS call.  When running the code in VSCode/Ionide, it ran fine.  When running it from the commandline using <code>fsharpi</code>, I got an error.  Specifically this: <code>Amazon.Runtime.AmazonServiceException: A WebException with status TrustFailure was thrown. ---&gt; System.Net.WebException:    Error: TrustFailure (The authentication or decryption has failed.) ---&gt; System.IO.IOException: The authentication or decryption has failed. ---&gt; System.IO.IOException: The authentication or decryption has failed. ---&gt; Mono.Security.Protocol.Tls.TlsException: Invalid certificate received from server. Error code: 0xffffffff800b010a at Mono.Security.Protocol.Tls.RecordProtocol.EndReceiveRecord (System.IAsyncResult asyncResult) ...</code>.  There are several ways to resolve this error.  I opt’d to solve this by importing the mozilla certs for mono using <code>mozroots.exe</code>.  Other options can be found at (<a href="http://www.mono-project.com/docs/faq/security/" target="_blank" rel="external">http://www.mono-project.com/docs/faq/security/</a>); your mileage may vary.</em></p>
<p>Once these components are in place, a couple small modifications are required.  First, add a new package to my package.dependencies file.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nuget AWSSDK.Rekognition </div></pre></td></tr></table></figure>
<p>Next, add the Rekognition dll’s and namespace.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#r <span class="string">"../packages/AWSSDK.Core/lib/net45/AWSSDK.Core.dll"</span></div><div class="line">#r <span class="string">"../packages/AWSSDK.Rekognition/lib/net45/AWSSDK.Rekognition.dll"</span></div><div class="line"></div><div class="line"><span class="keyword">open</span> Amazon</div><div class="line"><span class="keyword">open</span> Amazon.Rekognition</div></pre></td></tr></table></figure>
<p>I’m going to put all the code into a new module.  To get what we need out of the api, the basic workflow is:</p>
<ol>
<li>Take photo as Bitmap.</li>
<li>Create a request object (with the image attached).</li>
<li>Call the Rekognition api with the request object.</li>
<li>Grab the attributes of the response object I care about.</li>
</ol>
<p>For details on the api, I recommend looking at the <a href="http://docs.aws.amazon.com/rekognition/latest/dg/API_DetectFaces.html" target="_blank" rel="external">Rekognition DetectFaces Documentation</a>.  There are a couple small details for my implementation I want to mention.  The api grabs all faces it can find, so FaceDetail is an array.  My use case presumes one person, or if more, it just takes the first one it finds.  The api emotion is a list of possible emotions with their probabilities.  This isn’t very friendly looking, so I only show the highest probability emotion.  The <code>whoAmI</code> function provides some addition interesting reporting from the image.  </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// Additional face analysis features</span></div><div class="line"><span class="keyword">module</span> FaceExtra = </div><div class="line"></div><div class="line">    <span class="comment">/// Take an image and return an aws Model.Image</span></div><div class="line">    <span class="keyword">let</span> <span class="keyword">private</span> bitmapToModelImage (image:Bitmap) = </div><div class="line">        <span class="comment">// Load image into memorystream</span></div><div class="line">        <span class="keyword">let</span> ms = <span class="keyword">new</span> MemoryStream()</div><div class="line">        image.Save(ms, ImageFormat.Jpeg);</div><div class="line"></div><div class="line">        <span class="comment">// Convert memorystream to aws' Model.Image</span></div><div class="line">        <span class="keyword">let</span> modelImage = <span class="keyword">new</span> Model.Image()</div><div class="line">        modelImage.Bytes &lt;- ms</div><div class="line"></div><div class="line">        <span class="comment">// Return model image</span></div><div class="line">        modelImage</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/// Take an image filename and return an aws DetectFacesRequest </span></div><div class="line">    <span class="keyword">let</span> <span class="keyword">private</span> buildRequest (image:Bitmap) = </div><div class="line">        <span class="keyword">let</span> request = <span class="keyword">new</span> Model.DetectFacesRequest()</div><div class="line"></div><div class="line">        <span class="comment">// Get all attributes back from api</span></div><div class="line">        <span class="keyword">let</span> attributeList = <span class="keyword">new</span> Collections.Generic.List&lt;string&gt;()</div><div class="line">        attributeList.Add(<span class="string">"ALL"</span>)</div><div class="line">        request.Attributes &lt;- attributeList</div><div class="line"></div><div class="line">        <span class="comment">// Set Image</span></div><div class="line">        request.Image &lt;- bitmapToModelImage image</div><div class="line"></div><div class="line">        <span class="comment">// Return request</span></div><div class="line">        request</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/// Given a list of emotions, return the highest confidence one (in tuple form)</span></div><div class="line">    <span class="keyword">let</span> getMainEmotion (emotions:Collections.Generic.List&lt;Model.Emotion&gt;) = </div><div class="line">        <span class="keyword">if</span> emotions.Count &lt;&gt; <span class="number">0</span> </div><div class="line">        <span class="keyword">then</span></div><div class="line">            emotions</div><div class="line">            |&gt; Seq.sortByDescending (<span class="keyword">fun</span> x -&gt; x.Confidence)</div><div class="line">            |&gt; Seq.head</div><div class="line">            |&gt; (<span class="keyword">fun</span> e -&gt; (e.Type.Value, e.Confidence))</div><div class="line">        <span class="keyword">else</span> (<span class="string">"Unknown"</span>, float32 <span class="number">0.</span>)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/// Query the rekognition api using the provided bitmap image</span></div><div class="line">    <span class="keyword">let</span> getFaceDetails (image:Bitmap) = </div><div class="line">        <span class="keyword">let</span> request = buildRequest image</div><div class="line"></div><div class="line">        <span class="keyword">let</span> rekognition = <span class="keyword">new</span> Amazon.Rekognition.AmazonRekognitionClient(Amazon.RegionEndpoint.USEast1)</div><div class="line"></div><div class="line">        <span class="keyword">let</span> detectedFaces = rekognition.DetectFaces(request)</div><div class="line"></div><div class="line">        detectedFaces</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/// Take a snapshot and determine the person's emotional state.</span></div><div class="line">    <span class="keyword">let</span> getCurrentEmotion () =</div><div class="line">        <span class="keyword">let</span> details = getFaceDetails (Camera.captureImageBitmap())</div><div class="line"></div><div class="line">        <span class="keyword">if</span> details.FaceDetails.Count &lt;&gt; <span class="number">0</span></div><div class="line">        <span class="keyword">then</span> Some ((fst (getMainEmotion details.FaceDetails.[<span class="number">0</span>].Emotions)).ToLower())</div><div class="line">        <span class="keyword">else</span> None</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/// Make a friendly description string for showing if face has an attribute</span></div><div class="line">    <span class="keyword">let</span> attributeDisplay (value:bool) (description:string) =</div><div class="line">        <span class="keyword">if</span> value <span class="keyword">then</span> sprintf <span class="string">"Has %s"</span> description <span class="keyword">else</span> sprintf <span class="string">"No %s"</span> description </div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/// Build a simple report string</span></div><div class="line">    <span class="keyword">let</span> getFaceReport () = </div><div class="line">        <span class="keyword">let</span> details = getFaceDetails (Camera.captureImageBitmap())</div><div class="line"></div><div class="line">        <span class="keyword">if</span> details.FaceDetails.Count &lt;&gt; <span class="number">0</span></div><div class="line">        <span class="keyword">then</span></div><div class="line">            <span class="keyword">let</span> face = details.FaceDetails.[<span class="number">0</span>]</div><div class="line">            sprintf </div><div class="line">                <span class="string">"Gender: %s\r\nAge: %d - %d\r\nEmotions: %s\r\n%s\r\n%s\r\n%s\r\n%s"</span> </div><div class="line">                face.Gender.Value.Value </div><div class="line">                face.AgeRange.Low </div><div class="line">                face.AgeRange.High</div><div class="line">                (String.Join(<span class="string">", "</span>, face.Emotions |&gt; Seq.map (<span class="keyword">fun</span> x -&gt; sprintf <span class="string">"%s (%f)"</span> x.Type.Value x.Confidence)))</div><div class="line">                (attributeDisplay face.Beard.Value <span class="string">"beard"</span>)</div><div class="line">                (attributeDisplay face.Mustache.Value <span class="string">"mustache"</span>)</div><div class="line">                (attributeDisplay face.Eyeglasses.Value <span class="string">"glasses"</span>)</div><div class="line">                (attributeDisplay face.Sunglasses.Value <span class="string">"sunglasses"</span>)</div><div class="line">        <span class="keyword">else</span> <span class="string">""</span>		</div></pre></td></tr></table></figure>
<p>The additional functionality gets wired into the <code>whoAmI</code> and <code>getName</code> calls.  This is a pretty simple add.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// Lookup person currently in front of camera</span></div><div class="line"><span class="keyword">let</span> whoAmI () =</div><div class="line">    <span class="keyword">let</span> person = Db.lookupPerson()</div><div class="line">    <span class="keyword">match</span> person <span class="keyword">with</span> </div><div class="line">    | Some(person) -&gt;</div><div class="line">        <span class="keyword">let</span> report = FaceExtra.getFaceReport()</div><div class="line">        printfn <span class="string">"You are %s\r\n%s"</span> person report </div><div class="line">    | None -&gt; </div><div class="line">        printfn <span class="string">"I don't recognize you.  Sorry."</span></div><div class="line"></div><div class="line"><span class="comment">/// Get a person's name (by lookup or prompt to add to db)</span></div><div class="line"><span class="keyword">let</span> getName() =</div><div class="line">    <span class="keyword">let</span> person = Db.lookupPerson()</div><div class="line">    <span class="keyword">match</span> person <span class="keyword">with</span> </div><div class="line">    | Some(person) -&gt;</div><div class="line">        <span class="keyword">let</span> emotion = FaceExtra.getCurrentEmotion()</div><div class="line">        <span class="keyword">match</span> emotion <span class="keyword">with</span></div><div class="line">        | Some(emotion) -&gt; printfn <span class="string">"Hi %s, you seem %s"</span> person emotion</div><div class="line">        | None          -&gt; printfn <span class="string">"Hi %s"</span> person</div><div class="line">        Some person</div><div class="line">    | None -&gt; </div><div class="line">        printfn <span class="string">"I don't recognize you. What is your name? "</span></div><div class="line">        <span class="keyword">let</span> name = Console.ReadLine()</div><div class="line">        printfn <span class="string">"Taking photos and training..."</span></div><div class="line">        Db.addPerson name</div><div class="line">        <span class="comment">// Note: Could return name, but I want to explicitly force a lookup</span></div><div class="line">        <span class="comment">//Some name    </span></div><div class="line">        None</div></pre></td></tr></table></figure>
<p>Time to checkout how the new functionality looks.</p>
<p><img src="/images/emgu1/demo-emotion.png" alt="With Emotion"></p>
<p>Cool.  It did a pretty good job.  The great thing is, this kind of technology will only get better.  This has been fun, but the post has already gone longer than intended, so I’ll end it here.  I hope you enjoyed this little glimpse into facial recognition and information extraction.  Until next time.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://codesuji.com/2017/05/20/F-and-EmguCV/" data-id="cj6ump127000a80liu990hr6k" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Computer-Vision/">Computer Vision</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/EmguCV/">EmguCV</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/F/">F#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FSharp/">FSharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Faces/">Faces</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Images/">Images</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Machine-Learning/">Machine Learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenCV/">OpenCV</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Rekognition/">Rekognition</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/07/28/F-and-SQLite/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          F# and SQLite
        
      </div>
    </a>
  
  
    <a href="/2017/03/13/bf-compiler-part4-optimization/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">BF Compiler Part 4 - Optimization</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/NET-Core/" style="font-size: 10px;">.NET Core</a> <a href="/tags/Accord-NET/" style="font-size: 16.67px;">Accord.NET</a> <a href="/tags/Analytics/" style="font-size: 13.33px;">Analytics</a> <a href="/tags/Audio/" style="font-size: 10px;">Audio</a> <a href="/tags/Classification/" style="font-size: 11.67px;">Classification</a> <a href="/tags/Cognitive-Services/" style="font-size: 11.67px;">Cognitive Services</a> <a href="/tags/Compiler/" style="font-size: 15px;">Compiler</a> <a href="/tags/Computer-Vision/" style="font-size: 11.67px;">Computer Vision</a> <a href="/tags/DTW/" style="font-size: 11.67px;">DTW</a> <a href="/tags/Data/" style="font-size: 18.33px;">Data</a> <a href="/tags/Database/" style="font-size: 11.67px;">Database</a> <a href="/tags/Decision-Trees/" style="font-size: 11.67px;">Decision Trees</a> <a href="/tags/Deedle/" style="font-size: 10px;">Deedle</a> <a href="/tags/Delegate/" style="font-size: 10px;">Delegate</a> <a href="/tags/Detection/" style="font-size: 10px;">Detection</a> <a href="/tags/Dynamic-Time-Warping/" style="font-size: 11.67px;">Dynamic Time Warping</a> <a href="/tags/EEG/" style="font-size: 10px;">EEG</a> <a href="/tags/Edges/" style="font-size: 10px;">Edges</a> <a href="/tags/EmguCV/" style="font-size: 10px;">EmguCV</a> <a href="/tags/F/" style="font-size: 20px;">F#</a> <a href="/tags/FParsec/" style="font-size: 13.33px;">FParsec</a> <a href="/tags/FSharp/" style="font-size: 20px;">FSharp</a> <a href="/tags/Faces/" style="font-size: 11.67px;">Faces</a> <a href="/tags/Filters/" style="font-size: 10px;">Filters</a> <a href="/tags/Http/" style="font-size: 11.67px;">Http</a> <a href="/tags/Images/" style="font-size: 13.33px;">Images</a> <a href="/tags/Ionide/" style="font-size: 10px;">Ionide</a> <a href="/tags/Kaggle/" style="font-size: 10px;">Kaggle</a> <a href="/tags/Legos/" style="font-size: 11.67px;">Legos</a> <a href="/tags/Logging/" style="font-size: 10px;">Logging</a> <a href="/tags/MSIL/" style="font-size: 13.33px;">MSIL</a> <a href="/tags/Machine-Learning/" style="font-size: 16.67px;">Machine Learning</a> <a href="/tags/MathNet/" style="font-size: 10px;">MathNet</a> <a href="/tags/Mono/" style="font-size: 10px;">Mono</a> <a href="/tags/Morse-Code/" style="font-size: 10px;">Morse Code</a> <a href="/tags/OpenCV/" style="font-size: 10px;">OpenCV</a> <a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a> <a href="/tags/Parsing/" style="font-size: 13.33px;">Parsing</a> <a href="/tags/Racket/" style="font-size: 10px;">Racket</a> <a href="/tags/Regression/" style="font-size: 10px;">Regression</a> <a href="/tags/Rekognition/" style="font-size: 10px;">Rekognition</a> <a href="/tags/Scoring/" style="font-size: 10px;">Scoring</a> <a href="/tags/Signals/" style="font-size: 11.67px;">Signals</a> <a href="/tags/Similarity/" style="font-size: 11.67px;">Similarity</a> <a href="/tags/Sound/" style="font-size: 10px;">Sound</a> <a href="/tags/Statistics/" style="font-size: 15px;">Statistics</a> <a href="/tags/Tail-calls/" style="font-size: 10px;">Tail calls</a> <a href="/tags/Text/" style="font-size: 11.67px;">Text</a> <a href="/tags/Translation/" style="font-size: 10px;">Translation</a> <a href="/tags/VS-Code/" style="font-size: 10px;">VS Code</a> <a href="/tags/Webapi/" style="font-size: 11.67px;">Webapi</a> <a href="/tags/admin/" style="font-size: 11.67px;">admin</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 codesuji.com<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>