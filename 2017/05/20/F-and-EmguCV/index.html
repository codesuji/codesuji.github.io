<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Facial Recognition using F# and EmguCV | codesuji</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="As the future rushes upon us, there is the growing desire to have a more integrated interaction with our computers.  One way is to have our computers recognize us; enter facial recognition.  Often thi">
<meta name="keywords" content="F#,FSharp,Machine Learning,Images,EmguCV,OpenCV,Computer Vision,Faces,Rekognition">
<meta property="og:type" content="article">
<meta property="og:title" content="Facial Recognition using F# and EmguCV">
<meta property="og:url" content="http://codesuji.com/2017/05/20/F-and-EmguCV/index.html">
<meta property="og:site_name" content="codesuji">
<meta property="og:description" content="As the future rushes upon us, there is the growing desire to have a more integrated interaction with our computers.  One way is to have our computers recognize us; enter facial recognition.  Often thi">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://codesuji.com/images/emgu1/tooltip-captureimagebitmap.png">
<meta property="og:image" content="http://codesuji.com/images/emgu1/demo.png">
<meta property="og:image" content="http://codesuji.com/images/emgu1/demo-emotion.png">
<meta property="og:updated_time" content="2017-12-23T19:03:14.112Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Facial Recognition using F# and EmguCV">
<meta name="twitter:description" content="As the future rushes upon us, there is the growing desire to have a more integrated interaction with our computers.  One way is to have our computers recognize us; enter facial recognition.  Often thi">
<meta name="twitter:image" content="http://codesuji.com/images/emgu1/tooltip-captureimagebitmap.png">
  
    <link rel="alternate" href="/atom.xml" title="codesuji" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-89982547-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codesuji</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://codesuji.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-F-and-EmguCV" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/05/20/F-and-EmguCV/" class="article-date">
  <time datetime="2017-05-21T00:32:04.000Z" itemprop="datePublished">2017-05-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Facial Recognition using F# and EmguCV
    </h1>
  

 		<span class="post-count">Read Time: 22 minutes</span>
 	  </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>As the future rushes upon us, there is the growing desire to have a more integrated interaction with our computers.  One way is to have our computers recognize us; enter facial recognition.  Often this can be done with complex tools, but it is encouraging to be able to do it with something as simple as <a href="http://fsharp.org/" target="_blank" rel="noopener">F#</a> and <a href="http://www.emgu.com" target="_blank" rel="noopener">EmguCV</a>.  With these tools in hand, facial recognition can be built into personal projects with ease.</p>
<a id="more"></a>
<p>For those not familiar, EmguCV is a one of the available <a href="http://opencv.org/" target="_blank" rel="noopener">OpenCV</a> .NET wrapper packages.  OpenCV has facial recognition built in, so this post will mostly devolve into the details of wiring it up using F#.  But once complete, this is a good integration point for additional functionality.  Time to get started.</p>
<p>Using <a href="https://github.com/fsprojects/Paket" target="_blank" rel="noopener">Paket</a>, here is a sample paket.dependencies file.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">source https:<span class="comment">//nuget.org/api/v2</span></span><br><span class="line"></span><br><span class="line">nuget EmguCV</span><br></pre></td></tr></table></figure>
<p><strong>Note:</strong> This project requires an additional step.  I prefer Paket for package management, but that has it’s own set of implications.  For this project there is a manual step after Paket has downloaded the packages.  To get all things to work, the native dlls must be copied into the same directory as the EmguCV dlls.  For me, the command looked like:</p>
<p><code>cp packages\EmguCV\build\native\x64\* packages\EmguCV\lib\net30</code></p>
<p>If you don’t do this, you’re likely to get an error that looks like this:</p>
<p><code>System.TypeInitializationException: The type initializer for &#39;Emgu.CV.CvInvoke&#39; threw an exception. ---&gt; System.DllNotFoundException: cvextern ...</code></p>
<p>Once package installation is complete, it is time to link up the library references.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">System.IO.Directory.SetCurrentDirectory(__SOURCE_DIRECTORY__)</span><br><span class="line"></span><br><span class="line">#I <span class="string">"../packages"</span></span><br><span class="line">#r <span class="string">"../packages/EmguCV/lib/net30/Emgu.CV.UI.dll"</span></span><br><span class="line">#r <span class="string">"../packages/EmguCV/lib/net30/Emgu.CV.World.dll"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> System</span><br><span class="line"><span class="keyword">open</span> System.Drawing</span><br><span class="line"><span class="keyword">open</span> System.Drawing.Imaging</span><br><span class="line"><span class="keyword">open</span> System.IO</span><br><span class="line"><span class="keyword">open</span> Emgu</span><br><span class="line"><span class="keyword">open</span> Emgu.CV</span><br><span class="line"><span class="keyword">open</span> Emgu.CV.CvEnum</span><br><span class="line"><span class="keyword">open</span> Emgu.CV.Structure</span><br><span class="line"><span class="keyword">open</span> Emgu.CV.UI</span><br><span class="line"><span class="keyword">open</span> Emgu.Util</span><br></pre></td></tr></table></figure>
<p>Aiming toward my goal of higher interactivity, I put together a little starter app that uses the webcam to see who is sitting at the computer.  If it doesn’t recognize the person, it prompts to add them to its database so they can be recognized in the future.  Once it knows who they are, it just says hi.  There are also some exploratory commands.  I know, it isn’t much, but its a nice start to a larger, long-term project.</p>
<p>Building from the ground up, the first part is interacting with the camera.  A simple <code>capture.QueryFrame().Bitmap</code> pulls a bitmap.  I use a couple wrapper functions to support returning an image appropriate (<code>Image&lt;Gray,Byte&gt;</code>) for the FacialRecognition calls as well as the ability to save a single and series of images from the camera.  </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Camera/photo code</span></span><br><span class="line"><span class="keyword">module</span> Camera =</span><br><span class="line">    <span class="keyword">let</span> rand = <span class="keyword">new</span> Random()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Capture image from webcam as a bitmap </span></span><br><span class="line">    <span class="keyword">let</span> captureImageBitmap () =</span><br><span class="line">        <span class="keyword">let</span> (capture:Capture) = <span class="keyword">new</span> Capture() </span><br><span class="line">        <span class="keyword">let</span> (imageBitmap:Bitmap) = capture.QueryFrame().Bitmap </span><br><span class="line">        imageBitmap </span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Capture image from webcam and return a FacialRecognition image</span></span><br><span class="line">    <span class="keyword">let</span> captureImage () = </span><br><span class="line">        <span class="keyword">let</span> (image:Image&lt;Gray,Byte&gt;) = <span class="keyword">new</span> Emgu.CV.Image&lt;Gray,Byte&gt;(captureImageBitmap())</span><br><span class="line">        image</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Capture image from webcam and save as jpg</span></span><br><span class="line">    <span class="keyword">let</span> captureAndSaveImage (filename:string) = </span><br><span class="line">        <span class="keyword">let</span> imageBitmap = captureImageBitmap()</span><br><span class="line">        imageBitmap.Save(filename, ImageFormat.Jpeg)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Take photos of person and return list of result photo files</span></span><br><span class="line">    <span class="keyword">let</span> takePhotos count (delayMs:int) dir person =</span><br><span class="line">        [<span class="number">1.</span>.count]</span><br><span class="line">        |&gt; List.map (<span class="keyword">fun</span> i -&gt; </span><br><span class="line">            <span class="keyword">let</span> filename = Path.Combine(dir, (sprintf <span class="string">"%s_%d.jpg"</span> person (rand.Next(<span class="number">1000000000</span>))))</span><br><span class="line">            captureAndSaveImage filename</span><br><span class="line">            System.Threading.Thread.Sleep(delayMs)</span><br><span class="line">            filename)</span><br></pre></td></tr></table></figure>
<p><em>Note: One extra take-away from the above code is that F# supports triple slash comments that show up in tooltips.</em></p>
<p><img src="/images/emgu1/tooltip-captureimagebitmap.png" alt="Triple-slash Tooltip"></p>
<p>Next, I setup a simple database of photos and people.  There are two components to the database module.  The first is general db-ish type things.  This includes person id/name lookup (person.txt), as well as a list of all photos taken (photos.txt).  I wrap a couple lookup functions using <code>Map</code> as well as the ability to add to the files.  In the future, these will be refactored into a real database, but simple text files work well for a demo.  The second component is the OpenCV trained facial recognizer.  It consists of the ability to train, as well as save the training results (trained.txt).</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Recognition database</span></span><br><span class="line"><span class="keyword">module</span> Db =</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Number of photos during image capture</span></span><br><span class="line">    <span class="keyword">let</span> photosToTake = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Delay (ms) between photos during image capture</span></span><br><span class="line">    <span class="keyword">let</span> delayMs = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Data directory</span></span><br><span class="line">    <span class="keyword">let</span> dataDir = <span class="string">"../data/"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Lookup table filename: Person id, name</span></span><br><span class="line">    <span class="keyword">let</span> personFilename = Path.Combine(dataDir, <span class="string">"person.txt"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Lookup table filename: Photos id, path</span></span><br><span class="line">    <span class="keyword">let</span> photosFilename = Path.Combine(dataDir,  <span class="string">"photos.txt"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Trained data filename</span></span><br><span class="line">    <span class="keyword">let</span> trainedFilename = Path.Combine(dataDir, <span class="string">"trained.txt"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Person-level summary of prediction match v total result</span></span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">ValidationResult</span> </span>= &#123; name:string; matchCount:int; totalCount:int &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Create a map from a lookup file</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">private</span> makeMap filename fn = </span><br><span class="line">        <span class="keyword">if</span> File.Exists(filename) </span><br><span class="line">        <span class="keyword">then</span> </span><br><span class="line">            File.ReadAllLines(filename)</span><br><span class="line">            |&gt; Array.map (<span class="keyword">fun</span> x -&gt; x.Split [| '|' |])</span><br><span class="line">            |&gt; Array.map fn</span><br><span class="line">            |&gt; Map.ofArray</span><br><span class="line">        <span class="keyword">else</span> Map.ofList []</span><br><span class="line">        </span><br><span class="line">    <span class="comment">/// Lookup person's id (using name)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">private</span> lookupId () = makeMap personFilename (<span class="keyword">fun</span> x -&gt; (x.[<span class="number">1</span>], int x.[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Lookup person's name (using id)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">private</span> lookupName () = makeMap personFilename (<span class="keyword">fun</span> x -&gt; (int x.[<span class="number">0</span>], x.[<span class="number">1</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Get a new id for a person</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">private</span> getNewId () = </span><br><span class="line">        <span class="keyword">let</span> ids = </span><br><span class="line">            Map.toArray (lookupName())</span><br><span class="line">            |&gt; Array.map fst</span><br><span class="line">        <span class="keyword">if</span> Array.length ids = <span class="number">0</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> (Array.max ids) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Get person's id (by name)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">private</span> getPersonId (map:Collections.Map&lt;string,int&gt;) (name:string) =</span><br><span class="line">        <span class="keyword">if</span> map.ContainsKey name <span class="keyword">then</span> Some (map.Item name) <span class="keyword">else</span> None</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Get person's name (by id)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">private</span> getPersonName (map:Collections.Map&lt;int,string&gt;) (id:int) =</span><br><span class="line">        <span class="keyword">if</span> map.ContainsKey id <span class="keyword">then</span> Some (map.Item id) <span class="keyword">else</span> None</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Append to new entries to photo db</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">private</span> appendPhotosLines photosFilename lines =</span><br><span class="line">        IO.File.AppendAllLines(photosFilename, lines)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Add a person to the person lookup file</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">private</span> addPersonId filename person id = </span><br><span class="line">        File.AppendAllLines(filename, [| sprintf <span class="string">"%d|%s"</span> id person |])</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Add new photos just taken to photos file</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">private</span> appendToPhotosFile dbFilename imageNames person = </span><br><span class="line">        <span class="keyword">let</span> id =</span><br><span class="line">            <span class="keyword">match</span> getPersonId (lookupId()) person <span class="keyword">with</span></span><br><span class="line">            | Some(x) -&gt; x</span><br><span class="line">            | None    -&gt;</span><br><span class="line">                        <span class="keyword">let</span> id' = getNewId()</span><br><span class="line">                        addPersonId personFilename person id' |&gt; ignore</span><br><span class="line">                        id'</span><br><span class="line"></span><br><span class="line">        imageNames</span><br><span class="line">        |&gt; List.map (<span class="keyword">fun</span> x -&gt; sprintf <span class="string">"%d|%s"</span> id x)</span><br><span class="line">        |&gt; appendPhotosLines dbFilename  </span><br><span class="line"></span><br><span class="line">    <span class="comment">/// ... Face Detection Functions (see below) ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// List of people in the db</span></span><br><span class="line">    <span class="keyword">let</span> PersonList () =</span><br><span class="line">        lookupId() </span><br><span class="line">        |&gt; Map.toSeq </span><br><span class="line">        |&gt; Seq.map fst</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Take a photo and lookup person's name</span></span><br><span class="line">    <span class="comment">/// Return their name</span></span><br><span class="line">    <span class="keyword">let</span> lookupPerson () =</span><br><span class="line">        <span class="comment">// take photo</span></span><br><span class="line">        <span class="keyword">let</span> image = Camera.captureImage()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Lookup in db</span></span><br><span class="line">        <span class="comment">// if found, return name, else return none</span></span><br><span class="line">        <span class="keyword">let</span> trainer = getTrainer()</span><br><span class="line">        <span class="keyword">match</span> trainer <span class="keyword">with</span></span><br><span class="line">        | Some(trainer) -&gt; getPersonName (lookupName()) (trainer.Predict(image).Label)</span><br><span class="line">        | _             -&gt; None</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Take photos and add person to database</span></span><br><span class="line">    <span class="keyword">let</span> addPerson name =</span><br><span class="line">        <span class="comment">// take photos</span></span><br><span class="line">        <span class="keyword">let</span> photoList = Camera.takePhotos photosToTake delayMs dataDir name </span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add to photosfile</span></span><br><span class="line">        appendToPhotosFile photosFilename photoList name </span><br><span class="line"></span><br><span class="line">        <span class="comment">// Train with new photos</span></span><br><span class="line">        <span class="keyword">let</span> trainer = trainFaceDetector photosFilename trainedFilename</span><br><span class="line">        trainer.Save trainedFilename</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Create a blank user (with a smiley face photo)</span></span><br><span class="line">    <span class="keyword">let</span> createBlankUser () =</span><br><span class="line">        <span class="keyword">let</span> blankUserId = <span class="number">0</span></span><br><span class="line">        <span class="keyword">let</span> blankUserName = <span class="string">"blank"</span></span><br><span class="line">        <span class="keyword">let</span> blankImageName = Path.Combine(dataDir, <span class="string">"blank.jpg"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> createBlankImage (filename:string) =</span><br><span class="line">            <span class="keyword">let</span> blankImage = <span class="keyword">new</span> Bitmap(<span class="number">640</span>, <span class="number">480</span>)</span><br><span class="line">            <span class="keyword">let</span> g = Graphics.FromImage(blankImage)</span><br><span class="line">            g.FillEllipse(<span class="keyword">new</span> SolidBrush(Color.Yellow), <span class="number">220</span>, <span class="number">140</span>, <span class="number">200</span>, <span class="number">200</span>)</span><br><span class="line">            g.FillEllipse(<span class="keyword">new</span> SolidBrush(Color.White), <span class="number">260</span>, <span class="number">180</span>, <span class="number">40</span>, <span class="number">40</span>)</span><br><span class="line">            g.FillEllipse(<span class="keyword">new</span> SolidBrush(Color.White), <span class="number">340</span>, <span class="number">180</span>, <span class="number">40</span>, <span class="number">40</span>)</span><br><span class="line">            g.DrawArc(<span class="keyword">new</span> Pen(Color.White, <span class="number">5.</span>F), <span class="keyword">new</span> Rectangle(<span class="number">260</span>, <span class="number">230</span>, <span class="number">120</span>, <span class="number">70</span>), <span class="number">10.</span>F, <span class="number">160.</span>F)</span><br><span class="line">            blankImage.Save(filename, ImageFormat.Jpeg)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> not (File.Exists(personFilename)) </span><br><span class="line">        <span class="keyword">then</span> </span><br><span class="line">            addPersonId personFilename blankUserName blankUserId</span><br><span class="line">            createBlankImage blankImageName</span><br><span class="line">            appendPhotosLines photosFilename [ sprintf <span class="string">"%d|%s"</span> blankUserId blankImageName ]</span><br><span class="line">        <span class="keyword">else</span> ()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Db initial setup</span></span><br><span class="line">    <span class="keyword">let</span> init() = </span><br><span class="line">        createBlankUser()</span><br><span class="line">		</span><br></pre></td></tr></table></figure>
<p>The application is a fun way to demonstrate functionality, but the really interesting parts (the OpenCV calls) can get lost of big blocks of code. I’ve pulled them out to make scanning for the interesting bits easier.  Training turns out to be pretty easy.  I’ve opted to use the <code>FisherFace</code> model, but Emgu also supports <code>EigenFace</code> and <code>LBPHFace</code> models.  To train, call the <code>CV.Face.FischerFaceRecognizer.Train</code> function. It takes two arrays; one of images, and a corresponding one of int labels.  It also assumes you have multiple classes, which makes sense, since what would you be training otherwise?  To accomodate always having at least two classes, I created a Db.init() function that creates a blank user with a single smiley face image.  Hopefully I don’t get classified as a &#9786;. Currently the training is one big pass, a future refactor will include iterative training.  </p>
<p>Once trained, face prediction is done with the <code>CV.Face.FischerFaceRecognizer.Predict</code> call.  It returns the predicted int label of the face.  This maps to id, so its a simple lookup at that point for the name.  All of the other stuff is boilerplate to load images and return results.  The last part of this puzzle is loading saved predictions, using <code>CV.Face.FisherFaceRecognizer.Load</code>. </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Train face detector</span></span><br><span class="line"><span class="keyword">let</span> <span class="keyword">private</span> trainFaceDetector photosFilename trainedFilename =</span><br><span class="line">    <span class="comment">// Get labels and photos for training</span></span><br><span class="line">    <span class="keyword">let</span> (ids, photos) = </span><br><span class="line">        IO.File.ReadAllLines(photosFilename)</span><br><span class="line">        |&gt; Array.map (<span class="keyword">fun</span> x -&gt; </span><br><span class="line">            <span class="keyword">let</span> columns = x.Split [| '|' |]</span><br><span class="line">            (int columns.[<span class="number">0</span>], columns.[<span class="number">1</span>]))</span><br><span class="line">        |&gt; Array.map (<span class="keyword">fun</span> (id, photoFilename) -&gt;</span><br><span class="line">            <span class="keyword">let</span> image = <span class="keyword">new</span> Image&lt;Gray, Byte&gt;(photoFilename)</span><br><span class="line">            (id, image))</span><br><span class="line">        |&gt; Array.unzip </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Train based on photos</span></span><br><span class="line">    <span class="keyword">let</span> trainer = <span class="keyword">new</span> CV.Face.FisherFaceRecognizer() </span><br><span class="line">    trainer.Train&lt;Gray, Byte&gt;(photos, ids)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Save trained data</span></span><br><span class="line">    trainer.Save(trainedFilename)</span><br><span class="line"></span><br><span class="line">    trainer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// Perform prediction validation for a set of photos and trainer</span></span><br><span class="line"><span class="keyword">let</span> validatePredictions photosFilename (trainer:Face.FisherFaceRecognizer) =</span><br><span class="line">        File.ReadAllLines(photosFilename)</span><br><span class="line">        |&gt; Array.map (<span class="keyword">fun</span> x -&gt; x.Split [| '|' |])</span><br><span class="line">        |&gt; Array.map (<span class="keyword">fun</span> x -&gt;</span><br><span class="line">            <span class="keyword">let</span> image = <span class="keyword">new</span> Image&lt;Gray, Byte&gt;(x.[<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">let</span> predicted = trainer.Predict(image)</span><br><span class="line">            &#123; </span><br><span class="line">                ValidationResult.name = lookupName().Item predicted.Label;</span><br><span class="line">                matchCount = (<span class="keyword">if</span> int x.[<span class="number">0</span>] = predicted.Label <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span>);</span><br><span class="line">                totalCount = <span class="number">1</span></span><br><span class="line">            &#125;)</span><br><span class="line">        |&gt; Array.groupBy (<span class="keyword">fun</span> x -&gt; x.name)</span><br><span class="line">        |&gt; Array.map (<span class="keyword">fun</span> x -&gt; </span><br><span class="line">            &#123; </span><br><span class="line">                ValidationResult.name = fst x;</span><br><span class="line">                matchCount = snd x |&gt; Array.map (<span class="keyword">fun</span> y -&gt; y.matchCount) |&gt; Array.sum;</span><br><span class="line">                totalCount = snd x |&gt; Array.map (<span class="keyword">fun</span> y -&gt; y.totalCount) |&gt; Array.sum</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// Load the trained face recognizer</span></span><br><span class="line"><span class="keyword">let</span> getTrainer () =</span><br><span class="line">    <span class="keyword">let</span> trainer = <span class="keyword">new</span> CV.Face.FisherFaceRecognizer()</span><br><span class="line">    <span class="keyword">if</span> File.Exists(trainedFilename) </span><br><span class="line">    <span class="keyword">then</span> </span><br><span class="line">        trainer.Load(trainedFilename)</span><br><span class="line">        Some trainer</span><br><span class="line">    <span class="keyword">else</span> None</span><br></pre></td></tr></table></figure>
<p>Next, putting it all together.  By this point the interesting things are already complete, all that’s left is wrapper code.  In the <code>App</code> module I build out the commands as well as the main loop.  I also have a small Db.init() call to create the blank image that I mentioned earlier.  Beyond that, the functions speak for themselves (and there are comments), so I won’t go into detail here.  </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Application</span></span><br><span class="line"><span class="keyword">module</span> App = </span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Add a person to the photo db</span></span><br><span class="line">    <span class="keyword">let</span> addPerson () = </span><br><span class="line">        printfn <span class="string">"Name to add (ensure person is in front of the camera): "</span></span><br><span class="line">        <span class="keyword">let</span> name = Console.ReadLine()</span><br><span class="line">        printfn <span class="string">"Taking photos and training..."</span></span><br><span class="line">        Db.addPerson name</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Lookup person currently in front of camera</span></span><br><span class="line">    <span class="keyword">let</span> whoAmI () =</span><br><span class="line">        <span class="keyword">let</span> person = Db.lookupPerson()</span><br><span class="line">        <span class="keyword">match</span> person <span class="keyword">with</span> </span><br><span class="line">        | Some(person) -&gt;</span><br><span class="line">            printfn <span class="string">"You are %s"</span> person</span><br><span class="line">        | None -&gt; </span><br><span class="line">            printfn <span class="string">"I don't recognize you.  Sorry."</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Display a list of known people in the db</span></span><br><span class="line">    <span class="keyword">let</span> reportPeople () =</span><br><span class="line">        printfn <span class="string">"People"</span></span><br><span class="line">        printfn <span class="string">"------"</span></span><br><span class="line">        Db.PersonList()</span><br><span class="line">        |&gt; Seq.iter (printfn <span class="string">"%s"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Display a validation report for recognition</span></span><br><span class="line">    <span class="keyword">let</span> reportValidation () =</span><br><span class="line">        <span class="comment">// run validation against existing photos</span></span><br><span class="line">        <span class="keyword">let</span> trainer = Db.getTrainer()</span><br><span class="line">        <span class="keyword">match</span> trainer <span class="keyword">with</span></span><br><span class="line">        | Some(trainer) -&gt; </span><br><span class="line">            Db.validatePredictions Db.photosFilename trainer</span><br><span class="line">            |&gt; Array.iter (<span class="keyword">fun</span> x -&gt; printfn <span class="string">"%10s %5d %5d %5.2f"</span> x.name x.matchCount x.totalCount ((float x.matchCount) / (float x.totalCount)))</span><br><span class="line">        | _             -&gt; printfn <span class="string">"No training data"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Show available commands</span></span><br><span class="line">    <span class="keyword">let</span> showHelp() =</span><br><span class="line">        printfn <span class="string">"Commands: [addperson|whoami|people|validate|help|exit]"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Execute provided command</span></span><br><span class="line">    <span class="comment">/// Return true to keep processing, false to exit</span></span><br><span class="line">    <span class="keyword">let</span> doCommand (command:string) = </span><br><span class="line">        <span class="keyword">match</span> command.ToLower() <span class="keyword">with</span></span><br><span class="line">        | <span class="string">"addperson"</span>   -&gt; addPerson(); <span class="keyword">true</span></span><br><span class="line">        | <span class="string">"whoami"</span>      -&gt; whoAmI(); <span class="keyword">true</span></span><br><span class="line">        | <span class="string">"people"</span>      -&gt; reportPeople(); <span class="keyword">true</span></span><br><span class="line">        | <span class="string">"validate"</span>    -&gt; reportValidation(); <span class="keyword">true</span></span><br><span class="line">        | <span class="string">"help"</span>        -&gt; showHelp(); <span class="keyword">true</span></span><br><span class="line">        | <span class="string">"exit"</span>        -&gt; <span class="keyword">false</span></span><br><span class="line">        | _             -&gt; printfn <span class="string">"unknown command"</span>; <span class="keyword">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Get a person's name (by lookup or prompt to add to db)</span></span><br><span class="line">    <span class="keyword">let</span> getName() =</span><br><span class="line">        <span class="keyword">let</span> person = Db.lookupPerson()</span><br><span class="line">        <span class="keyword">match</span> person <span class="keyword">with</span> </span><br><span class="line">        | Some(person) -&gt;</span><br><span class="line">            printfn <span class="string">"Hi %s"</span> person</span><br><span class="line">            Some person</span><br><span class="line">        | None -&gt; </span><br><span class="line">            printfn <span class="string">"I don't recognize you. What is your name? "</span></span><br><span class="line">            <span class="keyword">let</span> name = Console.ReadLine()</span><br><span class="line">            printfn <span class="string">"Taking photos and training..."</span></span><br><span class="line">            Db.addPerson name</span><br><span class="line">            <span class="comment">// Note: Could return name, but I want to explicitly force a lookup</span></span><br><span class="line">            <span class="comment">//Some name    </span></span><br><span class="line">            None</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Main</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">rec</span> main name = </span><br><span class="line">        <span class="keyword">match</span> name <span class="keyword">with</span></span><br><span class="line">        | Some(name) -&gt;</span><br><span class="line">            Console.Write(<span class="string">"&gt; "</span>)</span><br><span class="line">            <span class="keyword">let</span> line = Console.ReadLine()</span><br><span class="line">            <span class="keyword">let</span> keepGoing = doCommand line</span><br><span class="line">            <span class="keyword">if</span> keepGoing <span class="keyword">then</span> main (Some name) <span class="keyword">else</span> ()</span><br><span class="line">        | None       -&gt;</span><br><span class="line">            <span class="keyword">let</span> name = getName()</span><br><span class="line">            main name</span><br><span class="line"></span><br><span class="line">Db.init()</span><br><span class="line">App.main None</span><br></pre></td></tr></table></figure>
<p>The code is all together, it’s time to take the application for a test drive.  </p>
<p><img src="/images/emgu1/demo.png" alt="Application Execution"></p>
<p>Great! It can tell the difference between people. <em>(Sidebar: the detection isn’t perfect; but more, and better quality, data often helps with accuracy.)</em> But I can’t leave well enough alone.  It feels too impersonal, if only it knew how I was feeling.  Lucky for me, Amazon’s <a href="https://aws.amazon.com/rekognition/" target="_blank" rel="noopener">Rekognition</a> api holds the key to some fun bits.  The TLDR; the api provides, among other things, its prediction of how a person in a picture is feeling.  Other interesting components are: age range, gender, do they have glasses, and feature location.</p>
<p>Before I get into the code, the first requirement is an AWS account.  Second, an IAM must be created with Rekognition service permissions.  Third, add the IAM credentials to the credentials file, <code>~/.aws/credentials</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">aws_access_key_id = &lt;your id here&gt;</span><br><span class="line">aws_secret_access_key = &lt;your key here&gt;</span><br></pre></td></tr></table></figure>
<p><em>Note: I’ll make a quick mention here about SSL certs.  There was an easy to overcome snag when making the AWS call.  When running the code in VSCode/Ionide, it ran fine.  When running it from the commandline using <code>fsharpi</code>, I got an error.  Specifically this: <code>Amazon.Runtime.AmazonServiceException: A WebException with status TrustFailure was thrown. ---&gt; System.Net.WebException:    Error: TrustFailure (The authentication or decryption has failed.) ---&gt; System.IO.IOException: The authentication or decryption has failed. ---&gt; System.IO.IOException: The authentication or decryption has failed. ---&gt; Mono.Security.Protocol.Tls.TlsException: Invalid certificate received from server. Error code: 0xffffffff800b010a at Mono.Security.Protocol.Tls.RecordProtocol.EndReceiveRecord (System.IAsyncResult asyncResult) ...</code>.  There are several ways to resolve this error.  I opt’d to solve this by importing the mozilla certs for mono using <code>mozroots.exe</code>.  Other options can be found at (<a href="http://www.mono-project.com/docs/faq/security/" target="_blank" rel="noopener">http://www.mono-project.com/docs/faq/security/</a>); your mileage may vary.</em></p>
<p>Once these components are in place, a couple small modifications are required.  First, add a new package to my package.dependencies file.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nuget AWSSDK.Rekognition </span><br></pre></td></tr></table></figure>
<p>Next, add the Rekognition dll’s and namespace.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#r <span class="string">"../packages/AWSSDK.Core/lib/net45/AWSSDK.Core.dll"</span></span><br><span class="line">#r <span class="string">"../packages/AWSSDK.Rekognition/lib/net45/AWSSDK.Rekognition.dll"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">open</span> Amazon</span><br><span class="line"><span class="keyword">open</span> Amazon.Rekognition</span><br></pre></td></tr></table></figure>
<p>I’m going to put all the code into a new module.  To get what we need out of the api, the basic workflow is:</p>
<ol>
<li>Take photo as Bitmap.</li>
<li>Create a request object (with the image attached).</li>
<li>Call the Rekognition api with the request object.</li>
<li>Grab the attributes of the response object I care about.</li>
</ol>
<p>For details on the api, I recommend looking at the <a href="http://docs.aws.amazon.com/rekognition/latest/dg/API_DetectFaces.html" target="_blank" rel="noopener">Rekognition DetectFaces Documentation</a>.  There are a couple small details for my implementation I want to mention.  The api grabs all faces it can find, so FaceDetail is an array.  My use case presumes one person, or if more, it just takes the first one it finds.  The api emotion is a list of possible emotions with their probabilities.  This isn’t very friendly looking, so I only show the highest probability emotion.  The <code>whoAmI</code> function provides some addition interesting reporting from the image.  </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Additional face analysis features</span></span><br><span class="line"><span class="keyword">module</span> FaceExtra = </span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Take an image and return an aws Model.Image</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">private</span> bitmapToModelImage (image:Bitmap) = </span><br><span class="line">        <span class="comment">// Load image into memorystream</span></span><br><span class="line">        <span class="keyword">let</span> ms = <span class="keyword">new</span> MemoryStream()</span><br><span class="line">        image.Save(ms, ImageFormat.Jpeg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Convert memorystream to aws' Model.Image</span></span><br><span class="line">        <span class="keyword">let</span> modelImage = <span class="keyword">new</span> Model.Image()</span><br><span class="line">        modelImage.Bytes &lt;- ms</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Return model image</span></span><br><span class="line">        modelImage</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Take an image filename and return an aws DetectFacesRequest </span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">private</span> buildRequest (image:Bitmap) = </span><br><span class="line">        <span class="keyword">let</span> request = <span class="keyword">new</span> Model.DetectFacesRequest()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get all attributes back from api</span></span><br><span class="line">        <span class="keyword">let</span> attributeList = <span class="keyword">new</span> Collections.Generic.List&lt;string&gt;()</span><br><span class="line">        attributeList.Add(<span class="string">"ALL"</span>)</span><br><span class="line">        request.Attributes &lt;- attributeList</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set Image</span></span><br><span class="line">        request.Image &lt;- bitmapToModelImage image</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Return request</span></span><br><span class="line">        request</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Given a list of emotions, return the highest confidence one (in tuple form)</span></span><br><span class="line">    <span class="keyword">let</span> getMainEmotion (emotions:Collections.Generic.List&lt;Model.Emotion&gt;) = </span><br><span class="line">        <span class="keyword">if</span> emotions.Count &lt;&gt; <span class="number">0</span> </span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            emotions</span><br><span class="line">            |&gt; Seq.sortByDescending (<span class="keyword">fun</span> x -&gt; x.Confidence)</span><br><span class="line">            |&gt; Seq.head</span><br><span class="line">            |&gt; (<span class="keyword">fun</span> e -&gt; (e.Type.Value, e.Confidence))</span><br><span class="line">        <span class="keyword">else</span> (<span class="string">"Unknown"</span>, float32 <span class="number">0.</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Query the rekognition api using the provided bitmap image</span></span><br><span class="line">    <span class="keyword">let</span> getFaceDetails (image:Bitmap) = </span><br><span class="line">        <span class="keyword">let</span> request = buildRequest image</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> rekognition = <span class="keyword">new</span> Amazon.Rekognition.AmazonRekognitionClient(Amazon.RegionEndpoint.USEast1)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> detectedFaces = rekognition.DetectFaces(request)</span><br><span class="line"></span><br><span class="line">        detectedFaces</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Take a snapshot and determine the person's emotional state.</span></span><br><span class="line">    <span class="keyword">let</span> getCurrentEmotion () =</span><br><span class="line">        <span class="keyword">let</span> details = getFaceDetails (Camera.captureImageBitmap())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> details.FaceDetails.Count &lt;&gt; <span class="number">0</span></span><br><span class="line">        <span class="keyword">then</span> Some ((fst (getMainEmotion details.FaceDetails.[<span class="number">0</span>].Emotions)).ToLower())</span><br><span class="line">        <span class="keyword">else</span> None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Make a friendly description string for showing if face has an attribute</span></span><br><span class="line">    <span class="keyword">let</span> attributeDisplay (value:bool) (description:string) =</span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">then</span> sprintf <span class="string">"Has %s"</span> description <span class="keyword">else</span> sprintf <span class="string">"No %s"</span> description </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Build a simple report string</span></span><br><span class="line">    <span class="keyword">let</span> getFaceReport () = </span><br><span class="line">        <span class="keyword">let</span> details = getFaceDetails (Camera.captureImageBitmap())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> details.FaceDetails.Count &lt;&gt; <span class="number">0</span></span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">let</span> face = details.FaceDetails.[<span class="number">0</span>]</span><br><span class="line">            sprintf </span><br><span class="line">                <span class="string">"Gender: %s\r\nAge: %d - %d\r\nEmotions: %s\r\n%s\r\n%s\r\n%s\r\n%s"</span> </span><br><span class="line">                face.Gender.Value.Value </span><br><span class="line">                face.AgeRange.Low </span><br><span class="line">                face.AgeRange.High</span><br><span class="line">                (String.Join(<span class="string">", "</span>, face.Emotions |&gt; Seq.map (<span class="keyword">fun</span> x -&gt; sprintf <span class="string">"%s (%f)"</span> x.Type.Value x.Confidence)))</span><br><span class="line">                (attributeDisplay face.Beard.Value <span class="string">"beard"</span>)</span><br><span class="line">                (attributeDisplay face.Mustache.Value <span class="string">"mustache"</span>)</span><br><span class="line">                (attributeDisplay face.Eyeglasses.Value <span class="string">"glasses"</span>)</span><br><span class="line">                (attributeDisplay face.Sunglasses.Value <span class="string">"sunglasses"</span>)</span><br><span class="line">        <span class="keyword">else</span> <span class="string">""</span>		</span><br></pre></td></tr></table></figure>
<p>The additional functionality gets wired into the <code>whoAmI</code> and <code>getName</code> calls.  This is a pretty simple add.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Lookup person currently in front of camera</span></span><br><span class="line"><span class="keyword">let</span> whoAmI () =</span><br><span class="line">    <span class="keyword">let</span> person = Db.lookupPerson()</span><br><span class="line">    <span class="keyword">match</span> person <span class="keyword">with</span> </span><br><span class="line">    | Some(person) -&gt;</span><br><span class="line">        <span class="keyword">let</span> report = FaceExtra.getFaceReport()</span><br><span class="line">        printfn <span class="string">"You are %s\r\n%s"</span> person report </span><br><span class="line">    | None -&gt; </span><br><span class="line">        printfn <span class="string">"I don't recognize you.  Sorry."</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// Get a person's name (by lookup or prompt to add to db)</span></span><br><span class="line"><span class="keyword">let</span> getName() =</span><br><span class="line">    <span class="keyword">let</span> person = Db.lookupPerson()</span><br><span class="line">    <span class="keyword">match</span> person <span class="keyword">with</span> </span><br><span class="line">    | Some(person) -&gt;</span><br><span class="line">        <span class="keyword">let</span> emotion = FaceExtra.getCurrentEmotion()</span><br><span class="line">        <span class="keyword">match</span> emotion <span class="keyword">with</span></span><br><span class="line">        | Some(emotion) -&gt; printfn <span class="string">"Hi %s, you seem %s"</span> person emotion</span><br><span class="line">        | None          -&gt; printfn <span class="string">"Hi %s"</span> person</span><br><span class="line">        Some person</span><br><span class="line">    | None -&gt; </span><br><span class="line">        printfn <span class="string">"I don't recognize you. What is your name? "</span></span><br><span class="line">        <span class="keyword">let</span> name = Console.ReadLine()</span><br><span class="line">        printfn <span class="string">"Taking photos and training..."</span></span><br><span class="line">        Db.addPerson name</span><br><span class="line">        <span class="comment">// Note: Could return name, but I want to explicitly force a lookup</span></span><br><span class="line">        <span class="comment">//Some name    </span></span><br><span class="line">        None</span><br></pre></td></tr></table></figure>
<p>Time to checkout how the new functionality looks.</p>
<p><img src="/images/emgu1/demo-emotion.png" alt="With Emotion"></p>
<p>Cool.  It did a pretty good job.  The great thing is, this kind of technology will only get better.  This has been fun, but the post has already gone longer than intended, so I’ll end it here.  I hope you enjoyed this little glimpse into facial recognition and information extraction.  Until next time.</p>

        <div class="related-posts-box">
        Related Posts:<ul class="related-posts"><li class="related-posts-item"><a class="related-posts-link" href="/2016/11/21/Face-Detection-with-FSharp-and-Accord-NET/">Face Detection with F# and Accord.NET</a></li><li class="related-posts-item"><a class="related-posts-link" href="/2018/04/24/FSharp-and-Word-Stems/">F# and Word Stems</a></li><li class="related-posts-item"><a class="related-posts-link" href="/2017/08/27/K-Means-Clustering-with-F/">K-Means Clustering with F#</a></li></ul>        </div>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codesuji.com/2017/05/20/F-and-EmguCV/" data-id="cjo9c9112000fb9m0um7bjey5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Computer-Vision/">Computer Vision</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/EmguCV/">EmguCV</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/F/">F#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FSharp/">FSharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Faces/">Faces</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Images/">Images</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Machine-Learning/">Machine Learning</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenCV/">OpenCV</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Rekognition/">Rekognition</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/07/28/F-and-SQLite/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          F# and SQLite
        
      </div>
    </a>
  
  
    <a href="/2017/03/13/bf-compiler-part4-optimization/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">BF Compiler Part 4 - Optimization</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/NET-Core/" style="font-size: 17.78px;">.NET Core</a> <a href="/tags/Accord-NET/" style="font-size: 15.56px;">Accord.NET</a> <a href="/tags/Analytics/" style="font-size: 14.44px;">Analytics</a> <a href="/tags/Audio/" style="font-size: 10px;">Audio</a> <a href="/tags/Benchmarking/" style="font-size: 10px;">Benchmarking</a> <a href="/tags/Chiron/" style="font-size: 10px;">Chiron</a> <a href="/tags/Classification/" style="font-size: 11.11px;">Classification</a> <a href="/tags/Cognitive-Services/" style="font-size: 11.11px;">Cognitive Services</a> <a href="/tags/Compiler/" style="font-size: 13.33px;">Compiler</a> <a href="/tags/Computer-Vision/" style="font-size: 11.11px;">Computer Vision</a> <a href="/tags/Cordova/" style="font-size: 10px;">Cordova</a> <a href="/tags/DTW/" style="font-size: 11.11px;">DTW</a> <a href="/tags/Data/" style="font-size: 16.67px;">Data</a> <a href="/tags/Database/" style="font-size: 11.11px;">Database</a> <a href="/tags/Decision-Trees/" style="font-size: 11.11px;">Decision Trees</a> <a href="/tags/Deedle/" style="font-size: 10px;">Deedle</a> <a href="/tags/Delegate/" style="font-size: 10px;">Delegate</a> <a href="/tags/Detection/" style="font-size: 10px;">Detection</a> <a href="/tags/Dynamic-Time-Warping/" style="font-size: 11.11px;">Dynamic Time Warping</a> <a href="/tags/EEG/" style="font-size: 10px;">EEG</a> <a href="/tags/Edges/" style="font-size: 10px;">Edges</a> <a href="/tags/Elmish/" style="font-size: 10px;">Elmish</a> <a href="/tags/EmguCV/" style="font-size: 10px;">EmguCV</a> <a href="/tags/F/" style="font-size: 20px;">F#</a> <a href="/tags/FParsec/" style="font-size: 12.22px;">FParsec</a> <a href="/tags/FSAdvent/" style="font-size: 10px;">FSAdvent</a> <a href="/tags/FSharp/" style="font-size: 20px;">FSharp</a> <a href="/tags/Fable/" style="font-size: 10px;">Fable</a> <a href="/tags/Faces/" style="font-size: 11.11px;">Faces</a> <a href="/tags/Filters/" style="font-size: 10px;">Filters</a> <a href="/tags/Http/" style="font-size: 11.11px;">Http</a> <a href="/tags/Images/" style="font-size: 12.22px;">Images</a> <a href="/tags/Ionide/" style="font-size: 10px;">Ionide</a> <a href="/tags/Kaggle/" style="font-size: 12.22px;">Kaggle</a> <a href="/tags/Keyboard/" style="font-size: 11.11px;">Keyboard</a> <a href="/tags/Legos/" style="font-size: 11.11px;">Legos</a> <a href="/tags/Logging/" style="font-size: 10px;">Logging</a> <a href="/tags/MLNet/" style="font-size: 16.67px;">MLNet</a> <a href="/tags/MSIL/" style="font-size: 12.22px;">MSIL</a> <a href="/tags/Machine-Learning/" style="font-size: 18.89px;">Machine Learning</a> <a href="/tags/MathNet/" style="font-size: 10px;">MathNet</a> <a href="/tags/Mobile/" style="font-size: 10px;">Mobile</a> <a href="/tags/Mono/" style="font-size: 10px;">Mono</a> <a href="/tags/Morse-Code/" style="font-size: 10px;">Morse Code</a> <a href="/tags/OpenCV/" style="font-size: 10px;">OpenCV</a> <a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a> <a href="/tags/Parsing/" style="font-size: 12.22px;">Parsing</a> <a href="/tags/Racket/" style="font-size: 10px;">Racket</a> <a href="/tags/Regression/" style="font-size: 10px;">Regression</a> <a href="/tags/Rekognition/" style="font-size: 10px;">Rekognition</a> <a href="/tags/Robotics/" style="font-size: 10px;">Robotics</a> <a href="/tags/Scoring/" style="font-size: 10px;">Scoring</a> <a href="/tags/Search/" style="font-size: 10px;">Search</a> <a href="/tags/Serialization/" style="font-size: 10px;">Serialization</a> <a href="/tags/SignalR/" style="font-size: 10px;">SignalR</a> <a href="/tags/Signals/" style="font-size: 12.22px;">Signals</a> <a href="/tags/Similarity/" style="font-size: 11.11px;">Similarity</a> <a href="/tags/Sound/" style="font-size: 10px;">Sound</a> <a href="/tags/Statistics/" style="font-size: 13.33px;">Statistics</a> <a href="/tags/Tail-calls/" style="font-size: 10px;">Tail calls</a> <a href="/tags/Text/" style="font-size: 14.44px;">Text</a> <a href="/tags/Timeseries/" style="font-size: 10px;">Timeseries</a> <a href="/tags/Translation/" style="font-size: 10px;">Translation</a> <a href="/tags/VS-Code/" style="font-size: 10px;">VS Code</a> <a href="/tags/Webapi/" style="font-size: 11.11px;">Webapi</a> <a href="/tags/admin/" style="font-size: 11.11px;">admin</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 codesuji.com<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>