<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>F# and ML.NET Regression | codesuji</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Recently Microsoft announced ML.NET, a machine learning framework for .NET.  This is exciting news.  So my mind immediately goes to: how does this look with F#?  The current post will take a look at u">
<meta name="keywords" content="F#,FSharp,Machine Learning,MLNet,.NET Core">
<meta property="og:type" content="article">
<meta property="og:title" content="F# and ML.NET Regression">
<meta property="og:url" content="http://codesuji.com/2018/06/09/F-and-MLNet-Regression/index.html">
<meta property="og:site_name" content="codesuji">
<meta property="og:description" content="Recently Microsoft announced ML.NET, a machine learning framework for .NET.  This is exciting news.  So my mind immediately goes to: how does this look with F#?  The current post will take a look at u">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-09-16T23:47:32.742Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="F# and ML.NET Regression">
<meta name="twitter:description" content="Recently Microsoft announced ML.NET, a machine learning framework for .NET.  This is exciting news.  So my mind immediately goes to: how does this look with F#?  The current post will take a look at u">
  
    <link rel="alternate" href="/atom.xml" title="codesuji" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-89982547-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codesuji</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://codesuji.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-F-and-MLNet-Regression" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/09/F-and-MLNet-Regression/" class="article-date">
  <time datetime="2018-06-09T12:48:41.000Z" itemprop="datePublished">2018-06-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      F# and ML.NET Regression
    </h1>
  

 		<span class="post-count">Read Time: 13 minutes</span>
 	  </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Recently Microsoft announced <a href="https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet" target="_blank" rel="noopener">ML.NET</a>, a machine learning framework for .NET.  This is exciting news.  So my mind immediately goes to: how does this look with <a href="http://fsharp.org/" target="_blank" rel="noopener">F#</a>?  The current post will take a look at using ML.NET’s regression module to predict concrete compressive strength based on its composite ingredients.</p>
<a id="more"></a>
<p><i>Update: This post is here for posterity sake, a rework of this post is <a href="/2019/09/14/F-and-MLNet-Regression-V2/">here</a> using ML.NET version 1.3.</i></p>
<p>Before jumping in too far, there is a disclaimer: ML.NET is in its early stages.  I found a couple implementation and interface idiosyncrasies I suspect will change over time.  Just keep that in mind moving forward.  The short version is, I’ve been pleased with what I’ve seen so far.  There is some room for improvement, especially having more F#-centric support for calling methods.  It will be an interesting journey as the framework matures.</p>
<p><i>Update: The post was written using Microsoft.ML v0.1.0, and v0.2.0 has since been released.  I have noted interfaces changes below, for the example it is just TextLoader.</i></p>
<p>With that out of the way, make sure you have <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core version 2.0</a> installed.  If you don’t, head out to the <a href="https://www.microsoft.com/net/download/core" target="_blank" rel="noopener">.NET Core Downloads</a> page.  Select <strong>SDK</strong> for your platform.  Tangential, but you can also get here by going to <a href="https://dot.net" target="_blank" rel="noopener">dot.net</a>, then navigating to <code>Downloads</code> and <code>.NET Core</code>.</p>
<p>First, create the project and add the ML.NET package.  This will be a console app in F# (obviously).</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dotnet new console --language F# --name MLNet-Concrete</span><br><span class="line">cd MLNet-Concrete</span><br><span class="line">dotnet add package Microsoft.ML</span><br></pre></td></tr></table></figure>
<p>Next, it is time to get the data.  The source I used for this post is from <a href="https://archive.ics.uci.edu/ml/datasets/Concrete+Compressive+Strength" target="_blank" rel="noopener">UCI</a>.  The dataset is an Excel file (xls), and I need it as a csv.  I used <code>ssource</code> (from <code>apt install gnumeric</code>) to convert from Excel to CSV, but feel free to use whatever works for you.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir data &amp;&amp; cd data</span><br><span class="line">curl -O https://archive.ics.uci.edu/ml/machine-learning-databases/concrete/compressive/Concrete_Data.xls</span><br><span class="line">ssource Concrete_Data.xls Concrete_Data.csv</span><br></pre></td></tr></table></figure>
<p>Here is a sample of what the data looks like.  There is a header row, I’ve transposed this to a vertical list for readablity.  The first 8 columns are features, the last is the concrete compressive strength.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Header Row</span><br><span class="line">Cement (component 1)(kg in a m^3 mixture)</span><br><span class="line">Blast Furnace Slag (component 2)(kg in a m^3 mixture)</span><br><span class="line">Fly Ash (component 3)(kg in a m^3 mixture)</span><br><span class="line">Water  (component 4)(kg in a m^3 mixture)</span><br><span class="line">Superplasticizer (component 5)(kg in a m^3 mixture)</span><br><span class="line">Coarse Aggregate  (component 6)(kg in a m^3 mixture)</span><br><span class="line">Fine Aggregate (component 7)(kg in a m^3 mixture)</span><br><span class="line">Age (day)</span><br><span class="line">Concrete compressive strength(MPa, megapascals)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Data Rows</span><br><span class="line">540,0,0,162,2.5,1040,676,28,79.98611076</span><br><span class="line">540,0,0,162,2.5,1055,676,28,61.887365759999994</span><br><span class="line">332.5,142.5,0,228,0,932,594,270,40.269535256000005</span><br><span class="line">332.5,142.5,0,228,0,932,594,365,41.052779992</span><br></pre></td></tr></table></figure>
<p>Now that the project is setup and data is local, we can get to the code.  Time to open up the already created <code>Program.fs</code>.  First, add the necessary namespaces.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> System</span><br><span class="line"><span class="keyword">open</span> Microsoft.ML</span><br><span class="line"><span class="keyword">open</span> Microsoft.ML.Runtime.Api</span><br><span class="line"><span class="keyword">open</span> Microsoft.ML.Trainers</span><br><span class="line"><span class="keyword">open</span> Microsoft.ML.Transforms</span><br><span class="line"><span class="keyword">open</span> Microsoft.ML.Models</span><br><span class="line"></span><br><span class="line"><span class="comment">// New for v0.2.0</span></span><br><span class="line"><span class="keyword">open</span> Microsoft.ML.Data</span><br></pre></td></tr></table></figure>
<p>The ML.NET pipeline expects the data in a specific format.  In the C# world, this is a class, for F# we can use a type.  Below are the required types; <code>ConcreteData</code> is the input data, <code>ConcretePrediction</code> is the output prediction.  For <code>ConcreteData</code>, this is basically a a map of columns to member variables.  There are a couple notable points to ensure the pipeline can properly consume the data.  Each attribute must be <code>mutable public</code>, it also requires the <code>[&lt;Column(&quot;#&quot;)&gt;]</code> to specify it’s column position, and <code>[&lt;DefaultValue&gt;]</code> attributes.  For <code>ConcretePrediction</code>, a single attribute is required, the prediction value.  For the input data, the label variable must be named <code>Label</code>.  For the prediction type, the variable must be labeled <code>Score</code>.  There are methods where you are supposed to be able to define a <code>ColumnName</code> attribute, or copy a label column into the pipeline.  But frankly they didn’t work for me.  I’m unclear if I was doing something wrong if its a current early-state problem.  Over time I expect this will be resolved, but for now I don’t mind working within tighter constraints.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">ConcreteData</span></span>() =</span><br><span class="line">  <span class="meta">[&lt;Column("0")&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Cement:float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;Column("1")&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Slag:float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;Column("2")&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Ash:float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;Column("3")&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Water:float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;Column("4")&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Superplasticizer:float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;Column("5")&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> CoarseAggregate:float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;Column("6")&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> FineAggregate:float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;Column("7")&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Age:float32</span><br><span class="line"></span><br><span class="line">  <span class="meta">[&lt;Column("8")&gt;]</span></span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Label :float32</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">ConcretePrediction</span></span>() =</span><br><span class="line">  <span class="meta">[&lt;DefaultValue&gt;]</span></span><br><span class="line">  <span class="keyword">val</span> <span class="keyword">mutable</span> <span class="keyword">public</span> Score:float32</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The structure of building a pipeline is pretty intuitive.  First, create a pipeline.  Then, add components to the pipeline in the order to be executed.  So first, load the data with a <code>TextLoader</code>.  This data is comma delimited and has a header row.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> pipeline = <span class="keyword">new</span> LearningPipeline()</span><br><span class="line"><span class="keyword">let</span> dataPath = <span class="string">"./data/Concrete_Data.csv"</span></span><br><span class="line"><span class="comment">// v0.1.0 </span></span><br><span class="line"><span class="comment">// pipeline.Add(new TextLoader&lt;ConcreteData&gt;(dataPath, separator = ",", useHeader = true))</span></span><br><span class="line"><span class="comment">// New for v0.2.0</span></span><br><span class="line">pipeline.Add((<span class="keyword">new</span> TextLoader(dataPath)).CreateFrom&lt;ConcreteData&gt;(separator = ',', useHeader = <span class="keyword">true</span>))</span><br></pre></td></tr></table></figure>
<p>After the data is loaded, feature columns need to be added to the pipeline.  I’m going to use all feature columns from the file, but I don’t have to.  The regressor model requires features to be numeric. In this example, that is the case and nothing special needs to be done.  In cases where columns are strings, the <code>CategoricalOneHotVectorizer()</code> will convert string columns to numeric mappings.  I’ve provided an example line below.  Even though I don’t need it, its a handy reference to have.  Note the order, since it is a pipeline, the string to numeric column conversion needs to happen prior to adding the feature columns.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Example how to convert text to numeric</span></span><br><span class="line"><span class="comment">// pipeline.Add(new CategoricalOneHotVectorizer("CementBrandName", "SlagBrandName"));</span></span><br><span class="line">pipeline.Add(<span class="keyword">new</span> ColumnConcatenator(<span class="string">"Features"</span>, <span class="string">"Cement"</span>, <span class="string">"Slag"</span>, <span class="string">"Ash"</span>, <span class="string">"Water"</span>, <span class="string">"Superplasticizer"</span>, <span class="string">"CoarseAggregate"</span>, <span class="string">"FineAggregate"</span>, <span class="string">"Age"</span>))</span><br></pre></td></tr></table></figure>
<p>Now that the features are defined, it is time to determine what training method to use.  For this post <code>FastTreeRegressor</code> is used.  This is a boosted decision tree and generally offers pretty good results.  Custom hyperparameters can also be defined.  I found the defaults to be fine, but its good to see the option to tweak those values.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pipeline.Add(<span class="keyword">new</span> FastTreeRegressor())</span><br><span class="line"></span><br><span class="line"><span class="comment">// FastTreeRegressor with hyperparameters</span></span><br><span class="line"><span class="comment">// pipeline.Add(new FastTreeRegressor(NumTrees = 500, DropoutRate = 0.2))</span></span><br></pre></td></tr></table></figure>
<p>For the dataset in question, the <code>FastTreeRegressor</code> worked the best, but there are alternatives.  I’ve listed them below.  Most had worst performance, with the <code>FastTreeTweedieRegressor</code> being similar.  As will anything, it is good to investigate options.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Similar performance</span></span><br><span class="line"><span class="comment">// pipeline.Add(new FastTreeTweedieRegressor())</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Worse performance</span></span><br><span class="line"><span class="comment">// pipeline.Add(new PoissonRegressor())</span></span><br><span class="line"><span class="comment">// pipeline.Add(new StochasticDualCoordinateAscentRegressor())</span></span><br><span class="line"><span class="comment">// pipeline.Add(new FastForestRegressor())</span></span><br><span class="line"><span class="comment">// pipeline.Add(new OnlineGradientDescentRegressor())</span></span><br></pre></td></tr></table></figure>
<p>The last part, train the model.  Note the <code>ConcreteData</code> and <code>ConcretePrediction</code> types as part of the <code>Train</code> call. </p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> model = pipeline.Train&lt;ConcreteData, ConcretePrediction&gt;()  </span><br></pre></td></tr></table></figure>
<p>Validation of any model is important.  For a real case, I would train on one dataset and validate against a previously unseen dataset.  Since this is just an example, I validate against the training data.  As a result, I expect the results to be very good, and they are.  ML.NET offers an Evaluator class, which makes getting some of those crucial high-level numbers pretty easy.  It takes a trained model and a dataset, and produces critical metrics.  Again, this is one of those components that is crucial to an ML framework and I’m glad to see it here.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Evaluate results</span></span><br><span class="line"><span class="comment">// v0.1.0 </span></span><br><span class="line"><span class="comment">// let testData = new TextLoader&lt;ConcreteData&gt;(dataPath, separator = ",", useHeader = true)</span></span><br><span class="line"><span class="comment">// New for v0.2.0</span></span><br><span class="line"><span class="keyword">let</span> testData = (<span class="keyword">new</span> TextLoader(dataPath)).CreateFrom&lt;ConcreteData&gt;(separator = ',', useHeader = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">let</span> evaluator = <span class="keyword">new</span> RegressionEvaluator()</span><br><span class="line"><span class="keyword">let</span> metrics = evaluator.Evaluate(model, testData) </span><br><span class="line">printfn <span class="string">""</span></span><br><span class="line">printfn <span class="string">"R-Squared: %f"</span> &lt;| metrics.RSquared</span><br><span class="line">printfn <span class="string">"RMS      : %f"</span> &lt;| metrics.Rms</span><br><span class="line">printfn <span class="string">"L1       : %f"</span> &lt;| metrics.L1</span><br><span class="line">printfn <span class="string">"L2       : %f"</span> &lt;| metrics.L2</span><br><span class="line">printfn <span class="string">""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Evaluator Results:</span><br><span class="line">R-Squared: 0.988533</span><br><span class="line">RMS      : 1.788017</span><br><span class="line">L1       : 1.139818</span><br><span class="line">L2       : 3.197006</span><br></pre></td></tr></table></figure>
<p>Backtracking to the hyperparameter example, here are those results.  As you can tell, my randomly picked hyperparameter choices were not better.  Certainly it seems like a fun opportunity to pair some optimization searches with the pipeline to see how methods can be improved. Of course, this is more meaningful if it is not validating against the training data, there is already a risk of overfitting that we’re not seeing.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Evaluator Results (with hyperparameters):</span><br><span class="line">R-Squared: 0.947057</span><br><span class="line">RMS      : 3.841995</span><br><span class="line">L1       : 2.846822</span><br><span class="line">L2       : 14.760922</span><br></pre></td></tr></table></figure>
<p>Here is an example of how individual predictions can be made.  Create a <code>ConcreteData</code> object and provide it to the <code>Predict</code> method.  For this example, I pull one of those rows from the training data.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> test1 = ConcreteData()</span><br><span class="line">test1.Cement &lt;- <span class="number">198.6</span>f</span><br><span class="line">test1.Slag &lt;- <span class="number">132.4</span>f</span><br><span class="line">test1.Ash &lt;- <span class="number">0.</span>f</span><br><span class="line">test1.Water &lt;- <span class="number">192.</span>f</span><br><span class="line">test1.Superplasticizer &lt;- <span class="number">0.</span>f</span><br><span class="line">test1.CoarseAggregate &lt;- <span class="number">978.4</span>f</span><br><span class="line">test1.FineAggregate &lt;- <span class="number">825.5</span>f</span><br><span class="line">test1.Age &lt;- <span class="number">90.</span>f</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> predictionTest1 = model.Predict(test1)</span><br><span class="line">printfn <span class="string">"Predicted Strength: %f"</span> predictionTest1.Score</span><br><span class="line">printfn <span class="string">"Actual Strength   : 38.074243671999994"</span></span><br><span class="line">printfn <span class="string">""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Prediction Result:</span><br><span class="line">Predicted Strength: 38.882920</span><br><span class="line">Actual Strength   : 38.074243671999994</span><br></pre></td></tr></table></figure>
<p>On a lark, let’s see what happens if slag is increased, and the water content is reduced.  It looks like compressive strength gets stronger.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> test2 = ConcreteData()</span><br><span class="line">test2.Cement &lt;- <span class="number">198.6</span>f</span><br><span class="line">test2.Slag &lt;- <span class="number">150.0</span>f</span><br><span class="line">test2.Ash &lt;- <span class="number">0.</span>f</span><br><span class="line">test2.Water &lt;- <span class="number">172.</span>f</span><br><span class="line">test2.Superplasticizer &lt;- <span class="number">0.</span>f</span><br><span class="line">test2.CoarseAggregate &lt;- <span class="number">978.4</span>f</span><br><span class="line">test2.FineAggregate &lt;- <span class="number">825.5</span>f</span><br><span class="line">test2.Age &lt;- <span class="number">90.</span>f</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> predictionTest2 = model.Predict(test2)</span><br><span class="line">printfn <span class="string">"Predicted Strength: %f"</span> predictionTest2.Score</span><br><span class="line">printfn <span class="string">""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Prediction Result:</span><br><span class="line">Predicted Strength: 45.623180</span><br></pre></td></tr></table></figure>
<p>Once a model is trained, it can also be saved to a file a reloaded at a later time.  This is supported by the <code>WriteAsync</code> and <code>ReadAsync</code> methods of a model.</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Save model to file</span></span><br><span class="line">model.WriteAsync(<span class="string">"test-model"</span>)</span><br><span class="line">|&gt; Async.AwaitTask</span><br><span class="line">|&gt; ignore</span><br><span class="line"></span><br><span class="line"><span class="comment">// Load model from file and run a prediction</span></span><br><span class="line"><span class="keyword">let</span> modelReloaded =</span><br><span class="line">  PredictionModel.ReadAsync&lt;ConcreteData, ConcretePrediction&gt;(<span class="string">"test-model"</span>) </span><br><span class="line">  |&gt; Async.AwaitTask </span><br><span class="line">  |&gt; Async.RunSynchronously</span><br><span class="line"><span class="keyword">let</span> predictionReloaded = modelReloaded.Predict(test1)</span><br><span class="line">printfn <span class="string">"Predicted Strength RL: %f"</span> predictionReloaded.Score</span><br><span class="line">printfn <span class="string">"Actual Strength      : 38.074243671999994"</span></span><br><span class="line">printfn <span class="string">""</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Prediction Result (model reloaded):</span><br><span class="line">Predicted Strength RL: 38.882920</span><br><span class="line">Actual Strength      : 38.074243671999994</span><br></pre></td></tr></table></figure>
<p>Throughout the post, portions of the output have been provided out of band.  Here is how the whole thing looks when run with <code>dotnet run</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Not adding a normalizer.</span><br><span class="line">Making per-feature arrays</span><br><span class="line">Changing data from row-wise to column-wise</span><br><span class="line">Processed 1030 instances</span><br><span class="line">Binning and forming Feature objects</span><br><span class="line">Reserved memory for tree learner: 234780 bytes</span><br><span class="line">Starting to train ...</span><br><span class="line">Not training a calibrator because it is not needed.</span><br><span class="line"></span><br><span class="line">R-Squared: 0.988533</span><br><span class="line">RMS      : 1.788017</span><br><span class="line">L1       : 1.139818</span><br><span class="line">L2       : 3.197006</span><br><span class="line"></span><br><span class="line">Predicted Strength: 38.882920</span><br><span class="line">Actual Strength   : 38.074243671999994</span><br><span class="line"></span><br><span class="line">Predicted Strength: 45.623180</span><br><span class="line"></span><br><span class="line">Predicted Strength RL: 38.882920</span><br><span class="line">Actual Strength      : 38.074243671999994</span><br></pre></td></tr></table></figure>
<p>There you have it.  A brief look into training and using an ML.NET regressor model.  Although there are a couple quirks, I’m excited to see this released.  This will only get better over time and if F# can be a part of that, even better.  </p>

        <div class="related-posts-box">
        Related Posts:<ul class="related-posts"><li class="related-posts-item"><a class="related-posts-link" href="/2018/07/07/F-and-MLNet-Clustering/">F# and ML.NET Clustering</a></li><li class="related-posts-item"><a class="related-posts-link" href="/2019/05/24/F-and-MLNet-Anomaly/">Taking Stock of Anomalies with F# and ML.NET</a></li><li class="related-posts-item"><a class="related-posts-link" href="/2019/09/14/F-and-MLNet-Regression-V2/">F# and ML.NET Regression</a></li></ul>        </div>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://codesuji.com/2018/06/09/F-and-MLNet-Regression/" data-id="cjo9c911m000rb9m0z6lonrz7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NET-Core/">.NET Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/F/">F#</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FSharp/">FSharp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MLNet/">MLNet</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Machine-Learning/">Machine Learning</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/06/23/F-and-MLNet-Classification/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          F# and ML.NET Classification
        
      </div>
    </a>
  
  
    <a href="/2018/04/24/FSharp-and-Word-Stems/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">F# and Word Stems</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/NET-Core/" style="font-size: 17.78px;">.NET Core</a> <a href="/tags/Accord-NET/" style="font-size: 15.56px;">Accord.NET</a> <a href="/tags/Analytics/" style="font-size: 14.44px;">Analytics</a> <a href="/tags/Audio/" style="font-size: 10px;">Audio</a> <a href="/tags/Benchmarking/" style="font-size: 10px;">Benchmarking</a> <a href="/tags/Chiron/" style="font-size: 10px;">Chiron</a> <a href="/tags/Classification/" style="font-size: 11.11px;">Classification</a> <a href="/tags/Cognitive-Services/" style="font-size: 11.11px;">Cognitive Services</a> <a href="/tags/Compiler/" style="font-size: 13.33px;">Compiler</a> <a href="/tags/Computer-Vision/" style="font-size: 11.11px;">Computer Vision</a> <a href="/tags/Cordova/" style="font-size: 10px;">Cordova</a> <a href="/tags/DTW/" style="font-size: 12.22px;">DTW</a> <a href="/tags/Data/" style="font-size: 16.67px;">Data</a> <a href="/tags/Database/" style="font-size: 11.11px;">Database</a> <a href="/tags/Decision-Trees/" style="font-size: 11.11px;">Decision Trees</a> <a href="/tags/Deedle/" style="font-size: 10px;">Deedle</a> <a href="/tags/Delegate/" style="font-size: 10px;">Delegate</a> <a href="/tags/Detection/" style="font-size: 10px;">Detection</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Dtw/" style="font-size: 10px;">Dtw</a> <a href="/tags/Dynamic-Time-Warping/" style="font-size: 12.22px;">Dynamic Time Warping</a> <a href="/tags/EEG/" style="font-size: 10px;">EEG</a> <a href="/tags/Edges/" style="font-size: 10px;">Edges</a> <a href="/tags/Elmish/" style="font-size: 10px;">Elmish</a> <a href="/tags/EmguCV/" style="font-size: 10px;">EmguCV</a> <a href="/tags/Entropy/" style="font-size: 10px;">Entropy</a> <a href="/tags/F/" style="font-size: 20px;">F#</a> <a href="/tags/FParsec/" style="font-size: 12.22px;">FParsec</a> <a href="/tags/FSAdvent/" style="font-size: 10px;">FSAdvent</a> <a href="/tags/FSharp/" style="font-size: 20px;">FSharp</a> <a href="/tags/Fable/" style="font-size: 10px;">Fable</a> <a href="/tags/Faces/" style="font-size: 11.11px;">Faces</a> <a href="/tags/Filters/" style="font-size: 10px;">Filters</a> <a href="/tags/Http/" style="font-size: 11.11px;">Http</a> <a href="/tags/Images/" style="font-size: 12.22px;">Images</a> <a href="/tags/Ionide/" style="font-size: 10px;">Ionide</a> <a href="/tags/Kaggle/" style="font-size: 12.22px;">Kaggle</a> <a href="/tags/Keyboard/" style="font-size: 11.11px;">Keyboard</a> <a href="/tags/Legos/" style="font-size: 11.11px;">Legos</a> <a href="/tags/Logging/" style="font-size: 10px;">Logging</a> <a href="/tags/MLNet/" style="font-size: 16.67px;">MLNet</a> <a href="/tags/MSIL/" style="font-size: 12.22px;">MSIL</a> <a href="/tags/Machine-Learning/" style="font-size: 18.89px;">Machine Learning</a> <a href="/tags/MathNet/" style="font-size: 10px;">MathNet</a> <a href="/tags/Messaging/" style="font-size: 10px;">Messaging</a> <a href="/tags/Mobile/" style="font-size: 10px;">Mobile</a> <a href="/tags/Mono/" style="font-size: 10px;">Mono</a> <a href="/tags/Morse-Code/" style="font-size: 10px;">Morse Code</a> <a href="/tags/OpenCV/" style="font-size: 10px;">OpenCV</a> <a href="/tags/Optimization/" style="font-size: 10px;">Optimization</a> <a href="/tags/Parsing/" style="font-size: 12.22px;">Parsing</a> <a href="/tags/Performance/" style="font-size: 10px;">Performance</a> <a href="/tags/Presentations/" style="font-size: 10px;">Presentations</a> <a href="/tags/Racket/" style="font-size: 10px;">Racket</a> <a href="/tags/Regression/" style="font-size: 10px;">Regression</a> <a href="/tags/Rekognition/" style="font-size: 10px;">Rekognition</a> <a href="/tags/Robotics/" style="font-size: 10px;">Robotics</a> <a href="/tags/Scoring/" style="font-size: 10px;">Scoring</a> <a href="/tags/Search/" style="font-size: 10px;">Search</a> <a href="/tags/Serialization/" style="font-size: 10px;">Serialization</a> <a href="/tags/SignalR/" style="font-size: 10px;">SignalR</a> <a href="/tags/Signals/" style="font-size: 12.22px;">Signals</a> <a href="/tags/Similarity/" style="font-size: 11.11px;">Similarity</a> <a href="/tags/Sound/" style="font-size: 10px;">Sound</a> <a href="/tags/Statistics/" style="font-size: 13.33px;">Statistics</a> <a href="/tags/Tail-calls/" style="font-size: 10px;">Tail calls</a> <a href="/tags/Text/" style="font-size: 14.44px;">Text</a> <a href="/tags/Timeseries/" style="font-size: 10px;">Timeseries</a> <a href="/tags/Translation/" style="font-size: 10px;">Translation</a> <a href="/tags/VS-Code/" style="font-size: 10px;">VS Code</a> <a href="/tags/Webapi/" style="font-size: 11.11px;">Webapi</a> <a href="/tags/admin/" style="font-size: 11.11px;">admin</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/03/17/Introduction-to-F-Talk/">Introduction to F# Talk</a>
          </li>
        
          <li>
            <a href="/2020/03/08/F-and-Docker/">Containerizing F# with Docker</a>
          </li>
        
          <li>
            <a href="/2019/12/21/F-Entropy/">Examing Entropy with F#</a>
          </li>
        
          <li>
            <a href="/2019/10/24/F-RabbitMQ/">Utilizing RabbitMQ with F#</a>
          </li>
        
          <li>
            <a href="/2019/10/13/F-Performance-Profiling/">Performance Profiling F#</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 codesuji.com<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>